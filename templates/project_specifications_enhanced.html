<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Specifications - AtlasNexus</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Modern Financial Institution Palette - Matching Dashboard */
            --deep-charcoal: #1A1D23;
            --slate-grey: #2C3137;
            --steel-blue: #364049;
            --silver-mist: #92969C;
            --silver-light: #B8C0C8;
            --pearl-grey: #E5E9F0;
            --pure-white: #FFFFFF;
            
            /* Accent Colors */
            --platinum-gold: #60a5fa;
            --amber-yellow: #93c5fd;
            --market-green: #22C55E;
            --market-red: #EF4444;
            --emerald-green: #059669;
            --crimson-red: #B91C1C;
            --royal-blue: #4169E1;
            
            /* Legacy mappings */
            --primary: #1e3a5f;
            --secondary: #60a5fa;
            --danger: #EF4444;
            --success: #22C55E;
            --warning: #f59e0b;
            --dark: #1A1D23;
            --light: #364049;
            --border: rgba(96, 165, 250, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--deep-charcoal);
            color: var(--pearl-grey);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #0a0e27, #020617);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(96, 165, 250, 0.2);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: white;
        }

        .container {
            max-width: 1600px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Sidebar */
        .sidebar {
            background: linear-gradient(135deg, #0a0e27, #020617);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            height: fit-content;
            position: sticky;
            top: 2rem;
        }

        .industry-selector {
            margin-bottom: 2rem;
        }

        .industry-btn {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 8px;
            background: linear-gradient(135deg, #0a0e27, #020617);
            color: var(--silver-light);
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .industry-btn:hover {
            background: rgba(30, 58, 138, 0.3);
            border-color: var(--platinum-gold);
            color: var(--platinum-gold);
        }

        .industry-btn.active {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            color: white;
            border-color: var(--platinum-gold);
        }

        .project-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .project-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #0a0e27, #020617);
            border: 1px solid rgba(96, 165, 250, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--silver-light);
        }

        .project-item:hover {
            background: rgba(30, 58, 138, 0.2);
            border-color: rgba(96, 165, 250, 0.3);
        }

        .project-item.active {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            color: white;
            border-color: var(--platinum-gold);
        }

        .project-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            display: inline-block;
            margin-top: 0.25rem;
        }

        .status-draft {
            background: #fef3c7;
            color: #92400e;
        }

        .status-submitted {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }

        /* Main Content */
        .main-content {
            background: linear-gradient(135deg, #0a0e27, #020617);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(96, 165, 250, 0.2);
        }

        .save-controls {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--silver-mist);
            transition: all 0.3s;
            position: relative;
        }

        .tab.active {
            color: var(--platinum-gold);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--secondary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Timeline Visualization */
        .timeline-container {
            margin: 2rem 0;
            padding: 1.5rem;
            background: linear-gradient(135deg, #0a0e27, #020617);
            border-radius: 10px;
        }

        .timeline {
            position: relative;
            padding: 2rem 0;
        }

        .timeline-line {
            position: absolute;
            left: 50px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(30, 58, 138, 0.3);
        }

        .timeline-phase {
            position: relative;
            padding-left: 100px;
            margin-bottom: 2rem;
        }

        .timeline-marker {
            position: absolute;
            left: 40px;
            top: 0;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0a0e27, #020617);
            border: 3px solid var(--secondary);
        }

        .timeline-marker.completed {
            background: var(--success);
        }

        .timeline-marker.in-progress {
            background: var(--warning);
        }

        .phase-card {
            background: linear-gradient(135deg, #0a0e27, #020617);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .phase-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .phase-name {
            font-weight: bold;
            color: white;
        }

        .phase-amount {
            color: var(--success);
            font-weight: bold;
        }

        .phase-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: var(--silver-mist);
        }

        /* Cash Flow Chart */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 2rem 0;
            padding: 1rem;
            background: linear-gradient(135deg, #0a0e27, #020617);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Progress Indicator */
        .progress-indicator {
            margin: 2rem 0;
            padding: 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .progress-bar {
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #059669);
            transition: width 0.5s ease;
        }

        /* Form Sections */
        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #0a0e27, #020617);
            border-radius: 8px;
        }

        .section-title {
            font-size: 1.2rem;
            color: white;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--dark);
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary);
        }

        /* Status Updates */
        .status-updates {
            margin-top: 2rem;
            padding: 1rem;
            background: #f0f9ff;
            border-radius: 8px;
            border: 1px solid #3b82f6;
        }

        .update-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #0a0e27, #020617);
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .update-time {
            font-size: 0.875rem;
            color: var(--silver-mist);
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid var(--light);
            border-top: 4px solid var(--secondary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">AtlasNexus - Project Management Portal</div>
            <div class="user-info">
                <span style="color: #B8C0C8;">{{ username }} ({{ account_type }})</span>
                <button onclick="saveDraft()" class="btn btn-warning">Save Draft</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="dashboard-grid">

            <!-- Main Content -->
            <div class="main-content">
                <div class="content-header">
                    <h2 id="projectTitle">New Project Specification</h2>
                    <div class="save-controls">
                        <span id="saveStatus" style="color: var(--success); margin-right: 1rem;"></span>
                        <button onclick="generateTimeline()" class="btn btn-warning">ðŸ“Š Generate Timeline</button>
                        <button onclick="submitProject()" class="btn btn-success">âœ… Submit Project</button>
                    </div>
                </div>

                <!-- Progress Indicator -->
                <div class="progress-indicator">
                    <div class="progress-header">
                        <span>Project Completion</span>
                        <span id="completionPercentage">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('details')">Project Details</button>
                    <button class="tab" onclick="switchTab('financial')">Financial Information</button>
                    <button class="tab" onclick="switchTab('timeline')">Timeline & Phases</button>
                    <button class="tab" onclick="switchTab('cashflow')">Cash Flow Analysis</button>
                    <button class="tab" onclick="switchTab('documents')">Documents</button>
                </div>

                <!-- Project Details Tab -->
                <div id="details-tab" class="tab-content active">
                    <form id="projectForm">
                        <!-- SECTION 1: PROJECT METADATA -->
                        <div class="form-section">
                            <h3 class="section-title">Project Metadata</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Project Title *</label>
                                    <input type="text" name="project_title" required placeholder="Enter project name" onchange="updateProgress()">
                                </div>
                                <div class="form-group">
                                    <label>Location Country *</label>
                                    <select name="location_country" required onchange="handleCountryChange(); updateProgress()">
                                        <option value="">Select Country</option>
                                        <option value="AL">Albania [Tier 3]</option>
                                        <option value="AD">Andorra [Tier 3]</option>
                                        <option value="AT">Austria [Tier 2]</option>
                                        <option value="BY">Belarus [Tier 3]</option>
                                        <option value="BE">Belgium [Tier 2]</option>
                                        <option value="BA">Bosnia and Herzegovina [Tier 3]</option>
                                        <option value="BG">Bulgaria [Tier 3]</option>
                                        <option value="HR">Croatia [Tier 3]</option>
                                        <option value="CY">Cyprus [Tier 3]</option>
                                        <option value="CZ">Czech Republic [Tier 2]</option>
                                        <option value="DK">Denmark [Tier 2]</option>
                                        <option value="EE">Estonia [Tier 3]</option>
                                        <option value="FI">Finland [Tier 2]</option>
                                        <option value="FR">France [Tier 1 - FLAP]</option>
                                        <option value="DE">Germany [Tier 1 - FLAP]</option>
                                        <option value="GR">Greece [Tier 2]</option>
                                        <option value="HU">Hungary [Tier 3]</option>
                                        <option value="IS">Iceland [Tier 2]</option>
                                        <option value="IE">Ireland [Tier 1 - FLAP-D]</option>
                                        <option value="IT">Italy [Tier 2]</option>
                                        <option value="XK">Kosovo [Tier 3]</option>
                                        <option value="LV">Latvia [Tier 3]</option>
                                        <option value="LI">Liechtenstein [Tier 3]</option>
                                        <option value="LT">Lithuania [Tier 3]</option>
                                        <option value="LU">Luxembourg [Tier 2]</option>
                                        <option value="MT">Malta [Tier 3]</option>
                                        <option value="MD">Moldova [Tier 3]</option>
                                        <option value="MC">Monaco [Tier 3]</option>
                                        <option value="ME">Montenegro [Tier 3]</option>
                                        <option value="NL">Netherlands [Tier 1 - FLAP]</option>
                                        <option value="MK">North Macedonia [Tier 3]</option>
                                        <option value="NO">Norway [Tier 2]</option>
                                        <option value="PL">Poland [Tier 2]</option>
                                        <option value="PT">Portugal [Tier 2]</option>
                                        <option value="RO">Romania [Tier 3]</option>
                                        <option value="RU">Russia [Tier 2]</option>
                                        <option value="SM">San Marino [Tier 3]</option>
                                        <option value="RS">Serbia [Tier 3]</option>
                                        <option value="SK">Slovakia [Tier 3]</option>
                                        <option value="SI">Slovenia [Tier 3]</option>
                                        <option value="ES">Spain [Tier 2]</option>
                                        <option value="SE">Sweden [Tier 2]</option>
                                        <option value="CH">Switzerland [Tier 2]</option>
                                        <option value="TR">Turkey [Tier 2]</option>
                                        <option value="UA">Ukraine [Tier 3]</option>
                                        <option value="UK" selected>United Kingdom [Tier 1 - FLAP]</option>
                                        <option value="VA">Vatican City [Tier 3]</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Project Status</label>
                                    <select name="project_status" onchange="updateProgress()">
                                        <option value="Planning" selected>Planning</option>
                                        <option value="Construction">Under Construction</option>
                                        <option value="Operational">Operational</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>CapEx Currency *</label>
                                    <select name="capex_currency" required onchange="handleCurrencyChange(); updateProgress()">
                                        <option value="GBP" selected>GBP (Â£)</option>
                                        <option value="EUR">EUR (â‚¬)</option>
                                        <option value="USD">USD ($)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Revenue Currency *</label>
                                    <select name="revenue_currency" required onchange="handleCurrencyChange(); updateProgress()">
                                        <option value="GBP" selected>GBP (Â£)</option>
                                        <option value="EUR">EUR (â‚¬)</option>
                                        <option value="USD">USD ($)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- SECTION 2: POWER & CAPACITY -->
                        <div class="form-section">
                            <h3 class="section-title">Power & Capacity</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Gross Facility Power (MW) *</label>
                                    <input type="number" name="gross_facility_power" value="100.00" step="0.01" min="0" required onchange="updatePowerCalculations(); updateProgress()">
                                    <small style="color: var(--silver-mist);">Total facility power capacity (grid connection)</small>
                                </div>
                                <div class="form-group">
                                    <label>PUE (Power Usage Effectiveness) *</label>
                                    <input type="number" name="pue" value="1.20" step="0.01" min="0.95" max="1.5" required onchange="updatePowerCalculations(); updateProgress()">
                                    <small style="color: var(--silver-mist);">Range: 0.95 - 1.5 (Lower is better)</small>
                                </div>
                                <div class="form-group">
                                    <label>IT Load (Calculated)</label>
                                    <input type="number" name="it_load" value="83.33" step="0.1" readonly style="background: rgba(96, 165, 250, 0.1); color: var(--platinum-gold); font-weight: 700;">
                                    <small style="color: var(--silver-mist);">Usable IT capacity = Gross Power / PUE</small>
                                </div>
                                <div class="form-group">
                                    <label>Overhead Power (Calculated)</label>
                                    <input type="number" name="overhead_power" value="16.67" step="0.1" readonly style="background: rgba(245, 158, 11, 0.1); color: var(--warning); font-weight: 700;">
                                    <small style="color: var(--silver-mist);">Cooling, UPS losses, lighting = Gross - IT</small>
                                </div>
                            </div>
                        </div>

                        <!-- SECTION 3: REVENUE & LEASE -->
                        <div class="form-section">
                            <h3 class="section-title">Revenue & Lease Terms</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Occupancy at Stabilization (%) *</label>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="range" name="occupancy" min="0" max="100" value="100" step="1" style="flex: 1;" oninput="document.getElementById('occupancyValue').textContent = this.value + '%'; updateProgress();">
                                        <span id="occupancyValue" style="min-width: 50px; font-weight: bold; color: var(--platinum-gold);">100%</span>
                                    </div>
                                    <small style="color: var(--silver-mist);">Target occupancy percentage of IT capacity</small>
                                </div>
                                <div class="form-group">
                                    <label>Monthly Rent (per IT kW) *</label>
                                    <input type="text" name="monthly_rent_per_kw" value="Â£130.00" required onchange="updateProgress()">
                                    <small style="color: var(--silver-mist);">Rent charged per kW of IT load (not facility load)</small>
                                </div>
                                <div class="form-group">
                                    <label>Lease Type *</label>
                                    <select name="lease_type" required onchange="handleLeaseTypeChange(); updateProgress()">
                                        <option value="TripleNet" selected>Triple Net (NNN) - Tenant pays utilities</option>
                                        <option value="Gross">Gross - Landlord pays utilities</option>
                                    </select>
                                    <small style="color: var(--silver-mist);">Who pays for electricity costs</small>
                                </div>
                                <div class="form-group">
                                    <label>Other OPEX (% of Revenue) *</label>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="range" name="other_opex_percent" min="0" max="50" value="5" step="0.5" style="flex: 1;" oninput="document.getElementById('otherOpexValue').textContent = this.value + '%'; updateProgress();">
                                        <span id="otherOpexValue" style="min-width: 50px; font-weight: bold; color: var(--platinum-gold);">5%</span>
                                    </div>
                                    <small style="color: var(--silver-mist);">Property tax, insurance, maintenance, security (excluding electricity)</small>
                                </div>
                                <div class="form-group" id="electricityRateGroup" style="display: none;">
                                    <label>Electricity Rate (per MWh) *</label>
                                    <input type="text" name="electricity_rate" value="Â£100.00" onchange="updateProgress()">
                                    <small style="color: var(--silver-mist);">Average electricity cost (Gross lease only)</small>
                                </div>
                            </div>
                        </div>

                        <!-- SECTION 4: LAND & INFRASTRUCTURE -->
                        <div class="form-section">
                            <h3 class="section-title">Land & Infrastructure</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Land Location Quality</label>
                                    <select name="land_location_quality" onchange="updateLandPurchase(); updateProgress()">
                                        <option value="rural">Rural (Â£100k/acre, 1.5 acres/MW)</option>
                                        <option value="suburban">Suburban (Â£300k/acre, 1.5 acres/MW)</option>
                                        <option value="urban" selected>Urban (Â£800k/acre, 1 acre/MW)</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Land Purchase</label>
                                    <input type="text" name="land_purchase" value="Â£80,000,000.00" onchange="updateProgress()">
                                    <small id="landPurchaseDetails" style="color: var(--silver-mist);">100 acres @ Â£800,000.00/acre</small>
                                </div>
                                <div class="form-group">
                                    <label>Grid Connection Quality</label>
                                    <select name="grid_connection_quality" onchange="updateGridConnection(); updateProgress()">
                                        <option value="good" selected>Good (Â£200k/MW)</option>
                                        <option value="medium">Medium (Â£400k/MW)</option>
                                        <option value="poor">Poor (Â£600k/MW)</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Grid Connection Costs</label>
                                    <input type="text" name="grid_connection" value="Â£20,000,000.00" onchange="updateProgress()">
                                    <small id="gridConnectionRate" style="color: var(--silver-mist);">Â£200,000.00 per MW</small>
                                </div>
                                <div class="form-group">
                                    <label>Stamp Duty Land Tax (SDLT) Structure</label>
                                    <select name="stamp_duty_structure" onchange="updateStampDutyRate(); updateProgress()">
                                        <option value="individual">Individual/Personal (5%)</option>
                                        <option value="company" selected>Company/Corporate (5%)</option>
                                        <option value="company_additional">Company + 3% Surcharge (8%)</option>
                                        <option value="reit">REIT/Institutional (0-5%)</option>
                                        <option value="custom">Custom Rate</option>
                                    </select>
                                    <small style="color: var(--silver-mist);">UK SDLT rates for non-residential property</small>
                                </div>
                                <div class="form-group">
                                    <label>Stamp Duty Rate %</label>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="range" name="stamp_duty_percent" min="0" max="20" value="5" step="0.5" style="flex: 1;" oninput="document.getElementById('stampDutyValue').textContent = this.value + '%'; updateProgress();">
                                        <span id="stampDutyValue" style="min-width: 50px; font-weight: bold; color: var(--platinum-gold);">5%</span>
                                    </div>
                                    <small style="color: var(--silver-mist);">Applied to land purchase price</small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Financial Information Tab -->
                <div id="financial-tab" class="tab-content">
                    <!-- BUILD CAPEX SECTION -->
                    <div class="form-section">
                        <h3 class="section-title">Build CapEx</h3>

                        <!-- CapEx Internal (Cost Basis) -->
                        <div style="background: rgba(96, 165, 250, 0.05); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 8px; margin-bottom: 1.5rem; overflow: hidden;">
                            <div style="background: rgba(96, 165, 250, 0.1); padding: 1rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleCapexSection('internal')">
                                <span style="font-weight: 600; color: var(--platinum-gold);">CapEx Internal (Cost Basis)</span>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <span id="capexInternalTotal" style="font-weight: 700; color: var(--pearl-grey);">Â£0</span>
                                    <span id="capexInternalIcon">â–¼</span>
                                </div>
                            </div>
                            <div id="capexInternalContent" style="padding: 1rem; display: none;">
                                <!-- Toggle between Per MW and Detailed -->
                                <div style="display: flex; gap: 10px; margin-bottom: 1rem;">
                                    <button type="button" class="capex-mode-btn active" id="internalOption1" onclick="setCapexMode('internal', 'perMW')" style="flex: 1; padding: 10px; background: var(--platinum-gold); color: var(--dark); border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Per MW Costing</button>
                                    <button type="button" class="capex-mode-btn" id="internalOption2" onclick="setCapexMode('internal', 'detailed')" style="flex: 1; padding: 10px; background: var(--slate-grey); color: var(--silver-light); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-weight: 600;">Detailed Breakdown</button>
                                </div>

                                <!-- Per MW Costing -->
                                <div id="internalPerMW">
                                    <div class="form-group">
                                        <label>Cost per Gross MW</label>
                                        <input type="text" name="internal_per_mw_cost" value="Â£7,500,000.00" onchange="updateCapexInternal()">
                                        <small style="color: var(--silver-mist);">Â£7.5m per Gross MW</small>
                                    </div>
                                    <div style="background: rgba(96, 165, 250, 0.1); padding: 10px; border-radius: 5px; text-align: center;">
                                        <strong id="internalPerMWCalc" style="color: var(--platinum-gold);">Â£7.5m Ã— 100 MW = Â£750,000,000</strong>
                                    </div>
                                </div>

                                <!-- Detailed Breakdown -->
                                <div id="internalDetailed" style="display: none;">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label>Architectural</label>
                                            <input type="text" name="internal_architectural" value="Â£0.00" onchange="updateCapexInternal()">
                                        </div>
                                        <div class="form-group">
                                            <label>Civil and Structural</label>
                                            <input type="text" name="internal_civil" value="Â£0.00" onchange="updateCapexInternal()">
                                        </div>
                                        <div class="form-group">
                                            <label>Substations</label>
                                            <input type="text" name="internal_substations" value="Â£0.00" onchange="updateCapexInternal()">
                                        </div>
                                        <div class="form-group">
                                            <label>Underground Utilities</label>
                                            <input type="text" name="internal_utilities" value="Â£0.00" onchange="updateCapexInternal()">
                                        </div>
                                        <div class="form-group">
                                            <label>Crusader Modules (Incl surveys and design)</label>
                                            <input type="text" name="internal_crusader" value="Â£0.00" onchange="updateCapexInternal()">
                                        </div>
                                        <div class="form-group">
                                            <label>Bess (Incl surveys and design)</label>
                                            <input type="text" name="internal_bess" value="Â£0.00" onchange="updateCapexInternal()">
                                        </div>
                                        <div class="form-group">
                                            <label>Main Contractor Installation</label>
                                            <input type="text" name="internal_main_contractor" value="Â£0.00" onchange="updateCapexInternal()">
                                        </div>
                                        <div class="form-group">
                                            <label>Photo Voltaic System</label>
                                            <input type="text" name="internal_photo_voltaic" value="Â£0.00" onchange="updateCapexInternal()">
                                        </div>
                                        <div class="form-group">
                                            <label>Landscaping</label>
                                            <input type="text" name="internal_landscaping" value="Â£0.00" onchange="updateCapexInternal()">
                                        </div>
                                        <div class="form-group">
                                            <label>Preliminaries - General</label>
                                            <input type="text" name="internal_preliminaries" value="Â£0.00" onchange="updateCapexInternal()">
                                        </div>
                                        <div class="form-group">
                                            <label>Main Contractor Margin</label>
                                            <input type="text" name="internal_margin" value="Â£0.00" onchange="updateCapexInternal()">
                                        </div>
                                        <div class="form-group">
                                            <label>Connection</label>
                                            <input type="text" name="internal_connection" value="Â£0.00" onchange="updateCapexInternal()">
                                        </div>
                                        <div class="form-group">
                                            <label>Land</label>
                                            <input type="text" name="internal_land" value="Â£0.00" onchange="updateCapexInternal()">
                                        </div>
                                        <div class="form-group">
                                            <label>Operations Team</label>
                                            <input type="text" name="internal_operations" value="Â£0.00" onchange="updateCapexInternal()">
                                        </div>
                                        <div class="form-group">
                                            <label>OS&E</label>
                                            <input type="text" name="internal_ose" value="Â£0.00" onchange="updateCapexInternal()">
                                        </div>
                                        <div class="form-group">
                                            <label>Marketing</label>
                                            <input type="text" name="internal_marketing" value="Â£0.00" onchange="updateCapexInternal()">
                                        </div>
                                        <div class="form-group">
                                            <label>Construction Phase Fee (max 1.5%)</label>
                                            <input type="text" name="internal_dark_fee" value="Â£0.00" readonly style="background: rgba(96, 165, 250, 0.05);">
                                            <small style="color: var(--silver-mist);">Auto-calculated as 1.5% of subtotal (capped)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CapEx Market (Debt Basis) -->
                        <div style="background: rgba(245, 158, 11, 0.05); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 8px; margin-bottom: 1.5rem; overflow: hidden;">
                            <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleCapexSection('market')">
                                <span style="font-weight: 600; color: var(--warning);">CapEx Market (Debt Basis)</span>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <span id="capexMarketTotal" style="font-weight: 700; color: var(--pearl-grey);">Â£0</span>
                                    <span id="capexMarketIcon">â–¼</span>
                                </div>
                            </div>
                            <div id="capexMarketContent" style="padding: 1rem; display: none;">
                                <!-- Toggle between Per MW and Detailed -->
                                <div style="display: flex; gap: 10px; margin-bottom: 1rem;">
                                    <button type="button" class="capex-mode-btn active" id="marketOption1" onclick="setCapexMode('market', 'perMW')" style="flex: 1; padding: 10px; background: var(--warning); color: var(--dark); border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Per MW Costing</button>
                                    <button type="button" class="capex-mode-btn" id="marketOption2" onclick="setCapexMode('market', 'detailed')" style="flex: 1; padding: 10px; background: var(--slate-grey); color: var(--silver-light); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-weight: 600;">Detailed Breakdown</button>
                                </div>

                                <!-- Per MW Costing -->
                                <div id="marketPerMW">
                                    <div class="form-group">
                                        <label>Cost per Gross MW</label>
                                        <input type="text" name="market_per_mw_cost" value="Â£10,000,000.00" onchange="updateCapexMarket()">
                                        <small style="color: var(--silver-mist);">Â£10m per Gross MW</small>
                                    </div>
                                    <div style="background: rgba(245, 158, 11, 0.1); padding: 10px; border-radius: 5px; text-align: center;">
                                        <strong id="marketPerMWCalc" style="color: var(--warning);">Â£10m Ã— 100 MW = Â£1,000,000,000</strong>
                                    </div>
                                </div>

                                <!-- Detailed Breakdown -->
                                <div id="marketDetailed" style="display: none;">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label>Architectural</label>
                                            <input type="text" name="market_architectural" value="Â£0.00" onchange="updateCapexMarket()">
                                        </div>
                                        <div class="form-group">
                                            <label>Civil and Structural</label>
                                            <input type="text" name="market_civil" value="Â£0.00" onchange="updateCapexMarket()">
                                        </div>
                                        <div class="form-group">
                                            <label>Substations</label>
                                            <input type="text" name="market_substations" value="Â£0.00" onchange="updateCapexMarket()">
                                        </div>
                                        <div class="form-group">
                                            <label>Underground Utilities</label>
                                            <input type="text" name="market_utilities" value="Â£0.00" onchange="updateCapexMarket()">
                                        </div>
                                        <div class="form-group">
                                            <label>Crusader Modules (Incl surveys and design)</label>
                                            <input type="text" name="market_crusader" value="Â£0.00" onchange="updateCapexMarket()">
                                        </div>
                                        <div class="form-group">
                                            <label>Bess (Incl surveys and design)</label>
                                            <input type="text" name="market_bess" value="Â£0.00" onchange="updateCapexMarket()">
                                        </div>
                                        <div class="form-group">
                                            <label>Main Contractor Installation</label>
                                            <input type="text" name="market_main_contractor" value="Â£0.00" onchange="updateCapexMarket()">
                                        </div>
                                        <div class="form-group">
                                            <label>Photo Voltaic System</label>
                                            <input type="text" name="market_photo_voltaic" value="Â£0.00" onchange="updateCapexMarket()">
                                        </div>
                                        <div class="form-group">
                                            <label>Landscaping</label>
                                            <input type="text" name="market_landscaping" value="Â£0.00" onchange="updateCapexMarket()">
                                        </div>
                                        <div class="form-group">
                                            <label>Preliminaries - General</label>
                                            <input type="text" name="market_preliminaries" value="Â£0.00" onchange="updateCapexMarket()">
                                        </div>
                                        <div class="form-group">
                                            <label>Main Contractor Margin</label>
                                            <input type="text" name="market_margin" value="Â£0.00" onchange="updateCapexMarket()">
                                        </div>
                                        <div class="form-group">
                                            <label>Connection</label>
                                            <input type="text" name="market_connection" value="Â£0.00" onchange="updateCapexMarket()">
                                        </div>
                                        <div class="form-group">
                                            <label>Land</label>
                                            <input type="text" name="market_land" value="Â£0.00" onchange="updateCapexMarket()">
                                        </div>
                                        <div class="form-group">
                                            <label>Operations Team</label>
                                            <input type="text" name="market_operations" value="Â£0.00" onchange="updateCapexMarket()">
                                        </div>
                                        <div class="form-group">
                                            <label>OS&E</label>
                                            <input type="text" name="market_ose" value="Â£0.00" onchange="updateCapexMarket()">
                                        </div>
                                        <div class="form-group">
                                            <label>Marketing</label>
                                            <input type="text" name="market_marketing" value="Â£0.00" onchange="updateCapexMarket()">
                                        </div>
                                        <div class="form-group">
                                            <label>Construction Phase Fee (max 1.5%)</label>
                                            <input type="text" name="market_dark_fee" value="Â£0.00" readonly style="background: rgba(245, 158, 11, 0.05);">
                                            <small style="color: var(--silver-mist);">Auto-calculated as 1.5% of subtotal (capped)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Contingency -->
                        <div class="form-group">
                            <label>Contingency Percent</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" name="contingency_percent" min="0" max="30" value="0" step="0.5" style="flex: 1;" oninput="document.getElementById('contingencyValue').textContent = this.value + '%'; updateCapexTotals();">
                                <span id="contingencyValue" style="min-width: 50px; font-weight: bold; color: var(--platinum-gold);">0%</span>
                            </div>
                            <small style="color: var(--silver-mist);">Applied to each CapEx individually</small>
                        </div>
                    </div>

                    <!-- CONSTRUCTION TIMELINE SECTION -->
                    <div class="form-section">
                        <h3 class="section-title">Construction Timeline</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Pre-Close Preparation (Months) *</label>
                                <input type="number" name="pre_close_months" value="1" step="1" min="1" max="18" required onchange="updateConstructionTimeline()">
                                <small style="color: var(--silver-mist);">Deal structuring, documentation, syndication to Day 1 Close</small>
                            </div>
                            <div class="form-group">
                                <label>Construction Start Date (Day 1 Close) *</label>
                                <input type="date" name="construction_start" required onchange="updateConstructionTimeline()">
                            </div>
                            <div class="form-group">
                                <label>Construction Duration (Months) *</label>
                                <input type="number" name="construction_duration" value="24" step="1" min="1" required onchange="updateConstructionTimeline()">
                            </div>
                            <div class="form-group">
                                <label>Expected Completion Date</label>
                                <input type="date" name="completion_date" readonly style="background: rgba(96, 165, 250, 0.1); color: var(--platinum-gold); font-weight: 700;">
                            </div>
                            <div class="form-group">
                                <label>Lease Commencement Date</label>
                                <input type="date" name="lease_commence_date" onchange="updateConstructionTimeline()">
                                <small style="color: var(--silver-mist);">Lease starts at project completion</small>
                            </div>
                        </div>
                    </div>

                    <!-- LEGACY REVENUE & COSTS SECTION -->
                    <div class="form-section">
                        <h3 class="section-title">Additional Revenue & Costs</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Offtaker Name</label>
                                <input type="text" name="offtaker_name" onchange="updateProgress()">
                            </div>
                            <div class="form-group">
                                <label>Lease Term (Years)</label>
                                <input type="number" name="lease_term_years" onchange="updateProgress()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timeline & Phases Tab -->
                <div id="timeline-tab" class="tab-content">
                    <div class="timeline-container">
                        <h3 class="section-title">Project Development Timeline</h3>
                        
                        <div class="form-section">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Construction Start Date</label>
                                    <input type="date" name="construction_start_date" onchange="updateTimeline()">
                                </div>
                                <div class="form-group">
                                    <label>Target Completion Date</label>
                                    <input type="date" name="construction_end_date" onchange="updateTimeline()">
                                </div>
                            </div>
                        </div>

                        <div class="timeline" id="timelineContainer">
                            <div class="timeline-line"></div>
                            
                            <div class="timeline-phase">
                                <div class="timeline-marker"></div>
                                <div class="phase-card">
                                    <div class="phase-header">
                                        <span class="phase-name">Pre-Development</span>
                                        <span class="phase-amount">Â£0</span>
                                    </div>
                                    <div class="phase-details">
                                        <div>
                                            <label>Duration (months)</label>
                                            <input type="number" name="pre_dev_months" value="6" min="1" max="24" onchange="updateTimeline()">
                                        </div>
                                        <div>
                                            <label>Status</label>
                                            <select name="pre_dev_status" onchange="updatePhaseStatus(this)">
                                                <option value="planned">Planned</option>
                                                <option value="in-progress">In Progress</option>
                                                <option value="completed">Completed</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label>CapEx %</label>
                                            <input type="number" value="5" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="timeline-phase">
                                <div class="timeline-marker"></div>
                                <div class="phase-card">
                                    <div class="phase-header">
                                        <span class="phase-name">Design & Planning</span>
                                        <span class="phase-amount">Â£0</span>
                                    </div>
                                    <div class="phase-details">
                                        <div>
                                            <label>Duration (months)</label>
                                            <input type="number" name="design_months" value="9" min="1" max="24" onchange="updateTimeline()">
                                        </div>
                                        <div>
                                            <label>Status</label>
                                            <select name="design_status" onchange="updatePhaseStatus(this)">
                                                <option value="planned">Planned</option>
                                                <option value="in-progress">In Progress</option>
                                                <option value="completed">Completed</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label>CapEx %</label>
                                            <input type="number" value="10" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="timeline-phase">
                                <div class="timeline-marker"></div>
                                <div class="phase-card">
                                    <div class="phase-header">
                                        <span class="phase-name">Legal & Permits</span>
                                        <span class="phase-amount">Â£0</span>
                                    </div>
                                    <div class="phase-details">
                                        <div>
                                            <label>Duration (months)</label>
                                            <input type="number" name="legal_months" value="6" min="1" max="24" onchange="updateTimeline()">
                                        </div>
                                        <div>
                                            <label>Status</label>
                                            <select name="legal_status" onchange="updatePhaseStatus(this)">
                                                <option value="planned">Planned</option>
                                                <option value="in-progress">In Progress</option>
                                                <option value="completed">Completed</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label>CapEx %</label>
                                            <input type="number" value="5" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="timeline-phase">
                                <div class="timeline-marker"></div>
                                <div class="phase-card">
                                    <div class="phase-header">
                                        <span class="phase-name">Construction Phase 1</span>
                                        <span class="phase-amount">Â£0</span>
                                    </div>
                                    <div class="phase-details">
                                        <div>
                                            <label>Duration (months)</label>
                                            <input type="number" name="construction1_months" value="12" min="1" max="36" onchange="updateTimeline()">
                                        </div>
                                        <div>
                                            <label>Status</label>
                                            <select name="construction1_status" onchange="updatePhaseStatus(this)">
                                                <option value="planned">Planned</option>
                                                <option value="in-progress">In Progress</option>
                                                <option value="completed">Completed</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label>CapEx %</label>
                                            <input type="number" value="40" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="timeline-phase">
                                <div class="timeline-marker"></div>
                                <div class="phase-card">
                                    <div class="phase-header">
                                        <span class="phase-name">Testing & Commissioning</span>
                                        <span class="phase-amount">Â£0</span>
                                    </div>
                                    <div class="phase-details">
                                        <div>
                                            <label>Duration (months)</label>
                                            <input type="number" name="testing_months" value="3" min="1" max="12" onchange="updateTimeline()">
                                        </div>
                                        <div>
                                            <label>Status</label>
                                            <select name="testing_status" onchange="updatePhaseStatus(this)">
                                                <option value="planned">Planned</option>
                                                <option value="in-progress">In Progress</option>
                                                <option value="completed">Completed</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label>CapEx %</label>
                                            <input type="number" value="5" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="status-updates">
                            <h4>Recent Updates</h4>
                            <div id="statusUpdates">
                                <!-- Updates will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cash Flow Analysis Tab -->
                <div id="cashflow-tab" class="tab-content">
                    <div class="chart-container">
                        <h3 class="section-title">Monthly Cash Flow Projection</h3>
                        <canvas id="cashFlowChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3 class="section-title">Cumulative CapEx Drawdown</h3>
                        <canvas id="cumulativeChart"></canvas>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">Cash Flow Summary</h3>
                        <div id="cashFlowSummary">
                            <!-- Summary will be generated here -->
                        </div>
                    </div>
                </div>

                <!-- Documents Tab -->
                <div id="documents-tab" class="tab-content">
                    <div class="form-section">
                        <h3 class="section-title">Project Documents</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <a href="/download-template/initial" class="btn btn-primary">
                                ðŸ“ Download Initial Submission
                            </a>
                            <a href="/download-template/final" class="btn btn-primary">
                                ðŸ“„ Download Final Submission
                            </a>
                            <a href="/download-template/pipeline" class="btn btn-primary">
                                ðŸ“Š Download Pipeline Template
                            </a>
                            <a href="/download-template/individual" class="btn btn-primary">
                                ðŸ“‹ Download Project Template
                            </a>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">Upload Documents</h3>
                        <input type="file" id="documentUpload" multiple accept=".pdf,.doc,.docx,.xls,.xlsx">
                        <div id="uploadedDocuments" style="margin-top: 1rem;">
                            <!-- Uploaded documents will be listed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentProject = {};
        let currentIndustry = 'DC';
        let cashFlowChart = null;
        let cumulativeChart = null;
        let autoSaveTimer = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadProjects();
            initializeCharts();
            setupAutoSave();
            updatePowerCalculations();
            updateCapexInternal();
            updateCapexMarket();
        });

        // ==================== NEW CALCULATOR FUNCTIONS ====================

        // Power Calculations
        function updatePowerCalculations() {
            const grossPower = parseFloat(document.querySelector('[name="gross_facility_power"]').value) || 100;
            const pue = parseFloat(document.querySelector('[name="pue"]').value) || 1.2;

            const itLoad = grossPower / pue;
            const overheadPower = grossPower - itLoad;

            document.querySelector('[name="it_load"]').value = itLoad.toFixed(2);
            document.querySelector('[name="overhead_power"]').value = overheadPower.toFixed(2);

            // Update CapEx calculations based on new power
            updateCapexInternal();
            updateCapexMarket();
        }

        // Handle Country Change
        function handleCountryChange() {
            // Could adjust default currency based on country
            updateProgress();
        }

        // Handle Currency Change
        function handleCurrencyChange() {
            updateProgress();
        }

        // Handle Lease Type Change
        function handleLeaseTypeChange() {
            const leaseType = document.querySelector('[name="lease_type"]').value;
            const electricityGroup = document.getElementById('electricityRateGroup');
            if (electricityGroup) {
                electricityGroup.style.display = leaseType === 'Gross' ? 'block' : 'none';
            }
            updateProgress();
        }

        // Update Land Purchase based on quality selection
        function updateLandPurchase() {
            const quality = document.querySelector('[name="land_location_quality"]').value;
            const grossPower = parseFloat(document.querySelector('[name="gross_facility_power"]').value) || 100;

            let pricePerAcre = 800000;
            let acresPerMW = 1;

            switch(quality) {
                case 'rural':
                    pricePerAcre = 100000;
                    acresPerMW = 1.5;
                    break;
                case 'suburban':
                    pricePerAcre = 300000;
                    acresPerMW = 1.5;
                    break;
                case 'urban':
                    pricePerAcre = 800000;
                    acresPerMW = 1;
                    break;
                case 'custom':
                    return; // Don't auto-calculate
            }

            const totalAcres = grossPower * acresPerMW;
            const landCost = totalAcres * pricePerAcre;

            document.querySelector('[name="land_purchase"]').value = 'Â£' + landCost.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('landPurchaseDetails').textContent = `${totalAcres.toFixed(0)} acres @ Â£${pricePerAcre.toLocaleString('en-GB', {minimumFractionDigits: 2})}/acre`;
        }

        // Update Grid Connection based on quality selection
        function updateGridConnection() {
            const quality = document.querySelector('[name="grid_connection_quality"]').value;
            const grossPower = parseFloat(document.querySelector('[name="gross_facility_power"]').value) || 100;

            let costPerMW = 200000;

            switch(quality) {
                case 'good':
                    costPerMW = 200000;
                    break;
                case 'medium':
                    costPerMW = 400000;
                    break;
                case 'poor':
                    costPerMW = 600000;
                    break;
                case 'custom':
                    return; // Don't auto-calculate
            }

            const gridCost = grossPower * costPerMW;

            document.querySelector('[name="grid_connection"]').value = 'Â£' + gridCost.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('gridConnectionRate').textContent = `Â£${costPerMW.toLocaleString('en-GB', {minimumFractionDigits: 2})} per MW`;
        }

        // Update Stamp Duty Rate
        function updateStampDutyRate() {
            const structure = document.querySelector('[name="stamp_duty_structure"]').value;

            let rate = 5;
            switch(structure) {
                case 'individual':
                case 'company':
                    rate = 5;
                    break;
                case 'company_additional':
                    rate = 8;
                    break;
                case 'reit':
                    rate = 2.5;
                    break;
                case 'custom':
                    return; // Don't change
            }

            document.querySelector('[name="stamp_duty_percent"]').value = rate;
            document.getElementById('stampDutyValue').textContent = rate + '%';
        }

        // Toggle CapEx Section
        function toggleCapexSection(section) {
            const content = document.getElementById(`capex${section.charAt(0).toUpperCase() + section.slice(1)}Content`);
            const icon = document.getElementById(`capex${section.charAt(0).toUpperCase() + section.slice(1)}Icon`);

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = 'â–²';
            } else {
                content.style.display = 'none';
                icon.textContent = 'â–¼';
            }
        }

        // Set CapEx Mode (Per MW or Detailed)
        function setCapexMode(type, mode) {
            const perMWDiv = document.getElementById(`${type}PerMW`);
            const detailedDiv = document.getElementById(`${type}Detailed`);
            const option1 = document.getElementById(`${type}Option1`);
            const option2 = document.getElementById(`${type}Option2`);

            if (mode === 'perMW') {
                perMWDiv.style.display = 'block';
                detailedDiv.style.display = 'none';
                option1.style.background = type === 'internal' ? 'var(--platinum-gold)' : 'var(--warning)';
                option1.style.color = 'var(--dark)';
                option2.style.background = 'var(--slate-grey)';
                option2.style.color = 'var(--silver-light)';
            } else {
                perMWDiv.style.display = 'none';
                detailedDiv.style.display = 'block';
                option2.style.background = type === 'internal' ? 'var(--platinum-gold)' : 'var(--warning)';
                option2.style.color = 'var(--dark)';
                option1.style.background = 'var(--slate-grey)';
                option1.style.color = 'var(--silver-light)';
            }
        }

        // Parse currency string to number
        function parseCurrency(str) {
            if (!str) return 0;
            return parseFloat(str.replace(/[Â£â‚¬$,]/g, '')) || 0;
        }

        // Format number as currency
        function formatCurrency(num, currency = 'GBP') {
            const symbols = { GBP: 'Â£', EUR: 'â‚¬', USD: '$' };
            const symbol = symbols[currency] || 'Â£';
            return symbol + num.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        // Update CapEx Internal
        function updateCapexInternal() {
            const grossPower = parseFloat(document.querySelector('[name="gross_facility_power"]').value) || 100;
            const perMWCost = parseCurrency(document.querySelector('[name="internal_per_mw_cost"]').value);
            const total = grossPower * perMWCost;

            document.getElementById('capexInternalTotal').textContent = formatCurrency(total);
            document.getElementById('internalPerMWCalc').textContent = `${formatCurrency(perMWCost/1000000)}m Ã— ${grossPower} MW = ${formatCurrency(total)}`;

            updateCapexTotals();
        }

        // Update CapEx Market
        function updateCapexMarket() {
            const grossPower = parseFloat(document.querySelector('[name="gross_facility_power"]').value) || 100;
            const perMWCost = parseCurrency(document.querySelector('[name="market_per_mw_cost"]').value);
            const total = grossPower * perMWCost;

            document.getElementById('capexMarketTotal').textContent = formatCurrency(total);
            document.getElementById('marketPerMWCalc').textContent = `${formatCurrency(perMWCost/1000000)}m Ã— ${grossPower} MW = ${formatCurrency(total)}`;

            updateCapexTotals();
        }

        // Update CapEx Totals with Contingency
        function updateCapexTotals() {
            const contingency = parseFloat(document.querySelector('[name="contingency_percent"]').value) || 0;
            // Apply contingency if needed
            updateProgress();
        }

        // Update Construction Timeline
        function updateConstructionTimeline() {
            const startDate = document.querySelector('[name="construction_start"]').value;
            const duration = parseInt(document.querySelector('[name="construction_duration"]').value) || 24;

            if (startDate) {
                const start = new Date(startDate);
                const completion = new Date(start);
                completion.setMonth(completion.getMonth() + duration);

                document.querySelector('[name="completion_date"]').value = completion.toISOString().split('T')[0];

                // Set lease commencement to completion date if not already set
                if (!document.querySelector('[name="lease_commence_date"]').value) {
                    document.querySelector('[name="lease_commence_date"]').value = completion.toISOString().split('T')[0];
                }
            }

            updateProgress();
        }

        // ==================== END NEW CALCULATOR FUNCTIONS ====================

        // Industry Selection
        function selectIndustry(industry) {
            currentIndustry = industry;
            document.querySelectorAll('.industry-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            loadProjects();
        }

        // Load Projects
        async function loadProjects() {
            try {
                const response = await fetch('/api/project-specifications/list');
                const projects = await response.json();
                
                const projectList = document.getElementById('projectList');
                projectList.innerHTML = '';
                
                projects.filter(p => p.industry === currentIndustry).forEach(project => {
                    const item = document.createElement('div');
                    item.className = 'project-item';
                    item.onclick = () => loadProject(project.id);
                    item.innerHTML = `
                        <div style="font-weight: bold;">${project.project_name || 'Untitled'}</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">${project.id}</div>
                        <span class="project-status status-${project.status}">${project.status}</span>
                    `;
                    projectList.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading projects:', error);
            }
        }

        // Create New Project
        function createNewProject() {
            currentProject = {
                industry: currentIndustry,
                status: 'draft'
            };
            document.getElementById('projectForm').reset();
            document.getElementById('projectTitle').textContent = 'New Project Specification';
            updateProgress();
        }

        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'cashflow') {
                updateCashFlowCharts();
            }
        }

        // Calculate Total CapEx
        function calculateTotalCapex() {
            const fields = [
                'capex_land_purchase',
                'capex_building',
                'capex_infrastructure',
                'capex_it_equipment',
                'capex_professional_fees',
                'capex_contingency'
            ];
            
            let total = 0;
            fields.forEach(field => {
                const input = document.querySelector(`[name="${field}"]`);
                if (input) {
                    total += parseFloat(input.value) || 0;
                }
            });
            
            document.querySelector('[name="capex_total"]').value = total;
            updateTimeline();
            updateProgress();
        }

        // Update Timeline
        function updateTimeline() {
            const capexTotal = parseFloat(document.querySelector('[name="capex_total"]').value) || 0;
            const phasePercentages = [5, 10, 5, 15, 40, 20, 5];
            
            document.querySelectorAll('.phase-amount').forEach((element, index) => {
                if (index < phasePercentages.length) {
                    const amount = capexTotal * (phasePercentages[index] / 100);
                    element.textContent = 'Â£' + amount.toLocaleString('en-GB', {maximumFractionDigits: 0});
                }
            });
        }

        // Update Phase Status
        function updatePhaseStatus(select) {
            const marker = select.closest('.timeline-phase').querySelector('.timeline-marker');
            marker.className = 'timeline-marker';
            
            if (select.value === 'completed') {
                marker.classList.add('completed');
            } else if (select.value === 'in-progress') {
                marker.classList.add('in-progress');
            }
            
            // Add status update
            addStatusUpdate(`Phase "${select.closest('.phase-card').querySelector('.phase-name').textContent}" status changed to ${select.value}`);
        }

        // Add Status Update
        function addStatusUpdate(message) {
            const updates = document.getElementById('statusUpdates');
            const update = document.createElement('div');
            update.className = 'update-item';
            update.innerHTML = `
                <span>${message}</span>
                <span class="update-time">${new Date().toLocaleTimeString()}</span>
            `;
            updates.insertBefore(update, updates.firstChild);
        }

        // Update Progress
        function updateProgress() {
            const form = document.getElementById('projectForm');
            const formData = new FormData(form);
            
            const requiredFields = ['project_name', 'deal_type', 'project_location', 'capex_total', 'offtaker_rent_per_kwh', 'power_cost_per_kwh'];
            let filled = 0;
            
            requiredFields.forEach(field => {
                if (formData.get(field)) filled++;
            });
            
            const percentage = Math.round((filled / requiredFields.length) * 100);
            document.getElementById('completionPercentage').textContent = percentage + '%';
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        // Initialize Charts
        function initializeCharts() {
            const cashFlowCtx = document.getElementById('cashFlowChart');
            const cumulativeCtx = document.getElementById('cumulativeChart');
            
            if (cashFlowCtx) {
                cashFlowChart = new Chart(cashFlowCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Monthly Cash Flow (Â£)',
                            data: [],
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'Â£' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            if (cumulativeCtx) {
                cumulativeChart = new Chart(cumulativeCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Cumulative CapEx (Â£)',
                            data: [],
                            borderColor: 'rgba(16, 185, 129, 1)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'Â£' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Update Cash Flow Charts
        async function updateCashFlowCharts() {
            const formData = collectFormData();
            
            try {
                const response = await fetch('/api/project-specifications/timeline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.status === 'success' && result.timeline) {
                    const timeline = result.timeline;
                    
                    // Update monthly cash flow chart
                    if (cashFlowChart && timeline.cash_flow_schedule) {
                        const labels = timeline.cash_flow_schedule.map(cf => cf.date);
                        const data = timeline.cash_flow_schedule.map(cf => cf.amount);
                        
                        cashFlowChart.data.labels = labels;
                        cashFlowChart.data.datasets[0].data = data;
                        cashFlowChart.update();
                    }
                    
                    // Update cumulative chart
                    if (cumulativeChart && timeline.cash_flow_schedule) {
                        const labels = timeline.cash_flow_schedule.map(cf => cf.date);
                        const data = timeline.cash_flow_schedule.map(cf => cf.cumulative);
                        
                        cumulativeChart.data.labels = labels;
                        cumulativeChart.data.datasets[0].data = data;
                        cumulativeChart.update();
                    }
                    
                    // Update summary
                    updateCashFlowSummary(timeline);
                }
            } catch (error) {
                console.error('Error updating cash flow:', error);
            }
        }

        // Update Cash Flow Summary
        function updateCashFlowSummary(timeline) {
            const summary = document.getElementById('cashFlowSummary');
            
            let html = '<table style="width: 100%;">';
            html += '<thead><tr><th>Phase</th><th>Duration</th><th>Amount</th><th>% of Total</th></tr></thead>';
            html += '<tbody>';
            
            timeline.phases.forEach(phase => {
                html += `<tr>
                    <td>${phase.name}</td>
                    <td>${phase.duration_months} months</td>
                    <td>Â£${phase.capex_amount.toLocaleString('en-GB', {maximumFractionDigits: 0})}</td>
                    <td>${phase.capex_percentage}%</td>
                </tr>`;
            });
            
            html += `<tr style="font-weight: bold; background: #f0f4f8;">
                <td>TOTAL</td>
                <td>${timeline.total_duration_months} months</td>
                <td>Â£${timeline.total_capex.toLocaleString('en-GB', {maximumFractionDigits: 0})}</td>
                <td>100%</td>
            </tr>`;
            
            html += '</tbody></table>';
            summary.innerHTML = html;
        }

        // Collect Form Data
        function collectFormData() {
            const formData = {};
            document.querySelectorAll('input, select, textarea').forEach(element => {
                if (element.name) {
                    formData[element.name] = element.value;
                }
            });
            return { project_data: formData, industry: currentIndustry };
        }

        // Save Draft
        async function saveDraft() {
            const formData = collectFormData();
            formData.draft_id = currentProject.draft_id;
            
            try {
                const response = await fetch('/api/project-specifications/save-draft', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    currentProject.draft_id = result.draft_id;
                    document.getElementById('saveStatus').textContent = 'âœ“ Saved';
                    setTimeout(() => {
                        document.getElementById('saveStatus').textContent = '';
                    }, 3000);
                }
            } catch (error) {
                console.error('Error saving draft:', error);
            }
        }

        // Setup Auto Save
        function setupAutoSave() {
            document.querySelectorAll('input, select, textarea').forEach(element => {
                element.addEventListener('change', () => {
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(saveDraft, 5000);
                });
            });
        }

        // Generate Timeline
        async function generateTimeline() {
            await updateCashFlowCharts();
            switchTab('timeline');
        }

        // Submit Project
        async function submitProject() {
            const formData = collectFormData();
            
            try {
                const response = await fetch('/api/project-specifications/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData.project_data)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert('Project submitted successfully!\nProject ID: ' + result.spec_id);
                    loadProjects();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Error submitting project: ' + error.message);
            }
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/logout';
            }
        }
    </script>
</body>
</html>