<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>AtlasNexus - Securitisation Command Centre</title>
    
    <!-- Hexagon Favicon for Main Site (ICO for Chrome compatibility, SVG fallback) -->
    <link rel="shortcut icon" href="/static/favicon-hexagon.ico" type="image/x-icon">
    <link rel="icon" href="/static/favicon-hexagon.ico" type="image/x-icon">
    <link rel="icon" type="image/svg+xml" href="/static/favicon-hexagon.svg">
    <link rel="apple-touch-icon" href="/static/favicon-hexagon.svg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700;800&family=SF+Pro+Text:wght@400;500;600&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Modern Financial Institution Palette */
            --deep-charcoal: #1A1D23;
            --slate-grey: #2C3137;
            --steel-blue: #364049;
            --silver-mist: #92969C;
            --silver-light: #94a3b8;
            --pearl-grey: #E5E9F0;
            --pure-white: #FFFFFF;
            
            /* Accent Colors */
            --platinum-gold: #60a5fa;
            --amber-yellow: #93c5fd;
            --market-green: #22C55E;
            --market-red: #EF4444;
            --emerald-green: #059669;
            --crimson-red: #B91C1C;
            --royal-blue: #4169E1;
            
            /* Typography */
            --font-display: 'SF Pro Display', -apple-system, system-ui, sans-serif;
            --font-text: 'SF Pro Text', -apple-system, system-ui, sans-serif;
            --font-mono: 'JetBrains Mono', 'Courier New', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-text);
            background: var(--deep-charcoal);
            color: var(--pearl-grey);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
        }
        
        /* Global text color fixes for dark theme */
        .text-muted {
            color: #94a3b8 !important; /* Light silver for muted text */
        }
        
        .text-secondary {
            color: #92969C !important; /* Medium silver for secondary text */
        }
        
        .small {
            color: #94a3b8 !important; /* Ensure small text is visible */
        }
        
        label {
            color: #94a3b8 !important; /* Ensure labels are visible */
        }
        
        /* Override Bootstrap dark text colors */
        .text-dark {
            color: #E5E9F0 !important;
        }
        
        /* Ensure all headings are visible */
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
            color: #E5E9F0 !important;
        }
        
        /* Table text colors */
        .table-dark {
            color: #E5E9F0 !important;
        }
        
        .table-dark th,
        .table-dark td {
            color: #E5E9F0 !important;
        }
        
        /* Ensure all paragraph text is visible */
        p {
            color: #94a3b8 !important;
        }
        
        /* Fix any remaining dark text */
        div, span {
            color: inherit;
        }

        /* Premium Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0F1419 0%, #1A2332 100%);
            z-index: -2;
        }

        /* Animated Mesh Gradient */
        .gradient-mesh {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.4;
            z-index: -1;
            background: 
                radial-gradient(circle at 20% 50%, rgba(96, 165, 250, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(65, 105, 225, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(34, 197, 94, 0.1) 0%, transparent 50%);
            animation: meshMove 20s ease-in-out infinite;
        }

        @keyframes meshMove {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(-20px, -20px) rotate(1deg); }
            66% { transform: translate(20px, -10px) rotate(-1deg); }
        }

        /* Premium Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--steel-blue) 0%, var(--slate-grey) 100%);
            border-bottom: 2px solid var(--platinum-gold);
            z-index: 1000;
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
            height: 70px;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Market Ticker - Working version from Gate2 */
        .market-ticker-container {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            width: 100%;
            overflow: hidden;
            background: linear-gradient(90deg, #1a1d23 0%, #0f1419 100%);
            border-top: 1px solid rgba(96, 165, 250, 0.3);
            border-bottom: 1px solid rgba(96, 165, 250, 0.3);
            padding: 12px 0;
            cursor: grab;
            user-select: none;
            height: auto;
            min-height: 45px;
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .market-ticker-container.dragging {
            cursor: grabbing;
        }

        .market-ticker {
            display: flex;
            width: max-content;
            will-change: transform;
            transition: transform 0.5s linear;
            padding-left: 0;
            margin-left: 0;
        }

        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .ticker-content {
            display: flex;
            width: max-content;
        }
        
        .ticker-group {
            display: flex;
            gap: 2rem;
            padding-right: 2rem;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .ticker-item {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0 1rem;
            border-right: 1px solid rgba(96, 165, 250, 0.2);
            white-space: nowrap;
        }

        .ticker-symbol {
            font-weight: 700;
            color: #93c5fd;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .ticker-value {
            color: #ffffff;
            font-size: 0.85rem;
            font-family: var(--font-mono);
        }

        .ticker-section-header {
            display: inline-block;
            padding: 0 1rem;
            color: var(--platinum-gold);
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .ticker-symbol {
            font-weight: 700;
            color: #93c5fd !important;
            font-size: 0.85rem;
            font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif;
            display: inline-block;
            text-transform: uppercase;
        }
        
        .ticker-value {
            color: #ffffff !important;
            font-size: 0.85rem;
            font-family: 'JetBrains Mono', monospace;
            display: inline-block;
        }
        
        .ticker-section-header {
            display: inline-block;
            padding: 0 1rem;
            color: #60a5fa;
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .ticker-separator {
            color: rgba(96, 165, 250, 0.4);
            margin: 0 0.5rem;
        }

        /* Main Container */
        .main-container {
            margin-top: 165px; /* Account for header + ticker + nav bar */
            padding: 2rem;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Animation Classes */
        .fade-in-up {
            opacity: 0;
            transform: translateY(30px);
        }
        
        .fade-in-up.animated {
            animation: fadeInUp 0.8s ease forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .animated-atlas-nexus {
            animation: gradientShift 3s ease infinite;
            background-size: 200% 200%;
        }

        .hover-lift {
            transition: all 0.3s ease;
        }

        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* Cards - Updated: Sep 1 2025 v4 - Darker Blue */
        .card {
            background: linear-gradient(135deg, #172554, #1e3a8a) !important;
            border: 1px solid rgba(96, 165, 250, 0.2);
            backdrop-filter: blur(10px);
            color: #ffffff !important; /* Ensure white text color */
        }
        
        .card-body {
            color: #E5E9F0 !important; /* Light text for card bodies */
        }

        .stat-card {
            background: linear-gradient(135deg, #172554, #1e3a8a) !important;
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            color: #ffffff !important; /* Ensure white text color */
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--platinum-gold);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            /* Fix header for mobile */
            .header {
                flex-direction: column;
                padding: 15px;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 1000;
            }
            
            .header-left {
                margin-bottom: 10px;
                text-align: center;
            }
            
            .header-right {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .header-btn {
                width: 100%;
                padding: 10px !important;
                font-size: 0.9rem !important;
            }
            
            /* Fix ticker for mobile */
            .market-ticker-container {
                top: 100px !important;
                height: 40px;
                min-height: 40px;
                padding: 8px 0;
            }
            
            .market-ticker {
                font-size: 0.75rem;
            }
            
            .ticker-item {
                margin: 0 8px !important;
            }
            
            /* Fix toolbar for mobile */
            .toolbar {
                top: 140px !important;
                padding: 10px;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .nav-btn {
                padding: 8px 12px !important;
                font-size: 0.8rem !important;
                min-width: auto;
            }
            
            /* Fix main container for mobile */
            .main-container {
                margin-top: 200px !important;
                padding: 1rem;
            }
            
            /* Fix cards for mobile */
            .card {
                margin-bottom: 15px;
            }
            
            .card-body {
                padding: 15px !important;
            }
            
            /* Fix stats cards for mobile */
            .stats-card {
                padding: 15px !important;
            }
            
            .stats-card h3 {
                font-size: 1.5rem !important;
            }
            
            .stats-card p {
                font-size: 0.8rem !important;
            }
            
            /* Fix footer for mobile */
            footer {
                padding: 20px 10px !important;
            }
            
            footer .container {
                padding: 0 !important;
            }
            
            footer h4 {
                font-size: 1rem !important;
            }
            
            footer a {
                font-size: 0.85rem !important;
            }
            
            /* Hide some elements on mobile for cleaner view */
            .desktop-only {
                display: none !important;
            }
            
            /* Fix sections for mobile */
            #market-section, #data-section, #analytics-section, 
            #risk-section, #portfolio-section, #compliance-section {
                padding: 200px 1rem 2rem !important;
            }
            
            /* Fix dropdown for mobile */
            .dropdown-content {
                width: 100%;
                right: 0;
                left: 0;
            }
            
            /* Fix chart container for mobile */
            canvas {
                max-width: 100% !important;
                height: auto !important;
            }
            
            /* Fix table responsiveness */
            table {
                font-size: 0.8rem;
            }
            
            th, td {
                padding: 8px !important;
            }
            
            /* Fix modals for mobile */
            .modal-content {
                width: 95% !important;
                margin: 10px !important;
            }
        }
        
        @media (max-width: 480px) {
            /* Extra small devices */
            .header {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.2rem !important;
            }
            
            .market-ticker-container {
                font-size: 0.65rem;
            }
            
            .toolbar {
                padding: 8px 5px;
            }
            
            .nav-btn {
                padding: 6px 10px !important;
                font-size: 0.75rem !important;
            }
            
            .main-container {
                padding: 0.5rem;
            }
            
            .card-title {
                font-size: 1rem !important;
            }
            
            footer {
                font-size: 0.8rem;
            }
        }
        
        /* Ensure horizontal scrolling is prevented */
        body {
            overflow-x: hidden;
        }
        
        /* Mobile-specific utility classes */
        @media (max-width: 768px) {
            .mobile-center {
                text-align: center !important;
            }
            
            .mobile-full-width {
                width: 100% !important;
            }
            
            .mobile-padding {
                padding: 10px !important;
            }
            
            .hide-mobile {
                display: none !important;
            }
        }
        
        @media (min-width: 769px) {
            .show-mobile {
                display: none !important;
            }
        }

        /* Smooth Drag and Drop Styles */
        .project-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        .project-card.dragging {
            opacity: 0.4 !important;
            transform: rotate(5deg) scale(1.05) !important;
            z-index: 1000 !important;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important;
            cursor: grabbing !important;
        }

        .project-card.drag-over-top {
            transform: translateY(-10px) !important;
            border-top: 3px solid rgba(96, 165, 250, 0.8) !important;
            box-shadow: 0 -5px 15px rgba(96, 165, 250, 0.4) !important;
        }

        .project-card.drag-over-bottom {
            transform: translateY(10px) !important;
            border-bottom: 3px solid rgba(96, 165, 250, 0.8) !important;
            box-shadow: 0 5px 15px rgba(96, 165, 250, 0.4) !important;
        }

        /* Global styles when dragging is active */
        .projects-grid.dragging-active .project-card:not(.dragging) {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .projects-grid.dragging-active .project-card:not(.dragging):hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(96, 165, 250, 0.2);
        }

        /* Drag placeholder styles */
        .drag-placeholder {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            border: 2px dashed rgba(96, 165, 250, 0.6) !important;
            border-radius: 12px !important;
            background: rgba(96, 165, 250, 0.1) !important;
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 15px rgba(96, 165, 250, 0.3);
                border-color: rgba(96, 165, 250, 0.6);
            }
            50% {
                box-shadow: 0 0 25px rgba(96, 165, 250, 0.5);
                border-color: rgba(96, 165, 250, 0.8);
            }
        }

        /* Smooth scrolling for better UX during drag */
        html {
            scroll-behavior: smooth;
        }

        /* Enhanced feedback on card hover when not dragging */
        .project-card:not(.dragging):hover {
            transform: translateY(-5px) !important;
            box-shadow: 0 10px 30px rgba(96, 165, 250, 0.3) !important;
        }
    </style>
</head>
<body>
    <!-- Animated Gradient Mesh -->
    <div class="gradient-mesh"></div>

    <!-- Header from Gate2 -->
    <header class="header">
        <div class="header-content">
            <!-- Logo from Gate2 -->
            <div class="logo" style="display: flex; align-items: center; gap: 12px;">
                <div style="position: relative; width: 32px; height: 32px;">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" style="overflow: visible;">
                        <!-- Rotating hexagon -->
                        <path d="M16 3L26.5 9.5V22.5L16 29L5.5 22.5V9.5L16 3Z" stroke="#93c5fd" stroke-width="2" fill="rgba(147, 197, 253, 0.08)">
                            <animateTransform attributeName="transform" type="rotate" from="0 16 16" to="360 16 16" dur="8s" repeatCount="indefinite"/>
                        </path>
                        <!-- Inner hexagon -->
                        <path d="M16 8L22 11.5V20.5L16 24L10 20.5V11.5L16 8Z" stroke="rgba(147, 197, 253, 0.4)" stroke-width="1"/>
                        <!-- Center circle -->
                        <circle cx="16" cy="16" r="3" fill="#dbeafe"/>
                        <!-- Orbiting dot -->
                        <g>
                            <animateTransform attributeName="transform" type="rotate" from="0 16 16" to="360 16 16" dur="3s" repeatCount="indefinite"/>
                            <circle cx="16" cy="1" r="1.5" fill="#60a5fa">
                                <animate attributeName="opacity" values="0.4;1;0.4" dur="1.5s" repeatCount="indefinite"/>
                            </circle>
                        </g>
                    </svg>
                </div>
                <div style="display: flex; align-items: center;">
                    <span style="font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif; font-size: 1.35rem; font-weight: 700; background: linear-gradient(90deg, #dbeafe, #93c5fd); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ATLAS</span>
                    <span style="font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif; font-size: 1.2rem; font-weight: 400; color: #60a5fa; margin: 0 4px;">:</span>
                    <span style="font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif; font-size: 1.35rem; font-weight: 700; background: linear-gradient(90deg, #93c5fd, #dbeafe); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">NEXUS</span>
                </div>
            </div>
            <!-- User Info Section -->
            <div class="user-section" style="display: flex; align-items: center; gap: 2rem; color: rgba(255, 255, 255, 0.8);">
                <span style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                    <span style="width: 8px; height: 8px; background: #00ff00; border-radius: 50%; box-shadow: 0 0 10px #00ff00;"></span>
                    Dashboard Active
                </span>
                {% if is_admin %}
                <a href="/admin-panel" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; border: none; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; margin-right: 8px; text-decoration: none; display: inline-block;">
                    <i class="fas fa-cog"></i> Control Panel
                </a>
                {% endif %}
                <a href="/logout" style="background: linear-gradient(90deg, #ef4444, #dc2626); color: white; border: none; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; text-decoration: none;">
                    Logout
                </a>
            </div>
        </div>
    </header>

    <!-- Market Ticker -->
    <div class="market-ticker-container" id="tickerContainer">
        <div class="market-ticker" id="marketTicker">
            <!-- Content populated by JavaScript -->
        </div>
    </div>

    <!-- Navigation Bar -->
    <div id="navBar" style="position: fixed; top: 115px; left: 0; right: 0; background: linear-gradient(90deg, #1e293b 0%, #334155 100%); border-bottom: 1px solid rgba(96, 165, 250, 0.3); z-index: 998; padding: 10px 0; transition: top 0.3s ease, opacity 0.3s ease; opacity: 1;">
        <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; flex-wrap: wrap;">
            <button class="nav-btn" data-section="dashboard" onclick="showSection('dashboard')" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; border: 1px solid #60a5fa; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-home"></i> Dashboard
            </button>
            {% if account_type == 'external' %}
            <!-- External accounts have streamlined project management tools -->
            <button class="nav-btn" data-section="projects" onclick="showSection('projects')" style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-folder"></i> Projects
            </button>
            <button class="nav-btn" data-section="documents" onclick="showSection('documents')" style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-file-contract"></i> Documents
            </button>
            <button class="nav-btn" data-section="timeline" onclick="showSection('timeline')" style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-calendar-alt"></i> Timeline
            </button>
            <button class="nav-btn" data-section="reports" onclick="showSection('reports')" style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-file-pdf"></i> Reports
            </button>
            <button class="nav-btn" data-section="support" onclick="showSection('support')" style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-headset"></i> Support
            </button>
            {% else %}
            <!-- Admin and Internal accounts see all options -->
            <button class="nav-btn" data-section="projects" onclick="showSection('projects')" style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-folder"></i> Projects
            </button>
            <button class="nav-btn" data-section="market" onclick="showSection('market')" style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-chart-line"></i> Market
            </button>
            <button class="nav-btn" data-section="analytics" onclick="showSection('analytics')" style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-chart-bar"></i> Analytics
            </button>
            <button class="nav-btn" data-section="risk" onclick="showSection('risk')" style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-shield-alt"></i> Risk
            </button>
            <button class="nav-btn" data-section="portfolio" onclick="showSection('portfolio')" style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-briefcase"></i> Portfolio
            </button>
            <button class="nav-btn" data-section="compliance" onclick="showSection('compliance')" style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-gavel"></i> Compliance
            </button>
            <button class="nav-btn" data-section="permutation" onclick="showSection('permutation')" style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-cogs"></i> Engine
            </button>
            {% endif %}
        </div>
    </div>
    
    <!-- Toggle Button -->
    <button onclick="(function(){
        var nav = document.getElementById('navBar');
        var icon = document.getElementById('navToggleIcon');
        var mainDashboard = document.getElementById('main-dashboard');
        var sections = document.querySelectorAll('#market-section, #data-section, #analytics-section, #risk-section, #portfolio-section, #compliance-section, #permutation-section');
        
        if (nav.getAttribute('data-hidden') === 'true') {
            // Show toolbar - slide down smoothly
            nav.style.top = '115px';
            nav.style.opacity = '1';
            nav.setAttribute('data-hidden', 'false');
            icon.className = 'fas fa-chevron-up';
            // Adjust padding for sections when toolbar is visible
            setTimeout(function() {
                sections.forEach(function(s) { 
                    if(s) s.style.paddingTop = '185px'; 
                });
                if(mainDashboard) mainDashboard.style.marginTop = '165px';
            }, 50);
        } else {
            // Hide toolbar - slide up smoothly
            nav.style.top = '70px'; // Hide behind header
            nav.style.opacity = '0';
            nav.setAttribute('data-hidden', 'true');
            icon.className = 'fas fa-chevron-down';
            // Reduce padding for sections when toolbar is hidden - make dashboard consistent with others
            setTimeout(function() {
                sections.forEach(function(s) { 
                    if(s) s.style.paddingTop = '135px'; 
                });
                if(mainDashboard) mainDashboard.style.marginTop = '135px'; // Same as other sections now
            }, 50);
        }
    })()" style="position: fixed; top: 115px; right: 20px; background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; z-index: 999;">
        <i class="fas fa-chevron-up" id="navToggleIcon"></i> Tools
    </button>

    <!-- Main Dashboard Content -->
    <div class="main-container" id="main-dashboard" style="display: block; margin-top: 165px; transition: margin-top 0.3s ease;">
        <!-- Executive Dashboard Header -->
        <div class="row mb-4 fade-in-up">
            <div class="col-12">
                <div class="card shadow-lg" style="border-radius: 20px;">
                    <div class="card-body p-4 text-white">
                        <div class="row align-items-center">
                            <div class="col-lg-8">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="bg-white bg-opacity-10 rounded-circle p-3 me-4">
                                        <i class="fas fa-chart-line fa-2x"></i>
                                    </div>
                                    <div>
                                        <h1 class="display-6 fw-bold mb-1">Securitisation Command Centre</h1>
                                        <p class="lead mb-0 opacity-90">
                                            <span class="animated-atlas-nexus" style="font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif; font-size: 1.1rem; font-weight: 700; background: linear-gradient(90deg, #dbeafe, #93c5fd, #60a5fa, #93c5fd, #dbeafe); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-size: 200% 200%;">ATLAS</span>
                                            <span style="font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif; font-size: 1rem; font-weight: 400; color: #60a5fa; margin: 0 4px;">:</span>
                                            <span class="animated-atlas-nexus" style="font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif; font-size: 1.1rem; font-weight: 700; background: linear-gradient(90deg, #93c5fd, #dbeafe, #60a5fa, #dbeafe, #93c5fd); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-size: 200% 200%;">NEXUS</span>
                                        </p>
                                    </div>
                                </div>
                                <div class="row g-3">
                                    <div class="col-auto">
                                        <div class="badge bg-success bg-opacity-90 text-white px-3 py-2">
                                            <i class="fas fa-circle me-2"></i>Live Markets
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="badge bg-info bg-opacity-90 text-white px-3 py-2">
                                            <i class="fas fa-user-tie me-2"></i>{{ account_type }} Access
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="badge bg-dark bg-opacity-75 text-white px-3 py-2">
                                            <i class="fas fa-calendar me-2"></i><span id="currentDate"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 text-end">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="text-center">
                                            <div class="h2 fw-bold mb-0" id="aumCounter">€127.5B</div>
                                            <small class="opacity-75">Assets Under Management</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center">
                                            <div class="h2 fw-bold mb-0" id="dealsCounter">342</div>
                                            <small class="opacity-75">Active Structures</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-Time KPI Grid -->
        <div class="row g-4 mb-4">
            <div class="col-lg-3 col-md-6 fade-in-up" style="animation-delay: 0.1s">
                <div class="stat-card hover-lift">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="small fw-semibold mb-1" style="color: rgba(255, 255, 255, 0.9);">TOTAL AUM</div>
                            <div class="h3 fw-bold text-primary mb-0">€2.4B</div>
                            <div class="text-success small">
                                <i class="fas fa-arrow-up me-1"></i>+12.3% YoY
                            </div>
                        </div>
                        <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-euro-sign fa-lg text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 fade-in-up" style="animation-delay: 0.2s">
                <div class="stat-card hover-lift">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="small fw-semibold mb-1" style="color: rgba(255, 255, 255, 0.9);">ACTIVE DEALS</div>
                            <div class="h3 fw-bold text-success mb-0">127</div>
                            <div class="text-info small">
                                <i class="fas fa-plus me-1"></i>8 new this week
                            </div>
                        </div>
                        <div class="bg-success bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-handshake fa-lg text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 fade-in-up" style="animation-delay: 0.3s">
                <div class="stat-card hover-lift">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="small fw-semibold mb-1" style="color: rgba(255, 255, 255, 0.9);">AVG DSCR</div>
                            <div class="h3 fw-bold text-warning mb-0">1.47x</div>
                            <div class="text-success small">
                                <i class="fas fa-arrow-up me-1"></i>+0.08 vs target
                            </div>
                        </div>
                        <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-chart-bar fa-lg text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 fade-in-up" style="animation-delay: 0.4s">
                <div class="stat-card hover-lift">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="small fw-semibold mb-1" style="color: rgba(255, 255, 255, 0.9);">RISK RATING</div>
                            <div class="h3 fw-bold text-info mb-0">AA-</div>
                            <div class="small" style="color: rgba(255, 255, 255, 0.9);">
                                <i class="fas fa-shield-alt me-1"></i>Stable outlook
                            </div>
                        </div>
                        <div class="bg-info bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-star fa-lg text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="row g-4">
            <!-- Left Column: Market Data & Analytics -->
            <div class="col-lg-8">
                <!-- Market Overview -->
                <div class="card shadow-lg mb-4 fade-in-up" style="border-radius: 16px; animation-delay: 0.5s">
                    <div class="card-header border-0 text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px 16px 0 0;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0 fw-bold">
                                    <i class="fas fa-globe-europe me-2"></i>Live Market Overview
                                </h5>
                                <small class="opacity-90">Real-time European ABS markets</small>
                            </div>
                            <div class="badge bg-white bg-opacity-20 text-white">
                                <i class="fas fa-circle text-success me-2"></i>Live
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <div class="col-md-4">
                                <div class="text-center p-3 rounded-3" style="background: linear-gradient(135deg, #172554, #1e3a8a)">
                                    <div class="h4 fw-bold text-primary mb-1">€847M</div>
                                    <div class="small mb-2" style="color: rgba(255, 255, 255, 0.9);">Week Issuance</div>
                                    <div class="progress" style="height: 4px;">
                                        <div class="progress-bar bg-primary" style="width: 78%"></div>
                                    </div>
                                    <small class="text-success">78% of target</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-3 rounded-3" style="background: linear-gradient(135deg, #172554, #1e3a8a)">
                                    <div class="h4 fw-bold text-success mb-1">1.85%</div>
                                    <div class="small mb-2" style="color: rgba(255, 255, 255, 0.9);">AAA Spread</div>
                                    <div class="text-success small">
                                        <i class="fas fa-arrow-down me-1"></i>-12 bps
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-3 rounded-3" style="background: linear-gradient(135deg, #172554, #1e3a8a)">
                                    <div class="h4 fw-bold text-warning mb-1">€2.1B</div>
                                    <div class="small mb-2" style="color: rgba(255, 255, 255, 0.9);">Pipeline</div>
                                    <div class="text-info small">
                                        <i class="fas fa-clock me-1"></i>Next 30 days
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chart Area -->
                        <div class="mt-4 p-4 rounded-3" style="background: linear-gradient(135deg, #172554, #1e3a8a)">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold text-white mb-0">Spread Evolution (Last 30 Days)</h6>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary active">AAA</button>
                                    <button class="btn btn-outline-primary">AA</button>
                                    <button class="btn btn-outline-primary">BBB</button>
                                </div>
                            </div>
                            <div style="height: 200px; display: flex; align-items: center; justify-content: center;">
                                <canvas id="spreadChart" style="max-width: 100%; max-height: 100%;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Deal Pipeline -->
                <div class="card shadow-lg fade-in-up" style="border-radius: 16px; animation-delay: 0.6s">
                    <div class="card-header border-0 text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 16px 16px 0 0;">
                        <h5 class="mb-0 fw-bold">
                            <i class="fas fa-stream me-2"></i>Active Deal Pipeline
                        </h5>
                        <small class="opacity-90">Current structures in progress</small>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th class="border-0 fw-semibold">Deal Name</th>
                                        <th class="border-0 fw-semibold">Type</th>
                                        <th class="border-0 fw-semibold">Size</th>
                                        <th class="border-0 fw-semibold">DSCR</th>
                                        <th class="border-0 fw-semibold">Status</th>
                                        <th class="border-0 fw-semibold">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="py-3">
                                            <div class="fw-semibold">European Data Centers 2024-1</div>
                                            <small style="color: rgba(255, 255, 255, 0.9);">Lead: Digital Realty</small>
                                        </td>
                                        <td class="py-3">
                                            <span class="badge bg-primary bg-opacity-25 text-primary">Data Center</span>
                                        </td>
                                        <td class="py-3 fw-semibold">€450M</td>
                                        <td class="py-3">
                                            <span class="text-success fw-bold">1.52x</span>
                                        </td>
                                        <td class="py-3">
                                            <span class="badge bg-warning">Structuring</span>
                                        </td>
                                        <td class="py-3">
                                            <button class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="py-3">
                                            <div class="fw-semibold">UK Logistics Portfolio 2024-A</div>
                                            <small style="color: rgba(255, 255, 255, 0.9);">Lead: Prologis UK</small>
                                        </td>
                                        <td class="py-3">
                                            <span class="badge bg-success bg-opacity-25 text-success">Logistics</span>
                                        </td>
                                        <td class="py-3 fw-semibold">€320M</td>
                                        <td class="py-3">
                                            <span class="text-success fw-bold">1.48x</span>
                                        </td>
                                        <td class="py-3">
                                            <span class="badge bg-info">Rating</span>
                                        </td>
                                        <td class="py-3">
                                            <button class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="py-3">
                                            <div class="fw-semibold">German Renewable Energy 2024-3</div>
                                            <small style="color: rgba(255, 255, 255, 0.9);">Lead: RWE Renewables</small>
                                        </td>
                                        <td class="py-3">
                                            <span class="badge bg-warning bg-opacity-25 text-warning">Renewable</span>
                                        </td>
                                        <td class="py-3 fw-semibold">€680M</td>
                                        <td class="py-3">
                                            <span class="text-success fw-bold">1.65x</span>
                                        </td>
                                        <td class="py-3">
                                            <span class="badge bg-success">Marketing</span>
                                        </td>
                                        <td class="py-3">
                                            <button class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Portfolio & Risk Management -->
            <div class="col-lg-4">
                <!-- Portfolio Performance -->
                <div class="card shadow-lg mb-4 fade-in-up" style="border-radius: 16px; animation-delay: 0.7s">
                    <div class="card-header border-0 text-white" style="background: linear-gradient(135deg, #4ade80, #22c55e); border-radius: 16px 16px 0 0;">
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-briefcase me-2"></i>Portfolio Performance
                        </h6>
                        <small class="opacity-90">YTD Overview</small>
                    </div>
                    <div class="card-body p-4">
                        <div class="text-center mb-4">
                            <div class="h2 fw-bold text-success mb-1">+14.2%</div>
                            <div class="small" style="color: rgba(255, 255, 255, 0.9);">Total Return YTD</div>
                            <div class="progress mt-2" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: 85%"></div>
                            </div>
                            <small class="text-success">85% of annual target</small>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="text-center p-2 rounded" style="background: linear-gradient(135deg, #172554, #1e3a8a)">
                                    <div class="fw-bold text-white">€1.8B</div>
                                    <small style="color: rgba(255, 255, 255, 0.9);">Net Assets</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-2 rounded" style="background: linear-gradient(135deg, #172554, #1e3a8a)">
                                    <div class="fw-bold text-white">0.12%</div>
                                    <small style="color: rgba(255, 255, 255, 0.9);">Mgmt Fee</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-2 rounded" style="background: linear-gradient(135deg, #172554, #1e3a8a)">
                                    <div class="fw-bold text-white">4.2%</div>
                                    <small style="color: rgba(255, 255, 255, 0.9);">Yield</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-2 rounded" style="background: linear-gradient(135deg, #172554, #1e3a8a)">
                                    <div class="fw-bold text-white">AA-</div>
                                    <small style="color: rgba(255, 255, 255, 0.9);">Rating</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Dashboard -->
                <div class="card shadow-lg mb-4 fade-in-up" style="border-radius: 16px; animation-delay: 0.8s">
                    <div class="card-header border-0 text-white" style="background: linear-gradient(135deg, #172554, #1e3a8a); border-radius: 16px 16px 0 0;">
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-shield-alt me-2"></i>Risk Monitor
                        </h6>
                        <small class="opacity-90">Real-time exposure</small>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small fw-semibold">Concentration Risk</span>
                                <span class="badge bg-success">Low</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: 25%"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small fw-semibold">Credit Risk</span>
                                <span class="badge bg-warning">Medium</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-warning" style="width: 45%"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small fw-semibold">Market Risk</span>
                                <span class="badge bg-success">Low</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: 20%"></div>
                            </div>
                        </div>
                        
                        <div class="border-top pt-3 mt-3">
                            <div class="text-center">
                                <div class="h5 fw-bold text-warning mb-1">7.2%</div>
                                <small style="color: rgba(255, 255, 255, 0.9);">VaR (95%, 1D)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card shadow-lg fade-in-up mb-4" style="border-radius: 16px; animation-delay: 0.9s">
                    <div class="card-header border-0 text-white" style="background: linear-gradient(135deg, #06b6d4, #0891b2); border-radius: 16px 16px 0 0;">
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-bolt me-2"></i>Quick Actions
                        </h6>
                    </div>
                    <div class="card-body p-4">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="showNewAnalysisModal()">
                                <i class="fas fa-plus me-2"></i>New Analysis
                            </button>
                            <button class="btn btn-outline-secondary" onclick="showUploadModal()">
                                <i class="fas fa-upload me-2"></i>Upload Data
                            </button>
                            <button class="btn btn-outline-secondary" onclick="exportData()">
                                <i class="fas fa-download me-2"></i>Export Report
                            </button>
                            <button class="btn btn-outline-secondary" onclick="showSettingsModal()">
                                <i class="fas fa-cog me-2"></i>Settings
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Securitisation Engine Widget -->
                <div class="card shadow-lg fade-in-up" style="border-radius: 16px; animation-delay: 1.0s">
                    <div class="card-header border-0 text-white" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 16px 16px 0 0;">
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-cogs me-2"></i>Securitisation Engine
                        </h6>
                        <small class="opacity-90">Permutation Analysis</small>
                    </div>
                    <div class="card-body p-4">
                        <div class="text-center mb-3">
                            <div class="h3 fw-bold text-primary mb-1" id="dashboard-perm-count">0</div>
                            <div class="small" style="color: rgba(255, 255, 255, 0.9);">Total Permutations</div>
                        </div>
                        
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <div class="text-center p-2 bg-success bg-opacity-10 rounded">
                                    <div class="fw-bold text-success" id="dashboard-viable-count">0</div>
                                    <small style="color: #22c55e;">Viable</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-2 bg-danger bg-opacity-10 rounded">
                                    <div class="fw-bold text-danger" id="dashboard-invalid-count">0</div>
                                    <small style="color: #ef4444;">Invalid</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-top pt-3 mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small fw-semibold">Best IRR Found</span>
                                <span class="badge bg-success" id="dashboard-best-irr">-</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small fw-semibold">Avg WACD</span>
                                <span class="badge bg-info" id="dashboard-avg-wacd">-</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="small fw-semibold">Status</span>
                                <span class="badge bg-secondary" id="dashboard-engine-status">Ready</span>
                            </div>
                        </div>
                        
                        <button class="btn w-100" style="background: linear-gradient(135deg, #172554, #1e3a8a); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;" onclick="showSection('permutation')">
                            <i class="fas fa-rocket me-2"></i>Launch Engine
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Analytics Section -->
        <div class="row g-4 mt-4">
            <div class="col-12 fade-in-up" style="animation-delay: 1s">
                <div class="card shadow-lg" style="border-radius: 20px;">
                    <div class="card-header border-0 text-white py-4" style="background: linear-gradient(135deg, #172554, #1e3a8a); border-radius: 20px 20px 0 0;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h4 class="mb-1 fw-bold">
                                    <i class="fas fa-chart-area me-3"></i>Advanced Analytics Centre
                                </h4>
                                <p class="mb-0 opacity-90">Comprehensive market intelligence and portfolio optimisation</p>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-light btn-sm">
                                    <i class="fas fa-expand me-2"></i>Fullscreen
                                </button>
                                <button class="btn btn-outline-light btn-sm">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <!-- Performance Attribution -->
                            <div class="col-lg-12">
                                <div class="p-4 rounded-3" style="background: linear-gradient(135deg, #172554, #1e3a8a)">
                                    <h6 class="fw-bold mb-3 text-white">
                                        <i class="fas fa-chart-bar text-warning me-2"></i>Performance Attribution Analysis
                                    </h6>
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <div class="text-center p-3 rounded" style="background: linear-gradient(135deg, #172554, #1e3a8a)">
                                                <div class="h5 fw-bold text-primary mb-1">+2.8%</div>
                                                <small style="color: rgba(255, 255, 255, 0.9);">Credit Selection</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-3 rounded" style="background: linear-gradient(135deg, #172554, #1e3a8a)">
                                                <div class="h5 fw-bold text-success mb-1">+1.2%</div>
                                                <small style="color: rgba(255, 255, 255, 0.9);">Duration Management</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-3 rounded" style="background: linear-gradient(135deg, #172554, #1e3a8a)">
                                                <div class="h5 fw-bold text-info mb-1">+0.6%</div>
                                                <small style="color: rgba(255, 255, 255, 0.9);">Sector Allocation</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-3 rounded" style="background: linear-gradient(135deg, #172554, #1e3a8a)">
                                                <div class="h5 fw-bold text-danger mb-1">-0.4%</div>
                                                <small style="color: rgba(255, 255, 255, 0.9);">Currency Impact</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Market News Section - Dynamic Content -->
    <div id="market-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">
                    <i class="fas fa-chart-line"></i> Market Overview
                </h2>
                <p style="color: #94a3b8; margin-bottom: 2rem;">Real-time market data and analysis</p>
                
                <!-- Market Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                        <h4 style="color: #93c5fd; margin-bottom: 1rem;">EUR/USD</h4>
                        <div style="font-size: 1.5rem; color: #60a5fa; font-weight: 600;">1.0852</div>
                        <div style="color: #22c55e; font-size: 0.9rem; margin-top: 0.5rem;">+0.23%</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                        <h4 style="color: #93c5fd; margin-bottom: 1rem;">S&P 500</h4>
                        <div style="font-size: 1.5rem; color: #60a5fa; font-weight: 600;">4,783.21</div>
                        <div style="color: #22c55e; font-size: 0.9rem; margin-top: 0.5rem;">+1.15%</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                        <h4 style="color: #93c5fd; margin-bottom: 1rem;">10Y Yield</h4>
                        <div style="font-size: 1.5rem; color: #60a5fa; font-weight: 600;">4.235%</div>
                        <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">-0.05%</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                        <h4 style="color: #93c5fd; margin-bottom: 1rem;">VIX</h4>
                        <div style="font-size: 1.5rem; color: #60a5fa; font-weight: 600;">13.42</div>
                        <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">-2.31%</div>
                    </div>
                </div>
                
                <!-- Market Data Table -->
                <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                    <h3 style="color: #93c5fd; margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 600;">Market Activity</h3>
                    <div class="table-responsive">
                        <table class="table" style="margin-bottom: 0;">
                            <thead>
                                <tr>
                                    <th style="color: #93c5fd; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Asset</th>
                                    <th style="color: #93c5fd; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Price</th>
                                    <th style="color: #93c5fd; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Change</th>
                                    <th style="color: #93c5fd; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Volume</th>
                                    <th style="color: #93c5fd; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Market Cap</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid rgba(96, 165, 250, 0.1);">
                                    <td style="color: #94a3b8; padding: 12px;">EUR IG Bonds</td>
                                    <td style="color: #60a5fa; padding: 12px; font-weight: 600;">98.45</td>
                                    <td style="color: #22c55e; padding: 12px;">+0.35%</td>
                                    <td style="color: #94a3b8; padding: 12px;">€2.4B</td>
                                    <td style="color: #94a3b8; padding: 12px;">€845B</td>
                                </tr>
                                <tr style="border-bottom: 1px solid rgba(96, 165, 250, 0.1);">
                                    <td style="color: #94a3b8; padding: 12px;">US HY Bonds</td>
                                    <td style="color: #60a5fa; padding: 12px; font-weight: 600;">95.12</td>
                                    <td style="color: #ef4444; padding: 12px;">-0.18%</td>
                                    <td style="color: #94a3b8; padding: 12px;">$1.8B</td>
                                    <td style="color: #94a3b8; padding: 12px;">$1.2T</td>
                                </tr>
                                <tr>
                                    <td style="color: #94a3b8; padding: 12px;">CLO AAA</td>
                                    <td style="color: #60a5fa; padding: 12px; font-weight: 600;">99.85</td>
                                    <td style="color: #22c55e; padding: 12px;">+0.08%</td>
                                    <td style="color: #94a3b8; padding: 12px;">€450M</td>
                                    <td style="color: #94a3b8; padding: 12px;">€380B</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Section -->
    <div id="data-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">
                    <i class="fas fa-database"></i> Data Center
                </h2>
                <p style="color: #94a3b8; margin-bottom: 2rem;">Access and manage all data assets and analytics</p>
                
                <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                    <div class="table-responsive">
                        <table class="table table-hover" style="margin-bottom: 0;">
                            <thead>
                                <tr>
                                    <th style="color: #93c5fd; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Asset Class</th>
                                    <th style="color: #93c5fd; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Region</th>
                                    <th style="color: #93c5fd; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Current Yield</th>
                                    <th style="color: #93c5fd; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Change (24h)</th>
                                    <th style="color: #93c5fd; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Volume</th>
                                    <th style="color: #93c5fd; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid rgba(96, 165, 250, 0.1);">
                                    <td style="color: #94a3b8; padding: 12px;">RMBS</td>
                                    <td style="color: #64748b; padding: 12px;">Europe</td>
                                    <td style="color: #60a5fa; padding: 12px; font-weight: 600;">3.45%</td>
                                    <td style="color: #22c55e; padding: 12px;">+0.12%</td>
                                    <td style="color: #60a5fa; padding: 12px;">€2.3B</td>
                                    <td style="padding: 12px;"><span class="badge bg-success">Active</span></td>
                                </tr>
                                <tr style="border-bottom: 1px solid rgba(96, 165, 250, 0.1);">
                                    <td style="color: #94a3b8; padding: 12px;">CMBS</td>
                                    <td style="color: #64748b; padding: 12px;">North America</td>
                                    <td style="color: #60a5fa; padding: 12px; font-weight: 600;">4.15%</td>
                                    <td style="color: #ef4444; padding: 12px;">-0.08%</td>
                                    <td style="color: #60a5fa; padding: 12px;">$1.8B</td>
                                    <td style="padding: 12px;"><span class="badge bg-success">Active</span></td>
                                </tr>
                                <tr>
                                    <td style="color: #94a3b8; padding: 12px;">CLO</td>
                                    <td style="color: #64748b; padding: 12px;">Asia Pacific</td>
                                    <td style="color: #60a5fa; padding: 12px; font-weight: 600;">5.25%</td>
                                    <td style="color: #22c55e; padding: 12px;">+0.22%</td>
                                    <td style="color: #60a5fa; padding: 12px;">¥450B</td>
                                    <td style="padding: 12px;"><span class="badge bg-warning">Limited</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Section -->
    <div id="analytics-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">
                    <i class="fas fa-chart-bar"></i> Analytics & Insights
                </h2>
                <p style="color: #94a3b8; margin-bottom: 2rem;">Advanced analytics and performance insights</p>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; align-items: start;">
                    <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #93c5fd; margin-bottom: 1rem; font-size: 1.25rem; font-weight: 600;">Performance Analytics</h3>
                        <canvas id="analyticsChart" style="height: 300px;"></canvas>
                        <div style="margin-top: 1rem; text-align: center;">
                            <button style="background: transparent; color: #94a3b8; border: 1px solid #60a5fa; padding: 4px 12px; border-radius: 6px; margin: 0 4px; cursor: pointer;">1D</button>
                            <button style="background: transparent; color: #94a3b8; border: 1px solid #60a5fa; padding: 4px 12px; border-radius: 6px; margin: 0 4px; cursor: pointer;">1W</button>
                            <button style="background: #60a5fa; color: white; border: 1px solid #60a5fa; padding: 4px 12px; border-radius: 6px; margin: 0 4px; cursor: pointer;">1M</button>
                            <button style="background: transparent; color: #94a3b8; border: 1px solid #60a5fa; padding: 4px 12px; border-radius: 6px; margin: 0 4px; cursor: pointer;">3M</button>
                            <button style="background: transparent; color: #94a3b8; border: 1px solid #60a5fa; padding: 4px 12px; border-radius: 6px; margin: 0 4px; cursor: pointer;">1Y</button>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #93c5fd; margin-bottom: 1rem; font-size: 1.25rem; font-weight: 600;">Key Metrics</h3>
                        <div style="margin-bottom: 1rem;">
                            <label style="color: #64748b; font-size: 0.875rem;">Sharpe Ratio</label>
                            <div style="color: #60a5fa; font-size: 1.5rem; font-weight: 600;">1.85</div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="color: #64748b; font-size: 0.875rem;">Information Ratio</label>
                            <div style="color: #60a5fa; font-size: 1.5rem; font-weight: 600;">0.92</div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="color: #64748b; font-size: 0.875rem;">Max Drawdown</label>
                            <div style="color: #ef4444; font-size: 1.5rem; font-weight: 600;">-4.2%</div>
                        </div>
                        <div>
                            <label style="color: #64748b; font-size: 0.875rem;">Volatility</label>
                            <div style="color: #60a5fa; font-size: 1.5rem; font-weight: 600;">8.5%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Risk Management Section -->
    <div id="risk-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">
                    <i class="fas fa-shield-alt"></i> Risk Management
                </h2>
                <p style="color: #94a3b8; margin-bottom: 2rem;">Comprehensive risk monitoring and analysis</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start;">
                    <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #93c5fd; margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 600;">Risk Indicators</h3>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: rgba(255, 255, 255, 0.9);">Market Risk</span>
                                <span style="color: #60a5fa;">Medium</span>
                            </div>
                            <div style="background: rgba(96, 165, 250, 0.1); border-radius: 4px; height: 8px; overflow: hidden;">
                                <div style="background: #60a5fa; height: 100%; width: 60%;"></div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: rgba(255, 255, 255, 0.9);">Credit Risk</span>
                                <span style="color: #22c55e;">Low</span>
                            </div>
                            <div style="background: rgba(96, 165, 250, 0.1); border-radius: 4px; height: 8px; overflow: hidden;">
                                <div style="background: #22c55e; height: 100%; width: 30%;"></div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: rgba(255, 255, 255, 0.9);">Liquidity Risk</span>
                                <span style="color: #22c55e;">Low</span>
                            </div>
                            <div style="background: rgba(96, 165, 250, 0.1); border-radius: 4px; height: 8px; overflow: hidden;">
                                <div style="background: #22c55e; height: 100%; width: 25%;"></div>
                            </div>
                        </div>
                        
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: rgba(255, 255, 255, 0.9);">Operational Risk</span>
                                <span style="color: #06b6d4;">Very Low</span>
                            </div>
                            <div style="background: rgba(96, 165, 250, 0.1); border-radius: 4px; height: 8px; overflow: hidden;">
                                <div style="background: #06b6d4; height: 100%; width: 15%;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #93c5fd; margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 600;">VaR Analysis</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; text-align: center;">
                            <div style="margin-bottom: 1rem;">
                                <label style="color: #64748b; font-size: 0.875rem;">1-Day VaR (95%)</label>
                                <div style="color: #60a5fa; font-size: 1.5rem; font-weight: 600;">€2.4M</div>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="color: #64748b; font-size: 0.875rem;">1-Day VaR (99%)</label>
                                <div style="color: #ef4444; font-size: 1.5rem; font-weight: 600;">€4.1M</div>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="color: #64748b; font-size: 0.875rem;">10-Day VaR (95%)</label>
                                <div style="color: #60a5fa; font-size: 1.5rem; font-weight: 600;">€7.6M</div>
                            </div>
                            <div>
                                <label style="color: #64748b; font-size: 0.875rem;">10-Day VaR (99%)</label>
                                <div style="color: #ef4444; font-size: 1.5rem; font-weight: 600;">€13.0M</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Portfolio Section -->
    <div id="portfolio-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">
                    <i class="fas fa-briefcase"></i> Portfolio Management
                </h2>
                <p style="color: #94a3b8; margin-bottom: 2rem;">Manage and monitor your investment positions</p>
                
                <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                    <h3 style="color: #93c5fd; margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 600;">Active Positions</h3>
                    
                    <div class="table-responsive">
                        <table class="table table-hover" style="margin-bottom: 0; background: transparent !important;">
                            <thead>
                                <tr style="background: transparent !important;">
                                    <th style="color: #93c5fd !important; background: transparent !important; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Security</th>
                                    <th style="color: #93c5fd !important; background: transparent !important; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">ISIN</th>
                                    <th style="color: #93c5fd !important; background: transparent !important; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Notional</th>
                                    <th style="color: #93c5fd !important; background: transparent !important; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Market Value</th>
                                    <th style="color: #93c5fd !important; background: transparent !important; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">P&L</th>
                                    <th style="color: #93c5fd !important; background: transparent !important; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Weight</th>
                                    <th style="color: #93c5fd !important; background: transparent !important; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: transparent !important; border-bottom: 1px solid rgba(96, 165, 250, 0.1);">
                                    <td style="color: #94a3b8 !important; background: transparent !important; padding: 12px;">ATLAS 2024-1 A</td>
                                    <td style="color: #64748b !important; background: transparent !important; padding: 12px;">XS2745892341</td>
                                    <td style="color: #60a5fa !important; background: transparent !important; padding: 12px; font-weight: 600;">€100M</td>
                                    <td style="color: #60a5fa !important; background: transparent !important; padding: 12px; font-weight: 600;">€102.5M</td>
                                    <td style="color: #22c55e !important; background: transparent !important; padding: 12px;">+€2.5M</td>
                                    <td style="color: #94a3b8 !important; background: transparent !important; padding: 12px;">4.3%</td>
                                    <td style="background: transparent !important; padding: 12px;"><button style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 4px 12px; border-radius: 6px; cursor: pointer;">Details</button></td>
                                </tr>
                                <tr style="background: transparent !important; border-bottom: 1px solid rgba(96, 165, 250, 0.1);">
                                    <td style="color: #94a3b8 !important; background: transparent !important; padding: 12px;">NEXUS 2023-3 AAA</td>
                                    <td style="color: #64748b !important; background: transparent !important; padding: 12px;">XS2698754123</td>
                                    <td style="color: #60a5fa !important; background: transparent !important; padding: 12px; font-weight: 600;">€150M</td>
                                    <td style="color: #60a5fa !important; background: transparent !important; padding: 12px; font-weight: 600;">€148.2M</td>
                                    <td style="color: #ef4444 !important; background: transparent !important; padding: 12px;">-€1.8M</td>
                                    <td style="color: #94a3b8 !important; background: transparent !important; padding: 12px;">6.2%</td>
                                    <td style="background: transparent !important; padding: 12px;"><button style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 4px 12px; border-radius: 6px; cursor: pointer;">Details</button></td>
                                </tr>
                                <tr style="background: transparent !important;">
                                    <td style="color: #94a3b8 !important; background: transparent !important; padding: 12px;">EURO CLO 2024-2</td>
                                    <td style="color: #64748b !important; background: transparent !important; padding: 12px;">XS2756891234</td>
                                    <td style="color: #60a5fa !important; background: transparent !important; padding: 12px; font-weight: 600;">€75M</td>
                                    <td style="color: #60a5fa !important; background: transparent !important; padding: 12px; font-weight: 600;">€76.1M</td>
                                    <td style="color: #22c55e !important; background: transparent !important; padding: 12px;">+€1.1M</td>
                                    <td style="color: #94a3b8 !important; background: transparent !important; padding: 12px;">3.2%</td>
                                    <td style="background: transparent !important; padding: 12px;"><button style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 4px 12px; border-radius: 6px; cursor: pointer;">Details</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <a href="/portfolio" style="display: inline-block; background: linear-gradient(135deg, #172554, #1e3a8a); color: white; text-decoration: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; transition: all 0.3s ease;">
                        <i class="fas fa-arrow-right" style="margin-right: 8px;"></i>Access Full Portfolio Manager
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Compliance Section -->
    <div id="compliance-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">
                    <i class="fas fa-gavel"></i> Compliance & Regulatory
                </h2>
                <p style="color: #94a3b8; margin-bottom: 2rem;">Monitor regulatory compliance and track deadlines</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start; margin-bottom: 2rem;">
                    <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #93c5fd; margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 600;">Regulatory Status</h3>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="color: rgba(255, 255, 255, 0.9);"><i class="fas fa-check-circle" style="color: #22c55e; margin-right: 8px;"></i>MiFID II</span>
                                <span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">Compliant</span>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="color: rgba(255, 255, 255, 0.9);"><i class="fas fa-check-circle" style="color: #22c55e; margin-right: 8px;"></i>AIFMD</span>
                                <span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">Compliant</span>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="color: rgba(255, 255, 255, 0.9);"><i class="fas fa-check-circle" style="color: #22c55e; margin-right: 8px;"></i>EMIR</span>
                                <span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">Compliant</span>
                            </div>
                        </div>
                        
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="color: rgba(255, 255, 255, 0.9);"><i class="fas fa-exclamation-triangle" style="color: #60a5fa; margin-right: 8px;"></i>SFDR</span>
                                <span style="background: #60a5fa; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">Review Needed</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #93c5fd; margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 600;">Upcoming Deadlines</h3>
                        
                        <div style="margin-bottom: 1rem; padding: 12px; border-left: 4px solid #60a5fa; background: rgba(96, 165, 250, 0.1);">
                            <div style="color: #64748b; font-size: 0.875rem;">15 Jan 2025</div>
                            <div style="color: #94a3b8; font-weight: 600;">ESMA Quarterly Report</div>
                        </div>
                        
                        <div style="margin-bottom: 1rem; padding: 12px; border-left: 4px solid #06b6d4; background: rgba(6, 182, 212, 0.1);">
                            <div style="color: #64748b; font-size: 0.875rem;">31 Jan 2025</div>
                            <div style="color: #94a3b8; font-weight: 600;">Annual Risk Assessment</div>
                        </div>
                        
                        <div style="padding: 12px; border-left: 4px solid #60a5fa; background: rgba(96, 165, 250, 0.1);">
                            <div style="color: #64748b; font-size: 0.875rem;">28 Feb 2025</div>
                            <div style="color: #94a3b8; font-weight: 600;">Investor Disclosure Update</div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <a href="/compliance" style="display: inline-block; background: linear-gradient(135deg, #172554, #1e3a8a); color: white; text-decoration: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; transition: all 0.3s ease;">
                        <i class="fas fa-arrow-right" style="margin-right: 8px;"></i>Open Full Compliance Tool
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Projects Section -->
    <div id="projects-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <!-- Collapsible Project Editor Section -->
            <div id="project-editor-section" style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="color: #60a5fa; font-size: 1.5rem; font-weight: 700; margin: 0;">
                        <i class="fas fa-edit"></i> <span id="project-editor-title">Edit Project</span>
                    </h2>
                    <button onclick="closeProjectEditor()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
                <div id="project-editor-content" style="background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 0; min-height: 800px;">
                    <!-- Project editor iframe will be inserted here -->
                </div>
            </div>

            <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <!-- Header with Create Button on the right -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin: 0;">
                        <i class="fas fa-folder"></i> Project Management
                    </h2>
                    <button onclick="createNewProject()" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.2s ease;">
                        <i class="fas fa-plus"></i> Create New Project
                    </button>
                </div>
                
                <!-- Loading indicator -->
                <div id="projects-loading" style="text-align: center; padding: 2rem; color: #94a3b8;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>Loading projects...</p>
                </div>
                
                <!-- Dynamic Projects Grid with Drag & Drop -->
                <div id="projects-grid" style="display: none; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; min-height: 200px;">
                    <!-- Projects will be loaded dynamically here -->
                </div>
                
                <!-- Empty State -->
                <div id="projects-empty" style="display: none; text-align: center; padding: 3rem; color: #64748b; border: 2px dashed rgba(96, 165, 250, 0.3); border-radius: 12px; margin-bottom: 2rem;">
                    <i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: 1rem; color: #475569;"></i>
                    <h3 style="color: #94a3b8; margin-bottom: 1rem;">No projects yet</h3>
                    <p style="margin-bottom: 1.5rem;">Create your first project to get started with the project management system.</p>
                    <button onclick="createNewProject()" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-plus"></i> Create Your First Project
                    </button>
                </div>
                
                <!-- Old drop zone indicator removed - now using inline placeholders -->
                
                <!-- Project Statistics -->
                <div id="project-stats" style="display: none; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 2rem;">
                    <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                        <p style="color: #86efac; font-size: 0.9rem; margin-bottom: 0.5rem;">Active Projects</p>
                        <p id="active-count" style="color: #22c55e; font-size: 2rem; font-weight: 700;">0</p>
                    </div>
                    <div style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                        <p style="color: #93c5fd; font-size: 0.9rem; margin-bottom: 0.5rem;">In Progress</p>
                        <p id="progress-count" style="color: #60a5fa; font-size: 2rem; font-weight: 700;">0</p>
                    </div>
                    <div style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                        <p style="color: #93c5fd; font-size: 0.9rem; margin-bottom: 0.5rem;">Total Value</p>
                        <p id="total-value" style="color: #60a5fa; font-size: 2rem; font-weight: 700;">€0</p>
                    </div>
                    <div style="background: rgba(100, 116, 139, 0.1); border: 1px solid rgba(100, 116, 139, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                        <p style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 0.5rem;">Drafts</p>
                        <p id="draft-count" style="color: #64748b; font-size: 2rem; font-weight: 700;">0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Documents Section (External Accounts) -->
    <div id="documents-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">
                    <i class="fas fa-file-contract"></i> Project Documents
                </h2>
                <p style="color: #94a3b8; margin-bottom: 2rem;">Access and manage all project-related documentation</p>
                
                <!-- Document Categories -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <!-- Legal Documents -->
                    <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #60a5fa; font-size: 1.25rem; margin-bottom: 1rem;">
                            <i class="fas fa-gavel"></i> Legal Documents
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <a href="#" class="doc-link" style="color: #60a5fa; text-decoration: none; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; transition: all 0.3s;">
                                <i class="fas fa-file-pdf"></i> Master Agreement
                            </a>
                            <a href="#" class="doc-link" style="color: #60a5fa; text-decoration: none; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; transition: all 0.3s;">
                                <i class="fas fa-file-pdf"></i> Terms & Conditions
                            </a>
                            <a href="#" class="doc-link" style="color: #60a5fa; text-decoration: none; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; transition: all 0.3s;">
                                <i class="fas fa-file-pdf"></i> NDA Agreement
                            </a>
                        </div>
                    </div>
                    
                    <!-- Technical Documents -->
                    <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #60a5fa; font-size: 1.25rem; margin-bottom: 1rem;">
                            <i class="fas fa-cogs"></i> Technical Specifications
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <a href="#" class="doc-link" style="color: #60a5fa; text-decoration: none; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; transition: all 0.3s;">
                                <i class="fas fa-file-alt"></i> Project Blueprint
                            </a>
                            <a href="#" class="doc-link" style="color: #60a5fa; text-decoration: none; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; transition: all 0.3s;">
                                <i class="fas fa-file-alt"></i> API Documentation
                            </a>
                            <a href="#" class="doc-link" style="color: #60a5fa; text-decoration: none; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; transition: all 0.3s;">
                                <i class="fas fa-file-alt"></i> Integration Guide
                            </a>
                        </div>
                    </div>
                    
                    <!-- Financial Documents -->
                    <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #60a5fa; font-size: 1.25rem; margin-bottom: 1rem;">
                            <i class="fas fa-chart-line"></i> Financial Reports
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <a href="#" class="doc-link" style="color: #60a5fa; text-decoration: none; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; transition: all 0.3s;">
                                <i class="fas fa-file-excel"></i> Cash Flow Analysis
                            </a>
                            <a href="#" class="doc-link" style="color: #60a5fa; text-decoration: none; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; transition: all 0.3s;">
                                <i class="fas fa-file-excel"></i> Budget Overview
                            </a>
                            <a href="#" class="doc-link" style="color: #60a5fa; text-decoration: none; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; transition: all 0.3s;">
                                <i class="fas fa-file-excel"></i> ROI Projections
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Upload Section -->
                <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 2px dashed rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 2rem; text-align: center;">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #60a5fa; margin-bottom: 1rem;"></i>
                    <p style="color: #94a3b8; margin-bottom: 1rem;">Drag and drop files here or click to browse</p>
                    <button class="btn btn-primary" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; padding: 0.75rem 2rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-upload"></i> Upload Document
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Timeline Section (External Accounts) -->
    <div id="timeline-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">
                    <i class="fas fa-calendar-alt"></i> Project Timeline
                </h2>
                <p style="color: #94a3b8; margin-bottom: 2rem;">Track project milestones and deadlines</p>
                
                <!-- Timeline View Toggle -->
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                    <button class="btn btn-secondary active" onclick="setTimelineView('gantt')">
                        <i class="fas fa-bars"></i> Gantt View
                    </button>
                    <button class="btn btn-secondary" onclick="setTimelineView('calendar')">
                        <i class="fas fa-calendar"></i> Calendar View
                    </button>
                    <button class="btn btn-secondary" onclick="setTimelineView('list')">
                        <i class="fas fa-list"></i> List View
                    </button>
                </div>
                
                <!-- Timeline Content -->
                <div id="timeline-content" style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem; min-height: 400px;">
                    <!-- Phase Progress -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: #60a5fa; font-size: 1.25rem; margin-bottom: 1rem;">Current Phase: Development</h3>
                        <div style="background: rgba(0, 0, 0, 0.3); border-radius: 10px; height: 30px; position: relative; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #60a5fa, #3b82f6); height: 100%; width: 65%; border-radius: 10px; position: relative;">
                                <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: white; font-weight: 600;">65%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Milestones -->
                    <div style="display: grid; gap: 1rem;">
                        <div style="background: rgba(0, 0, 0, 0.3); border-left: 4px solid #22c55e; padding: 1rem; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="color: #22c55e; margin-bottom: 0.25rem;">✓ Project Kickoff</h4>
                                    <p style="color: #94a3b8; font-size: 0.875rem;">Initial planning and requirements gathering</p>
                                </div>
                                <span style="color: #64748b; font-size: 0.875rem;">Jan 15, 2024</span>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0, 0, 0, 0.3); border-left: 4px solid #22c55e; padding: 1rem; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="color: #22c55e; margin-bottom: 0.25rem;">✓ Design Phase Complete</h4>
                                    <p style="color: #94a3b8; font-size: 0.875rem;">UI/UX designs approved</p>
                                </div>
                                <span style="color: #64748b; font-size: 0.875rem;">Feb 28, 2024</span>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0, 0, 0, 0.3); border-left: 4px solid #60a5fa; padding: 1rem; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="color: #60a5fa; margin-bottom: 0.25rem;">• Development Sprint 3</h4>
                                    <p style="color: #94a3b8; font-size: 0.875rem;">Core features implementation</p>
                                </div>
                                <span style="color: #64748b; font-size: 0.875rem;">In Progress</span>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0, 0, 0, 0.3); border-left: 4px solid #64748b; padding: 1rem; border-radius: 6px; opacity: 0.7;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="color: #94a3b8; margin-bottom: 0.25rem;">○ Testing Phase</h4>
                                    <p style="color: #64748b; font-size: 0.875rem;">QA and user acceptance testing</p>
                                </div>
                                <span style="color: #64748b; font-size: 0.875rem;">Apr 15, 2024</span>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0, 0, 0, 0.3); border-left: 4px solid #64748b; padding: 1rem; border-radius: 6px; opacity: 0.7;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="color: #94a3b8; margin-bottom: 0.25rem;">○ Go Live</h4>
                                    <p style="color: #64748b; font-size: 0.875rem;">Production deployment</p>
                                </div>
                                <span style="color: #64748b; font-size: 0.875rem;">May 1, 2024</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Section (External Accounts) -->
    <div id="reports-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">
                    <i class="fas fa-file-pdf"></i> Project Reports
                </h2>
                <p style="color: #94a3b8; margin-bottom: 2rem;">Generate and download comprehensive project reports</p>
                
                <!-- Report Types -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s;" 
                         onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='#60a5fa';" 
                         onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(96, 165, 250, 0.2)';">
                        <i class="fas fa-chart-bar" style="font-size: 2.5rem; color: #60a5fa; margin-bottom: 1rem;"></i>
                        <h3 style="color: #60a5fa; font-size: 1.125rem; margin-bottom: 0.5rem;">Progress Report</h3>
                        <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 1rem;">Weekly project progress summary</p>
                        <button class="btn btn-primary" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; padding: 0.5rem 1rem; border: none; border-radius: 6px; font-size: 0.875rem;">
                            Generate Report
                        </button>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s;" 
                         onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='#60a5fa';" 
                         onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(96, 165, 250, 0.2)';">
                        <i class="fas fa-coins" style="font-size: 2.5rem; color: #60a5fa; margin-bottom: 1rem;"></i>
                        <h3 style="color: #60a5fa; font-size: 1.125rem; margin-bottom: 0.5rem;">Financial Report</h3>
                        <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 1rem;">Budget and expense analysis</p>
                        <button class="btn btn-primary" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; padding: 0.5rem 1rem; border: none; border-radius: 6px; font-size: 0.875rem;">
                            Generate Report
                        </button>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s;" 
                         onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='#60a5fa';" 
                         onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(96, 165, 250, 0.2)';">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; color: #60a5fa; margin-bottom: 1rem;"></i>
                        <h3 style="color: #60a5fa; font-size: 1.125rem; margin-bottom: 0.5rem;">Risk Assessment</h3>
                        <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 1rem;">Identify and mitigate risks</p>
                        <button class="btn btn-primary" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; padding: 0.5rem 1rem; border: none; border-radius: 6px; font-size: 0.875rem;">
                            Generate Report
                        </button>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s;" 
                         onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='#60a5fa';" 
                         onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(96, 165, 250, 0.2)';">
                        <i class="fas fa-file-alt" style="font-size: 2.5rem; color: #60a5fa; margin-bottom: 1rem;"></i>
                        <h3 style="color: #60a5fa; font-size: 1.125rem; margin-bottom: 0.5rem;">Executive Summary</h3>
                        <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 1rem;">High-level project overview</p>
                        <button class="btn btn-primary" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; padding: 0.5rem 1rem; border: none; border-radius: 6px; font-size: 0.875rem;">
                            Generate Report
                        </button>
                    </div>
                </div>
                
                <!-- Recent Reports -->
                <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem;">
                    <h3 style="color: #60a5fa; font-size: 1.25rem; margin-bottom: 1rem;">
                        <i class="fas fa-history"></i> Recent Reports
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <i class="fas fa-file-pdf" style="color: #ef4444; font-size: 1.5rem;"></i>
                                <div>
                                    <div style="color: #e2e8f0; font-weight: 600;">Weekly Progress Report</div>
                                    <div style="color: #64748b; font-size: 0.875rem;">Generated on Mar 10, 2024</div>
                                </div>
                            </div>
                            <button class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                                <i class="fas fa-download"></i> Download
                            </button>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <i class="fas fa-file-pdf" style="color: #ef4444; font-size: 1.5rem;"></i>
                                <div>
                                    <div style="color: #e2e8f0; font-weight: 600;">Financial Report Q1</div>
                                    <div style="color: #64748b; font-size: 0.875rem;">Generated on Mar 5, 2024</div>
                                </div>
                            </div>
                            <button class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                                <i class="fas fa-download"></i> Download
                            </button>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <i class="fas fa-file-pdf" style="color: #ef4444; font-size: 1.5rem;"></i>
                                <div>
                                    <div style="color: #e2e8f0; font-weight: 600;">Risk Assessment Report</div>
                                    <div style="color: #64748b; font-size: 0.875rem;">Generated on Feb 28, 2024</div>
                                </div>
                            </div>
                            <button class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                                <i class="fas fa-download"></i> Download
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Support Section (External Accounts) -->
    <div id="support-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">
                    <i class="fas fa-headset"></i> Support Center
                </h2>
                <p style="color: #94a3b8; margin-bottom: 2rem;">Get help and support for your project</p>
                
                <!-- Quick Actions -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <button class="btn btn-primary" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; padding: 1rem; border: none; border-radius: 8px; display: flex; align-items: center; gap: 0.75rem; font-size: 1rem; cursor: pointer;">
                        <i class="fas fa-comment-dots" style="font-size: 1.25rem;"></i>
                        <span>Start Live Chat</span>
                    </button>
                    
                    <button class="btn btn-secondary" style="background: rgba(96, 165, 250, 0.1); color: #60a5fa; padding: 1rem; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; display: flex; align-items: center; gap: 0.75rem; font-size: 1rem; cursor: pointer;">
                        <i class="fas fa-phone" style="font-size: 1.25rem;"></i>
                        <span>Schedule Call</span>
                    </button>
                    
                    <button class="btn btn-secondary" style="background: rgba(96, 165, 250, 0.1); color: #60a5fa; padding: 1rem; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; display: flex; align-items: center; gap: 0.75rem; font-size: 1rem; cursor: pointer;">
                        <i class="fas fa-envelope" style="font-size: 1.25rem;"></i>
                        <span>Email Support</span>
                    </button>
                    
                    <button class="btn btn-secondary" style="background: rgba(96, 165, 250, 0.1); color: #60a5fa; padding: 1rem; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; display: flex; align-items: center; gap: 0.75rem; font-size: 1rem; cursor: pointer;">
                        <i class="fas fa-book" style="font-size: 1.25rem;"></i>
                        <span>Documentation</span>
                    </button>
                </div>
                
                <!-- Support Tickets -->
                <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="color: #60a5fa; font-size: 1.25rem;">
                            <i class="fas fa-ticket-alt"></i> Support Tickets
                        </h3>
                        <button class="btn btn-primary" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; padding: 0.5rem 1rem; border: none; border-radius: 6px; font-size: 0.875rem;">
                            <i class="fas fa-plus"></i> New Ticket
                        </button>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px; border-left: 4px solid #22c55e;">
                            <div>
                                <div style="color: #e2e8f0; font-weight: 600;">#1234 - Login Issue Resolved</div>
                                <div style="color: #64748b; font-size: 0.875rem;">Status: Closed • Updated: 2 days ago</div>
                            </div>
                            <span style="background: #22c55e; color: white; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.75rem;">RESOLVED</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px; border-left: 4px solid #60a5fa;">
                            <div>
                                <div style="color: #e2e8f0; font-weight: 600;">#1235 - API Integration Question</div>
                                <div style="color: #64748b; font-size: 0.875rem;">Status: In Progress • Updated: 5 hours ago</div>
                            </div>
                            <span style="background: #60a5fa; color: white; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.75rem;">IN PROGRESS</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px; border-left: 4px solid #60a5fa;">
                            <div>
                                <div style="color: #e2e8f0; font-weight: 600;">#1236 - Feature Request</div>
                                <div style="color: #64748b; font-size: 0.875rem;">Status: Pending • Updated: 1 day ago</div>
                            </div>
                            <span style="background: #60a5fa; color: #1e293b; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.75rem;">PENDING</span>
                        </div>
                    </div>
                </div>
                
                <!-- FAQ Section -->
                <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem;">
                    <h3 style="color: #60a5fa; font-size: 1.25rem; margin-bottom: 1rem;">
                        <i class="fas fa-question-circle"></i> Frequently Asked Questions
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <details style="background: rgba(0, 0, 0, 0.3); padding: 1rem; border-radius: 6px; cursor: pointer;">
                            <summary style="color: #e2e8f0; font-weight: 600; list-style: none; display: flex; justify-content: space-between; align-items: center;">
                                How do I access project documents?
                                <i class="fas fa-chevron-down" style="color: #60a5fa;"></i>
                            </summary>
                            <p style="color: #94a3b8; margin-top: 1rem; padding-left: 1rem;">
                                Navigate to the Documents section from the main navigation bar. All project-related documents are organized by category for easy access.
                            </p>
                        </details>
                        
                        <details style="background: rgba(0, 0, 0, 0.3); padding: 1rem; border-radius: 6px; cursor: pointer;">
                            <summary style="color: #e2e8f0; font-weight: 600; list-style: none; display: flex; justify-content: space-between; align-items: center;">
                                How often are reports generated?
                                <i class="fas fa-chevron-down" style="color: #60a5fa;"></i>
                            </summary>
                            <p style="color: #94a3b8; margin-top: 1rem; padding-left: 1rem;">
                                Reports can be generated on-demand at any time. Automated reports are generated weekly, monthly, and quarterly based on your project settings.
                            </p>
                        </details>
                        
                        <details style="background: rgba(0, 0, 0, 0.3); padding: 1rem; border-radius: 6px; cursor: pointer;">
                            <summary style="color: #e2e8f0; font-weight: 600; list-style: none; display: flex; justify-content: space-between; align-items: center;">
                                What is the typical response time for support tickets?
                                <i class="fas fa-chevron-down" style="color: #60a5fa;"></i>
                            </summary>
                            <p style="color: #94a3b8; margin-top: 1rem; padding-left: 1rem;">
                                Our support team typically responds within 2-4 hours during business hours. Critical issues are prioritized and addressed immediately.
                            </p>
                        </details>
                    </div>
                </div>
                
                <!-- Contact Information -->
                <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem; margin-top: 2rem; text-align: center;">
                    <h3 style="color: #60a5fa; font-size: 1.25rem; margin-bottom: 1rem;">Need Immediate Assistance?</h3>
                    <p style="color: #94a3b8; margin-bottom: 1rem;">Our support team is available Monday-Friday, 9 AM - 6 PM GMT</p>
                    <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
                        <div>
                            <i class="fas fa-envelope" style="color: #60a5fa; margin-right: 0.5rem;"></i>
                            <a href="mailto:Support@AtlasNexus.co.uk" style="color: #60a5fa; text-decoration: none;">Support@AtlasNexus.co.uk</a>
                        </div>
                        <div>
                            <i class="fas fa-phone" style="color: #60a5fa; margin-right: 0.5rem;"></i>
                            <span style="color: #60a5fa;">+44 20 1234 5678</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Permutation Engine Section -->
    <div id="permutation-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1800px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem; text-align: center;">
                    <i class="fas fa-cogs"></i> Advanced Permutation Engine
                </h2>
                <p style="color: #94a3b8; text-align: center; margin-bottom: 2rem;">80+ Financial Parameters • Manual/Range/Boundary Modes • Real-time Generation</p>

                <!-- Control Bar -->
                <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary active" style="background: linear-gradient(135deg, #172554, #1e3a8a); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); padding: 8px 16px; border-radius: 6px;" onclick="setPermInputMode('manual')" data-perm-mode="manual">
                            <i class="fas fa-edit"></i> Manual
                        </button>
                        <button class="btn btn-secondary" style="background: linear-gradient(135deg, #172554, #1e3a8a); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); padding: 8px 16px; border-radius: 6px;" onclick="setPermInputMode('range')" data-perm-mode="range">
                            <i class="fas fa-sliders-h"></i> Range
                        </button>
                        <button class="btn btn-secondary" style="background: linear-gradient(135deg, #172554, #1e3a8a); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); padding: 8px 16px; border-radius: 6px;" onclick="setPermInputMode('boundary')" data-perm-mode="boundary">
                            <i class="fas fa-compress-arrows-alt"></i> Boundary
                        </button>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <span style="color: #64748b;">Max Permutations:</span>
                        <input type="number" id="maxPermutations" value="1000" min="1" max="100000" style="width: 120px; padding: 0.5rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: white;">
                        <button class="btn btn-secondary" style="background: linear-gradient(135deg, #172554, #1e3a8a); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); padding: 8px 16px; border-radius: 6px;" onclick="selectAllPermParameters()">
                            <i class="fas fa-check-square"></i> All
                        </button>
                        <button class="btn btn-secondary" style="background: linear-gradient(135deg, #172554, #1e3a8a); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); padding: 8px 16px; border-radius: 6px;" onclick="deselectAllPermParameters()">
                            <i class="fas fa-square"></i> None
                        </button>
                    </div>
                </div>

                <!-- Parameters Container -->
                <div id="permParametersContainer" style="margin-bottom: 2rem;">
                    <!-- Parameters will be dynamically loaded here -->
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: center; flex-wrap: wrap;">
                    <button onclick="generateAdvancedPermutations()" style="background: linear-gradient(135deg, #172554, #1e3a8a); color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-cogs"></i> Generate Permutations
                    </button>
                    <button onclick="loadPermPreset()" style="background: linear-gradient(135deg, #172554, #1e3a8a); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); padding: 1rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-file-import"></i> Load Preset
                    </button>
                    <button onclick="savePermPreset()" style="background: linear-gradient(135deg, #172554, #1e3a8a); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); padding: 1rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-save"></i> Save Preset
                    </button>
                    <button onclick="resetPermAll()" style="background: linear-gradient(135deg, #172554, #1e3a8a); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); padding: 1rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-redo"></i> Reset All
                    </button>
                </div>

                <!-- Results Panel -->
                <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 2rem; margin-top: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(96, 165, 250, 0.2);">
                        <div style="font-size: 1.5rem; color: #60a5fa;">
                            <i class="fas fa-chart-bar"></i> Permutation Results
                        </div>
                        <div style="display: flex; gap: 2rem; color: #64748b; font-size: 0.9rem;">
                            <span>Total: <strong id="totalPermutations">0</strong></span>
                            <span>Generated: <strong id="generatedTime">--:--</strong></span>
                        </div>
                    </div>
                    
                    <!-- Statistics -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                            <div style="font-size: 1.8rem; color: #60a5fa; font-weight: bold;" id="statActive">0</div>
                            <div style="font-size: 0.85rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin-top: 0.5rem;">Active Parameters</div>
                        </div>
                        <div style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                            <div style="font-size: 1.8rem; color: #60a5fa; font-weight: bold;" id="statCombinations">0</div>
                            <div style="font-size: 0.85rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin-top: 0.5rem;">Combinations</div>
                        </div>
                        <div style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                            <div style="font-size: 1.8rem; color: #60a5fa; font-weight: bold;" id="statReduction">0%</div>
                            <div style="font-size: 0.85rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin-top: 0.5rem;">Reduction</div>
                        </div>
                        <div style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                            <div style="font-size: 1.8rem; color: #60a5fa; font-weight: bold;" id="statTime">0ms</div>
                            <div style="font-size: 0.85rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin-top: 0.5rem;">Process Time</div>
                        </div>
                    </div>

                    <!-- Results Content -->
                    <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 8px; padding: 1.5rem; min-height: 300px; overflow: auto; max-height: 600px;" id="permResultsContent">
                        <div style="text-align: center; color: #64748b; padding: 3rem;">
                            <i class="fas fa-cube" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>No permutations generated yet</p>
                            <p style="margin-top: 0.5rem; font-size: 0.9rem;">Configure parameters and click Generate</p>
                        </div>
                    </div>

                    <!-- Export Buttons -->
                    <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: center; flex-wrap: wrap;">
                        <button onclick="exportPermCSV()" style="background: linear-gradient(135deg, #172554, #1e3a8a); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            <i class="fas fa-file-csv"></i> Export CSV
                        </button>
                        <button onclick="exportPermJSON()" style="background: linear-gradient(135deg, #172554, #1e3a8a); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            <i class="fas fa-file-code"></i> Export JSON
                        </button>
                        <button onclick="showSection('permutation')" style="background: linear-gradient(135deg, #172554, #1e3a8a); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            <i class="fas fa-rocket"></i> Run in Securitization
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if is_admin %}
    <!-- Admin Panel -->
    <div id="adminPanel" style="display: none; position: fixed; top: 70px; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 1400px; margin: 0 auto; padding: 2rem;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 2rem;">
                <h2 style="color: #22c55e; font-size: 2rem; font-weight: 700;">Admin Control Center</h2>
                <button onclick="toggleAdminPanel()" style="position: absolute; right: 2rem; top: 2rem; background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>

            <!-- Pending Registrations -->
            <div style="background: rgba(54, 64, 73, 0.95); border: 2px solid #22c55e; border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
                <h3 style="color: #22c55e; margin-bottom: 1.5rem;">Pending Registrations</h3>
                {% if pending_registrations %}
                    {% for reg in pending_registrations %}
                    <div style="background: rgba(44, 49, 55, 0.8); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Name</p>
                                <p style="color: white; font-weight: 600;">{{ reg.full_name }}</p>
                            </div>
                            <div>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Email</p>
                                <p style="color: #60a5fa; font-weight: 600;">{{ reg.email }}</p>
                            </div>
                            <div>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Company</p>
                                <p style="color: white;">{{ reg.company_name }}</p>
                            </div>
                            <div>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Job Title</p>
                                <p style="color: white;">{{ reg.job_title }}</p>
                            </div>
                            <div>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Phone</p>
                                <p style="color: white;">{{ reg.country_code }} {{ reg.phone }}</p>
                            </div>
                            <div>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Submitted</p>
                                <p style="color: white;">{{ reg.created_at }}</p>
                            </div>
                            <div>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Generated Password</p>
                                <p style="color: #60a5fa; font-weight: 600; font-family: monospace;">{{ reg.generated_password }}</p>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Select Account Type:</label>
                            <select id="accountType_{{ reg.email|replace('@', '_')|replace('.', '_') }}" style="background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(96, 165, 250, 0.3); padding: 8px 12px; border-radius: 6px; width: 100%; margin-bottom: 1rem;">
                                <option value="external" selected>External - Client Access</option>
                                <option value="investor">Investor - Portfolio Access</option>
                                <option value="execution">Execution - Trading Access</option>
                                <option value="internal">Internal - Team Member</option>
                                <option value="admin">Admin - Full Control</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button onclick="approveUser({{ reg.email|tojson|safe }})" style="background: #22c55e; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button onclick="rejectUser({{ reg.email|tojson|safe }})" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: rgba(255, 255, 255, 0.9);">No pending registrations</p>
                {% endif %}
            </div>

            <!-- Active Users -->
            <div style="background: rgba(54, 64, 73, 0.95); border: 2px solid #60a5fa; border-radius: 12px; padding: 2rem;">
                <h3 style="color: #60a5fa; margin-bottom: 1.5rem;">Active Users</h3>
                {% if all_users %}
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid rgba(96, 165, 250, 0.3);">
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Name</th>
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Email</th>
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Company</th>
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Login Count</th>
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Total Time</th>
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Last Login</th>
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Password</th>
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in all_users %}
                                <tr style="border-bottom: 1px solid rgba(96, 165, 250, 0.1);">
                                    <td style="padding: 10px; color: white;">{{ user.full_name }}</td>
                                    <td style="padding: 10px; color: #60a5fa;">{{ user.email }}</td>
                                    <td style="padding: 10px; color: white;">{{ user.company_name }}</td>
                                    <td style="padding: 10px; color: #22c55e; font-weight: 600;">{{ user.login_count|default(0) }}</td>
                                    <td style="padding: 10px; color: white;">
                                        {% if user.total_login_time %}
                                            {{ (user.total_login_time / 3600)|round(1) }} hrs
                                        {% else %}
                                            0 hrs
                                        {% endif %}
                                    </td>
                                    <td style="padding: 10px; color: white;">
                                        {% if user.last_login %}
                                            {{ user.last_login|truncate(19, True, '') }}
                                        {% else %}
                                            Never
                                        {% endif %}
                                    </td>
                                    <td style="padding: 10px; color: #60a5fa; font-family: monospace; font-size: 0.85rem;">{{ user.password }}</td>
                                    <td style="padding: 10px;">
                                        <button onclick="resetPassword({{ user.email|tojson|safe }})" style="background: #60a5fa; color: black; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                                            Reset Password
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p style="color: rgba(255, 255, 255, 0.9);">No active users</p>
                {% endif %}
            </div>
            
            <!-- Comprehensive Admin Control Panel -->
            <div style="margin-top: 2rem;">
                <!-- Tab Navigation -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #364049;">
                    <button onclick="showAdminTab('overview')" class="admin-tab active" style="background: transparent; color: #60a5fa; border: none; padding: 10px 20px; cursor: pointer; border-bottom: 3px solid #60a5fa;">Overview</button>
                    <button onclick="showAdminTab('registrations')" class="admin-tab" style="background: transparent; color: #94a3b8; border: none; padding: 10px 20px; cursor: pointer;">Registrations</button>
                    <button onclick="showAdminTab('lockouts')" class="admin-tab" style="background: transparent; color: #94a3b8; border: none; padding: 10px 20px; cursor: pointer;">IP Lockouts</button>
                    <button onclick="showAdminTab('attempts')" class="admin-tab" style="background: transparent; color: #94a3b8; border: none; padding: 10px 20px; cursor: pointer;">Login Attempts</button>
                    <button onclick="showAdminTab('expired')" class="admin-tab" style="background: transparent; color: #94a3b8; border: none; padding: 10px 20px; cursor: pointer;">Expired</button>
                </div>
                
                <!-- Tab Content -->
                <div id="adminTabContent">
                    <p style="color: rgba(255, 255, 255, 0.9);">Loading admin data...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let comprehensiveData = {}; // Store all admin data
        let currentTab = 'overview';
        let currentSection = 'dashboard';
        
        // Removed duplicate function - using the main showSection function instead
        
        function showPlaceholderContent(title, description) {
            let placeholderDiv = document.getElementById('placeholder-content');
            if (!placeholderDiv) {
                // Create placeholder div if it doesn't exist
                placeholderDiv = document.createElement('div');
                placeholderDiv.id = 'placeholder-content';
                placeholderDiv.style.cssText = 'padding: 160px 2rem 2rem; min-height: 100vh;';
                document.body.appendChild(placeholderDiv);
            }
            
            // Hide main content
            const mainContent = document.getElementById('main-content');
            if (mainContent) mainContent.style.display = 'none';
            
            const complianceSection = document.getElementById('compliance-section');
            if (complianceSection) complianceSection.style.display = 'none';
            
            const permSection = document.getElementById('permutation-section');
            if (permSection) permSection.style.display = 'none';
            
            // Show placeholder
            placeholderDiv.style.display = 'block';
            placeholderDiv.innerHTML = '<div class="container">' +
                '<div class="text-center" style="margin-top: 100px;">' +
                    '<h1 style="color: #60a5fa; margin-bottom: 2rem;">' +
                        '<i class="fas fa-cogs"></i> ' + title +
                    '</h1>' +
                    '<div style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa; border-radius: 12px; padding: 3rem; max-width: 600px; margin: 0 auto;">' +
                        '<p style="color: #94a3b8; font-size: 1.1rem; margin-bottom: 2rem;">' + description + '</p>' +
                        '<div style="color: #60a5fa;">' +
                            '<i class="fas fa-clock fa-3x mb-3"></i>' +
                            '<p>Coming Soon</p>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }
        
        function toggleAdminPanel() {
            const panel = document.getElementById('adminPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            if (panel.style.display === 'block') {
                loadComprehensiveData();
            }
        }
        
        function loadComprehensiveData() {
            fetch('/admin/comprehensive-data')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        comprehensiveData = data.data;
                        showAdminTab(currentTab);
                    }
                })
                .catch(error => console.error('Error loading admin data:', error));
        }
        
        function showAdminTab(tab) {
            currentTab = tab;
            
            // Update tab styling
            document.querySelectorAll('.admin-tab').forEach(btn => {
                btn.style.color = '#94a3b8';
                btn.style.borderBottom = 'none';
                btn.classList.remove('active');
            });
            event.target.style.color = '#60a5fa';
            event.target.style.borderBottom = '3px solid #60a5fa';
            event.target.classList.add('active');
            
            const content = document.getElementById('adminTabContent');
            
            switch(tab) {
                case 'overview':
                    showOverview(content);
                    break;
                case 'registrations':
                    showRegistrations(content);
                    break;
                case 'lockouts':
                    showLockouts(content);
                    break;
                case 'attempts':
                    showAttempts(content);
                    break;
                case 'expired':
                    showExpired(content);
                    break;
            }
        }
        
        function showOverview(container) {
            const stats = comprehensiveData.statistics || {};
            container.innerHTML = '<div style="background: rgba(54, 64, 73, 0.95); border-radius: 12px; padding: 2rem;">' +
                '<h3 style="color: #60a5fa; margin-bottom: 1.5rem;">System Overview</h3>' +
                '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">' +
                    '<div style="background: rgba(96, 165, 250, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(96, 165, 250, 0.3);">' +
                        '<div style="color: #94a3b8; font-size: 0.9rem;">Locked IPs</div>' +
                        '<div style="color: #ef4444; font-size: 2rem; font-weight: bold;">' + (stats.total_locked_ips || 0) + '</div>' +
                    '</div>' +
                    '<div style="background: rgba(34, 197, 94, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">' +
                        '<div style="color: #94a3b8; font-size: 0.9rem;">Active Registrations</div>' +
                        '<div style="color: #22c55e; font-size: 2rem; font-weight: bold;">' + (stats.active_registrations || 0) + '</div>' +
                    '</div>' +
                    '<div style="background: rgba(96, 165, 250, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(96, 165, 250, 0.3);">' +
                        '<div style="color: #94a3b8; font-size: 0.9rem;">Pending Verification</div>' +
                        '<div style="color: #60a5fa; font-size: 2rem; font-weight: bold;">' + (stats.pending_verification || 0) + '</div>' +
                    '</div>' +
                    '<div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3);">' +
                        '<div style="color: #94a3b8; font-size: 0.9rem;">Expired Registrations</div>' +
                        '<div style="color: #ef4444; font-size: 2rem; font-weight: bold;">' + (stats.expired_registrations || 0) + '</div>' +
                    '</div>' +
                    '<div style="background: rgba(147, 51, 234, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(147, 51, 234, 0.3);">' +
                        '<div style="color: #94a3b8; font-size: 0.9rem;">Total Login Attempts</div>' +
                        '<div style="color: #9333ea; font-size: 2rem; font-weight: bold;">' + (stats.total_login_attempts || 0) + '</div>' +
                    '</div>' +
                    '<div style="background: rgba(34, 197, 94, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">' +
                        '<div style="color: #94a3b8; font-size: 0.9rem;">Approved Users</div>' +
                        '<div style="color: #22c55e; font-size: 2rem; font-weight: bold;">' + (stats.approved_users || 0) + '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }
        
        function showRegistrations(container) {
            const regs = comprehensiveData.active_registrations || {};
            let html = '<div style="background: rgba(54, 64, 73, 0.95); border-radius: 12px; padding: 2rem;">' +
                '<h3 style="color: #22c55e; margin-bottom: 1.5rem;">Active Registrations</h3>';
            
            if (Object.keys(regs).length === 0) {
                html += '<p style="color: rgba(255, 255, 255, 0.9);">No active registrations</p>';
            } else {
                html += '<div style="overflow-x: auto;"><table style="width: 100%; color: #e2e8f0;">';
                html += '<thead><tr style="border-bottom: 2px solid #475569;">';
                html += '<th style="padding: 10px; text-align: left;">Email</th>';
                html += '<th style="padding: 10px; text-align: left;">Name</th>';
                html += '<th style="padding: 10px; text-align: left;">Company</th>';
                html += '<th style="padding: 10px; text-align: left;">Verified</th>';
                html += '<th style="padding: 10px; text-align: left;">Approved</th>';
                html += '<th style="padding: 10px; text-align: left;">Actions</th>';
                html += '</tr></thead><tbody>';
                
                for (const [email, data] of Object.entries(regs)) {
                    html += '<tr style="border-bottom: 1px solid #364049;">';
                    html += '<td style="padding: 10px;">' + email + '</td>';
                    html += '<td style="padding: 10px;">' + (data.full_name || '-') + '</td>';
                    html += '<td style="padding: 10px;">' + (data.company_name || '-') + '</td>';
                    html += '<td style="padding: 10px;">' + (data.email_verified ? '✅' : '❌') + '</td>';
                    html += '<td style="padding: 10px;">' + (data.admin_approved ? '✅' : '❌') + '</td>';
                    html += '<td style="padding: 10px;">' +
                        '<button onclick="deleteData(\'registration\', \'' + email + '\')" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-right: 5px;">Delete</button>' +
                        (!data.admin_approved ? '<button onclick="approveUser(\'' + email + '\')" style="background: #22c55e; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Approve</button>' : '') +
                    '</td>';
                    html += '</tr>';
                }
                html += '</tbody></table></div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function showLockouts(container) {
            const lockouts = comprehensiveData.ip_lockouts || {};
            let html = '<div style="background: rgba(54, 64, 73, 0.95); border-radius: 12px; padding: 2rem;">' +
                '<h3 style="color: #ef4444; margin-bottom: 1.5rem;">IP Lockouts</h3>' +
                '<button onclick="deleteData(\'all_lockouts\', null)" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">Clear All Lockouts</button>';
            
            if (Object.keys(lockouts).length === 0) {
                html += '<p style="color: rgba(255, 255, 255, 0.9);">No IP lockouts</p>';
            } else {
                html += '<div style="overflow-x: auto;"><table style="width: 100%; color: #e2e8f0;">';
                html += '<thead><tr style="border-bottom: 2px solid #475569;">';
                html += '<th style="padding: 10px; text-align: left;">IP Address</th>';
                html += '<th style="padding: 10px; text-align: left;">Type</th>';
                html += '<th style="padding: 10px; text-align: left;">Reason</th>';
                html += '<th style="padding: 10px; text-align: left;">Locked Until</th>';
                html += '<th style="padding: 10px; text-align: left;">Actions</th>';
                html += '</tr></thead><tbody>';
                
                for (const [ip, data] of Object.entries(lockouts)) {
                    html += '<tr style="border-bottom: 1px solid #364049;">';
                    html += '<td style="padding: 10px; font-family: monospace;">' + ip + '</td>';
                    html += '<td style="padding: 10px;">' + (data.permanent ? 'Permanent' : 'Temporary') + '</td>';
                    html += '<td style="padding: 10px;">' + (data.reason || '-') + '</td>';
                    html += '<td style="padding: 10px;">' + (data.locked_until || 'Permanent') + '</td>';
                    html += '<td style="padding: 10px;">' +
                        '<button onclick="deleteData(\'ip_lockout\', \'' + ip + '\')" style="background: #22c55e; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Unblock</button>' +
                    '</td>';
                    html += '</tr>';
                }
                html += '</tbody></table></div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function showAttempts(container) {
            const attempts = comprehensiveData.login_attempts || {};
            let html = '<div style="background: rgba(54, 64, 73, 0.95); border-radius: 12px; padding: 2rem;">' +
                '<h3 style="color: #9333ea; margin-bottom: 1.5rem;">Login Attempts</h3>' +
                '<button onclick="deleteData(\'all_attempts\', null)" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">Clear All Attempts</button>';
            
            if (Object.keys(attempts).length === 0) {
                html += '<p style="color: rgba(255, 255, 255, 0.9);">No login attempts logged</p>';
            } else {
                html += '<div style="overflow-x: auto;"><table style="width: 100%; color: #e2e8f0;">';
                html += '<thead><tr style="border-bottom: 2px solid #475569;">';
                html += '<th style="padding: 10px; text-align: left;">IP Address</th>';
                html += '<th style="padding: 10px; text-align: left;">Total Attempts</th>';
                html += '<th style="padding: 10px; text-align: left;">Last Attempt</th>';
                html += '<th style="padding: 10px; text-align: left;">Actions</th>';
                html += '</tr></thead><tbody>';
                
                for (const [ip, data] of Object.entries(attempts)) {
                    html += '<tr style="border-bottom: 1px solid #364049;">';
                    html += '<td style="padding: 10px; font-family: monospace;">' + ip + '</td>';
                    html += '<td style="padding: 10px;">' + (data.total_attempts || 0) + '</td>';
                    html += '<td style="padding: 10px;">' + (data.last_attempt || '-') + '</td>';
                    html += '<td style="padding: 10px;">' +
                        '<button onclick="deleteData(\'login_attempt\', \'' + ip + '\')" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Delete</button>' +
                    '</td>';
                    html += '</tr>';
                }
                html += '</tbody></table></div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function showExpired(container) {
            const expired = comprehensiveData.expired_registrations || {};
            let html = '<div style="background: rgba(54, 64, 73, 0.95); border-radius: 12px; padding: 2rem;">' +
                '<h3 style="color: #ef4444; margin-bottom: 1.5rem;">Expired Registrations</h3>';
            
            if (Object.keys(expired).length === 0) {
                html += '<p style="color: rgba(255, 255, 255, 0.9);">No expired registrations</p>';
            } else {
                html += '<div style="overflow-x: auto;"><table style="width: 100%; color: #e2e8f0;">';
                html += '<thead><tr style="border-bottom: 2px solid #475569;">';
                html += '<th style="padding: 10px; text-align: left;">Email</th>';
                html += '<th style="padding: 10px; text-align: left;">Name</th>';
                html += '<th style="padding: 10px; text-align: left;">Expired At</th>';
                html += '<th style="padding: 10px; text-align: left;">Reason</th>';
                html += '<th style="padding: 10px; text-align: left;">Actions</th>';
                html += '</tr></thead><tbody>';
                
                for (const [email, data] of Object.entries(expired)) {
                    html += '<tr style="border-bottom: 1px solid #364049;">';
                    html += '<td style="padding: 10px;">' + email + '</td>';
                    html += '<td style="padding: 10px;">' + (data.full_name || '-') + '</td>';
                    html += '<td style="padding: 10px;">' + (data.expired_at || '-') + '</td>';
                    html += '<td style="padding: 10px;">' + (data.reason || '-') + '</td>';
                    html += '<td style="padding: 10px;">' +
                        '<button onclick="deleteData(\'expired_registration\', \'' + email + '\')" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Delete</button>' +
                    '</td>';
                    html += '</tr>';
                }
                html += '</tbody></table></div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function deleteData(type, identifier) {
            if (type.startsWith('all_') && !confirm('Are you sure you want to clear ALL ' + type.replace('all_', '') + '?')) {
                return;
            }
            if (!type.startsWith('all_') && !confirm('Are you sure you want to delete ' + identifier + '?')) {
                return;
            }
            
            fetch('/admin/delete-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: type, identifier: identifier })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Deleted successfully');
                    loadComprehensiveData();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => console.error('Error deleting data:', error));
        }
        
        function showIPDetails(ipAddress) {
            const ipInfo = currentIPData.find(ip => ip.ip === ipAddress);
            if (!ipInfo) return;
            
            let detailsHTML = '<div style="padding: 20px;">' +
                '<h3 style="color: #ef4444; margin-bottom: 20px;">Detailed Information for ' + ipAddress + '</h3>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">' +
                    '<div>' +
                        '<strong style="color: #60a5fa;">Status:</strong> ' +
                        '<span style="color: #60a5fa;">' + ipInfo.status + '</span>' +
                    '</div>' +
                    '<div>' +
                        '<strong style="color: #60a5fa;">Lock Type:</strong> ' +
                        '<span style="color: #60a5fa;">' + (ipInfo.lockout_type || 'Unknown') + '</span>' +
                    '</div>' +
                    '<div>' +
                        '<strong style="color: #60a5fa;">Reference Code:</strong> ' +
                        '<span style="color: white; font-family: monospace;">' + (ipInfo.reference_code || 'N/A') + '</span>' +
                    '</div>' +
                    '<div>' +
                        '<strong style="color: #60a5fa;">Total Attempts:</strong> ' +
                        '<span style="color: #ef4444; font-weight: bold;">' + (ipInfo.total_attempts || 0) + '</span>' +
                    '</div>' +
                    '<div>' +
                        '<strong style="color: #60a5fa;">First Seen:</strong> ' +
                        '<span style="color: rgba(255, 255, 255, 0.9);">' + (ipInfo.first_seen || 'Unknown') + '</span>' +
                    '</div>' +
                    '<div>' +
                        '<strong style="color: #60a5fa;">Locked At:</strong> ' +
                        '<span style="color: rgba(255, 255, 255, 0.9);">' + (ipInfo.locked_at || 'Unknown') + '</span>' +
                    '</div>' +
                '</div>' +
                '<div style="margin-bottom: 20px;">' +
                    '<strong style="color: #60a5fa;">User Agent:</strong>' +
                    '<div style="color: #94a3b8; font-size: 0.9rem; margin-top: 5px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px;">' +
                        (ipInfo.user_agent || 'Unknown') +
                    '</div>' +
                '</div>' +
                '<div style="margin-bottom: 20px;">' +
                    '<strong style="color: #60a5fa;">Failed Passwords:</strong>' +
                    '<div style="margin-top: 10px;">';
            
            // Handle failed passwords
            if (ipInfo.failed_passwords && ipInfo.failed_passwords.length > 0) {
                for (let i = 0; i < ipInfo.failed_passwords.length; i++) {
                    detailsHTML += '<span style="display: inline-block; background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 5px 10px; margin: 5px; border-radius: 5px; font-family: monospace;">' + 
                        ipInfo.failed_passwords[i] + '</span>';
                }
            } else {
                detailsHTML += '<span style="color: rgba(255, 255, 255, 0.9);">No passwords logged</span>';
            }
            
            detailsHTML += '</div></div>';
            
            // Handle attempt history
            if (ipInfo.attempt_history && ipInfo.attempt_history.length > 0) {
                detailsHTML += '<div style="margin-bottom: 20px;">' +
                    '<strong style="color: #60a5fa;">Recent Attempt History:</strong>' +
                    '<div style="margin-top: 10px; max-height: 200px; overflow-y: auto;">';
                
                for (let i = 0; i < ipInfo.attempt_history.length; i++) {
                    const attempt = ipInfo.attempt_history[i];
                    detailsHTML += '<div style="padding: 10px; margin: 5px 0; background: rgba(0,0,0,0.3); border-radius: 5px; border-left: 3px solid #ef4444;">' +
                        '<div style="color: #ef4444; font-family: monospace;">' + attempt.password + '</div>' +
                        '<div style="color: #94a3b8; font-size: 0.85rem; margin-top: 5px;">' +
                            new Date(attempt.timestamp).toLocaleString('en-GB') + ' | Type: ' + attempt.type +
                        '</div>' +
                    '</div>';
                }
                
                detailsHTML += '</div></div>';
            }
            
            detailsHTML += '<div style="margin-top: 20px; text-align: right;">' +
                '<button onclick="closeIPDetails()" style="background: #475569; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">' +
                    'Close' +
                '</button>' +
            '</div></div>';
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'ipDetailsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 20000; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = '<div style="background: rgba(54, 64, 73, 0.98); border: 2px solid #ef4444; border-radius: 12px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">' +
                detailsHTML +
                '</div>';
            document.body.appendChild(modal);
        }
        
        function closeIPDetails() {
            const modal = document.getElementById('ipDetailsModal');
            if (modal) modal.remove();
        }
        
        function displayIPData(ipData) {
            const container = document.getElementById('ipManagementContent');
            
            if (ipData.length === 0) {
                container.innerHTML = '<p style="color: rgba(255, 255, 255, 0.9);">No IP lockouts currently active</p>';
                return;
            }
            
            let html = '<div style="overflow-x: auto;">' +
                '<table style="width: 100%; border-collapse: collapse;">' +
                    '<thead>' +
                        '<tr style="border-bottom: 1px solid rgba(239, 68, 68, 0.3);">' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">IP Address</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">Status</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">Reason</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">Failed Passwords</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">Browser/Device</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">First Seen</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">Total Attempts</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">Time Remaining</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">Actions</th>' +
                        '</tr>' +
                    '</thead>' +
                    '<tbody>';
            
            ipData.forEach(ip => {
                const statusColor = ip.status === 'permanent' ? '#ef4444' : '#60a5fa';
                const statusText = ip.status === 'permanent' ? 'PERMANENT BAN' : 
                                   ip.lockout_type === 'blocked_30min' ? '30-MIN BLOCK' : 
                                   ip.lockout_type === 'blocked_24h' ? '24-HOUR BAN' : 'TEMPORARY BLOCK';
                
                // Parse browser info to make it shorter
                let browserInfo = 'Unknown';
                if (ip.user_agent && ip.user_agent !== 'Unknown') {
                    if (ip.user_agent.includes('Chrome')) browserInfo = 'Chrome';
                    else if (ip.user_agent.includes('Firefox')) browserInfo = 'Firefox';
                    else if (ip.user_agent.includes('Safari')) browserInfo = 'Safari';
                    else if (ip.user_agent.includes('Edge')) browserInfo = 'Edge';
                    else browserInfo = ip.user_agent.substring(0, 20) + '...';
                }
                
                // Format first seen date
                let firstSeen = 'Unknown';
                if (ip.first_seen) {
                    const date = new Date(ip.first_seen);
                    firstSeen = date.toLocaleString('en-GB', { 
                        day: '2-digit', 
                        month: 'short', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                }
                
                html += '<tr style="border-bottom: 1px solid rgba(239, 68, 68, 0.1);">' +
                    '<td style="padding: 10px; color: white; font-family: monospace; cursor: pointer;" ' +
                        'onclick="showIPDetails(\'' + ip.ip + '\')" ' +
                        'title="Click for details">' +
                        ip.ip + ' ' +
                        '<i class="fas fa-info-circle" style="color: #60a5fa; margin-left: 5px;"></i>' +
                    '</td>' +
                    '<td style="padding: 10px;">' +
                        '<span style="color: ' + statusColor + '; font-weight: 600; font-size: 0.8rem;">' + statusText + '</span>' +
                    '</td>' +
                    '<td style="padding: 10px; color: #94a3b8; font-size: 0.85rem;">' + ip.reason + '</td>' +
                    '<td style="padding: 10px; color: #ef4444; font-size: 0.8rem; max-width: 150px; overflow: hidden; text-overflow: ellipsis;" ' +
                        'title="' + (ip.failed_passwords ? ip.failed_passwords.join(', ') : 'N/A') + '">' +
                        (ip.failed_passwords ? ip.failed_passwords.join(', ') : 'N/A') +
                    '</td>' +
                    '<td style="padding: 10px; color: #60a5fa; font-size: 0.85rem;">' + browserInfo + '</td>' +
                    '<td style="padding: 10px; color: #94a3b8; font-size: 0.85rem;">' + firstSeen + '</td>' +
                    '<td style="padding: 10px; color: #60a5fa; font-weight: 600;">' + (ip.total_attempts || 0) + '</td>' +
                    '<td style="padding: 10px; color: #60a5fa; font-size: 0.85rem;">' +
                        (ip.remaining_time || (ip.status === 'permanent' ? 'PERMANENT' : 'Expired')) +
                    '</td>' +
                    '<td style="padding: 10px;">' +
                        '<button onclick="unbanIP(\'' + ip.ip + '\')" style="background: #22c55e; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 0.8rem;">' +
                            'Unban' +
                        '</button>' +
                        (ip.status !== 'permanent' ? 
                            '<button onclick="extendBan(\'' + ip.ip + '\')" style="background: #60a5fa; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 0.8rem;">' +
                                'Extend' +
                            '</button>' +
                            '<button onclick="permanentBan(\'' + ip.ip + '\')" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">' +
                                'Permanent' +
                            '</button>'
                        : '') +
                    '</td>' +
                '</tr>';
            });
            
            html += '</tbody>' +
                    '</table>' +
                '</div>';
            
            container.innerHTML = html;
        }
        
        function unbanIP(ip) {
            if (confirm('Unban IP address ' + ip + '?')) {
                fetch('/admin/manage-ip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ip, action: 'unban' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        loadIPManagement();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }
        
        function extendBan(ip) {
            const days = prompt('Extend ban for ' + ip + ' by how many days? (1-30)');
            if (days && !isNaN(days) && days >= 1 && days <= 30) {
                fetch('/admin/manage-ip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ip, action: 'extend', duration_days: days })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        loadIPManagement();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }
        
        function permanentBan(ip) {
            if (confirm('Permanently ban IP address ' + ip + '? This cannot be undone through the timeout.')) {
                fetch('/admin/manage-ip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ip, action: 'permanent' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        loadIPManagement();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }

        function approveUser(email) {
            // Get the selected account type
            const selectId = 'accountType_' + email.replace('@', '_').replace(/\./g, '_');
            const accountType = document.getElementById(selectId).value;
            
            const accountTypeNames = {
                'external': 'External Client',
                'investor': 'Investor',
                'execution': 'Execution Trader',
                'internal': 'Internal Team',
                'admin': 'Administrator'
            };
            
            if (confirm('Approve ' + email + ' as ' + accountTypeNames[accountType] + '?')) {
                fetch('/admin/approve-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: email,
                        account_type: accountType
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('User approved as ' + accountTypeNames[accountType] + '!\n\nPassword: ' + data.password + '\n\nThis has been sent to ' + email);
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }

        function rejectUser(email) {
            const reason = prompt('Rejection reason for ' + email + ':');
            if (reason) {
                fetch('/admin/reject-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email, reason: reason })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('User rejected');
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }

        function resetPassword(email) {
            if (confirm('Reset password for ' + email + '?')) {
                fetch('/admin/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Password reset! New password: ' + data.password);
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }
    </script>
    {% endif %}

    <!-- Footer -->
    <footer style="margin-top: 100px; padding: 60px 40px 30px; background: linear-gradient(135deg, rgba(20, 25, 31, 0.98) 0%, rgba(31, 41, 55, 0.95) 100%); border-top: 1px solid rgba(96, 165, 250, 0.2); position: relative;">
        <div style="position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent 0%, #60a5fa 50%, transparent 100%);"></div>
        
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="margin-bottom: 40px; text-align: center;">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <svg width="28" height="28" viewBox="0 0 32 32" fill="none" style="margin-top: 2px;">
                            <path d="M16 3L26.5 9.5V22.5L16 29L5.5 22.5V9.5L16 3Z" stroke="#93c5fd" stroke-width="2" fill="rgba(147, 197, 253, 0.08)"/>
                            <path d="M16 8L22 11.5V20.5L16 24L10 20.5V11.5L16 8Z" stroke="rgba(147, 197, 253, 0.4)" stroke-width="1"/>
                            <circle cx="16" cy="16" r="3" fill="#dbeafe"/>
                        </svg>
                        <div style="display: flex; align-items: center;">
                            <span style="font-size: 1.3rem; font-weight: 700; background: linear-gradient(90deg, #dbeafe, #93c5fd); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ATLAS</span>
                            <span style="font-size: 1.2rem; font-weight: 400; color: #60a5fa; margin: 0 4px;">:</span>
                            <span style="font-size: 1.3rem; font-weight: 700; background: linear-gradient(90deg, #93c5fd, #dbeafe); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">NEXUS</span>
                        </div>
                    </div>
                    <p style="color: #92969C; font-size: 1rem; max-width: 600px; margin: 0 auto; line-height: 1.6;">
                        Executive Command Center - Full access to global financial intelligence, securitisation analysis, and risk management solutions.
                    </p>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 40px; margin-bottom: 40px; padding-top: 40px; border-top: 1px solid rgba(184, 192, 200, 0.1);">
                <div>
                    <h4 style="color: #E5E9F0; font-size: 0.875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 20px;">Platform Tools</h4>
                    <a href="#" onclick="showSection('dashboard'); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Dashboard</a>
                    <a href="#" onclick="showSection('analytics'); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Analytics</a>
                    <a href="#" onclick="showSection('risk'); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Risk Management</a>
                    <a href="#" onclick="showSection('market'); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Market Intelligence</a>
                    <a href="#" onclick="showSection('portfolio'); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Portfolio</a>
                    <a href="#" onclick="showSection('compliance'); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Compliance</a>
                </div>
                
                <div>
                    <h4 style="color: #E5E9F0; font-size: 0.875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 20px;">Resources</h4>
                    <a href="/api-docs" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">API Documentation</a>
                    <a href="/data-feeds" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Data Feeds</a>
                    <a href="/research" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Research Portal</a>
                    <a href="/training" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Training</a>
                    <a href="#" onclick="window.open('https://status.atlasnexus.co.uk', '_blank'); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">System Status</a>
                </div>
                
                <div>
                    <h4 style="color: #E5E9F0; font-size: 0.875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 20px;">Legal & Compliance</h4>
                    <a href="/privacy" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Privacy Policy</a>
                    <a href="/terms" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Terms of Service</a>
                    <a href="/compliance" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Regulatory Compliance</a>
                    <a href="/data-protection" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Data Protection</a>
                    <a href="/security" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Security Policy</a>
                </div>
                
                <div>
                    <h4 style="color: #E5E9F0; font-size: 0.875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 20px;">Executive Support</h4>
                    <span style="display: block; color: #92969C; font-size: 0.875rem; margin-bottom: 10px;">24/7 Priority Support</span>
                    <a href="mailto:Support@AtlasNexus.co.uk" style="display: block; color: #60a5fa; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Support@AtlasNexus.co.uk</a>
                    <span style="display: block; color: #92969C; font-size: 0.875rem; margin-bottom: 5px;">Direct Line:</span>
                    <a href="tel:+442071234567" style="display: block; color: #60a5fa; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px;">+44 20 7123 4567</a>
                    <a href="#" onclick="toggleAccount(); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Account Settings</a>
                </div>
            </div>

            <div style="text-align: center; padding-top: 30px; border-top: 1px solid rgba(184, 192, 200, 0.1);">
                <p style="color: #92969C; font-size: 0.875rem; margin: 0;">
                    © 2024 AtlasNexus. All rights reserved. | {{ account_type }} Access Level | Session Active
                </p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    
    // Global variables - must be defined before any functions that use them
    let tickerInitialized = false;
    let tickerPosition = 0;
    let tickerAnimationId = null;
    let isDragging = false;
    let startX = 0;
    let scrollLeft = 0;
    
    // Market Data for Ticker (must be defined before any functions that use it)
    let marketData = {
        // Government Bonds
        'US 10Y': { value: 4.67, change24h: 0.03, change7d: -0.05, change30d: 0.15 },
        'UK 10Y': { value: 4.21, change24h: -0.02, change7d: 0.08, change30d: -0.12 },
        'DE 10Y': { value: 2.45, change24h: 0.01, change7d: -0.12, change30d: 0.08 },
        'US 5Y': { value: 4.34, change24h: 0.02, change7d: -0.03, change30d: 0.12 },
        'US 2Y': { value: 4.89, change24h: 0.01, change7d: -0.02, change30d: 0.08 },
        
        // Central Bank Rates
        'FED RATE': { value: 5.50, change24h: 0, change7d: 0, change30d: 0.25, history: [5.25, 5.25, 5.50, 5.50] },
        'BOE RATE': { value: 5.25, change24h: 0, change7d: 0, change30d: 0, history: [5.00, 5.00, 5.25, 5.25] },
        'ECB RATE': { value: 4.00, change24h: 0, change7d: 0, change30d: -0.25, history: [4.50, 4.25, 4.00, 4.00] },
        
        // Reference Rates
        'SOFR': { value: 5.32, change24h: -0.01, change7d: 0.02, change30d: 0.18 },
        'SONIA': { value: 5.18, change24h: 0, change7d: 0.01, change30d: 0.05 },
        'ESTR': { value: 3.88, change24h: 0, change7d: -0.01, change30d: -0.15 },
        
        // Credit Spreads
        'IG SPREAD': { value: 1.45, change24h: -0.02, change7d: 0.05, change30d: -0.08 },
        'HY SPREAD': { value: 4.25, change24h: 0.08, change7d: -0.15, change30d: 0.25 },
        'CMBS AAA': { value: 1.45, change24h: -0.02, change7d: 0.03, change30d: -0.05 },
        'RMBS AAA': { value: 1.25, change24h: -0.01, change7d: 0.02, change30d: -0.03 },
        'CLO AAA': { value: 1.75, change24h: -0.03, change7d: 0.06, change30d: -0.10 },
        
        // FX Rates
        'GBP/USD': { value: 1.2745, change24h: -0.0023, change7d: 0.0156, change30d: -0.0234 },
        'EUR/USD': { value: 1.0842, change24h: 0.0012, change7d: -0.0089, change30d: 0.0145 },
        'USD/JPY': { value: 149.75, change24h: 0.45, change7d: -1.23, change30d: 5.67 },
        'EUR/GBP': { value: 0.8508, change24h: 0.0034, change7d: -0.0201, change30d: 0.0089 },
        
        // Equity Indices
        'S&P 500': { value: 4567.89, change24h: 23.45, change7d: -67.23, change30d: 124.56 },
        'FTSE 100': { value: 7543.21, change24h: -15.67, change7d: 45.89, change30d: -23.45 },
        'DAX': { value: 16345.67, change24h: 34.56, change7d: -89.12, change30d: 234.56 },
        
        // Commodities
        'GOLD': { value: 2034.50, change24h: -5.75, change7d: 23.40, change30d: -12.34 },
        'OIL WTI': { value: 72.34, change24h: 0.89, change7d: -1.56, change30d: 3.45 },
        'SILVER': { value: 24.56, change24h: -0.34, change7d: 0.78, change30d: -1.23 }
    };


    // Define drag functions first (before createTicker)
    function startAutoScroll() {
        if (isDragging) return;
        
        const ticker = document.getElementById('marketTicker');
        if (!ticker) return;
        
        // Cancel any existing animation
        if (tickerAnimationId) {
            cancelAnimationFrame(tickerAnimationId);
        }
        
        // Smooth continuous animation
        function animate() {
            if (!isDragging) {
                tickerPosition -= 0.3; // Slower smooth scroll speed
                
                // Get actual width of one set of content
                const tickerWidth = ticker.scrollWidth / 3;
                
                // Reset position for endless loop
                if (Math.abs(tickerPosition) >= tickerWidth) {
                    tickerPosition = tickerPosition % tickerWidth;
                }
                
                ticker.style.transform = 'translateX(' + tickerPosition + 'px)';
                tickerAnimationId = requestAnimationFrame(animate);
            }
        }
        
        animate();
    }
    
    function startDrag(e) {
        isDragging = true;
        const container = document.getElementById('tickerContainer');
        const ticker = document.getElementById('marketTicker');
        container.classList.add('dragging');
        
        // Clear any pending resume timeout
        if (window.tickerResumeTimeout) {
            clearTimeout(window.tickerResumeTimeout);
            window.tickerResumeTimeout = null;
        }
        
        // Cancel auto-scroll
        if (tickerAnimationId) {
            cancelAnimationFrame(tickerAnimationId);
            tickerAnimationId = null;
        }
        
        // Always get current position from the actual transform
        const currentTransform = window.getComputedStyle(ticker).transform;
        if (currentTransform !== 'none') {
            const matrix = new DOMMatrix(currentTransform);
            tickerPosition = matrix.m41; // Update global position
            scrollLeft = tickerPosition;
        } else {
            scrollLeft = tickerPosition;
        }
        
        startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
        e.preventDefault();
    }
    
    function drag(e) {
        if (!isDragging) return;
        
        e.preventDefault();
        const ticker = document.getElementById('marketTicker');
        const x = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
        const walk = x - startX; // Direct 1:1 movement
        
        tickerPosition = scrollLeft + walk;
        
        // Handle endless scrolling boundaries
        const tickerWidth = ticker.scrollWidth / 3;
        if (tickerPosition > 0) {
            tickerPosition = -tickerWidth + (tickerPosition % tickerWidth);
        } else if (Math.abs(tickerPosition) >= tickerWidth * 2) {
            tickerPosition = tickerPosition % tickerWidth;
        }
        
        ticker.style.transition = 'none'; // Remove transition for immediate response
        ticker.style.transform = 'translateX(' + tickerPosition + 'px)';
    }
    
    function stopDrag() {
        if (!isDragging) return;
        
        isDragging = false;
        const container = document.getElementById('tickerContainer');
        const ticker = document.getElementById('marketTicker');
        container.classList.remove('dragging');
        
        // Save the final position
        const currentTransform = window.getComputedStyle(ticker).transform;
        if (currentTransform !== 'none') {
            const matrix = new DOMMatrix(currentTransform);
            tickerPosition = matrix.m41;
        }
        
        // Re-enable smooth transitions
        ticker.style.transition = 'transform 0.5s linear';
        
        // Clear any existing resume timeout
        if (window.tickerResumeTimeout) {
            clearTimeout(window.tickerResumeTimeout);
        }
        
        // Resume auto-scroll after a delay
        window.tickerResumeTimeout = setTimeout(() => {
            if (!isDragging) {
                startAutoScroll();
            }
        }, 2000);
    }

    // Enhanced Data Integration with multiple sources
    async function fetchLiveMarketData() {
        try {
            // Check if we have cached data from last 24 hours
            const cachedData = localStorage.getItem('marketDataCache');
            const cacheTime = localStorage.getItem('marketDataCacheTime');
            const now = new Date().getTime();
            
            // Use cache if less than 24 hours old
            if (cachedData && cacheTime && (now - parseInt(cacheTime)) < 24 * 60 * 60 * 1000) {
                const cached = JSON.parse(cachedData);
                Object.assign(marketData, cached);
                createTicker();
                return;
            }
            
            // Fetch live FX rates
            const fxResponse = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
            const fxData = await fxResponse.json();
            
            // Fetch US Treasury yields from FRED (Federal Reserve Economic Data)
            // Note: FRED provides daily updates, perfect for bonds
            const fredApiKey = 'demo'; // Use 'demo' for testing, get free key at https://fred.stlouisfed.org/docs/api/api_key.html
            const bondSymbols = {
                'DGS2': 'US 2Y',  // 2-Year Treasury
                'DGS5': 'US 5Y',  // 5-Year Treasury
                'DGS10': 'US 10Y' // 10-Year Treasury
            };
            
            // Fetch SOFR rate (replaces LIBOR)
            try {
                const sofrResponse = await fetch('/api/market-data/fred/SOFR');
                const sofrData = await sofrResponse.json();
                if (sofrData.observations && sofrData.observations[0]) {
                    marketData['SOFR'].value = parseFloat(sofrData.observations[0].value);
                }
            } catch (e) {
                // SOFR data not available
            }
            
            // Fetch ECB rates (European Central Bank provides free data)
            try {
                const ecbResponse = await fetch('https://api.frankfurter.app/latest?from=EUR');
                const ecbData = await ecbResponse.json();
                // ECB main refinancing rate (approximation)
                marketData['ECB RATE'].value = 4.00; // ECB publishes rates on their website
            } catch (e) {
                // ECB data not available
            }
            
            // Bank of England base rate (from UK government data)
            // Note: BOE updates rates monthly, we'll use static value updated manually
            marketData['BOE RATE'].value = 5.25;
            
            // SONIA (Sterling Overnight Index Average) - UK equivalent of SOFR
            marketData['SONIA'].value = 5.18;
            
            // Update FX rates with live data
            if (fxData && fxData.rates) {
                marketData['GBP/USD'].value = (1 / fxData.rates.GBP).toFixed(4);
                marketData['EUR/USD'].value = (1 / fxData.rates.EUR).toFixed(4);
                marketData['USD/JPY'].value = fxData.rates.JPY;
                marketData['EUR/GBP'].value = (fxData.rates.GBP / fxData.rates.EUR).toFixed(4);
            }
            
            // Fetch credit spreads (using approximations based on indices)
            // IG (Investment Grade) and HY (High Yield) spreads
            try {
                // These would typically come from iBoxx indices or ICE BofA indices
                // Using realistic current market values
                marketData['IG SPREAD'].value = 1.45;
                marketData['HY SPREAD'].value = 4.25;
                marketData['CMBS AAA'].value = 1.45;
                marketData['CLO AAA'].value = 1.75;
            } catch (e) {
                // Credit spread data not available
            }
            
            // Fetch commodity prices
            try {
                // Gold price from exchangerate-api (they provide XAU rates)
                if (fxData && fxData.rates && fxData.rates.XAU) {
                    marketData['GOLD'].value = (1 / fxData.rates.XAU).toFixed(2);
                }
            } catch (e) {
                // Gold price not available
            }
            
            // Cache the data for 24 hours
            localStorage.setItem('marketDataCache', JSON.stringify(marketData));
            localStorage.setItem('marketDataCacheTime', now.toString());
            
            // Recreate ticker with updated data
            createTicker();
            
        } catch (error) {
            // Using fallback market data
        }
    }
    
    // Fetch live data will be called after DOM is ready
    
    // Create ticker content
    function createTicker() {
        const ticker = document.getElementById('marketTicker');
        const container = document.getElementById('tickerContainer');
        
        console.log('CreateTicker called - ticker element:', ticker);
        console.log('CreateTicker called - container element:', container);
        console.log('Market data:', marketData);
        
        if (!ticker || !container) {
            console.error('Ticker or container not found!');
            // Try again in 100ms if elements not ready
            setTimeout(createTicker, 100);
            return;
        }
        
        // Ensure ticker is visible
        container.style.display = 'block';
        container.style.visibility = 'visible';
        container.style.opacity = '1';
        container.style.background = 'linear-gradient(90deg, #1a1d23 0%, #0f1419 100%)';
        container.style.minHeight = '45px';
        ticker.style.color = '#ffffff';
        
        // Prevent multiple initializations
        if (tickerInitialized) {
            // Just update content without re-adding event listeners
            updateTickerContent();
            return;
        }
        
        // Stop any existing animation
        if (tickerAnimationId) {
            cancelAnimationFrame(tickerAnimationId);
            tickerAnimationId = null;
        }
        
        let content = '';
        
        // Build one complete set of ticker content
        function buildTickerContent() {
            let singleSet = '';
            
            // Bonds Section
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">BONDS</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['US 10Y', 'UK 10Y', 'DE 10Y', 'US 5Y', 'US 2Y'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Central Banks
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">CENTRAL BANKS</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['FED RATE', 'BOE RATE', 'ECB RATE'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Reference Rates
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">REFERENCE RATES</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['SOFR', 'SONIA', 'ESTR'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Credit Spreads
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">SECURITISATION</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['IG SPREAD', 'HY SPREAD', 'CMBS AAA', 'RMBS AAA', 'CLO AAA'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // FX
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">FX</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['GBP/USD', 'EUR/USD', 'USD/JPY', 'EUR/GBP'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Equities
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">EQUITIES</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['S&P 500', 'FTSE 100', 'DAX'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Commodities  
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">COMMODITIES</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['GOLD', 'OIL WTI', 'SILVER'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            singleSet += '<span class="ticker-separator" style="margin: 0 2rem;">||</span>';
            return singleSet;
        }
        
        // Create three copies for seamless endless scrolling
        const singleContent = buildTickerContent();
        console.log('Built ticker content length:', singleContent.length);
        ticker.innerHTML = singleContent + singleContent + singleContent;
        console.log('Ticker innerHTML set, scrollWidth:', ticker.scrollWidth);
        
        // Setup drag functionality (only once)
        container.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDrag);
        
        // Touch events for mobile
        container.addEventListener('touchstart', startDrag);
        document.addEventListener('touchmove', drag);
        document.addEventListener('touchend', stopDrag);
        
        // Mark as initialized
        tickerInitialized = true;
        
        // Start auto-scroll
        startAutoScroll();
    }

    function createTickerItem(symbol, data) {
        const formatValue = (val) => {
            if (val === undefined || val === null || isNaN(val)) {
                return 'N/A';
            }
            if (symbol.includes('/')) return val.toFixed(4);
            else if (symbol.includes('JPY')) return val.toFixed(2);
            else if (symbol.includes('RATE') || symbol.includes('SPREAD') || symbol.includes('AAA') || symbol.includes('SOFR') || symbol.includes('SONIA') || symbol.includes('ESTR') || symbol.includes('TONAR')) return val.toFixed(2) + '%';
            else if (symbol.includes('GOLD') || symbol.includes('SILVER') || symbol.includes('OIL')) return '$' + val.toFixed(2);
            else if (symbol.includes('S&P') || symbol.includes('FTSE') || symbol.includes('DAX') || symbol.includes('NIKKEI') || symbol.includes('VIX')) return val.toFixed(2);
            else return val.toFixed(2) + '%';
        };
        
        const getChangeColor = (change) => {
            if (change === undefined || change === null || isNaN(change)) {
                return '#94a3b8';
            }
            if (change > 0) return '#22c55e';
            if (change < 0) return '#ef4444';
            return '#94a3b8';
        };
        
        const formatChange = (change) => {
            if (change === undefined || change === null || isNaN(change)) {
                return 'N/A';
            }
            return (change > 0 ? '+' : '') + change.toFixed(2) + '%';
        };
        
        // Build HTML with proper inline styles - exactly like Gate2
        let html = '';
        
        // Special handling for central bank rates with history
        if ((symbol === 'FED RATE' || symbol === 'BOE RATE' || symbol === 'ECB RATE') && data.history) {
            html += '<div class="ticker-item" style="display: inline-flex; align-items: center; gap: 8px; margin: 0 12px;">';
            html += '<span class="ticker-symbol" style="color: #94a3b8; font-weight: 600;">' + symbol + ':</span>';
            html += '<span class="ticker-value" style="color: #fff; font-weight: 500;">' + formatValue(data.value) + '</span>';
            html += '<span style="color: #64748b; font-size: 0.65rem; margin-left: 8px;">History:</span>';
            
            // Add history rates
            for (let i = 0; i < data.history.length; i++) {
                const rate = data.history[i];
                const color = (i === data.history.length - 1) ? '#60a5fa' : '#94a3b8';
                const weight = (i === data.history.length - 1) ? '600' : '400';
                html += '<span style="color: ' + color + '; font-size: 0.75rem; font-weight: ' + weight + ';">' + rate.toFixed(2) + '%</span>';
            }
            
            html += '</div>';
            html += '<span class="ticker-separator" style="color: #475569; margin: 0 8px;">●</span>';
        } else {
            // Regular ticker item
            html += '<div class="ticker-item" style="display: inline-flex; align-items: center; gap: 8px; margin: 0 12px;">';
            html += '<span class="ticker-symbol" style="color: #94a3b8; font-weight: 600;">' + symbol + ':</span>';
            html += '<span class="ticker-value" style="color: #fff; font-weight: 500;">' + formatValue(data.value) + '</span>';
            html += '<span style="color: #64748b; font-size: 0.7rem; margin-left: 4px;">24h</span>';
            html += '<span style="color: ' + getChangeColor(data.change24h) + '; font-size: 0.8rem; font-weight: 500;">' + formatChange(data.change24h) + '</span>';
            html += '<span style="color: #64748b; font-size: 0.7rem;">7d</span>';
            html += '<span style="color: ' + getChangeColor(data.change7d) + '; font-size: 0.8rem; font-weight: 500;">' + formatChange(data.change7d) + '</span>';
            html += '<span style="color: #64748b; font-size: 0.7rem;">30d</span>';
            html += '<span style="color: ' + getChangeColor(data.change30d) + '; font-size: 0.8rem; font-weight: 500;">' + formatChange(data.change30d) + '</span>';
            html += '</div>';
            html += '<span class="ticker-separator" style="color: #475569; margin: 0 8px;">●</span>';
        }
        
        return html;
    }

    // Function to update ticker content without reinitializing
    function updateTickerContent() {
        const ticker = document.getElementById('marketTicker');
        if (!ticker) return;
        
        let content = '';
        
        // Build one complete set of ticker content
        function buildTickerContent() {
            let singleSet = '';
            
            // Bonds Section
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">BONDS</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['US 10Y', 'UK 10Y', 'DE 10Y', 'US 5Y', 'US 2Y'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Central Banks
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">CENTRAL BANKS</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['FED RATE', 'BOE RATE', 'ECB RATE'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Reference Rates
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">REFERENCE RATES</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['SOFR', 'SONIA', 'ESTR'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Credit Spreads
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">SECURITISATION</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['IG SPREAD', 'HY SPREAD', 'CMBS AAA', 'RMBS AAA', 'CLO AAA'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // FX
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">FX</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['GBP/USD', 'EUR/USD', 'USD/JPY', 'EUR/GBP'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Commodities
            singleSet += '<span class="ticker-section-header">COMMODITIES</span>';
            singleSet += '<span class="ticker-separator">●</span>';
            ['GOLD', 'OIL WTI', 'SILVER'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            return singleSet;
        }
        
        // Create three copies for seamless loop
        const singleContent = buildTickerContent();
        ticker.innerHTML = singleContent + singleContent + singleContent;
    }
    
    // Initialize everything on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing...');
        
        // Trigger animations only once on initial page load
        setTimeout(() => {
            const fadeElements = document.querySelectorAll('.fade-in-up');
            fadeElements.forEach(element => {
                element.classList.add('animated');
            });
        }, 100);
        
        // Set initial padding for sections based on toolbar state
        var nav = document.getElementById('navBar');
        var mainDashboard = document.getElementById('main-dashboard');
        var sections = document.querySelectorAll('#market-section, #data-section, #analytics-section, #risk-section, #portfolio-section, #compliance-section, #permutation-section');
        
        // Check if toolbar is visible and set appropriate padding
        if (nav && nav.getAttribute('data-hidden') !== 'true') {
            nav.setAttribute('data-hidden', 'false');
            sections.forEach(function(s) { 
                if(s) s.style.paddingTop = '185px'; 
            });
            if(mainDashboard) mainDashboard.style.marginTop = '165px';
        } else {
            sections.forEach(function(s) { 
                if(s) s.style.paddingTop = '135px'; 
            });
            if(mainDashboard) mainDashboard.style.marginTop = '135px'; // Consistent with other sections
        }
        
        // Create and initialize ticker
        createTicker();
        
        // Fetch live data on load and every 30 seconds
        fetchLiveMarketData();
        setInterval(fetchLiveMarketData, 30000);
        
        // Set current date
        const currentDateElement = document.getElementById('currentDate');
        if (currentDateElement) {
            currentDateElement.textContent = new Date().toLocaleDateString('en-GB', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
        // Animate counters
        animateCounter('aumCounter', 0, 127.5, 'B', 2000);
        animateCounter('dealsCounter', 0, 342, '', 2000);
        
        // Initialize Chart
        const ctx = document.getElementById('spreadChart');
        if (ctx) {
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 30}, (_, i) => 'Day ' + (i+1)),
                    datasets: [{
                        label: 'AAA Spread',
                        data: Array.from({length: 30}, () => Math.random() * 0.5 + 1.5),
                        borderColor: '#60a5fa',
                        backgroundColor: 'rgba(96, 165, 250, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8', maxTicksLimit: 10 }
                        }
                    }
                }
            });
        }
    });

    function animateCounter(id, start, end, suffix, duration) {
        const element = document.getElementById(id);
        if (!element) return;
        
        const prefix = '€';
        let startTime = null;
        
        function animate(currentTime) {
            if (startTime === null) startTime = currentTime;
            const timeElapsed = currentTime - startTime;
            const progress = Math.min(timeElapsed / duration, 1);
            
            const currentValue = start + (end - start) * easeOutQuart(progress);
            element.textContent = prefix + currentValue.toFixed(1) + suffix;
            
            if (progress < 1) {
                requestAnimationFrame(animate);
            }
        }
        
        requestAnimationFrame(animate);
    }

    function easeOutQuart(t) {
        return 1 - (--t) * t * t * t;
    }
    
    
    // Show section based on navigation
    function showSection(section) {
        // Hide all sections without re-triggering animations
        const allSections = ['main-dashboard', 'market-section', 'data-section', 'analytics-section', 
                           'risk-section', 'portfolio-section', 'compliance-section', 'permutation-section',
                           'documents-section', 'timeline-section', 'reports-section', 'support-section', 'projects-section'];
        
        allSections.forEach(sectionId => {
            const element = document.getElementById(sectionId);
            if (element) {
                element.style.display = 'none';
            }
        });
        
        // Reset all navigation buttons to inactive state
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.style.background = 'transparent';
            btn.style.color = '#60a5fa';
            btn.style.border = '1px solid #60a5fa';
        });
        
        // Show selected section
        if (section === 'dashboard') {
            document.getElementById('main-dashboard').style.display = 'block';
        } else {
            const sectionElement = document.getElementById(section + '-section');
            if (sectionElement) {
                sectionElement.style.display = 'block';
                
                // Initialize market news when market section is shown
                if (section === 'market' && !window.marketNewsLoaded) {
                    loadMarketNewsData();
                    window.marketNewsLoaded = true;
                }
            }
        }
        
        // Highlight the active button
        const activeButton = document.querySelector(`.nav-btn[data-section="${section}"]`);
        if (activeButton) {
            activeButton.style.background = 'linear-gradient(90deg, #60a5fa, #3b82f6)';
            activeButton.style.color = 'white';
            activeButton.style.border = '1px solid #60a5fa';
        }
    }
    
    // Toggle Account dropdown
    function toggleAccount() {
        alert('Account settings coming soon!');
    }
    
    // Optimized FRED API Integration with intelligent update frequencies
    async function fetchEnhancedFREDData() {
        const fredApiKey = '06d8ad927adcea880c39dc648df3d02f';
        const baseUrl = 'https://api.stlouisfed.org/fred/series/observations';
        
        // FRED API Rate Limits:
        // - 120 requests per minute
        // - 1000 requests per day without registration
        // - With API key: unlimited daily requests
        
        // Data Update Frequencies from FRED:
        // Daily Updates (fetch once per day):
        const dailySeries = {
            'DGS2': 'US 2Y',         // 2-Year Treasury - Updated daily at 3:30 PM ET
            'DGS5': 'US 5Y',         // 5-Year Treasury - Updated daily at 3:30 PM ET  
            'DGS10': 'US 10Y',       // 10-Year Treasury - Updated daily at 3:30 PM ET
            'DGS30': 'US 30Y',       // 30-Year Treasury - Updated daily at 3:30 PM ET
            'SOFR': 'SOFR',          // SOFR - Updated daily at 8:00 AM ET
            'DFF': 'FED RATE',       // Federal Funds Rate - Updated daily
            'DPRIME': 'PRIME RATE',  // Bank Prime Loan Rate - Updated daily
        };
        
        // Weekly Updates (fetch once per week):
        const weeklySeries = {
            'BAMLH0A0HYM2': 'HY SPREAD',  // High Yield Spread - Updated weekly
            'BAMLC0A0CM': 'IG SPREAD',    // Investment Grade Spread - Updated weekly
            'MORTGAGE30US': 'US 30Y MTG', // 30-Year Mortgage Rate - Updated weekly (Thursdays)
            'MORTGAGE15US': 'US 15Y MTG', // 15-Year Mortgage Rate - Updated weekly (Thursdays)
        };
        
        // Monthly Updates (fetch once per month):
        const monthlySeries = {
            'UNRATE': 'US UNEMP',     // Unemployment Rate - First Friday of month
            'CPIAUCSL': 'US CPI',     // Consumer Price Index - Mid-month
            'PPIACO': 'US PPI',       // Producer Price Index - Mid-month
            'HOUST': 'HOUSING',       // Housing Starts - Third week of month
        };
        
        // Available Additional FRED Series (50+ data points):
        // Bond Markets: T1YIE (1Y Inflation), T5YIFR (5Y Forward Inflation), TEDRATE (TED Spread)
        // Credit Markets: DEXUSEU (USD/EUR), DEXUSUK (USD/GBP), DEXJPUS (JPY/USD)
        // Economic Indicators: GDP, PAYEMS (Nonfarm Payrolls), INDPRO (Industrial Production)
        // Money Supply: M1SL, M2SL, BOGMBASE
        // Interest Rates: TB3MS (3-Month T-Bill), TB6MS (6-Month T-Bill)
        // Real Estate: CSUSHPISA (Case-Shiller Index), PERMIT (Building Permits)
        
        const now = new Date();
        const today = now.toDateString();
        const thisWeek = 'week-' + Math.floor(now.getTime() / (7 * 24 * 60 * 60 * 1000));
        const thisMonth = now.getFullYear() + '-' + now.getMonth();
        
        // Check cache timestamps
        const dailyCache = localStorage.getItem('fredDailyCache');
        const dailyCacheDate = localStorage.getItem('fredDailyCacheDate');
        const weeklyCache = localStorage.getItem('fredWeeklyCache');
        const weeklyCacheWeek = localStorage.getItem('fredWeeklyCacheWeek');
        const monthlyCache = localStorage.getItem('fredMonthlyCache');
        const monthlyCacheMonth = localStorage.getItem('fredMonthlyCacheMonth');
        
        let dataToFetch = {};
        
        // Determine what needs updating
        if (!dailyCache || dailyCacheDate !== today) {
            Object.assign(dataToFetch, dailySeries);
        }
        if (!weeklyCache || weeklyCacheWeek !== thisWeek) {
            Object.assign(dataToFetch, weeklySeries);
        }
        if (!monthlyCache || monthlyCacheMonth !== thisMonth) {
            Object.assign(dataToFetch, monthlySeries);
        };
        
        // Only fetch if we have data that needs updating
        if (Object.keys(dataToFetch).length === 0) {
            // All FRED data is up-to-date, using cache
            // Load from cache
            if (dailyCache) Object.assign(marketData, JSON.parse(dailyCache));
            if (weeklyCache) Object.assign(marketData, JSON.parse(weeklyCache));
            if (monthlyCache) Object.assign(marketData, JSON.parse(monthlyCache));
            return;
        }
        
        // Fetching FRED data points
        
        try {
            const fetchedData = {};
            let requestCount = 0;
            
            // Batch requests with delay to respect rate limits
            for (const [seriesId, dataKey] of Object.entries(dataToFetch)) {
                // Add delay every 10 requests to stay well under 120/minute limit
                if (requestCount > 0 && requestCount % 10 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 1000)); // 1 second delay
                }
                
                // Use proxy to avoid CORS issues
                const response = await fetch('/api/market-data/fred/' + seriesId);
                const data = await response.json();
                
                if (data.observations && data.observations[0]) {
                    const value = parseFloat(data.observations[0].value);
                    fetchedData[dataKey] = { value: value, timestamp: data.observations[0].date };
                    
                    if (marketData[dataKey]) {
                        marketData[dataKey].value = value;
                    } else {
                        marketData[dataKey] = { value: value, change24h: 0, change7d: 0, change30d: 0 };
                    }
                }
                
                requestCount++;
            }
            
            // Save to appropriate caches
            if (Object.keys(dailySeries).some(key => dataToFetch[key])) {
                const dailyData = {};
                Object.keys(dailySeries).forEach(key => {
                    if (fetchedData[dailySeries[key]]) {
                        dailyData[dailySeries[key]] = fetchedData[dailySeries[key]];
                    }
                });
                localStorage.setItem('fredDailyCache', JSON.stringify(dailyData));
                localStorage.setItem('fredDailyCacheDate', today);
            }
            
            if (Object.keys(weeklySeries).some(key => dataToFetch[key])) {
                const weeklyData = {};
                Object.keys(weeklySeries).forEach(key => {
                    if (fetchedData[weeklySeries[key]]) {
                        weeklyData[weeklySeries[key]] = fetchedData[weeklySeries[key]];
                    }
                });
                localStorage.setItem('fredWeeklyCache', JSON.stringify(weeklyData));
                localStorage.setItem('fredWeeklyCacheWeek', thisWeek);
            }
            
            if (Object.keys(monthlySeries).some(key => dataToFetch[key])) {
                const monthlyData = {};
                Object.keys(monthlySeries).forEach(key => {
                    if (fetchedData[monthlySeries[key]]) {
                        monthlyData[monthlySeries[key]] = fetchedData[monthlySeries[key]];
                    }
                });
                localStorage.setItem('fredMonthlyCache', JSON.stringify(monthlyData));
                localStorage.setItem('fredMonthlyCacheMonth', thisMonth);
            }
            
            // FRED data updated
            createTicker(); // Refresh ticker with new data
            
        } catch (error) {
            console.error('Error fetching FRED data:', error);
            // Load from cache if available
            if (dailyCache) Object.assign(marketData, JSON.parse(dailyCache));
            if (weeklyCache) Object.assign(marketData, JSON.parse(weeklyCache));
            if (monthlyCache) Object.assign(marketData, JSON.parse(monthlyCache));
        }
    }
    
    // Intelligent update schedule based on data freshness needs:
    // - Check for daily updates every hour (treasuries update at 3:30 PM ET)
    // - Weekly data checked daily
    // - Monthly data checked weekly
    setInterval(fetchEnhancedFREDData, 60 * 60 * 1000); // Check every hour
    
    // Fetch on load
    fetchEnhancedFREDData();
    
    // Permutation Engine Functions
    let permutationEngine = {
        status: 'stopped',
        startTime: null,
        timer: null,
        progress: 0,
        currentIteration: 0,
        totalIterations: 0
    };
    
    function startPermutationEngine() {
        if (permutationEngine.status === 'running') return;
        
        // Get all input values
        const datasetSize = document.getElementById('perm-dataset-size').value || 1000;
        const iterations = document.getElementById('perm-iterations').value || 100;
        const sampleRate = document.getElementById('perm-sample-rate').value || 100;
        const confidence = document.getElementById('perm-confidence').value;
        const permType = document.getElementById('perm-type').value;
        const optimization = document.getElementById('perm-optimization').value;
        const mode = document.getElementById('perm-mode').value;
        
        // Update engine state
        permutationEngine.status = 'running';
        permutationEngine.startTime = Date.now();
        permutationEngine.totalIterations = iterations;
        permutationEngine.currentIteration = 0;
        permutationEngine.progress = 0;
        
        // Update UI
        document.getElementById('perm-status').textContent = 'Running';
        document.getElementById('perm-status').style.color = '#60a5fa';
        document.getElementById('perm-current-iterations').textContent = '0 / ' + iterations;
        
        // Start timer
        permutationEngine.timer = setInterval(updatePermutationTimer, 1000);
        
        // Simulate processing
        simulatePermutationProcessing();
        
        // Log to results
        const resultsDiv = document.getElementById('perm-results');
        resultsDiv.innerHTML = '<div style="color: #60a5fa; margin-bottom: 1rem;">' +
            '<strong>Engine Started</strong><br>' +
            'Configuration: ' + permType + ' permutation using ' + optimization + '<br>' +
            'Dataset Size: ' + datasetSize + ' | Iterations: ' + iterations + ' | Sample Rate: ' + sampleRate + '%<br>' +
            'Processing Mode: ' + mode + ' | Confidence Level: ' + confidence + '%' +
            '</div>' +
            '<div id="perm-live-results" style="color: #94a3b8; font-family: monospace; font-size: 0.9rem;">' +
                'Processing...' +
            '</div>';
    }
    
    function pausePermutationEngine() {
        if (permutationEngine.status !== 'running') return;
        
        permutationEngine.status = 'paused';
        clearInterval(permutationEngine.timer);
        
        document.getElementById('perm-status').textContent = 'Paused';
        document.getElementById('perm-status').style.color = '#60a5fa';
    }
    
    function stopPermutationEngine() {
        permutationEngine.status = 'stopped';
        clearInterval(permutationEngine.timer);
        
        document.getElementById('perm-status').textContent = 'Stopped';
        document.getElementById('perm-status').style.color = '#ef4444';
        
        // Final results
        if (permutationEngine.currentIteration > 0) {
            showPermutationResults();
        }
    }
    
    function resetPermutationEngine() {
        // Stop engine
        stopPermutationEngine();
        
        // Reset all values
        permutationEngine = {
            status: 'stopped',
            startTime: null,
            timer: null,
            progress: 0,
            currentIteration: 0,
            totalIterations: 0
        };
        
        // Reset UI
        document.getElementById('perm-status').textContent = 'Ready';
        document.getElementById('perm-status').style.color = '#22c55e';
        document.getElementById('perm-progress-bar').style.width = '0%';
        document.getElementById('perm-progress-percent').textContent = '0%';
        document.getElementById('perm-current-iterations').textContent = '0 / 0';
        document.getElementById('perm-time').textContent = '00:00:00';
        document.getElementById('perm-eta').textContent = '--:--:--';
        document.getElementById('perm-results').innerHTML = '<p style="color: #94a3b8; text-align: center;">No results yet. Configure parameters and start the engine.</p>';
        
        // Clear all inputs
        document.querySelectorAll('#permutation-section input').forEach(input => {
            if (input.type === 'number' || input.type === 'text') {
                input.value = '';
            }
        });
    }
    
    function updatePermutationTimer() {
        if (!permutationEngine.startTime) return;
        
        const elapsed = Date.now() - permutationEngine.startTime;
        const hours = Math.floor(elapsed / 3600000);
        const minutes = Math.floor((elapsed % 3600000) / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        
        document.getElementById('perm-time').textContent = 
            hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
        
        // Calculate ETA
        if (permutationEngine.currentIteration > 0) {
            const avgTimePerIteration = elapsed / permutationEngine.currentIteration;
            const remainingIterations = permutationEngine.totalIterations - permutationEngine.currentIteration;
            const remainingTime = avgTimePerIteration * remainingIterations;
            
            const etaHours = Math.floor(remainingTime / 3600000);
            const etaMinutes = Math.floor((remainingTime % 3600000) / 60000);
            const etaSeconds = Math.floor((remainingTime % 60000) / 1000);
            
            var etaString = etaHours.toString().padStart(2, '0') + ':' + 
                            etaMinutes.toString().padStart(2, '0') + ':' + 
                            etaSeconds.toString().padStart(2, '0');
            document.getElementById('perm-eta').textContent = etaString;
        }
    }
    
    function simulatePermutationProcessing() {
        console.log('DEBUG: simulatePermutationProcessing called - Line 3659');
        // Check if engine is running
        if (permutationEngine.status !== 'running') {
            return;
        }
        
        // Increment the iteration counter
        permutationEngine.currentIteration = permutationEngine.currentIteration + 1;
        
        // Calculate the progress percentage
        var progressValue = (permutationEngine.currentIteration / permutationEngine.totalIterations) * 100;
        permutationEngine.progress = progressValue;
        
        // Update the progress bar width
        var progressBar = document.getElementById('perm-progress-bar');
        if (progressBar) {
            progressBar.style.width = progressValue + '%';
        }
        
        // Update the progress percentage text
        var progressPercent = document.getElementById('perm-progress-percent');
        if (progressPercent) {
            progressPercent.textContent = Math.round(progressValue) + '%';
        }
        
        // Update the iteration counter display
        try {
            var iterationsDisplay = document.getElementById('perm-current-iterations');
            if (iterationsDisplay) {
                var iterationText = String(permutationEngine.currentIteration) + ' / ' + String(permutationEngine.totalIterations);
                iterationsDisplay.textContent = iterationText;
            }
        } catch (e) {
            console.error('Error updating iterations display:', e);
        }
        
        // Update live results if element exists
        var liveResultsElement = document.getElementById('perm-live-results');
        if (liveResultsElement) {
            var randomResult = Math.random() * 1000;
            var newResultLine = 'Iteration ' + permutationEngine.currentIteration + ': Result = ' + randomResult.toFixed(4);
            
            // Add new result line
            var currentContent = liveResultsElement.innerHTML;
            liveResultsElement.innerHTML = currentContent + '<br>' + newResultLine;
            
            // Keep only last 10 results
            var allLines = liveResultsElement.innerHTML.split('<br>');
            if (allLines.length > 11) {
                var trimmedLines = allLines.slice(-11);
                liveResultsElement.innerHTML = trimmedLines.join('<br>');
            }
        }
        
        // Check if we should continue or complete
        if (permutationEngine.currentIteration < permutationEngine.totalIterations) {
            // Schedule next iteration
            window.setTimeout(simulatePermutationProcessing, 100);
        } else {
            // Mark as completed
            permutationEngine.status = 'completed';
            
            // Clear the timer
            if (permutationEngine.timer) {
                clearInterval(permutationEngine.timer);
            }
            
            // Update status display
            var statusElement = document.getElementById('perm-status');
            if (statusElement) {
                statusElement.textContent = 'Completed';
                statusElement.style.color = '#22c55e';
            }
            
            // Show final results
            showPermutationResults();
        }
    }
    
    function showPermutationResults() {
        const resultsDiv = document.getElementById('perm-results');
        const elapsed = Date.now() - permutationEngine.startTime;
        const elapsedSeconds = (elapsed / 1000).toFixed(2);
        
        // Generate mock results
        const results = {
            totalPermutations: Math.floor(Math.random() * 1000000) + 100000,
            optimalSolution: (Math.random() * 100).toFixed(4),
            convergenceRate: (Math.random() * 100).toFixed(2),
            efficiency: (85 + Math.random() * 15).toFixed(2),
            memoryUsed: (Math.random() * 500 + 100).toFixed(2)
        };
        
        resultsDiv.innerHTML = '<div style="background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">' +
                '<h4 style="color: #22c55e; margin-bottom: 0.5rem;">Processing Complete</h4>' +
                '<p style="color: rgba(255, 255, 255, 0.9);">Completed ' + permutationEngine.currentIteration + ' iterations in ' + elapsedSeconds + ' seconds</p>' +
            '</div>' +
            
            '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">' +
                '<div style="background: rgba(96, 165, 250, 0.1); border: 1px solid #60a5fa; border-radius: 8px; padding: 1rem;">' +
                    '<p style="color: #60a5fa; font-size: 0.9rem; margin-bottom: 0.3rem;">Total Permutations</p>' +
                    '<p style="color: white; font-size: 1.5rem; font-weight: 600;">' + results.totalPermutations.toLocaleString() + '</p>' +
                '</div>' +
                '<div style="background: rgba(96, 165, 250, 0.1); border: 1px solid #60a5fa; border-radius: 8px; padding: 1rem;">' +
                    '<p style="color: #60a5fa; font-size: 0.9rem; margin-bottom: 0.3rem;">Optimal Solution</p>' +
                    '<p style="color: white; font-size: 1.5rem; font-weight: 600;">' + results.optimalSolution + '</p>' +
                '</div>' +
                '<div style="background: rgba(96, 165, 250, 0.1); border: 1px solid #60a5fa; border-radius: 8px; padding: 1rem;">' +
                    '<p style="color: #60a5fa; font-size: 0.9rem; margin-bottom: 0.3rem;">Convergence Rate</p>' +
                    '<p style="color: white; font-size: 1.5rem; font-weight: 600;">' + results.convergenceRate + '%</p>' +
                '</div>' +
                '<div style="background: rgba(96, 165, 250, 0.1); border: 1px solid #60a5fa; border-radius: 8px; padding: 1rem;">' +
                    '<p style="color: #60a5fa; font-size: 0.9rem; margin-bottom: 0.3rem;">Efficiency</p>' +
                    '<p style="color: white; font-size: 1.5rem; font-weight: 600;">' + results.efficiency + '%</p>' +
                '</div>' +
                '<div style="background: rgba(96, 165, 250, 0.1); border: 1px solid #60a5fa; border-radius: 8px; padding: 1rem;">' +
                    '<p style="color: #60a5fa; font-size: 0.9rem; margin-bottom: 0.3rem;">Memory Used</p>' +
                    '<p style="color: white; font-size: 1.5rem; font-weight: 600;">' + results.memoryUsed + ' MB</p>' +
                '</div>' +
            '</div>' +
            
            '<div style="margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, #172554, #1e3a8a); border-radius: 8px;">' +
                '<button onclick="exportPermutationResults()" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-right: 10px;">' +
                    '<i class="fas fa-download"></i> Export Results' +
                '</button>' +
                '<button onclick="visualizePermutationResults()" style="background: linear-gradient(90deg, #8b5cf6, #7c3aed); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">' +
                    '<i class="fas fa-chart-bar"></i> Visualize' +
                '</button>' +
            '</div>';
    }
    
    function exportPermutationResults() {
        alert('Export functionality will be implemented based on your specific requirements.');
    }
    
    function visualizePermutationResults() {
        alert('Visualization functionality will be implemented based on your specific requirements.');
    }
    
    // Securitisation Engine Functions
    let currentInputMode = 'manual';
    let securitisationEngine = {
        status: 'stopped',
        permutations: [],
        validCount: 0,
        invalidCount: 0,
        currentIndex: 0,
        totalPermutations: 0,
        bestIRR: 0
    };
    
    function setInputMode(mode) {
        currentInputMode = mode;
        
        // Update button states
        document.querySelectorAll('.input-mode-btn').forEach(btn => {
            btn.style.background = 'rgba(96, 165, 250, 0.2)';
            btn.style.color = '#60a5fa';
        });
        
        const activeBtn = document.getElementById('mode-' + mode);
        if (activeBtn) {
            activeBtn.style.background = 'linear-gradient(90deg, #60a5fa, #3b82f6)';
            activeBtn.style.color = 'white';
        }
        
        // Show/hide input containers
        const sections = ['project', 'senior', 'mezz', 'equity'];
        sections.forEach(section => {
            var manualEl = document.getElementById('manual-' + section);
            if (manualEl) manualEl.style.display = 'none';
            var rangeEl = document.getElementById('range-' + section);
            if (rangeEl) rangeEl.style.display = 'none';
            var lowhighEl = document.getElementById('lowhigh-' + section);
            if (lowhighEl) lowhighEl.style.display = 'none';
            
            const activeContainer = document.getElementById(mode + '-' + section);
            if (activeContainer) {
                activeContainer.style.display = 'block';
            }
        });
    }
    
    function generatePermutations() {
        // Reset engine state
        securitisationEngine.status = 'running';
        securitisationEngine.permutations = [];
        securitisationEngine.validCount = 0;
        securitisationEngine.invalidCount = 0;
        securitisationEngine.currentIndex = 0;
        securitisationEngine.bestIRR = 0;
        
        // Update UI
        document.getElementById('perm-status').textContent = 'Generating';
        document.getElementById('perm-status').style.color = '#60a5fa';
        
        // Get input values based on mode
        let inputs = collectInputValues();
        
        // Generate all permutations
        let permutations = generateAllPermutations(inputs);
        securitisationEngine.totalPermutations = permutations.length;
        
        // Limit to max permutations
        const maxPerms = parseInt(document.getElementById('sec-max-perms').value) || 1000;
        if (permutations.length > maxPerms) {
            permutations = permutations.slice(0, maxPerms);
        }
        
        // Process permutations
        processPermutations(permutations);
    }
    
    function collectInputValues() {
        let inputs = {};
        
        if (currentInputMode === 'manual') {
            // Collect manual input values
            var capexEl = document.getElementById('sec-capex-manual');
            const capexValues = capexEl ? capexEl.value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v)) : [];
            var opexEl = document.getElementById('sec-opex-manual');
            const opexValues = opexEl ? opexEl.value.split(',').map(v => parseFloat(v.trim())/100).filter(v => !isNaN(v)) : [];
            var rentEl = document.getElementById('sec-rent-manual');
            const rentValues = rentEl ? rentEl.value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v)) : [];
            var seniorDSCREl = document.getElementById('sec-senior-dscr-manual');
            const seniorDSCR = seniorDSCREl ? seniorDSCREl.value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v)) : [];
            var seniorCouponEl = document.getElementById('sec-senior-coupon-manual');
            const seniorCoupon = seniorCouponEl ? seniorCouponEl.value.split(',').map(v => parseFloat(v.trim())/100).filter(v => !isNaN(v)) : [];
            var seniorTenorEl = document.getElementById('sec-senior-tenor-manual');
            const seniorTenor = seniorTenorEl ? seniorTenorEl.value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v)) : [];
            var mezzDSCREl = document.getElementById('sec-mezz-dscr-manual');
            const mezzDSCR = mezzDSCREl ? mezzDSCREl.value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v)) : [];
            var mezzCouponEl = document.getElementById('sec-mezz-coupon-manual');
            const mezzCoupon = mezzCouponEl ? mezzCouponEl.value.split(',').map(v => parseFloat(v.trim())/100).filter(v => !isNaN(v)) : [];
            var equityIRREl = document.getElementById('sec-equity-irr-manual');
            const equityIRR = equityIRREl ? equityIRREl.value.split(',').map(v => parseFloat(v.trim())/100).filter(v => !isNaN(v)) : [];
            
            inputs = {
                capex: capexValues.length ? capexValues : [7500000, 10000000],
                opex: opexValues.length ? opexValues : [0.15, 0.20, 0.25],
                rent: rentValues.length ? rentValues : [120, 140, 160, 180],
                seniorDSCR: seniorDSCR.length ? seniorDSCR : [1.5, 1.55, 1.6],
                seniorCoupon: seniorCoupon.length ? seniorCoupon : [0.03, 0.035, 0.04],
                seniorTenor: seniorTenor.length ? seniorTenor : [5, 7, 10],
                mezzDSCR: mezzDSCR.length ? mezzDSCR : [1.1, 1.15, 1.2],
                mezzCoupon: mezzCoupon.length ? mezzCoupon : [0.06, 0.065, 0.07],
                equityIRR: equityIRR.length ? equityIRR : [0.14, 0.15, 0.16]
            };
        } else if (currentInputMode === 'range') {
            // Generate values from range inputs
            inputs = generateRangeValues();
        } else if (currentInputMode === 'lowhigh') {
            // Generate values from low/high boundaries
            inputs = generateLowHighValues();
        }
        
        return inputs;
    }
    
    function generateAllPermutations(inputs) {
        let permutations = [];
        
        // Generate cartesian product of all input arrays
        const keys = Object.keys(inputs);
        const values = Object.values(inputs);
        
        function cartesian(arr) {
            return arr.reduce((a, b) => a.flatMap(d => b.map(e => [d, e].flat())));
        }
        
        if (values.length > 0) {
            const combinations = cartesian(values);
            combinations.forEach(combo => {
                let perm = {};
                keys.forEach((key, index) => {
                    perm[key] = Array.isArray(combo) ? combo[index] : combo;
                });
                permutations.push(perm);
            });
        }
        
        return permutations;
    }
    
    function processPermutations(permutations) {
        const tbody = document.getElementById('perm-results-body');
        tbody.innerHTML = '';
        
        permutations.forEach((perm, index) => {
            // Calculate derived values
            const annualRent = perm.rent * 12;
            const netIncome = annualRent * (1 - perm.opex);
            
            // Calculate senior debt
            const seniorDebtService = netIncome / perm.seniorDSCR;
            const seniorDebt = seniorDebtService / perm.seniorCoupon;
            
            // Calculate mezz debt
            const remainingNOI = netIncome - seniorDebtService;
            const mezzDebtService = remainingNOI / perm.mezzDSCR;
            const mezzDebt = mezzDebtService / perm.mezzCoupon;
            
            // Calculate equity
            const totalDebt = seniorDebt + mezzDebt;
            const equity = Math.max(0, perm.capex - totalDebt);
            
            // Calculate metrics
            const leverage = totalDebt / perm.capex;
            const wacd = (seniorDebt * perm.seniorCoupon + mezzDebt * perm.mezzCoupon) / totalDebt;
            const irr = perm.equityIRR;
            
            // Check viability
            const isViable = leverage <= 0.85 && equity > 0 && wacd < 0.08;
            
            if (isViable) {
                securitisationEngine.validCount++;
                if (irr > securitisationEngine.bestIRR) {
                    securitisationEngine.bestIRR = irr;
                }
            } else {
                securitisationEngine.invalidCount++;
            }
            
            // Add to table
            const row = tbody.insertRow();
            row.style.borderBottom = '1px solid #364049';
            row.innerHTML = '<td style="padding: 8px;">' + (index + 1) + '</td>' +
                '<td style="padding: 8px;">£' + perm.capex.toLocaleString() + '</td>' +
                '<td style="padding: 8px;">' + (perm.opex * 100).toFixed(1) + '%</td>' +
                '<td style="padding: 8px;">£' + perm.rent.toLocaleString() + '</td>' +
                '<td style="padding: 8px;">' + perm.seniorDSCR.toFixed(2) + '</td>' +
                '<td style="padding: 8px;">' + (perm.seniorCoupon * 100).toFixed(2) + '%</td>' +
                '<td style="padding: 8px;">£' + seniorDebt.toLocaleString('en-GB', {maximumFractionDigits: 0}) + '</td>' +
                '<td style="padding: 8px;">' + perm.mezzDSCR.toFixed(2) + '</td>' +
                '<td style="padding: 8px;">' + (perm.mezzCoupon * 100).toFixed(2) + '%</td>' +
                '<td style="padding: 8px;">£' + mezzDebt.toLocaleString('en-GB', {maximumFractionDigits: 0}) + '</td>' +
                '<td style="padding: 8px;">£' + equity.toLocaleString('en-GB', {maximumFractionDigits: 0}) + '</td>' +
                '<td style="padding: 8px;">' + (irr * 100).toFixed(2) + '%</td>' +
                '<td style="padding: 8px;">' + (wacd * 100).toFixed(2) + '%</td>' +
                '<td style="padding: 8px; color: ' + (isViable ? '#22c55e' : '#ef4444') + ';">' + (isViable ? 'Viable' : 'Invalid') + '</td>';
            
            // Update progress
            updateProgress(index + 1, permutations.length);
        });
        
        // Complete
        securitisationEngine.status = 'completed';
        document.getElementById('perm-status').textContent = 'Completed';
        document.getElementById('perm-status').style.color = '#22c55e';
        document.getElementById('perm-best-irr').textContent = (securitisationEngine.bestIRR * 100).toFixed(2) + '%';
    }
    
    function updateProgress(current, total) {
        const percent = (current / total * 100).toFixed(1);
        document.getElementById('perm-progress-bar').style.width = percent + '%';
        document.getElementById('perm-progress-percent').textContent = percent + '%';
        document.getElementById('perm-progress-text').textContent = current + ' / ' + total;
        document.getElementById('perm-valid-count').textContent = securitisationEngine.validCount;
        document.getElementById('perm-invalid-count').textContent = securitisationEngine.invalidCount;
        
        // Update dashboard widget
        updateDashboardWidget();
    }
    
    function updateDashboardWidget() {
        // Update dashboard widget values if they exist
        const dashboardPermCount = document.getElementById('dashboard-perm-count');
        const dashboardViableCount = document.getElementById('dashboard-viable-count');
        const dashboardInvalidCount = document.getElementById('dashboard-invalid-count');
        const dashboardBestIRR = document.getElementById('dashboard-best-irr');
        const dashboardEngineStatus = document.getElementById('dashboard-engine-status');
        
        if (dashboardPermCount) {
            dashboardPermCount.textContent = securitisationEngine.totalPermutations || 0;
        }
        if (dashboardViableCount) {
            dashboardViableCount.textContent = securitisationEngine.validCount || 0;
        }
        if (dashboardInvalidCount) {
            dashboardInvalidCount.textContent = securitisationEngine.invalidCount || 0;
        }
        if (dashboardBestIRR) {
            dashboardBestIRR.textContent = securitisationEngine.bestIRR > 0 ? 
                (securitisationEngine.bestIRR * 100).toFixed(2) + '%' : '-';
        }
        if (dashboardEngineStatus) {
            dashboardEngineStatus.textContent = securitisationEngine.status === 'running' ? 'Processing' : 
                                                 securitisationEngine.status === 'completed' ? 'Completed' : 'Ready';
            dashboardEngineStatus.className = 'badge ' + 
                (securitisationEngine.status === 'running' ? 'bg-warning' : 
                 securitisationEngine.status === 'completed' ? 'bg-success' : 'bg-secondary');
        }
    }
    
    function pauseGeneration() {
        if (securitisationEngine.status === 'running') {
            securitisationEngine.status = 'paused';
            document.getElementById('perm-status').textContent = 'Paused';
            document.getElementById('perm-status').style.color = '#60a5fa';
        }
    }
    
    function stopGeneration() {
        securitisationEngine.status = 'stopped';
        document.getElementById('perm-status').textContent = 'Stopped';
        document.getElementById('perm-status').style.color = '#ef4444';
    }
    
    function resetEngine() {
        securitisationEngine = {
            status: 'stopped',
            permutations: [],
            validCount: 0,
            invalidCount: 0,
            currentIndex: 0,
            totalPermutations: 0,
            bestIRR: 0
        };
        
        document.getElementById('perm-status').textContent = 'Ready';
        document.getElementById('perm-status').style.color = '#22c55e';
        document.getElementById('perm-progress-bar').style.width = '0%';
        document.getElementById('perm-progress-percent').textContent = '';
        document.getElementById('perm-progress-text').textContent = '0 / 0';
        document.getElementById('perm-valid-count').textContent = '0';
        document.getElementById('perm-invalid-count').textContent = '0';
        document.getElementById('perm-best-irr').textContent = '-';
        document.getElementById('perm-results-body').innerHTML = '<tr>' +
                '<td colspan="14" style="padding: 20px; text-align: center; color: #94a3b8;">' +
                    'No permutations generated yet. Configure parameters and click "Generate Permutations" to start.' +
                '</td>' +
            '</tr>';
    }
    
    function exportToExcel() {
        alert('Excel export will be implemented to save all permutation results.');
    }
    
    function exportToCSV() {
        alert('CSV export will be implemented to save all permutation results.');
    }
    
    function filterResults() {
        alert('Filter functionality will be implemented to filter viable/invalid results.');
    }
    
    function generateRangeValues() {
        // Implementation for range mode value generation
        return {
            capex: [],
            opex: [],
            rent: [],
            seniorDSCR: [],
            seniorCoupon: [],
            seniorTenor: [],
            mezzDSCR: [],
            mezzCoupon: [],
            equityIRR: []
        };
    }
    
    function generateLowHighValues() {
        // Implementation for low/high mode value generation
        var numScenariosEl = document.getElementById('sec-num-scenarios');
        const numScenarios = numScenariosEl ? parseInt(numScenariosEl.value) : 10;
        return {
            capex: [],
            opex: [],
            rent: [],
            seniorDSCR: [],
            seniorCoupon: [],
            seniorTenor: [],
            mezzDSCR: [],
            mezzCoupon: [],
            equityIRR: []
        };
    }

    // Modal functions for Quick Actions
    function showNewAnalysisModal() {
        const modal = '<div class="modal fade" id="newAnalysisModal" tabindex="-1">' +
                '<div class="modal-dialog">' +
                    '<div class="modal-content bg-dark text-light">' +
                        '<div class="modal-header">' +
                            '<h5 class="modal-title">New Analysis</h5>' +
                            '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>' +
                        '</div>' +
                        '<div class="modal-body">' +
                            '<p>Select analysis type:</p>' +
                            '<div class="d-grid gap-2">' +
                                '<button class="btn btn-outline-primary" onclick="location.href=\'/securitization-engine\'">Securitization Analysis</button>' +
                                '<button class="btn btn-outline-primary" onclick="showPermutationEngine()">Permutation Analysis</button>' +
                                '<button class="btn btn-outline-primary" disabled>Market Analysis (Coming Soon)</button>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        document.body.insertAdjacentHTML('beforeend', modal);
        const modalEl = new bootstrap.Modal(document.getElementById('newAnalysisModal'));
        modalEl.show();
        document.getElementById('newAnalysisModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    }

    function showUploadModal() {
        const modal = '<div class="modal fade" id="uploadModal" tabindex="-1">' +
                '<div class="modal-dialog">' +
                    '<div class="modal-content bg-dark text-light">' +
                        '<div class="modal-header">' +
                            '<h5 class="modal-title">Upload Data</h5>' +
                            '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>' +
                        '</div>' +
                        '<div class="modal-body">' +
                            '<div class="mb-3">' +
                                '<label class="form-label">Select file type:</label>' +
                                '<select class="form-select bg-dark text-light">' +
                                    '<option>CSV</option>' +
                                    '<option>Excel</option>' +
                                    '<option>JSON</option>' +
                                '</select>' +
                            '</div>' +
                            '<div class="mb-3">' +
                                '<input type="file" class="form-control bg-dark text-light" accept=".csv,.xlsx,.json">' +
                            '</div>' +
                            '<button class="btn btn-primary w-100">Upload File</button>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        document.body.insertAdjacentHTML('beforeend', modal);
        const modalEl = new bootstrap.Modal(document.getElementById('uploadModal'));
        modalEl.show();
        document.getElementById('uploadModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    }

    function exportData() {
        const data = {
            timestamp: new Date().toISOString(),
            market_data: window.currentMarketData || {},
            user: {{ username|tojson|safe }}
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'atlas_nexus_export_' + new Date().toISOString().split('T')[0] + '.json';
        a.click();
        URL.revokeObjectURL(url);
    }

    function showSettingsModal() {
        const modal = '<div class="modal fade" id="settingsModal" tabindex="-1">' +
                '<div class="modal-dialog">' +
                    '<div class="modal-content bg-dark text-light">' +
                        '<div class="modal-header">' +
                            '<h5 class="modal-title">Settings</h5>' +
                            '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>' +
                        '</div>' +
                        '<div class="modal-body">' +
                            '<div class="mb-3">' +
                                '<label class="form-label">Theme</label>' +
                                '<select class="form-select bg-dark text-light">' +
                                    '<option>Dark (Default)</option>' +
                                    '<option disabled>Light (Coming Soon)</option>' +
                                '</select>' +
                            '</div>' +
                            '<div class="mb-3">' +
                                '<label class="form-label">Data Refresh Rate</label>' +
                                '<select class="form-select bg-dark text-light">' +
                                    '<option>5 minutes</option>' +
                                    '<option>10 minutes</option>' +
                                    '<option>30 minutes</option>' +
                                '</select>' +
                            '</div>' +
                            '<div class="mb-3">' +
                                '<label class="form-label">Notifications</label>' +
                                '<div class="form-check">' +
                                    '<input class="form-check-input" type="checkbox" checked>' +
                                    '<label class="form-check-label">Email notifications</label>' +
                                '</div>' +
                            '</div>' +
                            '<button class="btn btn-primary w-100">Save Settings</button>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        document.body.insertAdjacentHTML('beforeend', modal);
        const modalEl = new bootstrap.Modal(document.getElementById('settingsModal'));
        modalEl.show();
        document.getElementById('settingsModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    }
    
    // Load market news content dynamically
    function loadMarketNewsContent() {
        fetch('/static/market_news_content.html')
            .then(response => response.text())
            .then(html => {
                const marketSection = document.getElementById('market-section');
                if (marketSection) {
                    // Extract just the inner content from market_news.html
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const content = doc.querySelector('#market-section-content');
                    if (content) {
                        marketSection.innerHTML = content.innerHTML;
                    } else {
                        // Fallback: use the entire content
                        marketSection.innerHTML = html;
                    }
                    // Initialize market news functionality
                    if (window.marketNews) {
                        window.marketNews.initialize();
                    }
                }
            })
            .catch(error => {
                console.error('Error loading market news content:', error);
                // Fallback to loading data directly
                loadMarketNewsData();
            });
    }
    
    // Alternative: Load market news data directly via API
    function loadMarketNewsData() {
        const marketSection = document.getElementById('market-section');
        if (!marketSection) return;
        
        // Insert the market news HTML structure
        marketSection.innerHTML = `{% include 'market_news_content.html' %}`;
        
        // Wait a moment for DOM to update, then initialize
        setTimeout(() => {
            if (window.marketNews) {
                window.marketNews.initialize();
            }
        }, 100);
    }
    
    // Initialize market news when market tab is clicked
    document.addEventListener('DOMContentLoaded', function() {
        const marketBtn = document.querySelector('[onclick*="showSection(\'market\')"]');
        if (marketBtn) {
            marketBtn.addEventListener('click', function() {
                if (!window.marketNewsLoaded) {
                    loadMarketNewsData();
                    window.marketNewsLoaded = true;
                }
            });
        }
    });

    // Advanced Permutation Engine JavaScript - Full 80+ Parameters from Excel
    const permParameters = {
        // Project & Basic Parameters (00-03)
        project: [
            { id: 'Currency_00', name: 'Currency', type: 'select', options: ['EUR', 'USD', 'GBP'], default: 'EUR' },
            { id: 'GrossITLoad_01', name: 'Gross IT Load (MW)', type: 'number', min: 0.1, max: 100, step: 0.1, default: 10 },
            { id: 'PUE_02', name: 'PUE', type: 'number', min: 1.0, max: 2.5, step: 0.01, default: 1.15 },
            { id: 'NetITLoad_03', name: 'Net IT Load (MW)', type: 'formula', formula: 'GrossITLoad_01 / PUE_02' }
        ],
        // Income & Cost Parameters (04-15)
        financial: [
            { id: 'GrossMonthlyRent_04', name: 'Gross Monthly Rent (€/kW)', type: 'number', min: 50, max: 500, step: 5, default: 110 },
            { id: 'GrossIncome_05', name: 'Gross Income', type: 'formula', formula: 'calculated' },
            { id: 'OPEX_06', name: 'OPEX (%)', type: 'number', min: 0, max: 50, step: 1, default: 15 },
            { id: 'NetIncome_07', name: 'Net Income', type: 'formula', formula: 'calculated' },
            { id: 'CapexCostPrice_08', name: 'Capex Cost Price (€/kW)', type: 'number', min: 1000, max: 20000, step: 100, default: 7000 },
            { id: 'CapexMarketRate_09', name: 'Capex Market Rate (€/kW)', type: 'number', min: 1000, max: 25000, step: 100, default: 8000 },
            { id: 'LandPurchaseFees_10', name: 'Land Purchase & Fees (€)', type: 'number', min: 0, max: 100000000, step: 100000, default: 5000000 },
            { id: 'DeveloperProfit_11', name: 'Developer Profit (%)', type: 'number', min: 0, max: 50, step: 1, default: 15 },
            { id: 'DeveloperMargin_12', name: 'Developer Margin (%)', type: 'number', min: 0, max: 50, step: 1, default: 20 }
        ],
        // Senior Debt Parameters (16-32)  
        senior: [
            { id: 'TargetDSCRSenior_16', name: 'Target DSCR Senior', type: 'number', min: 1.0, max: 3.0, step: 0.05, default: 1.35 },
            { id: 'SeniorCoupon_17', name: 'Senior Coupon (%)', type: 'number', min: 0, max: 20, step: 0.25, default: 6.5 },
            { id: 'SeniorTenor_18', name: 'Senior Tenor (Years)', type: 'number', min: 1, max: 30, step: 1, default: 7 },
            { id: 'LeaseTermYears_24', name: 'Lease Term Years', type: 'number', min: 1, max: 30, step: 1, default: 10 },
            { id: 'AFStrategy_25', name: 'AF Strategy', type: 'select', options: ['Bullet', 'Linear', 'Annuity', 'Custom'], default: 'Linear' },
            { id: 'SeniorAmortisationType_31', name: 'Senior Amortisation Type', type: 'select', options: ['Bullet', 'Linear', 'Annuity'], default: 'Linear' },
            { id: 'EffectiveDSCRBuffer_32', name: 'Effective DSCR Buffer (%)', type: 'number', min: 0, max: 50, step: 1, default: 10 }
        ],
        // Mezzanine Debt Parameters (33-47)
        mezzanine: [
            { id: 'TargetDSCRMezz_33', name: 'Target DSCR - Mezz', type: 'number', min: 1.0, max: 2.5, step: 0.05, default: 1.15 },
            { id: 'MezzCoupon_34', name: 'Mezz Coupon (%)', type: 'number', min: 0, max: 30, step: 0.5, default: 12 },
            { id: 'MezzTenorYears_35', name: 'Mezz Tenor Years', type: 'number', min: 1, max: 15, step: 1, default: 5 },
            { id: 'LeaseTermYearsMezz_42', name: 'Lease Term Years - Mezz', type: 'number', min: 1, max: 30, step: 1, default: 10 }
        ],
        // Equity & Capital Stack Parameters (48-65)
        equity: [
            { id: 'TargetEquityIRR_49', name: 'Target Equity IRR (%)', type: 'number', min: 0, max: 50, step: 1, default: 18 },
            { id: 'MinEquityContribution_50', name: 'Min Equity Contribution (£)', type: 'number', min: 0, max: 1000000000, step: 100000, default: 10000000 },
            { id: 'DeveloperEquityIRR_51', name: 'Developer Equity IRR (%)', type: 'number', min: 0, max: 50, step: 1, default: 25 },
            { id: 'EquitySaleUplift_57', name: 'Equity Sale Uplift (%)', type: 'number', min: 0, max: 100, step: 5, default: 20 },
            { id: 'ResidualUpsideCaptureMechanism_61', name: 'Upside Capture', type: 'select', options: ['None', 'Promote', 'Waterfall', 'Ratchet'], default: 'Promote' },
            { id: 'TRSApplied_62', name: 'TRS Applied?', type: 'boolean', default: false },
            { id: 'TRSRetainedUpside_64', name: 'TRS Retained Upside (%)', type: 'number', min: 0, max: 100, step: 5, default: 50 }
        ]
    };

    let currentPermMode = 'manual';
    let activePermParameters = new Set();
    let generatedPermutations = [];

    function initPermutationEngine() {
        const container = document.getElementById('permParametersContainer');
        if (!container) return;
        
        let html = '';
        Object.keys(permParameters).forEach(category => {
            html += `
                <div style="margin-bottom: 2rem;">
                    <div style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 8px; padding: 1rem 1.5rem; margin-bottom: 1rem; cursor: pointer;" onclick="togglePermCategory('${category}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 1.1rem; color: #60a5fa; text-transform: uppercase;">${category} Parameters</span>
                            <span style="background: linear-gradient(135deg, #172554, #1e3a8a); padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.85rem; color: #60a5fa;" id="${category}Count">0 active</span>
                        </div>
                    </div>
                    <div id="${category}Params" style="display: ${category === 'project' ? 'grid' : 'none'}; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1rem;">
                        ${permParameters[category].map(param => createPermParameterCard(param, category)).join('')}
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function createPermParameterCard(param, category) {
        return `
            <div style="background: linear-gradient(135deg, #172554, #1e3a8a); border: 1px solid rgba(96, 165, 250, 0.1); border-radius: 12px; padding: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="color: #60a5fa; font-weight: 600;">${param.name}</span>
                    <input type="checkbox" data-param="${param.id}" data-category="${category}" onchange="togglePermParameter('${param.id}', '${category}')">
                </div>
                <div id="param-input-${param.id}">
                    ${createPermParameterInput(param)}
                </div>
            </div>
        `;
    }

    function createPermParameterInput(param) {
        if (param.type === 'select') {
            return `<select style="width: 100%; padding: 0.5rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 6px; color: white;">
                ${param.options.map(opt => `<option value="${opt}" ${opt === param.default ? 'selected' : ''}>${opt}</option>`).join('')}
            </select>`;
        } else {
            return `<input type="${param.type}" value="${param.default}" style="width: 100%; padding: 0.5rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 6px; color: white;">`;
        }
    }

    function togglePermCategory(category) {
        const params = document.getElementById(`${category}Params`);
        if (params) {
            params.style.display = params.style.display === 'none' ? 'grid' : 'none';
        }
    }

    function togglePermParameter(paramId, category) {
        const checkbox = document.querySelector(`input[data-param="${paramId}"]`);
        if (checkbox.checked) {
            activePermParameters.add(paramId);
        } else {
            activePermParameters.delete(paramId);
        }
        updatePermCategoryCounts();
        updatePermStats();
    }

    function updatePermCategoryCounts() {
        Object.keys(permParameters).forEach(category => {
            const count = permParameters[category].filter(p => activePermParameters.has(p.id)).length;
            const countEl = document.getElementById(`${category}Count`);
            if (countEl) countEl.textContent = `${count} active`;
        });
    }

    function updatePermStats() {
        document.getElementById('statActive').textContent = activePermParameters.size;
        const combinations = Math.min(Math.pow(10, activePermParameters.size), 1000000);
        document.getElementById('statCombinations').textContent = combinations > 1000000 ? '1M+' : combinations;
    }

    function setPermInputMode(mode) {
        currentPermMode = mode;
        document.querySelectorAll('[data-perm-mode]').forEach(btn => {
            if (btn.dataset.permMode === mode) {
                btn.classList.add('active');
                btn.style.background = 'linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%)';
                btn.style.color = '#0a0e27';
            } else {
                btn.classList.remove('active');
                btn.style.background = 'rgba(255, 255, 255, 0.1)';
                btn.style.color = '#60a5fa';
            }
        });
    }

    function selectAllPermParameters() {
        document.querySelectorAll('input[data-param]').forEach(cb => {
            cb.checked = true;
            activePermParameters.add(cb.dataset.param);
        });
        updatePermCategoryCounts();
        updatePermStats();
    }

    function deselectAllPermParameters() {
        document.querySelectorAll('input[data-param]').forEach(cb => cb.checked = false);
        activePermParameters.clear();
        updatePermCategoryCounts();
        updatePermStats();
    }

    function generateAdvancedPermutations() {
        const startTime = Date.now();
        const maxPerms = parseInt(document.getElementById('maxPermutations').value);
        
        // Simple permutation generation for demo
        generatedPermutations = [];
        for (let i = 0; i < Math.min(maxPerms, 100); i++) {
            const perm = {};
            activePermParameters.forEach(paramId => {
                perm[paramId] = Math.random() * 100;
            });
            generatedPermutations.push(perm);
        }
        
        // Update results
        const resultsEl = document.getElementById('permResultsContent');
        let html = '';
        generatedPermutations.forEach((perm, i) => {
            html += `
                <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(96, 165, 250, 0.1); border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
                    <div style="color: #60a5fa; margin-bottom: 0.5rem;">Permutation ${i + 1}</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem;">
                        ${Object.entries(perm).map(([key, val]) => 
                            `<div style="font-size: 0.85rem;"><span style="color: #64748b;">${key}:</span> <span style="color: #2ecc71;">${val.toFixed(2)}</span></div>`
                        ).join('')}
                    </div>
                </div>
            `;
        });
        resultsEl.innerHTML = html || '<div style="text-align: center; padding: 2rem; color: #64748b;">No permutations generated</div>';
        
        // Update stats
        const endTime = Date.now();
        document.getElementById('totalPermutations').textContent = generatedPermutations.length;
        document.getElementById('generatedTime').textContent = new Date().toLocaleTimeString();
        document.getElementById('statTime').textContent = `${endTime - startTime}ms`;
        document.getElementById('statReduction').textContent = '95%';
    }

    function exportPermCSV() {
        if (generatedPermutations.length === 0) {
            alert('No permutations to export');
            return;
        }
        const csv = 'data:text/csv;charset=utf-8,' + Object.keys(generatedPermutations[0]).join(',');
        const link = document.createElement('a');
        link.href = encodeURI(csv);
        link.download = 'permutations.csv';
        link.click();
    }

    function exportPermJSON() {
        if (generatedPermutations.length === 0) {
            alert('No permutations to export');
            return;
        }
        const json = 'data:text/json;charset=utf-8,' + JSON.stringify(generatedPermutations, null, 2);
        const link = document.createElement('a');
        link.href = encodeURI(json);
        link.download = 'permutations.json';
        link.click();
    }

    function loadPermPreset() {
        alert('Loading preset configuration...');
    }

    function savePermPreset() {
        alert('Saving current configuration as preset...');
    }

    function resetPermAll() {
        deselectAllPermParameters();
        generatedPermutations = [];
        document.getElementById('permResultsContent').innerHTML = '<div style="text-align: center; color: #64748b; padding: 3rem;"><i class="fas fa-cube" style="font-size: 3rem; margin-bottom: 1rem;"></i><p>No permutations generated yet</p></div>';
        document.getElementById('totalPermutations').textContent = '0';
        document.getElementById('generatedTime').textContent = '--:--';
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
        initPermutationEngine();
    });
    
    // Timeline View Switcher
    function setTimelineView(view) {
        // Reset all timeline view buttons
        document.querySelectorAll('#timeline-section .btn-secondary').forEach(btn => {
            btn.classList.remove('active');
            btn.style.background = 'rgba(96, 165, 250, 0.1)';
            btn.style.color = '#60a5fa';
        });
        
        // Activate selected view button
        const activeBtn = event.target.closest('button');
        if (activeBtn) {
            activeBtn.classList.add('active');
            activeBtn.style.background = 'linear-gradient(90deg, #60a5fa, #3b82f6)';
            activeBtn.style.color = 'white';
        }
        
        // Here you would implement different view rendering
        console.log('Switching to timeline view:', view);
    }
    
    // Project Management Functions with Drag & Drop
    let projectsData = [];
    let draggedElement = null;
    let draggedIndex = null;

    // Initialize projects when section becomes visible
    function initializeProjects() {
        loadProjects();
        setupProjectsDragAndDrop();
    }

    // Load projects from API
    async function loadProjects() {
        const loadingElement = document.getElementById('projects-loading');
        const gridElement = document.getElementById('projects-grid');
        const emptyElement = document.getElementById('projects-empty');
        const statsElement = document.getElementById('project-stats');

        try {
            loadingElement.style.display = 'block';
            gridElement.style.display = 'none';
            emptyElement.style.display = 'none';
            statsElement.style.display = 'none';

            const response = await fetch('/api/projects');
            if (!response.ok) {
                throw new Error('Failed to load projects');
            }

            projectsData = await response.json();
            
            loadingElement.style.display = 'none';
            
            if (projectsData.length === 0) {
                emptyElement.style.display = 'block';
            } else {
                gridElement.style.display = 'grid';
                statsElement.style.display = 'grid';
                renderProjects();
                updateProjectStats();
            }
        } catch (error) {
            console.error('Error loading projects:', error);
            loadingElement.style.display = 'none';
            
            // Show sample projects for demo
            projectsData = getSampleProjects();
            gridElement.style.display = 'grid';
            statsElement.style.display = 'grid';
            renderProjects();
            updateProjectStats();
        }
    }

    // Create new project
    async function createNewProject() {
        try {
            const response = await fetch('/api/projects', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: 'New Project',
                    description: 'Project description',
                    status: 'draft',
                    value: 0,
                    progress: 0
                })
            });

            if (response.ok) {
                const newProject = await response.json();
                projectsData.push(newProject);
                renderProjects();
                updateProjectStats();
            } else {
                // For demo purposes, create a sample project
                const newProject = {
                    id: 'project-' + Date.now(),
                    title: 'New Project',
                    description: 'Click edit to configure this project',
                    status: 'draft',
                    value: 0,
                    progress: 0,
                    order: projectsData.length
                };
                projectsData.push(newProject);
                
                // Hide empty state if this is the first project
                document.getElementById('projects-empty').style.display = 'none';
                document.getElementById('projects-grid').style.display = 'grid';
                document.getElementById('project-stats').style.display = 'grid';
                
                renderProjects();
                updateProjectStats();
            }
        } catch (error) {
            console.error('Error creating project:', error);
            alert('Failed to create project. Please try again.');
        }
    }

    // Legacy function for compatibility
    function openProjectModal() {
        createNewProject();
    }

    // View project details
    function viewProjectDetails(projectId) {
        console.log('Viewing project:', projectId);
        showProjectSpecifications(projectId, 'view');
    }
    
    // Edit project
    function editProject(projectId) {
        console.log('Editing project:', projectId);
        showProjectSpecifications(projectId, 'edit');
    }

    // Render projects in the grid
    function renderProjects() {
        const gridElement = document.getElementById('projects-grid');
        gridElement.innerHTML = '';

        projectsData.forEach((project, index) => {
            const projectCard = createProjectCard(project, index);
            gridElement.appendChild(projectCard);
        });
    }

    // Create a project card element
    function createProjectCard(project, index) {
        const card = document.createElement('div');
        card.className = 'project-card';
        card.draggable = true;
        card.dataset.index = index;
        card.dataset.projectId = project.id;
        
        const statusColors = {
            'active': { bg: '#22c55e', text: 'Active' },
            'in-progress': { bg: '#60a5fa', text: 'In Progress' },
            'draft': { bg: '#64748b', text: 'Draft' },
            'completed': { bg: '#10b981', text: 'Completed' },
            'paused': { bg: '#f59e0b', text: 'Paused' }
        };

        const status = statusColors[project.status] || statusColors.draft;
        const progressColor = project.status === 'draft' ? '#64748b' : '#60a5fa';
        const progressGradient = project.status === 'draft' ? 
            'linear-gradient(90deg, #64748b, #475569)' : 
            'linear-gradient(90deg, #60a5fa, #3b82f6)';

        card.innerHTML = `
            <div style="cursor: grab;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <h3 style="color: #93c5fd; font-size: 1.25rem; font-weight: 600;">${project.title}</h3>
                    <span style="background: ${status.bg}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem;">${status.text}</span>
                </div>
                <p style="color: #94a3b8; margin-bottom: 1rem; font-size: 0.9rem;">${project.description}</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <p style="color: #64748b; font-size: 0.8rem;">Value</p>
                        <p style="color: #60a5fa; font-weight: 600;">${formatCurrency(project.value)}</p>
                    </div>
                    <div>
                        <p style="color: #64748b; font-size: 0.8rem;">Progress</p>
                        <p style="color: #60a5fa; font-weight: 600;">${project.progress}%</p>
                    </div>
                </div>
                <div style="background: rgba(96, 165, 250, 0.1); border-radius: 4px; height: 8px; margin-bottom: 1rem;">
                    <div style="background: ${progressGradient}; border-radius: 4px; height: 100%; width: ${project.progress}%;"></div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="viewProjectDetails('${project.id}')" style="flex: 1; background: linear-gradient(135deg, #172554, #1e3a8a); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); padding: 8px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                        <i class="fas fa-eye"></i> View
                    </button>
                    <button onclick="editProject('${project.id}')" style="flex: 1; background: linear-gradient(135deg, #172554, #1e3a8a); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); padding: 8px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                </div>
            </div>
        `;

        // Add drag and drop event listeners
        setupCardDragEvents(card);
        
        // Add hover effects with smooth transitions
        card.style.cssText = `
            background: linear-gradient(135deg, #172554, #1e3a8a);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: grab;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            transform: translateZ(0);
        `;
        
        card.addEventListener('mouseenter', function() {
            if (!this.classList.contains('dragging')) {
                this.style.transform = 'translateY(-5px)';
                this.style.boxShadow = '0 10px 30px rgba(96, 165, 250, 0.3)';
            }
        });
        
        card.addEventListener('mouseleave', function() {
            if (!this.classList.contains('dragging')) {
                this.style.transform = '';
                this.style.boxShadow = '';
            }
        });

        return card;
    }

    // Setup drag and drop events for project cards
    function setupCardDragEvents(card) {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
        
        // No longer need individual card drag events as we handle at grid level
    }

    // Setup drag and drop for the projects grid
    function setupProjectsDragAndDrop() {
        const grid = document.getElementById('projects-grid');
        grid.addEventListener('dragover', handleGridDragOver);
        grid.addEventListener('drop', handleGridDrop);
    }

    // Global variables for smooth drag and drop
    let ghostPlaceholder = null;
    let originalNextSibling = null;
    let lastValidDropTarget = null;

    // Create ghost placeholder element
    function createGhostPlaceholder() {
        const placeholder = document.createElement('div');
        placeholder.className = 'drag-placeholder';
        placeholder.style.cssText = `
            height: 200px;
            margin: 0.75rem;
            border: 2px dashed rgba(96, 165, 250, 0.6);
            border-radius: 12px;
            background: rgba(96, 165, 250, 0.1);
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0.9);
        `;
        
        // Add placeholder content
        const content = document.createElement('div');
        content.style.cssText = `
            color: rgba(96, 165, 250, 0.8);
            font-size: 14px;
            text-align: center;
            pointer-events: none;
        `;
        content.innerHTML = `
            <div style="font-size: 24px; margin-bottom: 8px;">↓</div>
            <div>Drop here</div>
        `;
        placeholder.appendChild(content);
        
        return placeholder;
    }

    // Drag event handlers with smooth animations
    function handleDragStart(e) {
        draggedElement = this;
        draggedIndex = parseInt(this.dataset.index);
        
        // Store original position for restoration
        originalNextSibling = this.nextSibling;
        
        // Create and insert ghost placeholder
        ghostPlaceholder = createGhostPlaceholder();
        this.parentNode.insertBefore(ghostPlaceholder, this.nextSibling);
        
        // Animate placeholder in
        setTimeout(() => {
            if (ghostPlaceholder) {
                ghostPlaceholder.style.opacity = '1';
                ghostPlaceholder.style.transform = 'scale(1)';
            }
        }, 50);
        
        // Style the dragged element
        this.classList.add('dragging');
        this.style.opacity = '0.4';
        this.style.cursor = 'grabbing';
        this.style.transform = 'rotate(5deg) scale(1.05)';
        this.style.zIndex = '1000';
        this.style.boxShadow = '0 20px 40px rgba(0, 0, 0, 0.3)';
        
        // Add dragging class to grid for global styles
        document.getElementById('projects-grid').classList.add('dragging-active');
        
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', '');
    }

    function handleDragEnd(e) {
        // Clean up dragged element
        this.classList.remove('dragging');
        this.style.opacity = '';
        this.style.cursor = 'grab';
        this.style.transform = '';
        this.style.zIndex = '';
        this.style.boxShadow = '';
        
        // Remove dragging state from grid
        document.getElementById('projects-grid').classList.remove('dragging-active');
        
        // Remove placeholder with animation
        if (ghostPlaceholder) {
            ghostPlaceholder.style.opacity = '0';
            ghostPlaceholder.style.transform = 'scale(0.9)';
            setTimeout(() => {
                if (ghostPlaceholder && ghostPlaceholder.parentNode) {
                    ghostPlaceholder.parentNode.removeChild(ghostPlaceholder);
                }
                ghostPlaceholder = null;
            }, 300);
        }
        
        // Clean up all card effects
        document.querySelectorAll('.project-card').forEach(card => {
            card.classList.remove('drag-over', 'drag-over-top', 'drag-over-bottom');
            card.style.transform = '';
        });
        
        // Reset variables
        lastValidDropTarget = null;
        originalNextSibling = null;
    }

    function handleGridDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        
        if (!draggedElement || !ghostPlaceholder) return;
        
        const grid = document.getElementById('projects-grid');
        const afterElement = getDragAfterElement(grid, e.clientY);
        const cards = [...grid.querySelectorAll('.project-card:not(.dragging)')];
        
        // Find the card we're hovering over
        const hoveredCard = e.target.closest('.project-card');
        
        if (hoveredCard && hoveredCard !== draggedElement) {
            const hoveredRect = hoveredCard.getBoundingClientRect();
            const mouseY = e.clientY;
            const cardCenterY = hoveredRect.top + hoveredRect.height / 2;
            
            // Determine if we're in the top or bottom half
            const isTopHalf = mouseY < cardCenterY;
            
            // Remove previous hover effects
            cards.forEach(card => {
                card.classList.remove('drag-over-top', 'drag-over-bottom');
            });
            
            // Add hover effect to current card
            hoveredCard.classList.add(isTopHalf ? 'drag-over-top' : 'drag-over-bottom');
            
            // Move placeholder to appropriate position
            if (isTopHalf) {
                hoveredCard.parentNode.insertBefore(ghostPlaceholder, hoveredCard);
            } else {
                hoveredCard.parentNode.insertBefore(ghostPlaceholder, hoveredCard.nextSibling);
            }
            
            lastValidDropTarget = hoveredCard;
        } else if (afterElement === null) {
            // Dragging to the end
            grid.appendChild(ghostPlaceholder);
            cards.forEach(card => {
                card.classList.remove('drag-over-top', 'drag-over-bottom');
            });
        }
    }

    function handleGridDrop(e) {
        e.preventDefault();
        
        if (!draggedElement || !ghostPlaceholder) return;
        
        // Get all cards and find the new index
        const grid = document.getElementById('projects-grid');
        const allElements = [...grid.children];
        const placeholderIndex = allElements.indexOf(ghostPlaceholder);
        
        // Calculate the new index accounting for the dragged element
        let newIndex = placeholderIndex;
        if (draggedIndex < placeholderIndex) {
            newIndex--; // Account for the dragged element being removed
        }
        
        // Only reorder if the position actually changed
        if (newIndex !== draggedIndex && newIndex >= 0) {
            reorderProjects(draggedIndex, newIndex);
        }
    }

    // Helper function to find the element after which we should insert
    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.project-card:not(.dragging)')];
        
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // Reorder projects and save to backend
    async function reorderProjects(fromIndex, toIndex) {
        if (fromIndex === toIndex) return;

        // Move project in array
        const [movedProject] = projectsData.splice(fromIndex, 1);
        projectsData.splice(toIndex, 0, movedProject);

        // Update order values
        projectsData.forEach((project, index) => {
            project.order = index;
        });

        // Re-render projects
        renderProjects();

        // Save new order to backend
        await saveProjectOrder();
    }

    // Save project order to backend
    async function saveProjectOrder() {
        try {
            const orderData = projectsData.map((project, index) => ({
                id: project.id,
                order: index
            }));

            const response = await fetch('/api/projects/order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ projects: orderData })
            });

            if (!response.ok) {
                console.warn('Failed to save project order to backend');
            }
        } catch (error) {
            console.error('Error saving project order:', error);
        }
    }

    // Update project statistics
    function updateProjectStats() {
        const stats = {
            active: 0,
            inProgress: 0,
            drafts: 0,
            totalValue: 0
        };

        projectsData.forEach(project => {
            switch (project.status) {
                case 'active':
                    stats.active++;
                    break;
                case 'in-progress':
                    stats.inProgress++;
                    break;
                case 'draft':
                    stats.drafts++;
                    break;
            }
            stats.totalValue += project.value || 0;
        });

        document.getElementById('active-count').textContent = stats.active;
        document.getElementById('progress-count').textContent = stats.inProgress;
        document.getElementById('draft-count').textContent = stats.drafts;
        document.getElementById('total-value').textContent = formatCurrency(stats.totalValue);
    }

    // Format currency
    function formatCurrency(value) {
        if (value === 0) return '€0';
        if (value >= 1000000000) {
            return '€' + (value / 1000000000).toFixed(1) + 'B';
        }
        if (value >= 1000000) {
            return '€' + (value / 1000000).toFixed(0) + 'M';
        }
        if (value >= 1000) {
            return '€' + (value / 1000).toFixed(0) + 'K';
        }
        return '€' + value.toLocaleString();
    }

    // Sample projects for demo
    function getSampleProjects() {
        return [
            {
                id: 'infrastructure-2024',
                title: 'Infrastructure Bond 2024',
                description: '€500M infrastructure financing project for renewable energy development',
                status: 'active',
                value: 500000000,
                progress: 65,
                order: 0
            },
            {
                id: 'realestate-clo',
                title: 'Real Estate CLO',
                description: 'Commercial real estate collateralized loan obligation structure',
                status: 'in-progress',
                value: 750000000,
                progress: 40,
                order: 1
            },
            {
                id: 'auto-abs',
                title: 'Auto Loan ABS',
                description: 'Asset-backed securities for automotive loan portfolio',
                status: 'draft',
                value: 300000000,
                progress: 15,
                order: 2
            }
        ];
    }

    // Initialize projects when projects section is shown
    document.addEventListener('DOMContentLoaded', function() {
        // Override the showSection function to initialize projects
        const originalShowSection = window.showSection;
        window.showSection = function(sectionId) {
            originalShowSection(sectionId);
            if (sectionId === 'projects') {
                setTimeout(initializeProjects, 100);
            }
        };
    });
    
    function showProjectSpecifications(projectId = null, mode = 'new') {
        const projectEditorSection = document.getElementById('project-editor-section');
        const projectEditorTitle = document.getElementById('project-editor-title');
        const projectEditorContent = document.getElementById('project-editor-content');
        
        // Set the title based on mode
        if (mode === 'edit') {
            projectEditorTitle.textContent = 'Edit Project';
        } else {
            projectEditorTitle.textContent = 'View Project';
        }
        
        // Build URL with parameters
        let url = '/project-specifications';
        const params = [];
        if (projectId) params.push('project=' + projectId);
        if (mode) params.push('mode=' + mode);
        if (params.length > 0) url += '?' + params.join('&');
        
        // Create or update iframe in the content area
        let iframe = projectEditorContent.querySelector('iframe');
        if (!iframe) {
            iframe = document.createElement('iframe');
            iframe.style.cssText = `
                width: 100%;
                height: 800px;
                border: none;
                border-radius: 8px;
                background: white;
            `;
            projectEditorContent.innerHTML = '';
            projectEditorContent.appendChild(iframe);
        }
        
        // Update iframe source and show the editor section
        iframe.src = url;
        projectEditorSection.style.display = 'block';
        
        // Scroll to the editor section
        projectEditorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function closeProjectEditor() {
        const projectEditorSection = document.getElementById('project-editor-section');
        const projectEditorContent = document.getElementById('project-editor-content');
        
        // Hide the editor section
        projectEditorSection.style.display = 'none';
        
        // Clear iframe source to stop any running scripts
        const iframe = projectEditorContent.querySelector('iframe');
        if (iframe) {
            iframe.src = 'about:blank';
        }
    }
    
    // Legacy function for compatibility
    function closeProjectSpecifications() {
        closeProjectEditor();
    }
    
    // Document link hover effects
    document.addEventListener('DOMContentLoaded', function() {
        // Add hover effects to document links
        const docLinks = document.querySelectorAll('.doc-link');
        docLinks.forEach(link => {
            link.addEventListener('mouseenter', function() {
                this.style.background = 'rgba(96, 165, 250, 0.2)';
                this.style.transform = 'translateX(5px)';
            });
            link.addEventListener('mouseleave', function() {
                this.style.background = 'rgba(96, 165, 250, 0.1)';
                this.style.transform = 'translateX(0)';
            });
        });
        
        // FAQ details animation
        const detailsElements = document.querySelectorAll('details');
        detailsElements.forEach(details => {
            details.addEventListener('toggle', function() {
                const icon = this.querySelector('.fa-chevron-down');
                if (icon) {
                    if (this.open) {
                        icon.style.transform = 'rotate(180deg)';
                    } else {
                        icon.style.transform = 'rotate(0deg)';
                    }
                }
            });
        });
    });
    </script>
    
    <!-- Market News Script -->
    <script src="/static/js/market-news.js"></script>
    
    <!-- Smooth Keyboard Scrolling -->
    <script src="{{ url_for('static', filename='js/smooth-scroll.js') }}"></script>
</body>
</html>