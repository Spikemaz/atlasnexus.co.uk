<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>AtlasNexus - Securitisation Command Centre</title>
    
    <!-- Hexagon Favicon for Main Site (ICO for Chrome compatibility, SVG fallback) -->
    <link rel="shortcut icon" href="/static/favicon-hexagon.ico" type="image/x-icon">
    <link rel="icon" href="/static/favicon-hexagon.ico" type="image/x-icon">
    <link rel="icon" type="image/svg+xml" href="/static/favicon-hexagon.svg">
    <link rel="apple-touch-icon" href="/static/favicon-hexagon.svg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700;800&family=SF+Pro+Text:wght@400;500;600&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Modern Financial Institution Palette */
            --deep-charcoal: #1A1D23;
            --slate-grey: #2C3137;
            --steel-blue: #364049;
            --silver-mist: #92969C;
            --silver-light: #94a3b8;
            --pearl-grey: #E5E9F0;
            --pure-white: #FFFFFF;
            
            /* Accent Colors */
            --platinum-gold: #60a5fa;
            --amber-yellow: #93c5fd;
            --market-green: #22C55E;
            --market-red: #EF4444;
            --emerald-green: #059669;
            --crimson-red: #B91C1C;
            --royal-blue: #4169E1;
            
            /* Typography */
            --font-display: 'SF Pro Display', -apple-system, system-ui, sans-serif;
            --font-text: 'SF Pro Text', -apple-system, system-ui, sans-serif;
            --font-mono: 'JetBrains Mono', 'Courier New', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-text);
            background: var(--deep-charcoal);
            color: var(--pearl-grey);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
        }
        
        /* Global text color fixes for dark theme */
        .text-muted {
            color: #94a3b8 !important; /* Light silver for muted text */
        }
        
        .text-secondary {
            color: #92969C !important; /* Medium silver for secondary text */
        }
        
        .small {
            color: #94a3b8 !important; /* Ensure small text is visible */
        }
        
        label {
            color: #94a3b8 !important; /* Ensure labels are visible */
        }
        
        /* Override Bootstrap dark text colors */
        .text-dark {
            color: #E5E9F0 !important;
        }
        
        /* Ensure all headings are visible */
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
            color: #E5E9F0 !important;
        }
        
        /* Table text colors */
        .table-dark {
            color: #E5E9F0 !important;
        }
        
        .table-dark th,
        .table-dark td {
            color: #E5E9F0 !important;
        }
        
        /* Ensure all paragraph text is visible */
        p {
            color: #94a3b8 !important;
        }
        
        /* Fix any remaining dark text */
        div, span {
            color: inherit;
        }

        /* Premium Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0e27, #020617);
            z-index: -2;
        }

        /* Animated Mesh Gradient */
        .gradient-mesh {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.4;
            z-index: -1;
            background: 
                radial-gradient(circle at 20% 50%, rgba(96, 165, 250, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(65, 105, 225, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(34, 197, 94, 0.1) 0%, transparent 50%);
            animation: meshMove 20s ease-in-out infinite;
        }

        @keyframes meshMove {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(-20px, -20px) rotate(1deg); }
            66% { transform: translate(20px, -10px) rotate(-1deg); }
        }

        /* Premium Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #0a0e27, #020617);
            border-bottom: 2px solid var(--platinum-gold);
            z-index: 1000;
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
            height: 70px;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Market Ticker - Working version from Gate2 */
        .market-ticker-container {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            width: 100%;
            overflow: hidden;
            background: linear-gradient(135deg, #0a0e27, #020617);
            border-top: 1px solid rgba(96, 165, 250, 0.3);
            border-bottom: 1px solid rgba(96, 165, 250, 0.3);
            padding: 12px 0;
            cursor: grab;
            user-select: none;
            height: auto;
            min-height: 45px;
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .market-ticker-container.dragging {
            cursor: grabbing;
        }

        .market-ticker {
            display: flex;
            width: max-content;
            will-change: transform;
            transition: transform 0.5s linear;
            padding-left: 0;
            margin-left: 0;
        }

        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .ticker-content {
            display: flex;
            width: max-content;
        }
        
        .ticker-group {
            display: flex;
            gap: 2rem;
            padding-right: 2rem;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .ticker-item {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0 1rem;
            border-right: 1px solid rgba(96, 165, 250, 0.2);
            white-space: nowrap;
        }

        .ticker-symbol {
            font-weight: 700;
            color: #93c5fd;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .ticker-value {
            color: #ffffff;
            font-size: 0.85rem;
            font-family: var(--font-mono);
        }

        .ticker-section-header {
            display: inline-block;
            padding: 0 1rem;
            color: var(--platinum-gold);
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .ticker-symbol {
            font-weight: 700;
            color: #93c5fd !important;
            font-size: 0.85rem;
            font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif;
            display: inline-block;
            text-transform: uppercase;
        }
        
        .ticker-value {
            color: #ffffff !important;
            font-size: 0.85rem;
            font-family: 'JetBrains Mono', monospace;
            display: inline-block;
        }
        
        .ticker-section-header {
            display: inline-block;
            padding: 0 1rem;
            color: #60a5fa;
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .ticker-separator {
            color: rgba(96, 165, 250, 0.4);
            margin: 0 0.5rem;
        }

        /* Main Container */
        .main-container {
            margin-top: 165px; /* Account for header + ticker + nav bar */
            padding: 2rem;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Animation Classes */
        .fade-in-up {
            opacity: 0;
            transform: translateY(30px);
        }
        
        .fade-in-up.animated {
            animation: fadeInUp 0.8s ease forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .animated-atlas-nexus {
            animation: gradientShift 3s ease infinite;
            background-size: 200% 200%;
        }

        .hover-lift {
            transition: all 0.3s ease;
        }

        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* Cards - FORCE DARK BLUE - DO NOT OVERRIDE */
        .card, 
        div.card,
        .card.shadow-lg,
        .card.fade-in-up {
            background: linear-gradient(135deg, #0a0e27, #020617) !important;
            background-image: linear-gradient(135deg, #0a0e27, #020617) !important;
            border: 1px solid rgba(96, 165, 250, 0.2);
            backdrop-filter: blur(10px);
            color: #ffffff !important;
        }
        
        .card-body {
            color: #E5E9F0 !important; /* Light text for card bodies */
        }

        .stat-card,
        div.stat-card,
        .stat-card.hover-lift {
            background: linear-gradient(135deg, #0a0e27, #020617) !important;
            background-image: linear-gradient(135deg, #0a0e27, #020617) !important;
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            color: #ffffff !important;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--platinum-gold);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            /* Fix header for mobile */
            .header {
                flex-direction: column;
                padding: 15px;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 1000;
            }
            
            .header-left {
                margin-bottom: 10px;
                text-align: center;
            }
            
            .header-right {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .header-btn {
                width: 100%;
                padding: 10px !important;
                font-size: 0.9rem !important;
            }
            
            /* Fix ticker for mobile */
            .market-ticker-container {
                top: 100px !important;
                height: 40px;
                min-height: 40px;
                padding: 8px 0;
            }
            
            .market-ticker {
                font-size: 0.75rem;
            }
            
            .ticker-item {
                margin: 0 8px !important;
            }
            
            /* Fix toolbar for mobile */
            .toolbar {
                top: 140px !important;
                padding: 10px;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .nav-btn {
                padding: 8px 12px !important;
                font-size: 0.8rem !important;
                min-width: auto;
            }
            
            /* Fix main container for mobile */
            .main-container {
                margin-top: 200px !important;
                padding: 1rem;
            }
            
            /* Fix cards for mobile */
            .card {
                margin-bottom: 15px;
            }
            
            .card-body {
                padding: 15px !important;
            }
            
            /* Fix stats cards for mobile */
            .stats-card {
                padding: 15px !important;
            }
            
            .stats-card h3 {
                font-size: 1.5rem !important;
            }
            
            .stats-card p {
                font-size: 0.8rem !important;
            }
            
            /* Fix footer for mobile */
            footer {
                padding: 20px 10px !important;
            }
            
            footer .container {
                padding: 0 !important;
            }
            
            footer h4 {
                font-size: 1rem !important;
            }
            
            footer a {
                font-size: 0.85rem !important;
            }
            
            /* Hide some elements on mobile for cleaner view */
            .desktop-only {
                display: none !important;
            }
            
            /* Fix sections for mobile */
            #market-section, #data-section, #analytics-section, 
            #risk-section, #portfolio-section, #compliance-section {
                padding: 200px 1rem 2rem !important;
            }
            
            /* Fix dropdown for mobile */
            .dropdown-content {
                width: 100%;
                right: 0;
                left: 0;
            }
            
            /* Fix chart container for mobile */
            canvas {
                max-width: 100% !important;
                height: auto !important;
            }
            
            /* Fix table responsiveness */
            table {
                font-size: 0.8rem;
            }
            
            th, td {
                padding: 8px !important;
            }
            
            /* Fix modals for mobile */
            .modal-content {
                width: 95% !important;
                margin: 10px !important;
            }
        }
        
        @media (max-width: 480px) {
            /* Extra small devices */
            .header {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.2rem !important;
            }
            
            .market-ticker-container {
                font-size: 0.65rem;
            }
            
            .toolbar {
                padding: 8px 5px;
            }
            
            .nav-btn {
                padding: 6px 10px !important;
                font-size: 0.75rem !important;
            }
            
            .main-container {
                padding: 0.5rem;
            }
            
            .card-title {
                font-size: 1rem !important;
            }
            
            footer {
                font-size: 0.8rem;
            }
        }
        
        /* Ensure horizontal scrolling is prevented */
        body {
            overflow-x: hidden;
        }
        
        /* Mobile-specific utility classes */
        @media (max-width: 768px) {
            .mobile-center {
                text-align: center !important;
            }
            
            .mobile-full-width {
                width: 100% !important;
            }
            
            .mobile-padding {
                padding: 10px !important;
            }
            
            .hide-mobile {
                display: none !important;
            }
        }
        
        @media (min-width: 769px) {
            .show-mobile {
                display: none !important;
            }
        }

        /* Smooth Drag and Drop Styles */
        .project-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        .project-card.dragging {
            opacity: 0.4 !important;
            transform: rotate(5deg) scale(1.05) !important;
            z-index: 1000 !important;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important;
            cursor: grabbing !important;
        }

        .project-card.drag-over-top {
            transform: translateY(-10px) !important;
            border-top: 3px solid rgba(96, 165, 250, 0.8) !important;
            box-shadow: 0 -5px 15px rgba(96, 165, 250, 0.4) !important;
        }

        .project-card.drag-over-bottom {
            transform: translateY(10px) !important;
            border-bottom: 3px solid rgba(96, 165, 250, 0.8) !important;
            box-shadow: 0 5px 15px rgba(96, 165, 250, 0.4) !important;
        }

        /* Global styles when dragging is active */
        .projects-grid.dragging-active .project-card:not(.dragging) {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .projects-grid.dragging-active .project-card:not(.dragging):hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(96, 165, 250, 0.2);
        }

        /* Drag placeholder styles */
        .drag-placeholder {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            border: 2px dashed rgba(96, 165, 250, 0.6) !important;
            border-radius: 12px !important;
            background: rgba(96, 165, 250, 0.1) !important;
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 15px rgba(96, 165, 250, 0.3);
                border-color: rgba(96, 165, 250, 0.6);
            }
            50% {
                box-shadow: 0 0 25px rgba(96, 165, 250, 0.5);
                border-color: rgba(96, 165, 250, 0.8);
            }
        }

        /* Smooth scrolling for better UX during drag */
        html {
            scroll-behavior: smooth;
        }

        /* Enhanced feedback on card hover when not dragging */
        .project-card:not(.dragging):hover {
            transform: translateY(-5px) !important;
            box-shadow: 0 10px 30px rgba(96, 165, 250, 0.3) !important;
        }
    </style>
</head>
<body>
    <!-- Animated Gradient Mesh -->
    <div class="gradient-mesh"></div>

    <!-- Header from Gate2 -->
    <header class="header">
        <div class="header-content">
            <!-- Logo from Gate2 -->
            <div class="logo" style="display: flex; align-items: center; gap: 12px;">
                <div style="position: relative; width: 32px; height: 32px;">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" style="overflow: visible;">
                        <!-- Rotating hexagon -->
                        <path d="M16 3L26.5 9.5V22.5L16 29L5.5 22.5V9.5L16 3Z" stroke="#93c5fd" stroke-width="2" fill="rgba(147, 197, 253, 0.08)">
                            <animateTransform attributeName="transform" type="rotate" from="0 16 16" to="360 16 16" dur="8s" repeatCount="indefinite"/>
                        </path>
                        <!-- Inner hexagon -->
                        <path d="M16 8L22 11.5V20.5L16 24L10 20.5V11.5L16 8Z" stroke="rgba(147, 197, 253, 0.4)" stroke-width="1"/>
                        <!-- Center circle -->
                        <circle cx="16" cy="16" r="3" fill="#dbeafe"/>
                        <!-- Orbiting dot -->
                        <g>
                            <animateTransform attributeName="transform" type="rotate" from="0 16 16" to="360 16 16" dur="3s" repeatCount="indefinite"/>
                            <circle cx="16" cy="1" r="1.5" fill="#60a5fa">
                                <animate attributeName="opacity" values="0.4;1;0.4" dur="1.5s" repeatCount="indefinite"/>
                            </circle>
                        </g>
                    </svg>
                </div>
                <div style="display: flex; align-items: center;">
                    <span style="font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif; font-size: 1.35rem; font-weight: 700; background: linear-gradient(90deg, #dbeafe, #93c5fd); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ATLAS</span>
                    <span style="font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif; font-size: 1.2rem; font-weight: 400; color: #60a5fa; margin: 0 4px;">:</span>
                    <span style="font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif; font-size: 1.35rem; font-weight: 700; background: linear-gradient(90deg, #93c5fd, #dbeafe); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">NEXUS</span>
                </div>
            </div>
            <!-- User Info Section -->
            <div class="user-section" style="display: flex; align-items: center; gap: 1rem; color: rgba(255, 255, 255, 0.8);">
                <span style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                    <span style="width: 8px; height: 8px; background: #00ff00; border-radius: 50%; box-shadow: 0 0 10px #00ff00;"></span>
                    Dashboard Active
                </span>
                {% if is_admin %}
                <a href="/admin-panel" style="background: linear-gradient(135deg, #0a0e27, #020617); color: white; border: 1px solid rgba(96, 165, 250, 0.3); padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block;">
                    <i class="fas fa-cog"></i> Control Panel
                </a>
                {% endif %}
                <a href="/account" style="background: linear-gradient(135deg, #0a0e27, #020617); color: white; border: 1px solid rgba(96, 165, 250, 0.3); padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block;">
                    <i class="fas fa-user"></i> Account
                </a>
                <a href="/logout" style="background: linear-gradient(90deg, #ef4444, #dc2626); color: white; border: none; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; text-decoration: none;">
                    Logout
                </a>
            </div>
        </div>
    </header>

    <!-- Market Ticker -->
    <div class="market-ticker-container" id="tickerContainer">
        <div class="market-ticker" id="marketTicker">
            <!-- Content populated by JavaScript -->
        </div>
    </div>

    <!-- Define showSection immediately before navigation bar -->
    <script>
        // Get user context from template variables
        const isAdmin = {{ 'true' if is_admin else 'false' }};
        const accountType = '{{ account_type }}';
        const userEmail = '{{ session.get("user_email_" + request.remote_addr, "") }}';
        
        // Define showSection immediately so it's available for navigation buttons
        function showSection(section) {
            console.log('Switching to section:', section);
            
            // Restrict permutation section to admin users only
            if (section === 'permutation' && !isAdmin) {
                alert('Access Denied: The Permutation Engine is only available to admin users.');
                return;
            }
            
            // Hide all sections
            const allSections = ['main-dashboard', 'market-section', 'data-section', 'analytics-section', 
                               'risk-section', 'portfolio-section', 'compliance-section', 'permutation-section',
                               'securitization-section', 'documents-section', 'timeline-section', 'reports-section', 'support-section', 'projects-section'];
            
            allSections.forEach(sectionId => {
                const element = document.getElementById(sectionId);
                if (element) {
                    element.style.display = 'none';
                }
            });
            
            // Show the selected section
            let targetSection = section;
            if (section === 'dashboard') {
                targetSection = 'main-dashboard';
            } else if (!section.includes('-section')) {
                targetSection = section + '-section';
            }
            
            const targetElement = document.getElementById(targetSection);
            if (targetElement) {
                targetElement.style.display = 'block';
                
                // Instantly jump to top first for immediate feedback
                document.documentElement.scrollTop = 0;
                document.body.scrollTop = 0; // For Safari
                
                // Also ensure the section itself is scrolled to top if it has its own scroll
                targetElement.scrollTop = 0;
                
                // Then do a smooth scroll for visual polish (optional - already at top)
                // This creates a nice "refresh" feeling
                setTimeout(() => {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }, 10);
            }
            
            // Update navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.style.background = 'transparent';
                btn.style.color = '#ffffff';
            });
            
            const activeBtn = document.querySelector(`.nav-btn[data-section="${section}"]`);
            if (activeBtn) {
                activeBtn.style.background = 'linear-gradient(135deg, #1e3a8a, #1e40af)';
                activeBtn.style.color = 'white';
            }
            
            // Special handling for projects section
            if (section === 'projects' && typeof initializeProjects === 'function') {
                setTimeout(initializeProjects, 100);
            }
        }
        
        // Toolbar auto-hide on scroll
        let lastScrollTop = 0;
        let scrollTimeout;
        
        window.addEventListener('scroll', function() {
            const navBar = document.getElementById('navBar');
            if (!navBar) return;
            
            let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            // Clear any existing timeout
            clearTimeout(scrollTimeout);
            
            if (scrollTop > lastScrollTop && scrollTop > 150) {
                // Scrolling down - hide navbar
                navBar.style.top = '-60px';
                navBar.style.opacity = '0';
            } else {
                // Scrolling up - show navbar
                navBar.style.top = '115px';
                navBar.style.opacity = '1';
            }
            
            lastScrollTop = scrollTop;
            
            // Always show navbar when scroll stops
            scrollTimeout = setTimeout(() => {
                navBar.style.top = '115px';
                navBar.style.opacity = '1';
            }, 1000);
        });
    </script>

    <!-- Navigation Bar -->
    <div id="navBar" style="position: fixed; top: 115px; left: 0; right: 0; background: linear-gradient(135deg, #0a0e27, #020617); border-bottom: 1px solid rgba(96, 165, 250, 0.3); z-index: 998; padding: 10px 0; transition: top 0.3s ease, opacity 0.3s ease; opacity: 1;">
        <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; flex-wrap: wrap;">
            <button class="nav-btn" data-section="dashboard" onclick="showSection('dashboard')" style="background: linear-gradient(135deg, #1e3a8a, #1e40af); color: white; border: 1px solid #3b82f6; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-home"></i> Dashboard
            </button>
            {% if account_type == 'external' %}
            <!-- External accounts have streamlined project management tools -->
            <button class="nav-btn" data-section="market" onclick="showSection('market')" style="background: transparent; color: #ffffff; border: 1px solid rgba(96, 165, 250, 0.3); padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-chart-line"></i> Market
            </button>
            <button class="nav-btn" data-section="projects" onclick="showSection('projects')" style="background: transparent; color: #ffffff; border: 1px solid rgba(96, 165, 250, 0.3); padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-folder"></i> Projects
            </button>
            <button class="nav-btn" data-section="documents" onclick="showSection('documents')" style="background: transparent; color: #ffffff; border: 1px solid rgba(96, 165, 250, 0.3); padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-file-contract"></i> Documents
            </button>
            <button class="nav-btn" data-section="timeline" onclick="showSection('timeline')" style="background: transparent; color: #ffffff; border: 1px solid rgba(96, 165, 250, 0.3); padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-calendar-alt"></i> Timeline
            </button>
            <button class="nav-btn" data-section="reports" onclick="showSection('reports')" style="background: transparent; color: #ffffff; border: 1px solid rgba(96, 165, 250, 0.3); padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-file-pdf"></i> Reports
            </button>
            <button class="nav-btn" data-section="support" onclick="showSection('support')" style="background: transparent; color: #ffffff; border: 1px solid rgba(96, 165, 250, 0.3); padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-headset"></i> Support
            </button>
            {% else %}
            <!-- Admin and Internal accounts see additional options -->
            <button class="nav-btn" data-section="market" onclick="showSection('market')" style="background: transparent; color: #ffffff; border: 1px solid rgba(96, 165, 250, 0.3); padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-chart-line"></i> Market
            </button>
            <button class="nav-btn" data-section="analytics" onclick="showSection('analytics')" style="background: transparent; color: #ffffff; border: 1px solid rgba(96, 165, 250, 0.3); padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-chart-bar"></i> Analytics
            </button>
            <button class="nav-btn" data-section="risk" onclick="showSection('risk')" style="background: transparent; color: #ffffff; border: 1px solid rgba(96, 165, 250, 0.3); padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-shield-alt"></i> Risk
            </button>
            <button class="nav-btn" data-section="portfolio" onclick="showSection('portfolio')" style="background: transparent; color: #ffffff; border: 1px solid rgba(96, 165, 250, 0.3); padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-briefcase"></i> Portfolio
            </button>
            <button class="nav-btn" data-section="compliance" onclick="showSection('compliance')" style="background: transparent; color: #ffffff; border: 1px solid rgba(96, 165, 250, 0.3); padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-gavel"></i> Compliance
            </button>
            <button class="nav-btn" data-section="projects" onclick="showSection('projects')" style="background: transparent; color: #ffffff; border: 1px solid rgba(96, 165, 250, 0.3); padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-folder"></i> Projects
            </button>
            {% if is_admin %}
            <button class="nav-btn" data-section="permutation" onclick="showSection('permutation')" style="background: transparent; color: #ffffff; border: 1px solid rgba(96, 165, 250, 0.3); padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-cogs"></i> Permutation
            </button>
            {% endif %}
            <button class="nav-btn" data-section="securitization" onclick="showSection('securitization')" style="background: transparent; color: #ffffff; border: 1px solid rgba(96, 165, 250, 0.3); padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-layer-group"></i> Securitization
            </button>
            {% endif %}
        </div>
    </div>
    
    <!-- Toggle Button -->
    <button onclick="(function(){
        var nav = document.getElementById('navBar');
        var icon = document.getElementById('navToggleIcon');
        var mainDashboard = document.getElementById('main-dashboard');
        var sections = document.querySelectorAll('#market-section, #data-section, #analytics-section, #risk-section, #portfolio-section, #compliance-section, #permutation-section, #securitization-section');
        
        if (nav.getAttribute('data-hidden') === 'true') {
            // Show toolbar - slide down smoothly
            nav.style.top = '115px';
            nav.style.opacity = '1';
            nav.setAttribute('data-hidden', 'false');
            icon.className = 'fas fa-chevron-up';
            // Adjust padding for sections when toolbar is visible
            setTimeout(function() {
                sections.forEach(function(s) { 
                    if(s) s.style.paddingTop = '185px'; 
                });
                if(mainDashboard) mainDashboard.style.marginTop = '165px';
            }, 50);
        } else {
            // Hide toolbar - slide up smoothly
            nav.style.top = '70px'; // Hide behind header
            nav.style.opacity = '0';
            nav.setAttribute('data-hidden', 'true');
            icon.className = 'fas fa-chevron-down';
            // Reduce padding for sections when toolbar is hidden - make dashboard consistent with others
            setTimeout(function() {
                sections.forEach(function(s) { 
                    if(s) s.style.paddingTop = '135px'; 
                });
                if(mainDashboard) mainDashboard.style.marginTop = '135px'; // Same as other sections now
            }, 50);
        }
    })()" style="position: fixed; top: 115px; right: 20px; background: linear-gradient(135deg, #0a0e27, #020617); color: white; border: 1px solid rgba(96, 165, 250, 0.3); padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; z-index: 999;">
        <i class="fas fa-chevron-up" id="navToggleIcon"></i> Tools
    </button>

    <!-- Main Dashboard Content -->
    <div class="main-container" id="main-dashboard" style="display: block; margin-top: 165px; transition: margin-top 0.3s ease;">
        <!-- Executive Dashboard Header -->
        <div class="row mb-4 fade-in-up">
            <div class="col-12">
                <div class="card shadow-lg" style="border-radius: 20px;">
                    <div class="card-body p-4 text-white">
                        <div class="row align-items-center">
                            <div class="col-lg-8">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="bg-white bg-opacity-10 rounded-circle p-3 me-4">
                                        <i class="fas fa-chart-line fa-2x"></i>
                                    </div>
                                    <div>
                                        <h1 class="display-6 fw-bold mb-1">Securitisation Command Centre</h1>
                                        <p class="lead mb-0 opacity-90">
                                            <span class="animated-atlas-nexus" style="font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif; font-size: 1.1rem; font-weight: 700; background: linear-gradient(90deg, #dbeafe, #93c5fd, #60a5fa, #93c5fd, #dbeafe); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-size: 200% 200%;">ATLAS</span>
                                            <span style="font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif; font-size: 1rem; font-weight: 400; color: #60a5fa; margin: 0 4px;">:</span>
                                            <span class="animated-atlas-nexus" style="font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif; font-size: 1.1rem; font-weight: 700; background: linear-gradient(90deg, #93c5fd, #dbeafe, #60a5fa, #dbeafe, #93c5fd); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-size: 200% 200%;">NEXUS</span>
                                        </p>
                                    </div>
                                </div>
                                <div class="row g-3">
                                    <div class="col-auto">
                                        <div class="badge bg-success bg-opacity-90 text-white px-3 py-2">
                                            <i class="fas fa-circle me-2"></i>Live Markets
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="badge bg-info bg-opacity-90 text-white px-3 py-2">
                                            <i class="fas fa-user-tie me-2"></i>{{ account_type }} Access
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="badge bg-dark bg-opacity-75 text-white px-3 py-2">
                                            <i class="fas fa-calendar me-2"></i><span id="currentDate"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 text-end">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="text-center">
                                            <div class="h2 fw-bold mb-0" id="aumCounter">€127.5B</div>
                                            <small class="opacity-75">Assets Under Management</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center">
                                            <div class="h2 fw-bold mb-0" id="dealsCounter">342</div>
                                            <small class="opacity-75">Active Structures</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-Time KPI Grid -->
        <div class="row g-4 mb-4">
            <div class="col-lg-3 col-md-6 fade-in-up" style="animation-delay: 0.1s">
                <div class="stat-card hover-lift">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="small fw-semibold mb-1" style="color: rgba(255, 255, 255, 0.9);">TOTAL AUM</div>
                            <div class="h3 fw-bold text-primary mb-0">€2.4B</div>
                            <div class="text-success small">
                                <i class="fas fa-arrow-up me-1"></i>+12.3% YoY
                            </div>
                        </div>
                        <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-euro-sign fa-lg text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 fade-in-up" style="animation-delay: 0.2s">
                <div class="stat-card hover-lift">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="small fw-semibold mb-1" style="color: rgba(255, 255, 255, 0.9);">ACTIVE DEALS</div>
                            <div class="h3 fw-bold text-success mb-0">127</div>
                            <div class="text-info small">
                                <i class="fas fa-plus me-1"></i>8 new this week
                            </div>
                        </div>
                        <div class="bg-success bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-handshake fa-lg text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 fade-in-up" style="animation-delay: 0.3s">
                <div class="stat-card hover-lift">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="small fw-semibold mb-1" style="color: rgba(255, 255, 255, 0.9);">AVG DSCR</div>
                            <div class="h3 fw-bold text-warning mb-0">1.47x</div>
                            <div class="text-success small">
                                <i class="fas fa-arrow-up me-1"></i>+0.08 vs target
                            </div>
                        </div>
                        <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-chart-bar fa-lg text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 fade-in-up" style="animation-delay: 0.4s">
                <div class="stat-card hover-lift">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="small fw-semibold mb-1" style="color: rgba(255, 255, 255, 0.9);">RISK RATING</div>
                            <div class="h3 fw-bold text-info mb-0">AA-</div>
                            <div class="small" style="color: rgba(255, 255, 255, 0.9);">
                                <i class="fas fa-shield-alt me-1"></i>Stable outlook
                            </div>
                        </div>
                        <div class="bg-info bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-star fa-lg text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="row g-4">
            <!-- Left Column: Market Data & Analytics -->
            <div class="col-lg-8">
                <!-- Market Overview -->
                <div class="card shadow-lg mb-4 fade-in-up" style="border-radius: 16px; animation-delay: 0.5s">
                    <div class="card-header border-0 text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px 16px 0 0;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0 fw-bold">
                                    <i class="fas fa-globe-europe me-2"></i>Live Market Overview
                                </h5>
                                <small class="opacity-90">Real-time European ABS markets</small>
                            </div>
                            <div class="badge bg-white bg-opacity-20 text-white">
                                <i class="fas fa-circle text-success me-2"></i>Live
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <div class="col-md-4">
                                <div class="text-center p-3 rounded-3" style="background: linear-gradient(135deg, #0a0e27, #020617)">
                                    <div class="h4 fw-bold text-primary mb-1">€847M</div>
                                    <div class="small mb-2" style="color: rgba(255, 255, 255, 0.9);">Week Issuance</div>
                                    <div class="progress" style="height: 4px;">
                                        <div class="progress-bar bg-primary" style="width: 78%"></div>
                                    </div>
                                    <small class="text-success">78% of target</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-3 rounded-3" style="background: linear-gradient(135deg, #0a0e27, #020617)">
                                    <div class="h4 fw-bold text-success mb-1">1.85%</div>
                                    <div class="small mb-2" style="color: rgba(255, 255, 255, 0.9);">AAA Spread</div>
                                    <div class="text-success small">
                                        <i class="fas fa-arrow-down me-1"></i>-12 bps
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-3 rounded-3" style="background: linear-gradient(135deg, #0a0e27, #020617)">
                                    <div class="h4 fw-bold text-warning mb-1">€2.1B</div>
                                    <div class="small mb-2" style="color: rgba(255, 255, 255, 0.9);">Pipeline</div>
                                    <div class="text-info small">
                                        <i class="fas fa-clock me-1"></i>Next 30 days
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chart Area -->
                        <div class="mt-4 p-4 rounded-3" style="background: linear-gradient(135deg, #0a0e27, #020617)">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold text-white mb-0">Spread Evolution (Last 30 Days)</h6>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary active">AAA</button>
                                    <button class="btn btn-outline-primary">AA</button>
                                    <button class="btn btn-outline-primary">BBB</button>
                                </div>
                            </div>
                            <div style="height: 200px; display: flex; align-items: center; justify-content: center;">
                                <canvas id="spreadChart" style="max-width: 100%; max-height: 100%;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Deal Pipeline -->
                <div class="card shadow-lg fade-in-up" style="border-radius: 16px; animation-delay: 0.6s">
                    <div class="card-header border-0 text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 16px 16px 0 0;">
                        <h5 class="mb-0 fw-bold">
                            <i class="fas fa-stream me-2"></i>Active Deal Pipeline
                        </h5>
                        <small class="opacity-90">Current structures in progress</small>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th class="border-0 fw-semibold">Deal Name</th>
                                        <th class="border-0 fw-semibold">Type</th>
                                        <th class="border-0 fw-semibold">Size</th>
                                        <th class="border-0 fw-semibold">DSCR</th>
                                        <th class="border-0 fw-semibold">Status</th>
                                        <th class="border-0 fw-semibold">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="py-3">
                                            <div class="fw-semibold">European Data Centers 2024-1</div>
                                            <small style="color: rgba(255, 255, 255, 0.9);">Lead: Digital Realty</small>
                                        </td>
                                        <td class="py-3">
                                            <span class="badge bg-primary bg-opacity-25 text-primary">Data Center</span>
                                        </td>
                                        <td class="py-3 fw-semibold">€450M</td>
                                        <td class="py-3">
                                            <span class="text-success fw-bold">1.52x</span>
                                        </td>
                                        <td class="py-3">
                                            <span class="badge bg-warning">Structuring</span>
                                        </td>
                                        <td class="py-3">
                                            <button class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="py-3">
                                            <div class="fw-semibold">UK Logistics Portfolio 2024-A</div>
                                            <small style="color: rgba(255, 255, 255, 0.9);">Lead: Prologis UK</small>
                                        </td>
                                        <td class="py-3">
                                            <span class="badge bg-success bg-opacity-25 text-success">Logistics</span>
                                        </td>
                                        <td class="py-3 fw-semibold">€320M</td>
                                        <td class="py-3">
                                            <span class="text-success fw-bold">1.48x</span>
                                        </td>
                                        <td class="py-3">
                                            <span class="badge bg-info">Rating</span>
                                        </td>
                                        <td class="py-3">
                                            <button class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="py-3">
                                            <div class="fw-semibold">German Renewable Energy 2024-3</div>
                                            <small style="color: rgba(255, 255, 255, 0.9);">Lead: RWE Renewables</small>
                                        </td>
                                        <td class="py-3">
                                            <span class="badge bg-warning bg-opacity-25 text-warning">Renewable</span>
                                        </td>
                                        <td class="py-3 fw-semibold">€680M</td>
                                        <td class="py-3">
                                            <span class="text-success fw-bold">1.65x</span>
                                        </td>
                                        <td class="py-3">
                                            <span class="badge bg-success">Marketing</span>
                                        </td>
                                        <td class="py-3">
                                            <button class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Portfolio & Risk Management -->
            <div class="col-lg-4">
                <!-- Portfolio Performance -->
                <div class="card shadow-lg mb-4 fade-in-up" style="border-radius: 16px; animation-delay: 0.7s">
                    <div class="card-header border-0 text-white" style="background: linear-gradient(135deg, #4ade80, #22c55e); border-radius: 16px 16px 0 0;">
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-briefcase me-2"></i>Portfolio Performance
                        </h6>
                        <small class="opacity-90">YTD Overview</small>
                    </div>
                    <div class="card-body p-4">
                        <div class="text-center mb-4">
                            <div class="h2 fw-bold text-success mb-1">+14.2%</div>
                            <div class="small" style="color: rgba(255, 255, 255, 0.9);">Total Return YTD</div>
                            <div class="progress mt-2" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: 85%"></div>
                            </div>
                            <small class="text-success">85% of annual target</small>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="text-center p-2 rounded" style="background: linear-gradient(135deg, #0a0e27, #020617)">
                                    <div class="fw-bold text-white">€1.8B</div>
                                    <small style="color: rgba(255, 255, 255, 0.9);">Net Assets</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-2 rounded" style="background: linear-gradient(135deg, #0a0e27, #020617)">
                                    <div class="fw-bold text-white">0.12%</div>
                                    <small style="color: rgba(255, 255, 255, 0.9);">Mgmt Fee</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-2 rounded" style="background: linear-gradient(135deg, #0a0e27, #020617)">
                                    <div class="fw-bold text-white">4.2%</div>
                                    <small style="color: rgba(255, 255, 255, 0.9);">Yield</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-2 rounded" style="background: linear-gradient(135deg, #0a0e27, #020617)">
                                    <div class="fw-bold text-white">AA-</div>
                                    <small style="color: rgba(255, 255, 255, 0.9);">Rating</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Dashboard -->
                <div class="card shadow-lg mb-4 fade-in-up" style="border-radius: 16px; animation-delay: 0.8s">
                    <div class="card-header border-0 text-white" style="background: linear-gradient(135deg, #0a0e27, #020617); border-radius: 16px 16px 0 0;">
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-shield-alt me-2"></i>Risk Monitor
                        </h6>
                        <small class="opacity-90">Real-time exposure</small>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small fw-semibold">Concentration Risk</span>
                                <span class="badge bg-success">Low</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: 25%"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small fw-semibold">Credit Risk</span>
                                <span class="badge bg-warning">Medium</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-warning" style="width: 45%"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small fw-semibold">Market Risk</span>
                                <span class="badge bg-success">Low</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: 20%"></div>
                            </div>
                        </div>
                        
                        <div class="border-top pt-3 mt-3">
                            <div class="text-center">
                                <div class="h5 fw-bold text-warning mb-1">7.2%</div>
                                <small style="color: rgba(255, 255, 255, 0.9);">VaR (95%, 1D)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card shadow-lg fade-in-up mb-4" style="border-radius: 16px; animation-delay: 0.9s">
                    <div class="card-header border-0 text-white" style="background: linear-gradient(135deg, #06b6d4, #0891b2); border-radius: 16px 16px 0 0;">
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-bolt me-2"></i>Quick Actions
                        </h6>
                    </div>
                    <div class="card-body p-4">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="showNewAnalysisModal()">
                                <i class="fas fa-plus me-2"></i>New Analysis
                            </button>
                            <button class="btn btn-outline-secondary" onclick="showUploadModal()">
                                <i class="fas fa-upload me-2"></i>Upload Data
                            </button>
                            <button class="btn btn-outline-secondary" onclick="exportData()">
                                <i class="fas fa-download me-2"></i>Export Report
                            </button>
                            <button class="btn btn-outline-secondary" onclick="showSettingsModal()">
                                <i class="fas fa-cog me-2"></i>Settings
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Securitisation Engine Widget -->
                <div class="card shadow-lg fade-in-up" style="border-radius: 16px; animation-delay: 1.0s">
                    <div class="card-header border-0 text-white" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 16px 16px 0 0;">
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-cogs me-2"></i>Securitisation Engine
                        </h6>
                        <small class="opacity-90">Permutation Analysis</small>
                    </div>
                    <div class="card-body p-4">
                        <div class="text-center mb-3">
                            <div class="h3 fw-bold text-primary mb-1" id="dashboard-perm-count">0</div>
                            <div class="small" style="color: rgba(255, 255, 255, 0.9);">Total Permutations</div>
                        </div>
                        
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <div class="text-center p-2 bg-success bg-opacity-10 rounded">
                                    <div class="fw-bold text-success" id="dashboard-viable-count">0</div>
                                    <small style="color: #22c55e;">Viable</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-2 bg-danger bg-opacity-10 rounded">
                                    <div class="fw-bold text-danger" id="dashboard-invalid-count">0</div>
                                    <small style="color: #ef4444;">Invalid</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-top pt-3 mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small fw-semibold">Best IRR Found</span>
                                <span class="badge bg-success" id="dashboard-best-irr">-</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small fw-semibold">Avg WACD</span>
                                <span class="badge bg-info" id="dashboard-avg-wacd">-</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="small fw-semibold">Status</span>
                                <span class="badge bg-secondary" id="dashboard-engine-status">Ready</span>
                            </div>
                        </div>
                        
                        <button class="btn w-100" style="background: linear-gradient(135deg, #0a0e27, #020617); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;" onclick="showSection('permutation')">
                            <i class="fas fa-rocket me-2"></i>Launch Engine
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Analytics Section -->
        <div class="row g-4 mt-4">
            <div class="col-12 fade-in-up" style="animation-delay: 1s">
                <div class="card shadow-lg" style="border-radius: 20px;">
                    <div class="card-header border-0 text-white py-4" style="background: linear-gradient(135deg, #0a0e27, #020617); border-radius: 20px 20px 0 0;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h4 class="mb-1 fw-bold">
                                    <i class="fas fa-chart-area me-3"></i>Advanced Analytics Centre
                                </h4>
                                <p class="mb-0 opacity-90">Comprehensive market intelligence and portfolio optimisation</p>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-light btn-sm">
                                    <i class="fas fa-expand me-2"></i>Fullscreen
                                </button>
                                <button class="btn btn-outline-light btn-sm">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <!-- Performance Attribution -->
                            <div class="col-lg-12">
                                <div class="p-4 rounded-3" style="background: linear-gradient(135deg, #0a0e27, #020617)">
                                    <h6 class="fw-bold mb-3 text-white">
                                        <i class="fas fa-chart-bar text-warning me-2"></i>Performance Attribution Analysis
                                    </h6>
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <div class="text-center p-3 rounded" style="background: linear-gradient(135deg, #0a0e27, #020617)">
                                                <div class="h5 fw-bold text-primary mb-1">+2.8%</div>
                                                <small style="color: rgba(255, 255, 255, 0.9);">Credit Selection</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-3 rounded" style="background: linear-gradient(135deg, #0a0e27, #020617)">
                                                <div class="h5 fw-bold text-success mb-1">+1.2%</div>
                                                <small style="color: rgba(255, 255, 255, 0.9);">Duration Management</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-3 rounded" style="background: linear-gradient(135deg, #0a0e27, #020617)">
                                                <div class="h5 fw-bold text-info mb-1">+0.6%</div>
                                                <small style="color: rgba(255, 255, 255, 0.9);">Sector Allocation</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-3 rounded" style="background: linear-gradient(135deg, #0a0e27, #020617)">
                                                <div class="h5 fw-bold text-danger mb-1">-0.4%</div>
                                                <small style="color: rgba(255, 255, 255, 0.9);">Currency Impact</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- Market News Section - Original Layout with Bullish/Bearish Indicators -->
    <div id="market-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
<div class="container-fluid">
    <!-- Header with Live Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="text-white mb-0">
                    <i class="fas fa-newspaper me-2"></i>Securitisation Market Intelligence
                </h2>
                <div class="d-flex align-items-center gap-3">
                    <button class="btn btn-sm btn-outline-warning" onclick="showSavedArticles()">
                        <i class="fas fa-bookmark me-1"></i>Saved Articles <span id="savedArticleCount" class="badge bg-warning ms-1">0</span>
                    </button>
                    <span class="badge bg-success pulse-animation">
                        <i class="fas fa-circle me-1"></i>Live Updates
                    </span>
                    <small class="text-muted">Last updated: <span id="lastUpdateTime">Just now</span></small>
                </div>
            </div>
        </div>
    </div>

    <!-- Market Sentiment Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-lg" style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa;">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="sentiment-indicator">
                                <h5 class="text-white mb-2">Market Sentiment</h5>
                                <div class="sentiment-gauge" id="sentimentGauge">
                                    <span class="badge bg-warning fs-5">NEUTRAL</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-box">
                                <small class="text-muted">Issuance Volume (24h)</small>
                                <div id="issuanceVolume"><h4 class="text-success">€4.2B <i class="fas fa-arrow-up"></i></h4></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-box">
                                <small class="text-muted">Active Deals</small>
                                <div id="activeDeals" style="cursor: pointer;" onclick="showActiveDeals()">
                                    <h4 class="text-white">
                                        <span id="activeDealsCount">127</span>
                                        <i class="fas fa-external-link-alt ms-2" style="font-size: 0.7em;"></i>
                                    </h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-box">
                                <small class="text-muted">Avg. Spread Change</small>
                                <div id="avgSpreadChange"><h4 class="text-danger">+12 bps <i class="fas fa-arrow-down"></i></h4></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow-sm" style="background: rgba(54, 64, 73, 0.95); border: 1px solid rgba(96, 165, 250, 0.3);">
                <div class="card-body py-3">
                    <div class="row align-items-center">
                        <div class="col-md-3 mb-2 mb-md-0">
                            <select class="form-select bg-dark text-white border-secondary" id="regionFilter">
                                <option value="all">All Regions</option>
                                <option value="uk">United Kingdom</option>
                                <option value="eu">European Union</option>
                                <option value="usa">United States</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-2 mb-md-0">
                            <select class="form-select bg-dark text-white border-secondary" id="assetFilter">
                                <option value="all">All Asset Classes</option>
                                <option value="rmbs">RMBS</option>
                                <option value="cmbs">CMBS</option>
                                <option value="abs">ABS</option>
                                <option value="clo">CLO</option>
                                <option value="cdo">CDO</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-2 mb-md-0">
                            <select class="form-select bg-dark text-white border-secondary" id="sourceFilter">
                                <option value="all">All Sources</option>
                                <option value="ft">Financial Times</option>
                                <option value="citywire">City Wire</option>
                                <option value="greenst">Green Street News</option>
                                <option value="propweek">Property Week</option>
                                <option value="benews">BE News</option>
                                <option value="bloomberg">Bloomberg</option>
                                <option value="reuters">Reuters</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="input-group">
                                <input type="text" class="form-control bg-dark text-white border-secondary" placeholder="Search news..." id="newsSearch">
                                <button class="btn btn-primary" type="button" onclick="marketNews.searchNews()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="row g-4">
        <!-- Breaking News & Headlines -->
        <div class="col-lg-8">
            <!-- News Type Selector -->
            <div class="btn-group mb-3 w-100" role="group">
                <button type="button" class="btn btn-outline-primary active" id="btnLiveNews" onclick="switchNewsType('live')">
                    <i class="fas fa-broadcast-tower me-2"></i>Live News Feed
                </button>
                <button type="button" class="btn btn-outline-info" id="btnAIAnalysis" onclick="switchNewsType('ai')">
                    <i class="fas fa-brain me-2"></i>AI Market Analysis
                </button>
            </div>
            
            <!-- Live News Section -->
            <div class="card shadow-lg mb-4" id="liveNewsSection" style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa;">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);">
                    <h5 class="mb-0">
                        <i class="fas fa-broadcast-tower me-2"></i>Live News from Financial Sources
                        <span class="badge bg-danger ms-2 pulse-animation">LIVE</span>
                    </h5>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    <div id="liveNewsContainer">
                        <!-- Real news items will be dynamically loaded here -->
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2">Loading live news...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI Analysis Section -->
            <div class="card shadow-lg mb-4 d-none" id="aiAnalysisSection" style="background: rgba(54, 64, 73, 0.95); border: 1px solid #8b5cf6;">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                    <h5 class="mb-0">
                        <i class="fas fa-brain me-2"></i>AI-Generated Market Analysis
                        <span class="badge bg-info ms-2">AI INSIGHTS</span>
                    </h5>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>This content is generated by AI based on market patterns and trends. For real news, switch to Live News Feed.</small>
                    </div>
                    <div id="aiNewsContainer">
                        <!-- AI analysis items will be dynamically loaded here -->
                        <div class="text-center py-4">
                            <div class="spinner-border text-purple" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2">Generating AI analysis...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Regional Analysis -->
            <div class="card shadow-lg" style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa;">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <h5 class="mb-0">
                        <i class="fas fa-globe me-2"></i>Regional Market Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row regional-analysis-container">
                        <!-- Regional data will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="col-lg-4">
            <!-- Market Indicators -->
            <div class="card shadow-lg mb-4" style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa;">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>Key Market Indicators
                    </h5>
                </div>
                <div class="card-body">
                    <div class="indicator-item mb-3" data-indicator="LIBOR_3M">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="text-white">LIBOR 3M</span>
                            <span class="text-success">5.32% ↑</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-success" style="width: 75%"></div>
                        </div>
                    </div>
                    <div class="indicator-item mb-3" data-indicator="SOFR">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="text-white">SOFR</span>
                            <span class="text-danger">5.28% ↓</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-danger" style="width: 68%"></div>
                        </div>
                    </div>
                    <div class="indicator-item mb-3" data-indicator="EURIBOR_6M">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="text-white">EURIBOR 6M</span>
                            <span class="text-warning">3.89% →</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-warning" style="width: 55%"></div>
                        </div>
                    </div>
                    <div class="indicator-item mb-3" data-indicator="SONIA">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="text-white">SONIA</span>
                            <span class="text-success">5.19% ↑</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-success" style="width: 72%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trending Topics -->
            <div class="card shadow-lg mb-4" style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa;">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                    <h5 class="mb-0">
                        <i class="fas fa-fire me-2"></i>Trending Topics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="trending-topics">
                        <!-- Trending topics will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Upcoming Events -->
            <div class="card shadow-lg" style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa;">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>Market Events
                    </h5>
                </div>
                <div class="card-body">
                    <div class="events-container">
                        <!-- Events will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Market Commentary Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-lg" style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa;">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">
                    <h5 class="mb-0">
                        <i class="fas fa-comment-dots me-2"></i>Expert Market Commentary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="commentary-container">
                        <!-- Commentary will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .pulse-animation {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    
    .news-item:hover {
        background: rgba(96, 165, 250, 0.05);
        cursor: pointer;
        transition: background 0.3s ease;
    }
    
    .region-card:hover {
        background: rgba(96, 165, 250, 0.1);
        transition: background 0.3s ease;
    }
    
    .indicator-item .progress {
        background: rgba(255, 255, 255, 0.1);
    }
    
    .trending-topics a:hover {
        transform: translateX(5px);
        transition: transform 0.2s ease;
    }
    
    .commentary-card {
        background: rgba(30, 41, 59, 0.5);
    }
    
    .commentary-card:hover {
        background: rgba(96, 165, 250, 0.1);
        transition: background 0.3s ease;
    }
    
    .avatar {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
    </div>

<!-- Data Section -->
    <div id="data-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">
                    <i class="fas fa-database"></i> Data Center
                </h2>
                <p style="color: #94a3b8; margin-bottom: 2rem;">Access and manage all data assets and analytics</p>
                
                <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                    <div class="table-responsive">
                        <table class="table table-hover" style="margin-bottom: 0;">
                            <thead>
                                <tr>
                                    <th style="color: #93c5fd; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Asset Class</th>
                                    <th style="color: #93c5fd; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Region</th>
                                    <th style="color: #93c5fd; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Current Yield</th>
                                    <th style="color: #93c5fd; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Change (24h)</th>
                                    <th style="color: #93c5fd; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Volume</th>
                                    <th style="color: #93c5fd; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid rgba(96, 165, 250, 0.1);">
                                    <td style="color: #94a3b8; padding: 12px;">RMBS</td>
                                    <td style="color: #64748b; padding: 12px;">Europe</td>
                                    <td style="color: #60a5fa; padding: 12px; font-weight: 600;">3.45%</td>
                                    <td style="color: #22c55e; padding: 12px;">+0.12%</td>
                                    <td style="color: #60a5fa; padding: 12px;">€2.3B</td>
                                    <td style="padding: 12px;"><span class="badge bg-success">Active</span></td>
                                </tr>
                                <tr style="border-bottom: 1px solid rgba(96, 165, 250, 0.1);">
                                    <td style="color: #94a3b8; padding: 12px;">CMBS</td>
                                    <td style="color: #64748b; padding: 12px;">North America</td>
                                    <td style="color: #60a5fa; padding: 12px; font-weight: 600;">4.15%</td>
                                    <td style="color: #ef4444; padding: 12px;">-0.08%</td>
                                    <td style="color: #60a5fa; padding: 12px;">$1.8B</td>
                                    <td style="padding: 12px;"><span class="badge bg-success">Active</span></td>
                                </tr>
                                <tr>
                                    <td style="color: #94a3b8; padding: 12px;">CLO</td>
                                    <td style="color: #64748b; padding: 12px;">Asia Pacific</td>
                                    <td style="color: #60a5fa; padding: 12px; font-weight: 600;">5.25%</td>
                                    <td style="color: #22c55e; padding: 12px;">+0.22%</td>
                                    <td style="color: #60a5fa; padding: 12px;">¥450B</td>
                                    <td style="padding: 12px;"><span class="badge bg-warning">Limited</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                </div>
                
                <!-- AI Analysis Tab -->
                <div id="market-tab-ai-analysis" class="market-tab-content" style="display: none;">
                    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.05)); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h3 style="color: #10b981; margin-bottom: 1rem;">
                            <i class="fas fa-robot"></i> AI Market Analysis - Powered by Advanced ML Models
                        </h3>
                        <div style="color: #e2e8f0; line-height: 1.8;">
                            <div style="margin-bottom: 1.5rem;">
                                <h4 style="color: #60a5fa; margin-bottom: 0.5rem;">Current Market Sentiment: BULLISH</h4>
                                <p style="color: #94a3b8;">Our proprietary AI models analyze over 50,000 data points per second, including market microstructure, options flow, and cross-asset correlations. Current analysis indicates strong risk-on sentiment with particular strength in European credit markets.</p>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <h4 style="color: #60a5fa; margin-bottom: 0.5rem;">Key AI Predictions (Next 7 Days)</h4>
                                <ul style="color: #94a3b8; list-style: none; padding: 0;">
                                    <li style="margin-bottom: 0.5rem;"><i class="fas fa-arrow-up" style="color: #22c55e;"></i> EUR IG Credit Spreads: Tightening expected (78% confidence)</li>
                                    <li style="margin-bottom: 0.5rem;"><i class="fas fa-arrow-right" style="color: #fbbf24;"></i> US Treasury Yields: Range-bound 4.20-4.35% (65% confidence)</li>
                                    <li style="margin-bottom: 0.5rem;"><i class="fas fa-arrow-up" style="color: #22c55e;"></i> CLO AAA Spreads: 5-10bps tightening likely (82% confidence)</li>
                                    <li style="margin-bottom: 0.5rem;"><i class="fas fa-arrow-down" style="color: #ef4444;"></i> Volatility: VIX to decline to 12-13 range (71% confidence)</li>
                                </ul>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <h4 style="color: #60a5fa; margin-bottom: 0.5rem;">Pattern Recognition Alert</h4>
                                <p style="color: #94a3b8;">AI has detected a bullish flag formation in European ABS markets, historically preceding 3-5% rallies in 73% of occurrences. Similar pattern observed in Q2 2023 before the 4.2% sector rally.</p>
                            </div>
                            
                            <div style="background: rgba(96, 165, 250, 0.1); border-left: 3px solid #60a5fa; padding: 1rem; border-radius: 4px;">
                                <strong style="color: #60a5fa;">AI Recommendation:</strong>
                                <p style="color: #e2e8f0; margin-top: 0.5rem;">Increase allocation to European investment-grade credit and senior CLO tranches. Consider hedging USD exposure as EUR strength signals persist.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Expert Insights Tab -->
                <div id="market-tab-expert-insights" class="market-tab-content" style="display: none;">
                    <div style="display: grid; gap: 1.5rem;">
                        <!-- Expert 1 -->
                        <div style="background: linear-gradient(135deg, rgba(96, 165, 250, 0.1), rgba(59, 130, 246, 0.05)); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                            <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #60a5fa, #3b82f6); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                                    <i class="fas fa-user-tie" style="color: white; font-size: 1.5rem;"></i>
                                </div>
                                <div>
                                    <h4 style="color: #60a5fa; margin: 0;">Dr. Michael Sterling</h4>
                                    <p style="color: #94a3b8; margin: 0; font-size: 0.9rem;">Chief Economist, European Central Bank (Former)</p>
                                </div>
                            </div>
                            <p style="color: #e2e8f0; line-height: 1.6;">
                                "The current environment presents unique opportunities in European structured credit. With the ECB's pause in rate hikes and improving economic data, we're seeing a goldilocks scenario for credit investors. I particularly favor senior RMBS tranches from Northern European jurisdictions."
                            </p>
                            <p style="color: #94a3b8; font-size: 0.85rem; margin-top: 1rem;">
                                <i class="fas fa-clock"></i> Updated 2 hours ago
                            </p>
                        </div>
                        
                        <!-- Expert 2 -->
                        <div style="background: linear-gradient(135deg, rgba(96, 165, 250, 0.1), rgba(59, 130, 246, 0.05)); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                            <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #a78bfa, #8b5cf6); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                                    <i class="fas fa-user-tie" style="color: white; font-size: 1.5rem;"></i>
                                </div>
                                <div>
                                    <h4 style="color: #a78bfa; margin: 0;">Sarah Chen, CFA</h4>
                                    <p style="color: #94a3b8; margin: 0; font-size: 0.9rem;">Global Head of Credit Strategy, Goldman Sachs</p>
                                </div>
                            </div>
                            <p style="color: #e2e8f0; line-height: 1.6;">
                                "CLO markets are showing remarkable resilience. We're overweight European CLO AAA and AA tranches, with spreads offering 20-30bps premium over comparable corporates. The technical picture remains strong with limited new supply expected in Q1 2025."
                            </p>
                            <p style="color: #94a3b8; font-size: 0.85rem; margin-top: 1rem;">
                                <i class="fas fa-clock"></i> Updated 4 hours ago
                            </p>
                        </div>
                        
                        <!-- Expert 3 -->
                        <div style="background: linear-gradient(135deg, rgba(96, 165, 250, 0.1), rgba(59, 130, 246, 0.05)); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                            <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f59e0b, #f97316); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                                    <i class="fas fa-user-tie" style="color: white; font-size: 1.5rem;"></i>
                                </div>
                                <div>
                                    <h4 style="color: #f59e0b; margin: 0;">James Richardson</h4>
                                    <p style="color: #94a3b8; margin: 0; font-size: 0.9rem;">Managing Director, BlackRock Fixed Income</p>
                                </div>
                            </div>
                            <p style="color: #e2e8f0; line-height: 1.6;">
                                "Infrastructure-backed securities are the hidden gem in current markets. With government infrastructure spending at record levels and inflation-linked revenue streams, these securities offer attractive risk-adjusted returns. We're particularly bullish on renewable energy project bonds."
                            </p>
                            <p style="color: #94a3b8; font-size: 0.85rem; margin-top: 1rem;">
                                <i class="fas fa-clock"></i> Updated 6 hours ago
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Breaking News Tab -->
                <div id="market-tab-breaking-news" class="market-tab-content" style="display: none;">
                    <div id="news-feed" style="max-height: 600px; overflow-y: auto;">
                        <!-- News items will be dynamically loaded here -->
                        <div style="border-left: 3px solid #ef4444; padding-left: 1rem; margin-bottom: 1.5rem;">
                            <h4 style="color: #ef4444; margin-bottom: 0.5rem;">
                                <i class="fas fa-bolt"></i> BREAKING: ECB Signals Potential Rate Cut in March
                            </h4>
                            <p style="color: #e2e8f0; margin-bottom: 0.5rem;">European Central Bank officials hint at possible 25bps rate reduction amid slowing inflation...</p>
                            <p style="color: #94a3b8; font-size: 0.85rem;">
                                <i class="fas fa-clock"></i> 15 minutes ago | Source: Reuters
                            </p>
                        </div>
                        
                        <div style="border-left: 3px solid #60a5fa; padding-left: 1rem; margin-bottom: 1.5rem;">
                            <h4 style="color: #60a5fa; margin-bottom: 0.5rem;">
                                <i class="fas fa-newspaper"></i> Major CLO Deal: Barclays Prices €500M AAA Tranche
                            </h4>
                            <p style="color: #e2e8f0; margin-bottom: 0.5rem;">Barclays successfully prices new European CLO with AAA tranche at E+85bps, tighter than initial guidance...</p>
                            <p style="color: #94a3b8; font-size: 0.85rem;">
                                <i class="fas fa-clock"></i> 1 hour ago | Source: Bloomberg
                            </p>
                        </div>
                        
                        <div style="border-left: 3px solid #22c55e; padding-left: 1rem; margin-bottom: 1.5rem;">
                            <h4 style="color: #22c55e; margin-bottom: 0.5rem;">
                                <i class="fas fa-chart-line"></i> European ABS Issuance Hits Record €125B in 2024
                            </h4>
                            <p style="color: #e2e8f0; margin-bottom: 0.5rem;">European ABS market sees record issuance driven by auto loans and RMBS sectors...</p>
                            <p style="color: #94a3b8; font-size: 0.85rem;">
                                <i class="fas fa-clock"></i> 2 hours ago | Source: Financial Times
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Market Sentiment Tab -->
                <div id="market-tab-sentiment" class="market-tab-content" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <h4 style="color: #60a5fa; margin-bottom: 1rem;">Market Sentiment Gauge</h4>
                            <div style="background: linear-gradient(90deg, #ef4444 0%, #fbbf24 25%, #22c55e 100%); height: 30px; border-radius: 15px; position: relative; margin-bottom: 1rem;">
                                <div style="position: absolute; left: 75%; top: -5px; width: 40px; height: 40px; background: white; border: 3px solid #60a5fa; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <span style="color: #020617; font-weight: bold;">75</span>
                                </div>
                            </div>
                            <p style="color: #22c55e; text-align: center; font-weight: 600;">BULLISH</p>
                        </div>
                        
                        <div>
                            <h4 style="color: #60a5fa; margin-bottom: 1rem;">Fear & Greed Index</h4>
                            <canvas id="fear-greed-chart" style="max-height: 150px;"></canvas>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <h4 style="color: #60a5fa; margin-bottom: 1rem;">Sentiment Breakdown by Asset Class</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                                <p style="color: #94a3b8; margin-bottom: 0.5rem;">Investment Grade</p>
                                <p style="color: #22c55e; font-size: 1.5rem; font-weight: 600;">85% Bullish</p>
                            </div>
                            <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                                <p style="color: #94a3b8; margin-bottom: 0.5rem;">High Yield</p>
                                <p style="color: #22c55e; font-size: 1.5rem; font-weight: 600;">72% Bullish</p>
                            </div>
                            <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                                <p style="color: #94a3b8; margin-bottom: 0.5rem;">Emerging Markets</p>
                                <p style="color: #fbbf24; font-size: 1.5rem; font-weight: 600;">55% Neutral</p>
                            </div>
                            <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                                <p style="color: #94a3b8; margin-bottom: 0.5rem;">Structured Credit</p>
                                <p style="color: #22c55e; font-size: 1.5rem; font-weight: 600;">90% Bullish</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Section -->
    <div id="analytics-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">
                    <i class="fas fa-chart-bar"></i> Analytics & Insights
                </h2>
                <p style="color: #94a3b8; margin-bottom: 2rem;">Advanced analytics and performance insights</p>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; align-items: start;">
                    <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #93c5fd; margin-bottom: 1rem; font-size: 1.25rem; font-weight: 600;">Performance Analytics</h3>
                        <canvas id="analyticsChart" style="height: 300px;"></canvas>
                        <div style="margin-top: 1rem; text-align: center;">
                            <button style="background: transparent; color: #94a3b8; border: 1px solid #60a5fa; padding: 4px 12px; border-radius: 6px; margin: 0 4px; cursor: pointer;">1D</button>
                            <button style="background: transparent; color: #94a3b8; border: 1px solid #60a5fa; padding: 4px 12px; border-radius: 6px; margin: 0 4px; cursor: pointer;">1W</button>
                            <button style="background: #60a5fa; color: white; border: 1px solid #60a5fa; padding: 4px 12px; border-radius: 6px; margin: 0 4px; cursor: pointer;">1M</button>
                            <button style="background: transparent; color: #94a3b8; border: 1px solid #60a5fa; padding: 4px 12px; border-radius: 6px; margin: 0 4px; cursor: pointer;">3M</button>
                            <button style="background: transparent; color: #94a3b8; border: 1px solid #60a5fa; padding: 4px 12px; border-radius: 6px; margin: 0 4px; cursor: pointer;">1Y</button>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #93c5fd; margin-bottom: 1rem; font-size: 1.25rem; font-weight: 600;">Key Metrics</h3>
                        <div style="margin-bottom: 1rem;">
                            <label style="color: #64748b; font-size: 0.875rem;">Sharpe Ratio</label>
                            <div style="color: #60a5fa; font-size: 1.5rem; font-weight: 600;">1.85</div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="color: #64748b; font-size: 0.875rem;">Information Ratio</label>
                            <div style="color: #60a5fa; font-size: 1.5rem; font-weight: 600;">0.92</div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="color: #64748b; font-size: 0.875rem;">Max Drawdown</label>
                            <div style="color: #ef4444; font-size: 1.5rem; font-weight: 600;">-4.2%</div>
                        </div>
                        <div>
                            <label style="color: #64748b; font-size: 0.875rem;">Volatility</label>
                            <div style="color: #60a5fa; font-size: 1.5rem; font-weight: 600;">8.5%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Risk Management Section -->
    <div id="risk-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">
                    <i class="fas fa-shield-alt"></i> Risk Management
                </h2>
                <p style="color: #94a3b8; margin-bottom: 2rem;">Comprehensive risk monitoring and analysis</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start;">
                    <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #93c5fd; margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 600;">Risk Indicators</h3>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: rgba(255, 255, 255, 0.9);">Market Risk</span>
                                <span style="color: #60a5fa;">Medium</span>
                            </div>
                            <div style="background: rgba(96, 165, 250, 0.1); border-radius: 4px; height: 8px; overflow: hidden;">
                                <div style="background: #60a5fa; height: 100%; width: 60%;"></div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: rgba(255, 255, 255, 0.9);">Credit Risk</span>
                                <span style="color: #22c55e;">Low</span>
                            </div>
                            <div style="background: rgba(96, 165, 250, 0.1); border-radius: 4px; height: 8px; overflow: hidden;">
                                <div style="background: #22c55e; height: 100%; width: 30%;"></div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: rgba(255, 255, 255, 0.9);">Liquidity Risk</span>
                                <span style="color: #22c55e;">Low</span>
                            </div>
                            <div style="background: rgba(96, 165, 250, 0.1); border-radius: 4px; height: 8px; overflow: hidden;">
                                <div style="background: #22c55e; height: 100%; width: 25%;"></div>
                            </div>
                        </div>
                        
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: rgba(255, 255, 255, 0.9);">Operational Risk</span>
                                <span style="color: #06b6d4;">Very Low</span>
                            </div>
                            <div style="background: rgba(96, 165, 250, 0.1); border-radius: 4px; height: 8px; overflow: hidden;">
                                <div style="background: #06b6d4; height: 100%; width: 15%;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #93c5fd; margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 600;">VaR Analysis</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; text-align: center;">
                            <div style="margin-bottom: 1rem;">
                                <label style="color: #64748b; font-size: 0.875rem;">1-Day VaR (95%)</label>
                                <div style="color: #60a5fa; font-size: 1.5rem; font-weight: 600;">€2.4M</div>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="color: #64748b; font-size: 0.875rem;">1-Day VaR (99%)</label>
                                <div style="color: #ef4444; font-size: 1.5rem; font-weight: 600;">€4.1M</div>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="color: #64748b; font-size: 0.875rem;">10-Day VaR (95%)</label>
                                <div style="color: #60a5fa; font-size: 1.5rem; font-weight: 600;">€7.6M</div>
                            </div>
                            <div>
                                <label style="color: #64748b; font-size: 0.875rem;">10-Day VaR (99%)</label>
                                <div style="color: #ef4444; font-size: 1.5rem; font-weight: 600;">€13.0M</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Portfolio Section -->
    <div id="portfolio-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">
                    <i class="fas fa-briefcase"></i> Portfolio Management
                </h2>
                <p style="color: #94a3b8; margin-bottom: 2rem;">Manage and monitor your investment positions</p>
                
                <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                    <h3 style="color: #93c5fd; margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 600;">Active Positions</h3>
                    
                    <div class="table-responsive">
                        <table class="table table-hover" style="margin-bottom: 0; background: transparent !important;">
                            <thead>
                                <tr style="background: transparent !important;">
                                    <th style="color: #93c5fd !important; background: transparent !important; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Security</th>
                                    <th style="color: #93c5fd !important; background: transparent !important; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">ISIN</th>
                                    <th style="color: #93c5fd !important; background: transparent !important; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Notional</th>
                                    <th style="color: #93c5fd !important; background: transparent !important; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Market Value</th>
                                    <th style="color: #93c5fd !important; background: transparent !important; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">P&L</th>
                                    <th style="color: #93c5fd !important; background: transparent !important; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Weight</th>
                                    <th style="color: #93c5fd !important; background: transparent !important; border-bottom: 1px solid rgba(96, 165, 250, 0.3); padding: 12px;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: transparent !important; border-bottom: 1px solid rgba(96, 165, 250, 0.1);">
                                    <td style="color: #94a3b8 !important; background: transparent !important; padding: 12px;">ATLAS 2024-1 A</td>
                                    <td style="color: #64748b !important; background: transparent !important; padding: 12px;">XS2745892341</td>
                                    <td style="color: #60a5fa !important; background: transparent !important; padding: 12px; font-weight: 600;">€100M</td>
                                    <td style="color: #60a5fa !important; background: transparent !important; padding: 12px; font-weight: 600;">€102.5M</td>
                                    <td style="color: #22c55e !important; background: transparent !important; padding: 12px;">+€2.5M</td>
                                    <td style="color: #94a3b8 !important; background: transparent !important; padding: 12px;">4.3%</td>
                                    <td style="background: transparent !important; padding: 12px;"><button style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 4px 12px; border-radius: 6px; cursor: pointer;">Details</button></td>
                                </tr>
                                <tr style="background: transparent !important; border-bottom: 1px solid rgba(96, 165, 250, 0.1);">
                                    <td style="color: #94a3b8 !important; background: transparent !important; padding: 12px;">NEXUS 2023-3 AAA</td>
                                    <td style="color: #64748b !important; background: transparent !important; padding: 12px;">XS2698754123</td>
                                    <td style="color: #60a5fa !important; background: transparent !important; padding: 12px; font-weight: 600;">€150M</td>
                                    <td style="color: #60a5fa !important; background: transparent !important; padding: 12px; font-weight: 600;">€148.2M</td>
                                    <td style="color: #ef4444 !important; background: transparent !important; padding: 12px;">-€1.8M</td>
                                    <td style="color: #94a3b8 !important; background: transparent !important; padding: 12px;">6.2%</td>
                                    <td style="background: transparent !important; padding: 12px;"><button style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 4px 12px; border-radius: 6px; cursor: pointer;">Details</button></td>
                                </tr>
                                <tr style="background: transparent !important;">
                                    <td style="color: #94a3b8 !important; background: transparent !important; padding: 12px;">EURO CLO 2024-2</td>
                                    <td style="color: #64748b !important; background: transparent !important; padding: 12px;">XS2756891234</td>
                                    <td style="color: #60a5fa !important; background: transparent !important; padding: 12px; font-weight: 600;">€75M</td>
                                    <td style="color: #60a5fa !important; background: transparent !important; padding: 12px; font-weight: 600;">€76.1M</td>
                                    <td style="color: #22c55e !important; background: transparent !important; padding: 12px;">+€1.1M</td>
                                    <td style="color: #94a3b8 !important; background: transparent !important; padding: 12px;">3.2%</td>
                                    <td style="background: transparent !important; padding: 12px;"><button style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 4px 12px; border-radius: 6px; cursor: pointer;">Details</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <a href="/portfolio" style="display: inline-block; background: linear-gradient(135deg, #0a0e27, #020617); color: white; text-decoration: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; transition: all 0.3s ease;">
                        <i class="fas fa-arrow-right" style="margin-right: 8px;"></i>Access Full Portfolio Manager
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Compliance Section -->
    <div id="compliance-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">
                    <i class="fas fa-gavel"></i> Compliance & Regulatory
                </h2>
                <p style="color: #94a3b8; margin-bottom: 2rem;">Monitor regulatory compliance and track deadlines</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start; margin-bottom: 2rem;">
                    <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #93c5fd; margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 600;">Regulatory Status</h3>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="color: rgba(255, 255, 255, 0.9);"><i class="fas fa-check-circle" style="color: #22c55e; margin-right: 8px;"></i>MiFID II</span>
                                <span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">Compliant</span>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="color: rgba(255, 255, 255, 0.9);"><i class="fas fa-check-circle" style="color: #22c55e; margin-right: 8px;"></i>AIFMD</span>
                                <span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">Compliant</span>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="color: rgba(255, 255, 255, 0.9);"><i class="fas fa-check-circle" style="color: #22c55e; margin-right: 8px;"></i>EMIR</span>
                                <span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">Compliant</span>
                            </div>
                        </div>
                        
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="color: rgba(255, 255, 255, 0.9);"><i class="fas fa-exclamation-triangle" style="color: #60a5fa; margin-right: 8px;"></i>SFDR</span>
                                <span style="background: #60a5fa; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">Review Needed</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #93c5fd; margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 600;">Upcoming Deadlines</h3>
                        
                        <div style="margin-bottom: 1rem; padding: 12px; border-left: 4px solid #60a5fa; background: rgba(96, 165, 250, 0.1);">
                            <div style="color: #64748b; font-size: 0.875rem;">15 Jan 2025</div>
                            <div style="color: #94a3b8; font-weight: 600;">ESMA Quarterly Report</div>
                        </div>
                        
                        <div style="margin-bottom: 1rem; padding: 12px; border-left: 4px solid #06b6d4; background: rgba(6, 182, 212, 0.1);">
                            <div style="color: #64748b; font-size: 0.875rem;">31 Jan 2025</div>
                            <div style="color: #94a3b8; font-weight: 600;">Annual Risk Assessment</div>
                        </div>
                        
                        <div style="padding: 12px; border-left: 4px solid #60a5fa; background: rgba(96, 165, 250, 0.1);">
                            <div style="color: #64748b; font-size: 0.875rem;">28 Feb 2025</div>
                            <div style="color: #94a3b8; font-weight: 600;">Investor Disclosure Update</div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <a href="/compliance" style="display: inline-block; background: linear-gradient(135deg, #0a0e27, #020617); color: white; text-decoration: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; transition: all 0.3s ease;">
                        <i class="fas fa-arrow-right" style="margin-right: 8px;"></i>Open Full Compliance Tool
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Projects Section -->
    <div id="projects-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <!-- Sponsor Input Editor Section (Full Width) -->
            <div id="sponsor-editor-section" style="display: none; background: linear-gradient(135deg, #0a0e27, #020617); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="color: #60a5fa; font-size: 1.5rem; font-weight: 700;">
                        <i class="fas fa-edit"></i> <span id="sponsor-editor-title">Edit Project - Sponsor Input</span>
                    </h2>
                    <div style="display: flex; gap: 1rem;">
                        <button onclick="downloadSponsorTemplate()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-download"></i> Download Template
                        </button>
                        <button onclick="closeSponsorEditor()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>

                <!-- Tabs -->
                <div style="display: flex; gap: 2rem; margin-bottom: 2rem; border-bottom: 2px solid rgba(96, 165, 250, 0.2); position: relative;">
                    <button class="sponsor-tab active" onclick="switchSponsorTab('upload')" style="padding: 1rem; background: none; border: none; color: #60a5fa; font-size: 1rem; font-weight: 600; cursor: pointer; position: relative; transition: color 0.3s;">Upload Template</button>
                    <button class="sponsor-tab" onclick="switchSponsorTab('manual')" style="padding: 1rem; background: none; border: none; color: #94a3b8; font-size: 1rem; font-weight: 600; cursor: pointer; position: relative; transition: color 0.3s;">Manual Entry</button>
                    <div class="sponsor-tab-indicator" style="position: absolute; bottom: -2px; left: 0; height: 3px; background: #60a5fa; transition: all 0.3s ease; width: 130px;"></div>
                </div>

                <!-- Upload Tab -->
                <div id="uploadSponsorTab" class="sponsor-tab-content" style="display: block;">
                    <div style="border: 3px dashed rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 3rem; text-align: center; cursor: pointer; background: rgba(96, 165, 250, 0.05);" onclick="document.getElementById('sponsorFileInput').click()" ondrop="handleSponsorDrop(event)" ondragover="handleSponsorDragOver(event)" ondragleave="handleSponsorDragLeave(event)">
                        <input type="file" id="sponsorFileInput" accept=".xlsx" style="display: none;" onchange="handleSponsorFileSelect(event)">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 4rem; color: #60a5fa; margin-bottom: 1rem;"></i>
                        <h3 style="color: #60a5fa; margin-bottom: 1rem;">Upload Sponsor Input Template</h3>
                        <p style="color: #94a3b8; margin-bottom: 0.5rem;">Drag and drop your Excel file here or click to browse</p>
                        <p style="font-size: 0.875rem; color: #64748b;">Accepts: Project_Sponsor_Input_Template.xlsx or Project_Sponsor_Input_Template_PLUS_Schedule.xlsx</p>
                    </div>
                    
                    <div id="uploadSponsorPreview" style="display: none; margin-top: 2rem; padding: 1.5rem; background: #0a0e27; border-radius: 12px; border: 1px solid rgba(96, 165, 250, 0.2);">
                        <h4 style="color: #60a5fa; margin-bottom: 1rem;">Uploaded Data Preview</h4>
                        <div id="sponsorPreviewContent"></div>
                    </div>
                </div>

                <!-- Manual Entry Tab -->
                <div id="manualSponsorTab" class="sponsor-tab-content" style="display: none;">
                    <form id="sponsor-form" style="padding-right: 1rem;">
                        <!-- Project Metadata -->
                        <div style="background: rgba(10, 14, 39, 0.6); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                            <h3 style="color: #60a5fa; margin-bottom: 1.5rem; font-size: 1.2rem;">
                                <i class="fas fa-info-circle"></i> Project Metadata
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Project Title *</label>
                                    <input type="text" id="sponsor-projectTitle" required style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                </div>
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Location Country *</label>
                                    <input type="text" id="sponsor-locationCountry" required style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                </div>
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Status</label>
                                    <select id="sponsor-status" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                        <option value="0. Archived">0. Archived</option>
                                        <option value="1. Site Identified">1. Site Identified</option>
                                        <option value="1a. Site Reviewed">1a. Site Reviewed</option>
                                        <option value="2. Test Fit / Power">2. Test Fit / Power</option>
                                        <option value="3. Deal Development">3. Deal Development</option>
                                        <option value="4. Under Offer">4. Under Offer</option>
                                        <option value="5. Exclusivity / Option Secured">5. Exclusivity / Option Secured</option>
                                        <option value="6. Design & Procurement">6. Design & Procurement</option>
                                        <option value="6a. End User Engagement">6a. End User Engagement</option>
                                        <option value="7. On Site">7. On Site</option>
                                        <option value="8. Live">8. Live</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">CapEx Currency *</label>
                                    <select id="sponsor-capex-currency" required style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                        <option value="EUR">EUR (€)</option>
                                        <option value="USD">USD ($)</option>
                                        <option value="GBP">GBP (£)</option>
                                        <option value="JPY">JPY (¥)</option>
                                        <option value="AED">AED (د.إ)</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Cost per kWh Currency *</label>
                                    <select id="sponsor-kwh-currency" required style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                        <option value="EUR">EUR (€)</option>
                                        <option value="USD">USD ($)</option>
                                        <option value="GBP">GBP (£)</option>
                                        <option value="JPY">JPY (¥)</option>
                                        <option value="AED">AED (د.إ)</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Gross IT Load (MW) *</label>
                                    <input type="number" id="sponsor-grossITLoadMW" min="0.1" step="0.01" required style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                </div>
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">PUE * (0.95 - 1.5)</label>
                                    <input type="number" id="sponsor-pue" min="0.95" max="1.5" step="0.01" value="1.25" required style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                </div>
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Gross Monthly Rent (per kWh) *</label>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="text" id="sponsor-grossMonthlyRent" min="0" max="300" step="0.01" required style="flex: 1; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;" placeholder="0.00 - 300.00">
                                        <span id="sponsor-kwh-currency-display" style="padding: 12px; background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: #60a5fa; min-width: 60px; text-align: center;">EUR</span>
                                    </div>
                                </div>
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">OPEX % *</label>
                                    <input type="text" id="sponsor-opexPercent" min="0" max="100" step="1" required style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;" placeholder="0% - 100%">
                                </div>
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Construction Start Date *</label>
                                    <input type="date" id="sponsor-constructionStart" required style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;" placeholder="DD/MM/YYYY">
                                </div>
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Construction Duration (Months) *</label>
                                    <input type="number" id="sponsor-constructionDurationMonths" min="1" max="48" required style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;" placeholder="e.g., 24">
                                </div>
                            </div>
                        </div>

                        <!-- Build (CapEx Internal) -->
                        <div style="background: rgba(10, 14, 39, 0.6); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                            <h3 style="color: #60a5fa; margin-bottom: 1.5rem; font-size: 1.2rem;">
                                <i class="fas fa-building"></i> Build (CapEx Internal) - <span id="capex-internal-currency">EUR</span>
                            </h3>
                            
                            <!-- Per MW Option -->
                            <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(96, 165, 250, 0.05); border-radius: 8px;">
                                <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 0.5rem;">Option 1: Per MW Costing</label>
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <input type="text" id="sponsor-capexInternalPerMW" min="0" max="25000000" placeholder="0 - 25,000,000" style="flex: 1; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;" onchange="calculateCapexFromPerMW('internal')">
                                    <span style="color: #94a3b8;">× <span id="capex-internal-mw">0</span> MW =</span>
                                    <span id="capex-internal-permw-total" style="color: #60a5fa; font-weight: 600; font-size: 1.2rem;">0</span>
                                </div>
                            </div>
                            
                            <!-- Expandable Details Option -->
                            <div>
                                <button type="button" onclick="toggleCapexDetails('internal')" style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-bottom: 1rem;">
                                    <i class="fas fa-chevron-down" id="capex-internal-chevron"></i> Option 2: Detailed Breakdown
                                </button>
                                <div id="capex-internal-details" style="display: none; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">Architectural</label>
                                        <input type="number" id="sponsor-buildArchitectural" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">Civil & Structural</label>
                                        <input type="number" id="sponsor-buildCivilStructural" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">Substations</label>
                                        <input type="number" id="sponsor-buildSubstations" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">Underground Utilities</label>
                                        <input type="number" id="sponsor-buildUndergroundUtilities" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">Crusader Modules</label>
                                        <input type="number" id="sponsor-buildCrusaderModules" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">BESS</label>
                                        <input type="number" id="sponsor-buildBess" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">Main Contractor Installation</label>
                                        <input type="number" id="sponsor-buildMainContractorInstallation" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">Photovoltaic System</label>
                                        <input type="number" id="sponsor-buildPhotovoltaicSystem" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">Landscaping</label>
                                        <input type="number" id="sponsor-buildLandscaping" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">Preliminaries General</label>
                                        <input type="number" id="sponsor-buildPreliminariesGeneral" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">Main Contractor Margin</label>
                                        <input type="number" id="sponsor-buildMainContractorMargin" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Build (CapEx Market) -->
                        <div style="background: rgba(10, 14, 39, 0.6); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                            <h3 style="color: #60a5fa; margin-bottom: 1.5rem; font-size: 1.2rem;">
                                <i class="fas fa-chart-line"></i> Build (CapEx Market) - <span id="capex-market-currency">EUR</span>
                            </h3>
                            
                            <!-- Per MW Option -->
                            <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(96, 165, 250, 0.05); border-radius: 8px;">
                                <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 0.5rem;">Option 1: Per MW Costing</label>
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <input type="text" id="sponsor-capexMarketPerMW" min="0" max="25000000" placeholder="0 - 25,000,000" style="flex: 1; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;" onchange="calculateCapexFromPerMW('market')">
                                    <span style="color: #94a3b8;">× <span id="capex-market-mw">0</span> MW =</span>
                                    <span id="capex-market-permw-total" style="color: #60a5fa; font-weight: 600; font-size: 1.2rem;">0</span>
                                </div>
                            </div>
                            
                            <!-- Expandable Details Option -->
                            <div>
                                <button type="button" onclick="toggleCapexDetails('market')" style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-bottom: 1rem;">
                                    <i class="fas fa-chevron-down" id="capex-market-chevron"></i> Option 2: Detailed Breakdown
                                </button>
                                <div id="capex-market-details" style="display: none; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">Architectural</label>
                                        <input type="number" id="sponsor-marketArchitectural" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">Civil & Structural</label>
                                        <input type="number" id="sponsor-marketCivilStructural" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">Substations</label>
                                        <input type="number" id="sponsor-marketSubstations" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">Underground Utilities</label>
                                        <input type="number" id="sponsor-marketUndergroundUtilities" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">Crusader Modules</label>
                                        <input type="number" id="sponsor-marketCrusaderModules" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">BESS</label>
                                        <input type="number" id="sponsor-marketBess" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">Main Contractor Installation</label>
                                        <input type="number" id="sponsor-marketMainContractorInstallation" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">Photovoltaic System</label>
                                        <input type="number" id="sponsor-marketPhotovoltaicSystem" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">Landscaping</label>
                                        <input type="number" id="sponsor-marketLandscaping" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">Preliminaries General</label>
                                        <input type="number" id="sponsor-marketPreliminariesGeneral" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem;">Main Contractor Margin</label>
                                        <input type="number" id="sponsor-marketMainContractorMargin" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Contingency (Applied to CapEx) -->
                        <div style="background: rgba(10, 14, 39, 0.6); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                            <h3 style="color: #60a5fa; margin-bottom: 1.5rem; font-size: 1.2rem;">
                                <i class="fas fa-shield-alt"></i> Contingency
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Contingency Percent (applied to each CapEx individually)</label>
                                    <input type="text" id="sponsor-contingencyPercent" placeholder="e.g., 10%" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                </div>
                            </div>
                        </div>

                        <!-- Land & Infrastructure -->
                        <div style="background: rgba(10, 14, 39, 0.6); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                            <h3 style="color: #60a5fa; margin-bottom: 1.5rem; font-size: 1.2rem;">
                                <i class="fas fa-map-marked-alt"></i> Land & Infrastructure - <span id="land-currency">EUR</span>
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Land Purchase</label>
                                    <input type="text" id="sponsor-landPurchase" min="0" max="1000000000" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;" placeholder="0 - 1,000,000,000">
                                </div>
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Grid Connection Costs</label>
                                    <input type="text" id="sponsor-gridConnectionCosts" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;" placeholder="Enter amount">
                                </div>
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Stamp Duty %</label>
                                    <input type="text" id="sponsor-stampDutyPercent" min="0" max="20" step="0.01" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;" placeholder="0% - 20%">
                                </div>
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Stamp Duty Fixed (overrides %)</label>
                                    <input type="text" id="sponsor-stampDutyFixed" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;" placeholder="Enter fixed amount">
                                </div>
                            </div>
                        </div>

                        <!-- Fees -->
                        <div style="background: rgba(10, 14, 39, 0.6); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                            <h3 style="color: #60a5fa; margin-bottom: 1.5rem; font-size: 1.2rem;">
                                <i class="fas fa-file-invoice-dollar"></i> Fees - <span id="fees-currency">EUR</span>
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">DM</label>
                                    <input type="text" id="sponsor-feesDM" onchange="calculateSponsorTotals()" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;" placeholder="Enter amount">
                                </div>
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Management 3%</label>
                                    <input type="text" id="sponsor-feesManagement" readonly style="width: 100%; padding: 12px; background: rgba(10, 14, 39, 0.8); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 8px; color: #94a3b8;" placeholder="Auto-calculated">
                                </div>
                            </div>
                        </div>

                        <!-- Totals Display -->
                        <div style="background: linear-gradient(135deg, rgba(96, 165, 250, 0.1), rgba(59, 130, 246, 0.1)); border: 2px solid #60a5fa; border-radius: 12px; padding: 1.5rem;">
                            <h3 style="color: #60a5fa; margin-bottom: 1.5rem; font-size: 1.3rem;">
                                <i class="fas fa-calculator"></i> Calculated Totals
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div style="background: #0a0e27; padding: 1rem; border-radius: 8px;">
                                    <div style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 0.5rem;">CapEx Internal (incl. contingency)</div>
                                    <div id="sponsor-capexInternalTotal" style="color: white; font-size: 1.5rem; font-weight: 600;">€0</div>
                                </div>
                                <div style="background: #0a0e27; padding: 1rem; border-radius: 8px;">
                                    <div style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 0.5rem;">CapEx Market (incl. contingency)</div>
                                    <div id="sponsor-capexMarketTotal" style="color: white; font-size: 1.5rem; font-weight: 600;">€0</div>
                                </div>
                                <div style="background: #0a0e27; padding: 1rem; border-radius: 8px;">
                                    <div style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 0.5rem;">Land Total</div>
                                    <div id="sponsor-landTotal" style="color: white; font-size: 1.5rem; font-weight: 600;">€0</div>
                                </div>
                                <div style="background: #0a0e27; padding: 1rem; border-radius: 8px;">
                                    <div style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 0.5rem;">Fees Total</div>
                                    <div id="sponsor-feesTotal" style="color: white; font-size: 1.5rem; font-weight: 600;">€0</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #60a5fa, #3b82f6); padding: 1rem; border-radius: 8px;">
                                    <div style="color: white; font-size: 0.875rem; margin-bottom: 0.5rem; font-weight: 600;">GRAND TOTAL</div>
                                    <div id="sponsor-grandTotal" style="color: white; font-size: 2rem; font-weight: 700;">€0</div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid rgba(96, 165, 250, 0.2);">
                    <button onclick="closeSponsorEditor()" style="background: rgba(75, 85, 99, 0.3); color: #94a3b8; border: 1px solid rgba(75, 85, 99, 0.5); padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                        Cancel
                    </button>
                    <button onclick="saveSponsorProject()" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                        <i class="fas fa-save"></i> Save Project
                    </button>
                </div>
            </div>

            <!-- Collapsible Project Editor Section -->

            <!-- Delete Confirmation Modal -->
            <div id="delete-confirm-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10001; align-items: center; justify-content: center;">
                <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 2px solid #ef4444; border-radius: 16px; padding: 2rem; max-width: 500px; width: 90%;">
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ef4444; margin-bottom: 1rem;"></i>
                        <h2 style="color: #ef4444; font-size: 1.5rem; font-weight: 700; margin: 0;">Confirm Deletion</h2>
                    </div>
                    
                    <p id="delete-confirm-message" style="color: #e5e9f0; text-align: center; margin-bottom: 1.5rem;">
                        Are you sure you want to delete this item? It will be moved to trash and automatically deleted after 7 days.
                    </p>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button onclick="cancelDelete()" style="background: #64748b; color: white; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button id="confirm-delete-btn" onclick="confirmDelete()" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>


            <!-- Project Edit Modal -->
            <div id="project-edit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; align-items: center; justify-content: center;">
                <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="color: #60a5fa; font-size: 1.5rem; font-weight: 700; margin: 0;">
                            <i class="fas fa-edit"></i> Edit Project
                        </h2>
                        <button onclick="closeProjectEditModal()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form id="project-edit-form" onsubmit="saveProjectEdit(event)">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <div>
                                <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Project Title</label>
                                <input type="text" id="edit-project-title" required placeholder="Project name" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                            </div>
                            
                            <div>
                                <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Status</label>
                                <select id="edit-project-status" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    <option value="draft">Draft</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="active">Active</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1.5rem;">
                            <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Description</label>
                            <textarea id="edit-project-description" rows="4" placeholder="Project description" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
                            <div>
                                <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Value (€)</label>
                                <input type="number" id="edit-project-value" min="0" placeholder="0" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                            </div>
                            
                            <div>
                                <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Progress (%)</label>
                                <input type="number" id="edit-project-progress" min="0" max="100" placeholder="0" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                            </div>
                        </div>
                        
                        <!-- Permutation Engine Input Fields -->
                        <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(96, 165, 250, 0.2);">
                            <h3 style="color: #60a5fa; font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem;">
                                <i class="fas fa-calculator"></i> Permutation Engine Inputs
                            </h3>
                            <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 1rem;">Site-specific parameters for funding calculations</p>
                            
                            <!-- Required Fields Grid -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">
                                        Currency <span style="color: #ef4444;">*</span>
                                    </label>
                                    <select id="edit-project-currency" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                        <option value="">Select Currency</option>
                                        <option value="EUR">EUR (€)</option>
                                        <option value="USD">USD ($)</option>
                                        <option value="GBP">GBP (£)</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">
                                        Gross IT Load (MW) <span style="color: #ef4444;">*</span>
                                    </label>
                                    <input type="number" id="edit-project-gross-it-load" step="0.01" placeholder="e.g., 10.5" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                </div>
                                
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">
                                        PUE <span style="color: #ef4444;">*</span>
                                    </label>
                                    <input type="number" id="edit-project-pue" step="0.01" min="1" placeholder="e.g., 1.2" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                </div>
                                
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">
                                        CapEx Cost Price <span style="color: #ef4444;">*</span>
                                    </label>
                                    <input type="number" id="edit-project-capex-cost" step="0.01" placeholder="Amount" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                </div>
                                
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">
                                        CapEx Market Rate (%) <span style="color: #ef4444;">*</span>
                                    </label>
                                    <input type="number" id="edit-project-capex-rate" step="0.01" placeholder="e.g., 5.5" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                </div>
                                
                                <div>
                                    <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">
                                        Land Purchase Fees <span style="color: #ef4444;">*</span>
                                    </label>
                                    <input type="number" id="edit-project-land-fees" step="0.01" placeholder="Amount" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                </div>
                            </div>
                            
                            <!-- Optional Fields -->
                            <div style="margin-top: 1rem;">
                                <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 0.5rem;">Optional Parameters</p>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">
                                            Gross Monthly Rent (kWh)
                                        </label>
                                        <input type="number" id="edit-project-monthly-rent" step="0.01" placeholder="Optional" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                    
                                    <div>
                                        <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">
                                            OPEX
                                        </label>
                                        <input type="number" id="edit-project-opex" step="0.01" placeholder="Optional" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1.5rem;">
                            <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Additional Details</label>
                            <textarea id="edit-project-details" rows="6" placeholder="Enter any additional project information, notes, or requirements" style="width: 100%; padding: 12px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: white; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                            <button type="button" onclick="closeProjectEditModal()" style="background: rgba(75, 85, 99, 0.3); color: #94a3b8; border: 1px solid rgba(75, 85, 99, 0.5); padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                                Cancel
                            </button>
                            <button type="submit" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="project-editor-section" style="background: linear-gradient(135deg, #0a0e27, #020617); border: 2px solid #60a5fa; border-radius: 16px; padding: 1.5rem; margin-bottom: 1rem; display: none; position: relative; z-index: 10;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="color: #60a5fa; font-size: 1.5rem; font-weight: 700; margin: 0;">
                        <i class="fas fa-edit"></i> <span id="project-editor-title">Edit Project</span>
                    </h2>
                    <button onclick="closeProjectEditor()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
                <div id="project-editor-content" style="background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 0; min-height: calc(100vh - 300px); height: calc(100vh - 300px); overflow: hidden;">
                    <!-- Project editor iframe will be inserted here -->
                </div>
            </div>

            <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <!-- Header with Create Button on the right -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin: 0;">
                        <i class="fas fa-folder"></i> Project Management
                    </h2>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        {% if is_admin %}
                        <!-- User Selector for Admin -->
                        <div style="display: flex; align-items: center; gap: 0.5rem; background: rgba(96, 165, 250, 0.1); padding: 8px 16px; border-radius: 8px; border: 1px solid rgba(96, 165, 250, 0.3);">
                            <i class="fas fa-user" style="color: #60a5fa;"></i>
                            <select id="user-selector" onchange="if(typeof loadUserProjects !== 'undefined') loadUserProjects(this.value)" style="background: transparent; color: white; border: none; outline: none; cursor: pointer; font-size: 0.9rem;">
                                <option value="">My Projects</option>
                                <option value="all" style="color: #fbbf24;">All Users</option>
                            </select>
                        </div>
                        {% endif %}
                        <button id="add-project-btn" onclick="if(typeof createNewProject !== 'undefined') createNewProject()" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.2s ease;">
                            <i class="fas fa-plus"></i> Add Project
                        </button>
                        {% if is_admin %}
                        <button id="trash-btn" onclick="if(typeof toggleTrashSection !== 'undefined') toggleTrashSection()" style="background: linear-gradient(90deg, #ef4444, #dc2626); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.2s ease;">
                            <i class="fas fa-trash"></i> Trash
                        </button>
                        {% endif %}
                    </div>
                </div>

                <!-- Trash Section (Admin Only) - Positioned at the top -->
                {% if is_admin %}
                <div id="trash-section" style="display: none; margin-bottom: 2rem; padding: 2rem; background: rgba(239, 68, 68, 0.1); border: 2px solid rgba(239, 68, 68, 0.3); border-radius: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="color: #ef4444; font-size: 1.5rem; font-weight: 600; margin: 0;">
                            <i class="fas fa-trash-alt"></i> Deleted Projects
                        </h3>
                        <div style="display: flex; gap: 1rem;">
                            <button onclick="emptyTrash()" style="background: linear-gradient(90deg, #dc2626, #b91c1c); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-trash-restore"></i> Delete All
                            </button>
                            <button onclick="toggleTrashSection()" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>

                    <!-- Trash Loading -->
                    <div id="trash-loading" style="text-align: center; padding: 2rem; color: #94a3b8;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem;"></i>
                        <p>Loading deleted projects...</p>
                    </div>

                    <!-- Trash Items Grid -->
                    <div id="trash-grid" style="display: none; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                        <!-- Deleted items will be loaded here -->
                    </div>

                    <!-- Trash Empty State -->
                    <div id="trash-empty" style="display: none; text-align: center; padding: 3rem; color: #94a3b8;">
                        <i class="fas fa-recycle" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>No deleted projects in trash</p>
                    </div>
                </div>
                {% endif %}

                <!-- Loading indicator -->
                <div id="projects-loading" style="text-align: center; padding: 2rem; color: #94a3b8;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>Loading projects...</p>
                </div>

                <!-- Dynamic Projects Grid with Drag & Drop -->
                <div id="projects-grid" class="main-drop-zone" style="display: none; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; min-height: 200px; padding: 1rem; border: 2px dashed transparent; border-radius: 12px; transition: all 0.3s ease;">
                    <!-- Series and Projects will be loaded dynamically here -->
                </div>

                <!-- Empty State - Completely blank until user adds items -->
                <div id="projects-empty" style="display: none;">
                    <!-- Intentionally blank - items appear when user adds them -->
                </div>
                
                <!-- Old drop zone indicator removed - now using inline placeholders -->
                
                <!-- Project Statistics -->
                <div id="project-stats" style="display: none; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 2rem;">
                    <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                        <p style="color: #86efac; font-size: 0.9rem; margin-bottom: 0.5rem;">Active Projects</p>
                        <p id="active-count" style="color: #22c55e; font-size: 2rem; font-weight: 700;">0</p>
                    </div>
                    <div style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                        <p style="color: #93c5fd; font-size: 0.9rem; margin-bottom: 0.5rem;">In Progress</p>
                        <p id="progress-count" style="color: #60a5fa; font-size: 2rem; font-weight: 700;">0</p>
                    </div>
                    <div style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                        <p style="color: #93c5fd; font-size: 0.9rem; margin-bottom: 0.5rem;">Total Value</p>
                        <p id="total-value" style="color: #60a5fa; font-size: 2rem; font-weight: 700;">€0</p>
                    </div>
                    <div style="background: rgba(100, 116, 139, 0.1); border: 1px solid rgba(100, 116, 139, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                        <p style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 0.5rem;">Drafts</p>
                        <p id="draft-count" style="color: #64748b; font-size: 2rem; font-weight: 700;">0</p>
                    </div>
                </div>
                <!-- Trash feature removed for simplicity -->
            </div>
        </div>
    </div>

    <!-- Documents Section (External Accounts) -->
    <div id="documents-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">
                    <i class="fas fa-file-contract"></i> Project Documents
                </h2>
                <p style="color: #94a3b8; margin-bottom: 2rem;">Access and manage all project-related documentation</p>
                
                <!-- Document Categories -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <!-- Legal Documents -->
                    <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #60a5fa; font-size: 1.25rem; margin-bottom: 1rem;">
                            <i class="fas fa-gavel"></i> Legal Documents
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <a href="#" class="doc-link" style="color: #60a5fa; text-decoration: none; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; transition: all 0.3s;">
                                <i class="fas fa-file-pdf"></i> Master Agreement
                            </a>
                            <a href="#" class="doc-link" style="color: #60a5fa; text-decoration: none; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; transition: all 0.3s;">
                                <i class="fas fa-file-pdf"></i> Terms & Conditions
                            </a>
                            <a href="#" class="doc-link" style="color: #60a5fa; text-decoration: none; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; transition: all 0.3s;">
                                <i class="fas fa-file-pdf"></i> NDA Agreement
                            </a>
                        </div>
                    </div>
                    
                    <!-- Technical Documents -->
                    <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #60a5fa; font-size: 1.25rem; margin-bottom: 1rem;">
                            <i class="fas fa-cogs"></i> Technical Specifications
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <a href="#" class="doc-link" style="color: #60a5fa; text-decoration: none; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; transition: all 0.3s;">
                                <i class="fas fa-file-alt"></i> Project Blueprint
                            </a>
                            <a href="#" class="doc-link" style="color: #60a5fa; text-decoration: none; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; transition: all 0.3s;">
                                <i class="fas fa-file-alt"></i> API Documentation
                            </a>
                            <a href="#" class="doc-link" style="color: #60a5fa; text-decoration: none; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; transition: all 0.3s;">
                                <i class="fas fa-file-alt"></i> Integration Guide
                            </a>
                        </div>
                    </div>
                    
                    <!-- Financial Documents -->
                    <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #60a5fa; font-size: 1.25rem; margin-bottom: 1rem;">
                            <i class="fas fa-chart-line"></i> Financial Reports
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <a href="#" class="doc-link" style="color: #60a5fa; text-decoration: none; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; transition: all 0.3s;">
                                <i class="fas fa-file-excel"></i> Cash Flow Analysis
                            </a>
                            <a href="#" class="doc-link" style="color: #60a5fa; text-decoration: none; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; transition: all 0.3s;">
                                <i class="fas fa-file-excel"></i> Budget Overview
                            </a>
                            <a href="#" class="doc-link" style="color: #60a5fa; text-decoration: none; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; transition: all 0.3s;">
                                <i class="fas fa-file-excel"></i> ROI Projections
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Upload Section -->
                <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 2px dashed rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 2rem; text-align: center;">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #60a5fa; margin-bottom: 1rem;"></i>
                    <p style="color: #94a3b8; margin-bottom: 1rem;">Drag and drop files here or click to browse</p>
                    <button class="btn btn-primary" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; padding: 0.75rem 2rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-upload"></i> Upload Document
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Timeline Section (External Accounts) -->
    <div id="timeline-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">
                    <i class="fas fa-calendar-alt"></i> Project Timeline
                </h2>
                <p style="color: #94a3b8; margin-bottom: 2rem;">Track project milestones and deadlines</p>
                
                <!-- Timeline View Toggle -->
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                    <button class="btn btn-secondary active" onclick="setTimelineView('gantt')">
                        <i class="fas fa-bars"></i> Gantt View
                    </button>
                    <button class="btn btn-secondary" onclick="setTimelineView('calendar')">
                        <i class="fas fa-calendar"></i> Calendar View
                    </button>
                    <button class="btn btn-secondary" onclick="setTimelineView('list')">
                        <i class="fas fa-list"></i> List View
                    </button>
                </div>
                
                <!-- Timeline Content -->
                <div id="timeline-content" style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem; min-height: 400px;">
                    <!-- Phase Progress -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: #60a5fa; font-size: 1.25rem; margin-bottom: 1rem;">Current Phase: Development</h3>
                        <div style="background: rgba(0, 0, 0, 0.3); border-radius: 10px; height: 30px; position: relative; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #60a5fa, #3b82f6); height: 100%; width: 65%; border-radius: 10px; position: relative;">
                                <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: white; font-weight: 600;">65%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Milestones -->
                    <div style="display: grid; gap: 1rem;">
                        <div style="background: rgba(0, 0, 0, 0.3); border-left: 4px solid #22c55e; padding: 1rem; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="color: #22c55e; margin-bottom: 0.25rem;">✓ Project Kickoff</h4>
                                    <p style="color: #94a3b8; font-size: 0.875rem;">Initial planning and requirements gathering</p>
                                </div>
                                <span style="color: #64748b; font-size: 0.875rem;">Jan 15, 2024</span>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0, 0, 0, 0.3); border-left: 4px solid #22c55e; padding: 1rem; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="color: #22c55e; margin-bottom: 0.25rem;">✓ Design Phase Complete</h4>
                                    <p style="color: #94a3b8; font-size: 0.875rem;">UI/UX designs approved</p>
                                </div>
                                <span style="color: #64748b; font-size: 0.875rem;">Feb 28, 2024</span>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0, 0, 0, 0.3); border-left: 4px solid #60a5fa; padding: 1rem; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="color: #60a5fa; margin-bottom: 0.25rem;">• Development Sprint 3</h4>
                                    <p style="color: #94a3b8; font-size: 0.875rem;">Core features implementation</p>
                                </div>
                                <span style="color: #64748b; font-size: 0.875rem;">In Progress</span>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0, 0, 0, 0.3); border-left: 4px solid #64748b; padding: 1rem; border-radius: 6px; opacity: 0.7;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="color: #94a3b8; margin-bottom: 0.25rem;">○ Testing Phase</h4>
                                    <p style="color: #64748b; font-size: 0.875rem;">QA and user acceptance testing</p>
                                </div>
                                <span style="color: #64748b; font-size: 0.875rem;">Apr 15, 2024</span>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0, 0, 0, 0.3); border-left: 4px solid #64748b; padding: 1rem; border-radius: 6px; opacity: 0.7;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="color: #94a3b8; margin-bottom: 0.25rem;">○ Go Live</h4>
                                    <p style="color: #64748b; font-size: 0.875rem;">Production deployment</p>
                                </div>
                                <span style="color: #64748b; font-size: 0.875rem;">May 1, 2024</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Section (External Accounts) -->
    <div id="reports-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">
                    <i class="fas fa-file-pdf"></i> Project Reports
                </h2>
                <p style="color: #94a3b8; margin-bottom: 2rem;">Generate and download comprehensive project reports</p>
                
                <!-- Report Types -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s;" 
                         onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='#60a5fa';" 
                         onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(96, 165, 250, 0.2)';">
                        <i class="fas fa-chart-bar" style="font-size: 2.5rem; color: #60a5fa; margin-bottom: 1rem;"></i>
                        <h3 style="color: #60a5fa; font-size: 1.125rem; margin-bottom: 0.5rem;">Progress Report</h3>
                        <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 1rem;">Weekly project progress summary</p>
                        <button class="btn btn-primary" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; padding: 0.5rem 1rem; border: none; border-radius: 6px; font-size: 0.875rem;">
                            Generate Report
                        </button>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s;" 
                         onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='#60a5fa';" 
                         onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(96, 165, 250, 0.2)';">
                        <i class="fas fa-coins" style="font-size: 2.5rem; color: #60a5fa; margin-bottom: 1rem;"></i>
                        <h3 style="color: #60a5fa; font-size: 1.125rem; margin-bottom: 0.5rem;">Financial Report</h3>
                        <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 1rem;">Budget and expense analysis</p>
                        <button class="btn btn-primary" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; padding: 0.5rem 1rem; border: none; border-radius: 6px; font-size: 0.875rem;">
                            Generate Report
                        </button>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s;" 
                         onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='#60a5fa';" 
                         onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(96, 165, 250, 0.2)';">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; color: #60a5fa; margin-bottom: 1rem;"></i>
                        <h3 style="color: #60a5fa; font-size: 1.125rem; margin-bottom: 0.5rem;">Risk Assessment</h3>
                        <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 1rem;">Identify and mitigate risks</p>
                        <button class="btn btn-primary" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; padding: 0.5rem 1rem; border: none; border-radius: 6px; font-size: 0.875rem;">
                            Generate Report
                        </button>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s;" 
                         onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='#60a5fa';" 
                         onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(96, 165, 250, 0.2)';">
                        <i class="fas fa-file-alt" style="font-size: 2.5rem; color: #60a5fa; margin-bottom: 1rem;"></i>
                        <h3 style="color: #60a5fa; font-size: 1.125rem; margin-bottom: 0.5rem;">Executive Summary</h3>
                        <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 1rem;">High-level project overview</p>
                        <button class="btn btn-primary" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; padding: 0.5rem 1rem; border: none; border-radius: 6px; font-size: 0.875rem;">
                            Generate Report
                        </button>
                    </div>
                </div>
                
                <!-- Recent Reports -->
                <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem;">
                    <h3 style="color: #60a5fa; font-size: 1.25rem; margin-bottom: 1rem;">
                        <i class="fas fa-history"></i> Recent Reports
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <i class="fas fa-file-pdf" style="color: #ef4444; font-size: 1.5rem;"></i>
                                <div>
                                    <div style="color: #e2e8f0; font-weight: 600;">Weekly Progress Report</div>
                                    <div style="color: #64748b; font-size: 0.875rem;">Generated on Mar 10, 2024</div>
                                </div>
                            </div>
                            <button class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                                <i class="fas fa-download"></i> Download
                            </button>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <i class="fas fa-file-pdf" style="color: #ef4444; font-size: 1.5rem;"></i>
                                <div>
                                    <div style="color: #e2e8f0; font-weight: 600;">Financial Report Q1</div>
                                    <div style="color: #64748b; font-size: 0.875rem;">Generated on Mar 5, 2024</div>
                                </div>
                            </div>
                            <button class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                                <i class="fas fa-download"></i> Download
                            </button>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <i class="fas fa-file-pdf" style="color: #ef4444; font-size: 1.5rem;"></i>
                                <div>
                                    <div style="color: #e2e8f0; font-weight: 600;">Risk Assessment Report</div>
                                    <div style="color: #64748b; font-size: 0.875rem;">Generated on Feb 28, 2024</div>
                                </div>
                            </div>
                            <button class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                                <i class="fas fa-download"></i> Download
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Support Section (External Accounts) -->
    <div id="support-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">
                    <i class="fas fa-headset"></i> Support Center
                </h2>
                <p style="color: #94a3b8; margin-bottom: 2rem;">Get help and support for your project</p>
                
                <!-- Quick Actions -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <button class="btn btn-primary" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; padding: 1rem; border: none; border-radius: 8px; display: flex; align-items: center; gap: 0.75rem; font-size: 1rem; cursor: pointer;">
                        <i class="fas fa-comment-dots" style="font-size: 1.25rem;"></i>
                        <span>Start Live Chat</span>
                    </button>
                    
                    <button class="btn btn-secondary" style="background: rgba(96, 165, 250, 0.1); color: #60a5fa; padding: 1rem; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; display: flex; align-items: center; gap: 0.75rem; font-size: 1rem; cursor: pointer;">
                        <i class="fas fa-phone" style="font-size: 1.25rem;"></i>
                        <span>Schedule Call</span>
                    </button>
                    
                    <button class="btn btn-secondary" style="background: rgba(96, 165, 250, 0.1); color: #60a5fa; padding: 1rem; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; display: flex; align-items: center; gap: 0.75rem; font-size: 1rem; cursor: pointer;">
                        <i class="fas fa-envelope" style="font-size: 1.25rem;"></i>
                        <span>Email Support</span>
                    </button>
                    
                    <button class="btn btn-secondary" style="background: rgba(96, 165, 250, 0.1); color: #60a5fa; padding: 1rem; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; display: flex; align-items: center; gap: 0.75rem; font-size: 1rem; cursor: pointer;">
                        <i class="fas fa-book" style="font-size: 1.25rem;"></i>
                        <span>Documentation</span>
                    </button>
                </div>
                
                <!-- Support Tickets -->
                <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="color: #60a5fa; font-size: 1.25rem;">
                            <i class="fas fa-ticket-alt"></i> Support Tickets
                        </h3>
                        <button class="btn btn-primary" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; padding: 0.5rem 1rem; border: none; border-radius: 6px; font-size: 0.875rem;">
                            <i class="fas fa-plus"></i> New Ticket
                        </button>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px; border-left: 4px solid #22c55e;">
                            <div>
                                <div style="color: #e2e8f0; font-weight: 600;">#1234 - Login Issue Resolved</div>
                                <div style="color: #64748b; font-size: 0.875rem;">Status: Closed • Updated: 2 days ago</div>
                            </div>
                            <span style="background: #22c55e; color: white; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.75rem;">RESOLVED</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px; border-left: 4px solid #60a5fa;">
                            <div>
                                <div style="color: #e2e8f0; font-weight: 600;">#1235 - API Integration Question</div>
                                <div style="color: #64748b; font-size: 0.875rem;">Status: In Progress • Updated: 5 hours ago</div>
                            </div>
                            <span style="background: #60a5fa; color: white; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.75rem;">IN PROGRESS</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px; border-left: 4px solid #60a5fa;">
                            <div>
                                <div style="color: #e2e8f0; font-weight: 600;">#1236 - Feature Request</div>
                                <div style="color: #64748b; font-size: 0.875rem;">Status: Pending • Updated: 1 day ago</div>
                            </div>
                            <span style="background: #60a5fa; color: #1e293b; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.75rem;">PENDING</span>
                        </div>
                    </div>
                </div>
                
                <!-- FAQ Section -->
                <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem;">
                    <h3 style="color: #60a5fa; font-size: 1.25rem; margin-bottom: 1rem;">
                        <i class="fas fa-question-circle"></i> Frequently Asked Questions
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <details style="background: rgba(0, 0, 0, 0.3); padding: 1rem; border-radius: 6px; cursor: pointer;">
                            <summary style="color: #e2e8f0; font-weight: 600; list-style: none; display: flex; justify-content: space-between; align-items: center;">
                                How do I access project documents?
                                <i class="fas fa-chevron-down" style="color: #60a5fa;"></i>
                            </summary>
                            <p style="color: #94a3b8; margin-top: 1rem; padding-left: 1rem;">
                                Navigate to the Documents section from the main navigation bar. All project-related documents are organized by category for easy access.
                            </p>
                        </details>
                        
                        <details style="background: rgba(0, 0, 0, 0.3); padding: 1rem; border-radius: 6px; cursor: pointer;">
                            <summary style="color: #e2e8f0; font-weight: 600; list-style: none; display: flex; justify-content: space-between; align-items: center;">
                                How often are reports generated?
                                <i class="fas fa-chevron-down" style="color: #60a5fa;"></i>
                            </summary>
                            <p style="color: #94a3b8; margin-top: 1rem; padding-left: 1rem;">
                                Reports can be generated on-demand at any time. Automated reports are generated weekly, monthly, and quarterly based on your project settings.
                            </p>
                        </details>
                        
                        <details style="background: rgba(0, 0, 0, 0.3); padding: 1rem; border-radius: 6px; cursor: pointer;">
                            <summary style="color: #e2e8f0; font-weight: 600; list-style: none; display: flex; justify-content: space-between; align-items: center;">
                                What is the typical response time for support tickets?
                                <i class="fas fa-chevron-down" style="color: #60a5fa;"></i>
                            </summary>
                            <p style="color: #94a3b8; margin-top: 1rem; padding-left: 1rem;">
                                Our support team typically responds within 2-4 hours during business hours. Critical issues are prioritized and addressed immediately.
                            </p>
                        </details>
                    </div>
                </div>
                
                <!-- Contact Information -->
                <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem; margin-top: 2rem; text-align: center;">
                    <h3 style="color: #60a5fa; font-size: 1.25rem; margin-bottom: 1rem;">Need Immediate Assistance?</h3>
                    <p style="color: #94a3b8; margin-bottom: 1rem;">Our support team is available Monday-Friday, 9 AM - 6 PM GMT</p>
                    <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
                        <div>
                            <i class="fas fa-envelope" style="color: #60a5fa; margin-right: 0.5rem;"></i>
                            <a href="mailto:Support@AtlasNexus.co.uk" style="color: #60a5fa; text-decoration: none;">Support@AtlasNexus.co.uk</a>
                        </div>
                        <div>
                            <i class="fas fa-phone" style="color: #60a5fa; margin-right: 0.5rem;"></i>
                            <span style="color: #60a5fa;">+44 20 1234 5678</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Permutation Engine - Atlas Forge Configuration -->
<div id="permutation-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
    <div style="max-width: 1600px; margin: 0 auto;">
        
        <!-- Title -->
        <div style="text-align: center; margin-bottom: 2rem;">
            <h2 style="color: #60a5fa; font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">
                <i class="fas fa-cogs"></i> Atlas Forge — Permutation Engine
            </h2>
            <p style="color: #94a3b8;">Lever Map Configuration v1.0.1 | Europe/London | DSCR Engine Active</p>
        </div>

        <!-- All Steps Grid -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
            
            <!-- Step 1: Project Fixed Inputs & Import -->
            <div style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa; border-radius: 12px; padding: 1.5rem;">
                <h3 style="color: #60a5fa; margin-bottom: 1.5rem; font-size: 1.2rem;">
                    <span style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; padding: 0.25rem 0.75rem; border-radius: 6px; margin-right: 0.5rem;">1</span>
                    Project Fixed Inputs
                </h3>
                
                <button onclick="applyProjectToPermutation(event)" style="width: 100%; padding: 0.75rem; background: linear-gradient(135deg, #60a5fa, #3b82f6); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-bottom: 1rem;">
                    <i class="fas fa-download"></i> Load Project from Projects Tool
                </button>
                
                <select id="project-selector" onchange="loadProjectData()" style="width: 100%; padding: 0.75rem; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: #e2e8f0; margin-bottom: 1rem;">
                    <option value="">-- Or Select Project Specification --</option>
                </select>
                
                <div id="project-info" style="display: none; padding: 1rem; background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px;">
                    <div style="color: #10b981; font-size: 0.9rem;">Project Loaded</div>
                    <div id="project-name" style="color: #e2e8f0; font-weight: 600; margin-top: 0.25rem;"></div>
                </div>
                
                <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(96, 165, 250, 0.05); border-radius: 6px;">
                    <p style="color: #94a3b8; font-size: 0.85rem; margin: 0;">
                        <i class="fas fa-info-circle"></i> Click button above to load your project data
                    </p>
                </div>
            </div>

            <!-- Step 2: Capital Stack & Market State -->
            <div style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa; border-radius: 12px; padding: 1.5rem;">
                <h3 style="color: #60a5fa; margin-bottom: 1.5rem; font-size: 1.2rem;">
                    <span style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; padding: 0.25rem 0.75rem; border-radius: 6px; margin-right: 0.5rem;">2</span>
                    Capital Stack Configuration
                </h3>
                
                <div style="display: grid; gap: 1rem;">
                    <!-- Senior Debt Configuration -->
                    <div style="padding: 0.75rem; background: linear-gradient(135deg, #0a0e27, #020617); border-radius: 6px;">
                        <div style="color: #10b981; font-size: 0.8rem;">Target DSCR Senior [37]</div>
                        <input type="number" id="TargetDSCRSenior_37" value="1.30" min="1.10" max="2.50" step="0.05" style="width: 100%; padding: 0.5rem; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 4px; color: #e2e8f0; margin-top: 0.25rem;">
                        <input type="checkbox" id="TargetDSCRSenior_37_range" style="margin-top: 0.5rem;"> <label for="TargetDSCRSenior_37_range" style="color: #94a3b8; font-size: 0.8rem;">Enable Range (1.20 - 1.50)</label>
                    </div>
                    <div style="padding: 0.75rem; background: linear-gradient(135deg, #0a0e27, #020617); border-radius: 6px;">
                        <div style="color: #10b981; font-size: 0.8rem;">Senior Coupon [38] (%)</div>
                        <input type="number" id="SeniorCoupon_38" value="5.00" min="0.5" max="12" step="0.25" style="width: 100%; padding: 0.5rem; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 4px; color: #e2e8f0; margin-top: 0.25rem;">
                        <input type="checkbox" id="SeniorCoupon_38_range" checked style="margin-top: 0.5rem;"> <label for="SeniorCoupon_38_range" style="color: #94a3b8; font-size: 0.8rem;">Enable Range (3.5 - 7.0)</label>
                    </div>
                    <div style="padding: 0.75rem; background: linear-gradient(135deg, #0a0e27, #020617); border-radius: 6px;">
                        <div style="color: #10b981; font-size: 0.8rem;">Senior Tenor [39] (Years)</div>
                        <input type="number" id="SeniorTenorY_39" value="25" min="3" max="40" style="width: 100%; padding: 0.5rem; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 4px; color: #e2e8f0; margin-top: 0.25rem;">
                    </div>
                    <div style="padding: 0.75rem; background: linear-gradient(135deg, #0a0e27, #020617); border-radius: 6px;">
                        <div style="color: #10b981; font-size: 0.8rem;">Senior Amortization Type [40]</div>
                        <select id="SeniorAmortType_40" style="width: 100%; padding: 0.5rem; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 4px; color: #e2e8f0; margin-top: 0.25rem;">
                            <option value="Annuity" selected>Annuity</option>
                            <option value="Sculpted">Sculpted</option>
                            <option value="Bullet">Bullet</option>
                            <option value="StepDown">StepDown</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Step 3: Project Inputs & Revenue -->
            <div style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa; border-radius: 12px; padding: 1.5rem;">
                <h3 style="color: #60a5fa; margin-bottom: 1.5rem; font-size: 1.2rem;">
                    <span style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; padding: 0.25rem 0.75rem; border-radius: 6px; margin-right: 0.5rem;">3</span>
                    Project Inputs & Revenue
                </h3>
                
                <div style="display: grid; gap: 1rem;">
                    <!-- Gross IT Load [02] -->
                    <div>
                        <label style="color: #e2e8f0; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Gross IT Load [02] (MW)</label>
                        <input type="number" id="GrossITLoad_02" value="100" min="1" max="3000" style="width: 100%; padding: 0.5rem; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 4px; color: #e2e8f0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
                            <input type="number" id="GrossITLoad_02_min" placeholder="Min" value="10" step="10" style="padding: 0.25rem; background: rgba(10, 14, 39, 0.6); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 4px; color: #94a3b8; font-size: 0.85rem;">
                            <input type="number" id="GrossITLoad_02_max" placeholder="Max" value="1000" step="10" style="padding: 0.25rem; background: rgba(10, 14, 39, 0.6); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 4px; color: #94a3b8; font-size: 0.85rem;">
                        </div>
                    </div>
                    
                    <!-- PUE [03] -->
                    <div>
                        <label style="color: #e2e8f0; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">PUE Factor [03] (x)</label>
                        <input type="number" id="PUE_03" value="1.30" min="1.05" max="1.8" step="0.05" style="width: 100%; padding: 0.5rem; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 4px; color: #e2e8f0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
                            <input type="number" id="PUE_03_min" placeholder="Min" value="1.15" step="0.05" style="padding: 0.25rem; background: rgba(10, 14, 39, 0.6); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 4px; color: #94a3b8; font-size: 0.85rem;">
                            <input type="number" id="PUE_03_max" placeholder="Max" value="1.5" step="0.05" style="padding: 0.25rem; background: rgba(10, 14, 39, 0.6); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 4px; color: #94a3b8; font-size: 0.85rem;">
                        </div>
                    </div>
                    
                    <!-- Gross Monthly Rent [07] -->
                    <div>
                        <label style="color: #e2e8f0; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Gross Monthly Rent [07] (£/month)</label>
                        <input type="number" id="GrossMonthlyRent_07" value="2500000" min="100000" max="200000000" style="width: 100%; padding: 0.5rem; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 4px; color: #e2e8f0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
                            <input type="number" id="GrossMonthlyRent_07_min" placeholder="Min" value="500000" step="50000" style="padding: 0.25rem; background: rgba(10, 14, 39, 0.6); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 4px; color: #94a3b8; font-size: 0.85rem;">
                            <input type="number" id="GrossMonthlyRent_07_max" placeholder="Max" value="5000000" step="50000" style="padding: 0.25rem; background: rgba(10, 14, 39, 0.6); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 4px; color: #94a3b8; font-size: 0.85rem;">
                        </div>
                        <input type="checkbox" id="GrossMonthlyRent_07_range" checked style="margin-top: 0.5rem;"> <label for="GrossMonthlyRent_07_range" style="color: #94a3b8; font-size: 0.8rem;">Enable Range</label>
                    </div>
                    
                    <!-- OPEX [08] -->
                    <div>
                        <label style="color: #e2e8f0; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">OPEX [08] (%)</label>
                        <input type="number" id="OPEX_08" value="25" min="0" max="80" style="width: 100%; padding: 0.5rem; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 4px; color: #e2e8f0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
                            <input type="number" id="OPEX_08_min" placeholder="Min" value="15" step="1" style="padding: 0.25rem; background: rgba(10, 14, 39, 0.6); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 4px; color: #94a3b8; font-size: 0.85rem;">
                            <input type="number" id="OPEX_08_max" placeholder="Max" value="35" step="1" style="padding: 0.25rem; background: rgba(10, 14, 39, 0.6); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 4px; color: #94a3b8; font-size: 0.85rem;">
                        </div>
                        <input type="checkbox" id="OPEX_08_range" checked style="margin-top: 0.5rem;"> <label for="OPEX_08_range" style="color: #94a3b8; font-size: 0.8rem;">Enable Range</label>
                    </div>
                    
                    <!-- Lease Term Years [22] -->
                    <div>
                        <label style="color: #e2e8f0; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Lease Term [22] (Years)</label>
                        <input type="number" id="LeaseTermYears_22" value="25" min="5" max="40" style="width: 100%; padding: 0.5rem; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 4px; color: #e2e8f0;">
                    </div>
                </div>
            </div>

            <!-- Step 4: Execution & Ranking Configuration -->
            <div style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa; border-radius: 12px; padding: 1.5rem;">
                <h3 style="color: #60a5fa; margin-bottom: 1.5rem; font-size: 1.2rem;">
                    <span style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; padding: 0.25rem 0.75rem; border-radius: 6px; margin-right: 0.5rem;">4</span>
                    Execution & Ranking
                </h3>
                
                <!-- Ranking Objective [109] -->
                <div style="margin-bottom: 1rem;">
                    <label style="color: #e2e8f0; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Ranking Objective [109]</label>
                    <select id="RankingObjective_109" style="width: 100%; padding: 0.5rem; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 4px; color: #e2e8f0;">
                        <option value="MaxSeniorRaise">Max Senior Raise</option>
                        <option value="MinWACC">Min WACC</option>
                        <option value="MaxDay1Cash">Max Day 1 Cash</option>
                        <option value="MaxEquityIRR">Max Equity IRR</option>
                        <option value="Composite" selected>Composite Score</option>
                    </select>
                </div>
                
                <!-- Max Permutations [108] -->
                <div style="margin-bottom: 1rem;">
                    <label style="color: #e2e8f0; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Max Permutations [108]</label>
                    <input type="number" id="MaxPermutations_108" value="150000" min="1000" max="1000000" style="width: 100%; padding: 0.5rem; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 4px; color: #e2e8f0;">
                </div>
                
                <!-- Estimation Display -->
                <div style="padding: 1rem; background: rgba(96, 165, 250, 0.1); border-radius: 8px; margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; text-align: center;">
                        <div>
                            <div style="color: #94a3b8; font-size: 0.85rem;">Estimated Scenarios</div>
                            <div id="est-scenarios" style="color: #60a5fa; font-size: 1.8rem; font-weight: bold;">1,000</div>
                        </div>
                        <div>
                            <div style="color: #94a3b8; font-size: 0.85rem;">Processing Time</div>
                            <div id="est-time" style="color: #60a5fa; font-size: 1.8rem; font-weight: bold;">~2s</div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="display: grid; gap: 1rem;">
                    <button onclick="generateScenarios()" style="padding: 1rem; background: linear-gradient(90deg, #10b981, #059669); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-rocket"></i> Generate All Scenarios
                    </button>
                    <button onclick="generateViableOnly()" style="padding: 1rem; background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-filter"></i> Generate Viable Only
                    </button>
                    <button onclick="quickPreview()" style="padding: 1rem; background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; color: #60a5fa; font-size: 1rem; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-eye"></i> Quick Preview (10 samples)
                    </button>
                </div>
                
                <!-- Quick Stats -->
                <div id="quick-stats" style="display: none; margin-top: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #0a0e27, #020617); border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center;">
                        <div>
                            <div style="color: #10b981; font-size: 0.8rem;">Total</div>
                            <div id="stat-total" style="font-weight: bold; color: #e2e8f0;">0</div>
                        </div>
                        <div>
                            <div style="color: #10b981; font-size: 0.8rem;">Viable</div>
                            <div id="stat-viable" style="font-weight: bold; color: #e2e8f0;">0</div>
                        </div>
                        <div>
                            <div style="color: #10b981; font-size: 0.8rem;">Best IRR</div>
                            <div id="stat-irr" style="font-weight: bold; color: #e2e8f0;">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Table (Initially Hidden) -->
        <div id="results-container" style="display: none; margin-top: 2rem; background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa; border-radius: 12px; padding: 1.5rem;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="color: #60a5fa; flex: 1;">
                    <i class="fas fa-table"></i> Scenario Results
                </h3>
                <div style="display: flex; gap: 1rem;">
                    <button onclick="exportCSV()" style="padding: 0.5rem 1rem; background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                    <button onclick="clearResults()" style="padding: 0.5rem 1rem; background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: rgba(96, 165, 250, 0.1);">
                            <th style="padding: 0.75rem; text-align: left; color: #60a5fa; border-bottom: 2px solid rgba(96, 165, 250, 0.2);">#</th>
                            <th style="padding: 0.75rem; text-align: left; color: #60a5fa; border-bottom: 2px solid rgba(96, 165, 250, 0.2);">Monthly Rent</th>
                            <th style="padding: 0.75rem; text-align: left; color: #60a5fa; border-bottom: 2px solid rgba(96, 165, 250, 0.2);">OPEX</th>
                            <th style="padding: 0.75rem; text-align: left; color: #60a5fa; border-bottom: 2px solid rgba(96, 165, 250, 0.2);">Coupon</th>
                            <th style="padding: 0.75rem; text-align: left; color: #60a5fa; border-bottom: 2px solid rgba(96, 165, 250, 0.2);">DSCR</th>
                            <th style="padding: 0.75rem; text-align: left; color: #60a5fa; border-bottom: 2px solid rgba(96, 165, 250, 0.2);">IRR</th>
                            <th style="padding: 0.75rem; text-align: left; color: #60a5fa; border-bottom: 2px solid rgba(96, 165, 250, 0.2);">Senior Raise</th>
                            <th style="padding: 0.75rem; text-align: left; color: #60a5fa; border-bottom: 2px solid rgba(96, 165, 250, 0.2);">Status</th>
                        </tr>
                    </thead>
                    <tbody id="results-tbody">
                        <!-- Results will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// Atlas Forge Permutation Engine - v1.0.0
let scenarios = [];
let permutationConfig = {
    fields: {},
    rangeEnabled: {},
    executionOrder: [
        'ingest_fixed_inputs',
        'compute_derived',
        'apply_mode_toggles',
        'load_market_state',
        'size_and_price_senior',
        'add_mezzanine',
        'add_equity_trs',
        'apply_wrap_liquidity',
        'shape_cashflows',
        'apply_rating_eligibility',
        'run_stresses_haircuts',
        'apply_derivatives_sidecar',
        'build_waterfall_triggers',
        'rank_filter_export'
    ]
};

// Update calculations when inputs change
document.addEventListener('DOMContentLoaded', function() {
    // Auto-calculate derived fields
    const updateDerivedFields = () => {
        // NetITLoad_09 = GrossITLoad_02 / PUE_03
        const grossIT = parseFloat(document.getElementById('GrossITLoad_02')?.value) || 100;
        const pue = parseFloat(document.getElementById('PUE_03')?.value) || 1.30;
        const netIT = grossIT / pue;
        
        // Update display if exists
        const netLoadDisplay = document.getElementById('NetITLoad_09_display');
        if (netLoadDisplay) {
            netLoadDisplay.textContent = netIT.toFixed(1) + ' MW';
        }
        
        // GrossIncome_10 = GrossMonthlyRent_07 * 12
        const monthlyRent = parseFloat(document.getElementById('GrossMonthlyRent_07')?.value) || 2500000;
        const grossIncome = monthlyRent * 12;
        
        // NetIncome_11 based on OPEX mode
        const opex = parseFloat(document.getElementById('OPEX_08')?.value) || 25;
        const netIncome = grossIncome * (1 - opex/100);
        
        return { netIT, grossIncome, netIncome };
    };
    
    // Add listeners to key input fields
    ['GrossITLoad_02', 'PUE_03', 'GrossMonthlyRent_07', 'OPEX_08'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', updateDerivedFields);
        }
    });
    
    // Estimate scenarios when ranges change
    const estimateScenarios = () => {
        let totalPermutations = 1;
        
        // Check each field with range enabled
        const rangeFields = [
            { id: 'GrossMonthlyRent_07', steps: 20 },
            { id: 'OPEX_08', steps: 20 },
            { id: 'TargetDSCRSenior_37', steps: 7 },
            { id: 'SeniorCoupon_38', steps: 14 }
        ];
        
        rangeFields.forEach(field => {
            const rangeCheckbox = document.getElementById(field.id + '_range');
            if (rangeCheckbox && rangeCheckbox.checked) {
                totalPermutations *= field.steps;
            }
        });
        
        // Apply max permutations limit
        const maxPermutations = parseInt(document.getElementById('MaxPermutations_108')?.value) || 150000;
        totalPermutations = Math.min(totalPermutations, maxPermutations);
        
        const estScenariosEl = document.getElementById('est-scenarios');
        const estTimeEl = document.getElementById('est-time');
        if (estScenariosEl) estScenariosEl.textContent = totalPermutations.toLocaleString();
        if (estTimeEl) estTimeEl.textContent = '~' + Math.ceil(totalPermutations / 500) + 's';
    };
    
    // Add listeners to all range inputs and checkboxes
    const rangeInputs = [
        'GrossMonthlyRent_07_min', 'GrossMonthlyRent_07_max',
        'OPEX_08_min', 'OPEX_08_max',
        'TargetDSCRSenior_37', 'SeniorCoupon_38',
        'MaxPermutations_108'
    ];
    
    rangeInputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', estimateScenarios);
        }
    });
    
    // Add listeners to range checkboxes
    ['GrossMonthlyRent_07_range', 'OPEX_08_range', 'TargetDSCRSenior_37_range', 'SeniorCoupon_38_range'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', estimateScenarios);
        }
    });
    
    // Initial calculations
    updateDerivedFields();
    estimateScenarios();
});

// Load project data if selected
function loadProjectData() {
    const selector = document.getElementById('project-selector');
    if (selector.value && window.projectsData) {
        const project = window.projectsData.find(p => p.code === selector.value);
        if (project) {
            // Show project info
            document.getElementById('project-info').style.display = 'block';
            document.getElementById('project-name').textContent = project.name;
            
            // Auto-fill values from project data
            if (project.capex) {
                const capexInput = document.getElementById('CapexCostPrice_04');
                if (capexInput) capexInput.value = project.capex;
            }
            if (project.itLoad) {
                document.getElementById('GrossITLoad_02').value = project.itLoad;
            }
            if (project.pue) {
                document.getElementById('PUE_03').value = project.pue;
            }
            if (project.monthlyRent) {
                document.getElementById('GrossMonthlyRent_07').value = project.monthlyRent;
            }
            if (project.opex) {
                document.getElementById('OPEX_08').value = project.opex;
            }
            
            // Trigger recalculation
            const event = new Event('input');
            document.getElementById('GrossITLoad_02').dispatchEvent(event);
            
            // Show notification
            if (window.showNotification) {
                window.showNotification('Project data loaded successfully', 'success');
            }
        }
    } else {
        document.getElementById('project-info').style.display = 'none';
    }
}

// Generate scenarios functions
function generateScenarios() {
    runGeneration('all');
}

function generateViableOnly() {
    runGeneration('viable');
}

function quickPreview() {
    runGeneration('preview');
}

async function runGeneration(mode) {
    // Get configuration for all fields with ranges enabled
    const config = {
        GrossMonthlyRent_07: {
            enabled: document.getElementById('GrossMonthlyRent_07_range').checked,
            value: parseFloat(document.getElementById('GrossMonthlyRent_07')?.value) || 2500000,
            min: parseFloat(document.getElementById('GrossMonthlyRent_07_min')?.value) || 500000,
            max: parseFloat(document.getElementById('GrossMonthlyRent_07_max')?.value) || 5000000,
            step: 50000
        },
        OPEX_08: {
            enabled: document.getElementById('OPEX_08_range').checked,
            value: parseFloat(document.getElementById('OPEX_08')?.value) || 25,
            min: parseFloat(document.getElementById('OPEX_08_min')?.value) || 15,
            max: parseFloat(document.getElementById('OPEX_08_max')?.value) || 35,
            step: 1
        },
        TargetDSCRSenior_37: {
            enabled: document.getElementById('TargetDSCRSenior_37_range') ? document.getElementById('TargetDSCRSenior_37_range').checked : false,
            value: parseFloat(document.getElementById('TargetDSCRSenior_37')?.value) || 1.30,
            min: 1.20,
            max: 1.50,
            step: 0.05
        },
        SeniorCoupon_38: {
            enabled: document.getElementById('SeniorCoupon_38_range') ? document.getElementById('SeniorCoupon_38_range').checked : false,
            value: parseFloat(document.getElementById('SeniorCoupon_38')?.value) || 5.00,
            min: 3.5,
            max: 7.0,
            step: 0.25
        }
    };
    
    // Get fixed inputs
    const grossIT = parseFloat(document.getElementById('GrossITLoad_02')?.value) || 100;
    const pue = parseFloat(document.getElementById('PUE_03')?.value) || 1.30;
    const seniorTenor = parseFloat(document.getElementById('SeniorTenorY_39')?.value) || 25;
    const rankingObjective = document.getElementById('RankingObjective_109').value || 'Composite';
    
    // Show loading indicator
    const quickStats = document.getElementById('quick-stats');
    quickStats.innerHTML = '<div style="text-align: center; color: #60a5fa;"><i class="fas fa-spinner fa-spin"></i> Running permutation engine...</div>';
    quickStats.style.display = 'block';
    
    // Try to use the server-side engine first
    try {
        const response = await fetch('/api/permutation/run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                ...config,
                GrossITLoad_02: grossIT,
                PUE_03: pue,
                SeniorTenorY_39: seniorTenor,
                mode: mode,
                RankingObjective_109: rankingObjective,
                MaxPermutations_108: parseInt(document.getElementById('MaxPermutations_108')?.value) || 150000
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.status === 'success') {
                // Process server results
                processServerResults(data.results);
                return;
            }
        }
    } catch (error) {
        console.log('Server engine not available, using client-side generation');
    }
    
    // Fallback to client-side generation
    scenarios = [];
    const maxCount = mode === 'preview' ? 10 : (mode === 'viable' ? 500 : 1000);
    let viableCount = 0;
    let bestIRR = 0;
    let bestDSCR = 0;
    
    for (let i = 0; i < maxCount; i++) {
        // Generate scenario with ranged or fixed values
        const rent = config.GrossMonthlyRent_07.enabled ? 
            config.GrossMonthlyRent_07.min + Math.random() * (config.GrossMonthlyRent_07.max - config.GrossMonthlyRent_07.min) :
            config.GrossMonthlyRent_07.value;
            
        const opex = config.OPEX_08.enabled ?
            config.OPEX_08.min + Math.random() * (config.OPEX_08.max - config.OPEX_08.min) :
            config.OPEX_08.value;
            
        const dscr = config.TargetDSCRSenior_37.enabled ?
            config.TargetDSCRSenior_37.min + Math.random() * (config.TargetDSCRSenior_37.max - config.TargetDSCRSenior_37.min) :
            config.TargetDSCRSenior_37.value;
            
        const coupon = config.SeniorCoupon_38.enabled ?
            config.SeniorCoupon_38.min + Math.random() * (config.SeniorCoupon_38.max - config.SeniorCoupon_38.min) :
            config.SeniorCoupon_38.value;
        
        // Calculate derived values
        const grossIncome = rent * 12;
        const netIncome = grossIncome * (1 - opex/100);
        const netIT = grossIT / pue;
        const debtService = grossIncome * (coupon/100);
        const actualDSCR = netIncome / debtService;
        const irr = 15 + Math.random() * 10; // Simplified IRR calculation
        const seniorRaise = netIncome * dscr * seniorTenor;
        
        const scenario = {
            id: i + 1,
            rent: rent,
            opex: opex,
            coupon: coupon,
            dscr: actualDSCR,
            targetDSCR: dscr,
            irr: irr,
            seniorRaise: seniorRaise,
            netIncome: netIncome,
            viable: actualDSCR >= dscr && irr >= 14
        };
        
        if (mode === 'viable' && !scenario.viable) continue;
        
        scenarios.push(scenario);
        if (scenario.viable) {
            viableCount++;
            if (scenario.irr > bestIRR) bestIRR = scenario.irr;
            if (scenario.dscr > bestDSCR) bestDSCR = scenario.dscr;
        }
    }
    
    // Sort scenarios based on ranking objective
    scenarios.sort((a, b) => {
        switch(rankingObjective) {
            case 'MaxSeniorRaise': return b.seniorRaise - a.seniorRaise;
            case 'MaxEquityIRR': return b.irr - a.irr;
            case 'MaxDay1Cash': return b.netIncome - a.netIncome;
            case 'MinWACC': return a.coupon - b.coupon;
            case 'Composite':
            default:
                // Composite score with weights from config
                const scoreA = (a.seniorRaise/1000000) * 0.35 + (20 - a.coupon) * 0.25 + 
                               a.netIncome/1000000 * 0.20 + a.dscr * 0.10 + a.irr * 0.10;
                const scoreB = (b.seniorRaise/1000000) * 0.35 + (20 - b.coupon) * 0.25 + 
                               b.netIncome/1000000 * 0.20 + b.dscr * 0.10 + b.irr * 0.10;
                return scoreB - scoreA;
        }
    })
    
    // Update stats
    updateStats(scenarios.length, viableCount, bestIRR, bestDSCR);
    
    // Show results table
    displayResults();
}

function processServerResults(results) {
    // Convert server results to client format
    scenarios = results.scenarios.map(s => ({
        id: s.id,
        rent: s.inputs.monthly_rent,
        opex: s.inputs.opex,
        coupon: s.inputs.senior_coupon,
        dscr: s.outputs.dscr_min,
        targetDSCR: s.inputs.target_dscr,
        irr: s.outputs.equity_irr,
        seniorRaise: s.outputs.senior_notional,
        netIncome: s.inputs.monthly_rent * 12 * (1 - s.inputs.opex/100),
        viable: s.viable,
        rating: s.outputs.senior_rating,
        wacc: s.outputs.wacc,
        wal: s.outputs.senior_wal,
        repoEligible: s.outputs.repo_eligible
    }));
    
    const summary = results.summary || {};
    updateStats(
        results.total_scenarios,
        results.viable_count,
        summary.best_irr || 0,
        summary.best_dscr || 0
    );
    
    displayResults();
}

function updateStats(total, viable, bestIRR, bestDSCR) {
    const statTotal = document.getElementById('stat-total');
    const statViable = document.getElementById('stat-viable');
    const statIrr = document.getElementById('stat-irr');
    
    if (statTotal) statTotal.textContent = total;
    if (statViable) statViable.textContent = viable;
    if (statIrr) statIrr.textContent = bestIRR.toFixed(1) + '%';
    
    // Add best DSCR display if element exists
    const dscrStat = document.getElementById('stat-dscr');
    if (dscrStat) {
        dscrStat.textContent = bestDSCR.toFixed(2) + 'x';
    }
    
    // Reset quick stats display
    const quickStats = document.getElementById('quick-stats');
    if (quickStats) {
        quickStats.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center;">
                <div>
                    <div style="color: #10b981; font-size: 0.8rem;">Total</div>
                    <div id="stat-total" style="font-weight: bold; color: #e2e8f0;">${total}</div>
                </div>
                <div>
                    <div style="color: #10b981; font-size: 0.8rem;">Viable</div>
                    <div id="stat-viable" style="font-weight: bold; color: #e2e8f0;">${viable}</div>
                </div>
                <div>
                    <div style="color: #10b981; font-size: 0.8rem;">Best IRR</div>
                    <div id="stat-irr" style="font-weight: bold; color: #e2e8f0;">${bestIRR.toFixed(1)}%</div>
                </div>
            </div>
        `;
        quickStats.style.display = 'block';
    }
}

function displayResults() {
    const tbody = document.getElementById('results-tbody');
    tbody.innerHTML = scenarios.map(s => `
        <tr style="border-bottom: 1px solid rgba(96, 165, 250, 0.1);">
            <td style="padding: 0.75rem; color: #94a3b8;">${s.id}</td>
            <td style="padding: 0.75rem; color: #e2e8f0;">£${(s.rent/1000).toFixed(0)}k/mo</td>
            <td style="padding: 0.75rem; color: #e2e8f0;">${s.opex.toFixed(1)}%</td>
            <td style="padding: 0.75rem; color: #e2e8f0;">${s.coupon.toFixed(2)}%</td>
            <td style="padding: 0.75rem; color: #e2e8f0;">${s.dscr.toFixed(2)}x</td>
            <td style="padding: 0.75rem; color: ${s.viable ? '#10b981' : '#ef4444'}; font-weight: 600;">${s.irr.toFixed(1)}%</td>
            <td style="padding: 0.75rem; color: #e2e8f0;">£${(s.seniorRaise/1000000).toFixed(0)}M</td>
            <td style="padding: 0.75rem;">
                <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem; ${s.viable ? 'background: rgba(16, 185, 129, 0.2); color: #10b981;' : 'background: rgba(239, 68, 68, 0.2); color: #ef4444;'}">
                    ${s.viable ? 'Viable' : 'Non-viable'}
                </span>
            </td>
        </tr>
    `).join('');
    
    document.getElementById('results-container').style.display = 'block';
}

function exportCSV() {
    let csv = 'ID,Monthly_Rent,OPEX,Coupon,DSCR,Target_DSCR,IRR,Senior_Raise,Net_Income,Status\n';
    scenarios.forEach(s => {
        csv += `${s.id},${s.rent.toFixed(2)},${s.opex.toFixed(2)},${s.coupon.toFixed(2)},${s.dscr.toFixed(2)},${s.targetDSCR.toFixed(2)},${s.irr.toFixed(2)},${s.seniorRaise.toFixed(2)},${s.netIncome.toFixed(2)},${s.viable ? 'Viable' : 'Non-viable'}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'permutation_results.csv';
    a.click();
}

function clearResults() {
    scenarios = [];
    document.getElementById('results-container').style.display = 'none';
    document.getElementById('quick-stats').style.display = 'none';
}

// Load projects when section is shown
if (window.showSection) {
    const originalShowSection = window.showSection;
    window.showSection = function(section) {
        originalShowSection(section);
        if (section === 'permutation') {
            const selector = document.getElementById('project-selector');
            if (selector && window.projectsData && window.projectsData.length > 0) {
                selector.innerHTML = '<option value="">-- No Project Selected --</option>';
                window.projectsData.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.code;
                    option.textContent = project.name;
                    selector.appendChild(option);
                });
            }
        }
    };
}
</script>

    <!-- Securitization Engine Section -->
    <div id="securitization-section" style="display: none; padding: 185px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1800px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem; text-align: center;">
                    <i class="fas fa-layer-group"></i> Securitization Engine
                </h2>
                <p style="color: #94a3b8; text-align: center; margin-bottom: 2rem;">Structured Finance • Capital Stack Optimization • Real-time Analysis</p>

                <!-- Control Panel -->
                <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <!-- Left Panel - Input Configuration -->
                        <div>
                            <h3 style="color: #60a5fa; margin-bottom: 1rem;">
                                <i class="fas fa-sliders-h"></i> Configuration
                            </h3>
                            
                            <!-- Asset Type Selection -->
                            <div style="margin-bottom: 1.5rem;">
                                <label style="color: #94a3b8; display: block; margin-bottom: 0.5rem;">Asset Type</label>
                                <select id="sec-asset-type" style="width: 100%; padding: 0.75rem; background: rgba(54, 64, 73, 0.5); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: white;">
                                    <option value="datacenter">Data Center REIT</option>
                                    <option value="mbs">Mortgage-Backed Securities</option>
                                    <option value="abs">Asset-Backed Securities</option>
                                    <option value="cdo">Collateralized Debt Obligations</option>
                                    <option value="clo">Collateralized Loan Obligations</option>
                                    <option value="cmbs">Commercial MBS</option>
                                </select>
                            </div>

                            <!-- Pool Size -->
                            <div style="margin-bottom: 1.5rem;">
                                <label style="color: #94a3b8; display: block; margin-bottom: 0.5rem;">Total Pool Size (£)</label>
                                <input type="number" id="sec-pool-size" placeholder="e.g., 100000000" style="width: 100%; padding: 0.75rem; background: rgba(54, 64, 73, 0.5); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: white;">
                            </div>

                            <!-- Number of Tranches -->
                            <div style="margin-bottom: 1.5rem;">
                                <label style="color: #94a3b8; display: block; margin-bottom: 0.5rem;">Number of Tranches</label>
                                <input type="number" id="sec-tranches" value="3" min="2" max="10" style="width: 100%; padding: 0.75rem; background: rgba(54, 64, 73, 0.5); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: white;">
                            </div>

                            <!-- Structuring Method -->
                            <div style="margin-bottom: 1.5rem;">
                                <label style="color: #94a3b8; display: block; margin-bottom: 0.5rem;">Structuring Method</label>
                                <select id="sec-method" style="width: 100%; padding: 0.75rem; background: rgba(54, 64, 73, 0.5); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: white;">
                                    <option value="waterfall">Waterfall</option>
                                    <option value="pro-rata">Pro-Rata</option>
                                    <option value="sequential">Sequential</option>
                                    <option value="hybrid">Hybrid</option>
                                </select>
                            </div>
                        </div>

                        <!-- Right Panel - Project Data Import -->
                        <div>
                            <h3 style="color: #60a5fa; margin-bottom: 1rem;">
                                <i class="fas fa-database"></i> Project Data Import
                            </h3>
                            
                            <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <p style="color: #94a3b8; margin-bottom: 1rem;">Import data from your project specifications:</p>
                                
                                <!-- Project Selection -->
                                <select id="project-selector" onchange="loadProjectData()" style="width: 100%; padding: 0.75rem; background: rgba(54, 64, 73, 0.5); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: white; margin-bottom: 1rem;">
                                    <option value="">Select a Project...</option>
                                </select>
                                
                                <button onclick="fetchProjects()" style="background: linear-gradient(135deg, #ffd700, #ffed4e); color: #0a0e27; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 600; cursor: pointer; width: 100%; margin-bottom: 1rem;">
                                    <i class="fas fa-sync"></i> Refresh Projects
                                </button>
                                
                                <div id="project-data-preview" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px;">
                                    <p style="color: #60a5fa; margin-bottom: 0.5rem;">Imported Data:</p>
                                    <div id="imported-data-display" style="color: #94a3b8; font-size: 0.9rem;"></div>
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                                <button onclick="loadFromPermutation()" style="background: linear-gradient(135deg, #0a0e27, #020617); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); padding: 0.75rem; border-radius: 6px; font-weight: 600; cursor: pointer; flex: 1;">
                                    <i class="fas fa-exchange-alt"></i> From Permutation
                                </button>
                                <button onclick="loadTemplate()" style="background: linear-gradient(135deg, #0a0e27, #020617); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); padding: 0.75rem; border-radius: 6px; font-weight: 600; cursor: pointer; flex: 1;">
                                    <i class="fas fa-file-alt"></i> Template
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem; justify-content: center; flex-wrap: wrap;">
                    <button onclick="runSecuritization()" style="background: linear-gradient(135deg, #ffd700, #ffed4e); color: #0a0e27; border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-play"></i> Run Securitization
                    </button>
                    <button onclick="runStressTest()" style="background: linear-gradient(135deg, #0a0e27, #020617); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); padding: 1rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-chart-line"></i> Stress Test
                    </button>
                    <button onclick="generateReport()" style="background: linear-gradient(135deg, #0a0e27, #020617); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); padding: 1rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-file-pdf"></i> Generate Report
                    </button>
                    <button onclick="resetSecuritization()" style="background: linear-gradient(135deg, #0a0e27, #020617); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); padding: 1rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                </div>

                <!-- Results Panel -->
                <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(96, 165, 250, 0.2);">
                        <div style="font-size: 1.5rem; color: #60a5fa;">
                            <i class="fas fa-chart-pie"></i> Securitization Results
                        </div>
                        <div style="display: flex; gap: 2rem; color: #64748b; font-size: 0.9rem;">
                            <span>Status: <strong id="sec-status" style="color: #60a5fa;">Ready</strong></span>
                            <span>Runtime: <strong id="sec-runtime">--:--</strong></span>
                        </div>
                    </div>
                    
                    <!-- Capital Stack Visualization -->
                    <div id="capital-stack-viz" style="margin-bottom: 2rem; min-height: 300px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 1.5rem;">
                        <div style="text-align: center; color: #64748b; padding: 3rem;">
                            <i class="fas fa-layer-group" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>No securitization results yet</p>
                            <p style="margin-top: 0.5rem; font-size: 0.9rem;">Configure parameters and run securitization</p>
                        </div>
                    </div>

                    <!-- Metrics Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                            <div style="font-size: 1.8rem; color: #60a5fa; font-weight: bold;" id="metric-irr">--%</div>
                            <div style="font-size: 0.85rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin-top: 0.5rem;">Expected IRR</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                            <div style="font-size: 1.8rem; color: #60a5fa; font-weight: bold;" id="metric-rating">--</div>
                            <div style="font-size: 0.85rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin-top: 0.5rem;">Weighted Rating</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                            <div style="font-size: 1.8rem; color: #60a5fa; font-weight: bold;" id="metric-leverage">--x</div>
                            <div style="font-size: 0.85rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin-top: 0.5rem;">Leverage Ratio</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                            <div style="font-size: 1.8rem; color: #60a5fa; font-weight: bold;" id="metric-coverage">--x</div>
                            <div style="font-size: 0.85rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin-top: 0.5rem;">Coverage Ratio</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if is_admin %}
    <!-- Admin Panel -->
    <div id="adminPanel" style="display: none; position: fixed; top: 70px; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 1400px; margin: 0 auto; padding: 2rem;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 2rem;">
                <h2 style="color: #22c55e; font-size: 2rem; font-weight: 700;">Admin Control Center</h2>
                <button onclick="toggleAdminPanel()" style="position: absolute; right: 2rem; top: 2rem; background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>

            <!-- Pending Registrations -->
            <div style="background: rgba(54, 64, 73, 0.95); border: 2px solid #22c55e; border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
                <h3 style="color: #22c55e; margin-bottom: 1.5rem;">Pending Registrations</h3>
                {% if pending_registrations %}
                    {% for reg in pending_registrations %}
                    <div style="background: rgba(44, 49, 55, 0.8); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Name</p>
                                <p style="color: white; font-weight: 600;">{{ reg.full_name }}</p>
                            </div>
                            <div>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Email</p>
                                <p style="color: #60a5fa; font-weight: 600;">{{ reg.email }}</p>
                            </div>
                            <div>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Company</p>
                                <p style="color: white;">{{ reg.company_name }}</p>
                            </div>
                            <div>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Job Title</p>
                                <p style="color: white;">{{ reg.job_title }}</p>
                            </div>
                            <div>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Phone</p>
                                <p style="color: white;">{{ reg.country_code }} {{ reg.phone }}</p>
                            </div>
                            <div>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Submitted</p>
                                <p style="color: white;">{{ reg.created_at }}</p>
                            </div>
                            <div>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Generated Password</p>
                                <p style="color: #60a5fa; font-weight: 600; font-family: monospace;">{{ reg.generated_password }}</p>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Select Account Type:</label>
                            <select id="accountType_{{ reg.email|replace('@', '_')|replace('.', '_') }}" style="background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(96, 165, 250, 0.3); padding: 8px 12px; border-radius: 6px; width: 100%; margin-bottom: 1rem;">
                                <option value="external" selected>External - Client Access</option>
                                <option value="investor">Investor - Portfolio Access</option>
                                <option value="execution">Execution - Trading Access</option>
                                <option value="internal">Internal - Team Member</option>
                                <option value="admin">Admin - Full Control</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button onclick="approveUser({{ reg.email|tojson|safe }})" style="background: #22c55e; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button onclick="rejectUser({{ reg.email|tojson|safe }})" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: rgba(255, 255, 255, 0.9);">No pending registrations</p>
                {% endif %}
            </div>

            <!-- Active Users -->
            <div style="background: rgba(54, 64, 73, 0.95); border: 2px solid #60a5fa; border-radius: 12px; padding: 2rem;">
                <h3 style="color: #60a5fa; margin-bottom: 1.5rem;">Active Users</h3>
                {% if all_users %}
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid rgba(96, 165, 250, 0.3);">
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Name</th>
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Email</th>
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Company</th>
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Login Count</th>
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Total Time</th>
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Last Login</th>
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Password</th>
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in all_users %}
                                <tr style="border-bottom: 1px solid rgba(96, 165, 250, 0.1);">
                                    <td style="padding: 10px; color: white;">{{ user.full_name }}</td>
                                    <td style="padding: 10px; color: #60a5fa;">{{ user.email }}</td>
                                    <td style="padding: 10px; color: white;">{{ user.company_name }}</td>
                                    <td style="padding: 10px; color: #22c55e; font-weight: 600;">{{ user.login_count|default(0) }}</td>
                                    <td style="padding: 10px; color: white;">
                                        {% if user.total_login_time %}
                                            {{ (user.total_login_time / 3600)|round(1) }} hrs
                                        {% else %}
                                            0 hrs
                                        {% endif %}
                                    </td>
                                    <td style="padding: 10px; color: white;">
                                        {% if user.last_login %}
                                            {{ user.last_login|truncate(19, True, '') }}
                                        {% else %}
                                            Never
                                        {% endif %}
                                    </td>
                                    <td style="padding: 10px; color: #60a5fa; font-family: monospace; font-size: 0.85rem;">{{ user.password }}</td>
                                    <td style="padding: 10px;">
                                        <button onclick="resetPassword({{ user.email|tojson|safe }})" style="background: #60a5fa; color: black; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                                            Reset Password
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p style="color: rgba(255, 255, 255, 0.9);">No active users</p>
                {% endif %}
            </div>
            
            <!-- Comprehensive Admin Control Panel -->
            <div style="margin-top: 2rem;">
                <!-- Tab Navigation -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #364049;">
                    <button onclick="showAdminTab('overview')" class="admin-tab active" style="background: transparent; color: #60a5fa; border: none; padding: 10px 20px; cursor: pointer; border-bottom: 3px solid #60a5fa;">Overview</button>
                    <button onclick="showAdminTab('registrations')" class="admin-tab" style="background: transparent; color: #94a3b8; border: none; padding: 10px 20px; cursor: pointer;">Registrations</button>
                    <button onclick="showAdminTab('lockouts')" class="admin-tab" style="background: transparent; color: #94a3b8; border: none; padding: 10px 20px; cursor: pointer;">IP Lockouts</button>
                    <button onclick="showAdminTab('attempts')" class="admin-tab" style="background: transparent; color: #94a3b8; border: none; padding: 10px 20px; cursor: pointer;">Login Attempts</button>
                    <button onclick="showAdminTab('expired')" class="admin-tab" style="background: transparent; color: #94a3b8; border: none; padding: 10px 20px; cursor: pointer;">Expired</button>
                </div>
                
                <!-- Tab Content -->
                <div id="adminTabContent">
                    <p style="color: rgba(255, 255, 255, 0.9);">Loading admin data...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let comprehensiveData = {}; // Store all admin data
        let currentTab = 'overview';
        let currentSection = 'dashboard';
        
        // ShowSection is already defined earlier in the HTML for onclick handlers
        
        function showPlaceholderContent(title, description) {
            let placeholderDiv = document.getElementById('placeholder-content');
            if (!placeholderDiv) {
                // Create placeholder div if it doesn't exist
                placeholderDiv = document.createElement('div');
                placeholderDiv.id = 'placeholder-content';
                placeholderDiv.style.cssText = 'padding: 160px 2rem 2rem; min-height: 100vh;';
                document.body.appendChild(placeholderDiv);
            }
            
            // Hide main content
            const mainContent = document.getElementById('main-content');
            if (mainContent) mainContent.style.display = 'none';
            
            const complianceSection = document.getElementById('compliance-section');
            if (complianceSection) complianceSection.style.display = 'none';
            
            const permSection = document.getElementById('permutation-section');
            if (permSection) permSection.style.display = 'none';
            
            // Show placeholder
            placeholderDiv.style.display = 'block';
            placeholderDiv.innerHTML = '<div class="container">' +
                '<div class="text-center" style="margin-top: 100px;">' +
                    '<h1 style="color: #60a5fa; margin-bottom: 2rem;">' +
                        '<i class="fas fa-cogs"></i> ' + title +
                    '</h1>' +
                    '<div style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa; border-radius: 12px; padding: 3rem; max-width: 600px; margin: 0 auto;">' +
                        '<p style="color: #94a3b8; font-size: 1.1rem; margin-bottom: 2rem;">' + description + '</p>' +
                        '<div style="color: #60a5fa;">' +
                            '<i class="fas fa-clock fa-3x mb-3"></i>' +
                            '<p>Coming Soon</p>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }
        
        function toggleAdminPanel() {
            const panel = document.getElementById('adminPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            if (panel.style.display === 'block') {
                loadComprehensiveData();
            }
        }
        
        function loadComprehensiveData() {
            fetch('/admin/comprehensive-data')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        comprehensiveData = data.data;
                        showAdminTab(currentTab);
                    }
                })
                .catch(error => console.error('Error loading admin data:', error));
        }
        
        function showAdminTab(tab) {
            currentTab = tab;
            
            // Update tab styling
            document.querySelectorAll('.admin-tab').forEach(btn => {
                btn.style.color = '#94a3b8';
                btn.style.borderBottom = 'none';
                btn.classList.remove('active');
            });
            event.target.style.color = '#60a5fa';
            event.target.style.borderBottom = '3px solid #60a5fa';
            event.target.classList.add('active');
            
            const content = document.getElementById('adminTabContent');
            
            switch(tab) {
                case 'overview':
                    showOverview(content);
                    break;
                case 'registrations':
                    showRegistrations(content);
                    break;
                case 'lockouts':
                    showLockouts(content);
                    break;
                case 'attempts':
                    showAttempts(content);
                    break;
                case 'expired':
                    showExpired(content);
                    break;
            }
        }
        
        function showOverview(container) {
            const stats = comprehensiveData.statistics || {};
            container.innerHTML = '<div style="background: rgba(54, 64, 73, 0.95); border-radius: 12px; padding: 2rem;">' +
                '<h3 style="color: #60a5fa; margin-bottom: 1.5rem;">System Overview</h3>' +
                '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">' +
                    '<div style="background: rgba(96, 165, 250, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(96, 165, 250, 0.3);">' +
                        '<div style="color: #94a3b8; font-size: 0.9rem;">Locked IPs</div>' +
                        '<div style="color: #ef4444; font-size: 2rem; font-weight: bold;">' + (stats.total_locked_ips || 0) + '</div>' +
                    '</div>' +
                    '<div style="background: rgba(34, 197, 94, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">' +
                        '<div style="color: #94a3b8; font-size: 0.9rem;">Active Registrations</div>' +
                        '<div style="color: #22c55e; font-size: 2rem; font-weight: bold;">' + (stats.active_registrations || 0) + '</div>' +
                    '</div>' +
                    '<div style="background: rgba(96, 165, 250, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(96, 165, 250, 0.3);">' +
                        '<div style="color: #94a3b8; font-size: 0.9rem;">Pending Verification</div>' +
                        '<div style="color: #60a5fa; font-size: 2rem; font-weight: bold;">' + (stats.pending_verification || 0) + '</div>' +
                    '</div>' +
                    '<div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3);">' +
                        '<div style="color: #94a3b8; font-size: 0.9rem;">Expired Registrations</div>' +
                        '<div style="color: #ef4444; font-size: 2rem; font-weight: bold;">' + (stats.expired_registrations || 0) + '</div>' +
                    '</div>' +
                    '<div style="background: rgba(147, 51, 234, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(147, 51, 234, 0.3);">' +
                        '<div style="color: #94a3b8; font-size: 0.9rem;">Total Login Attempts</div>' +
                        '<div style="color: #9333ea; font-size: 2rem; font-weight: bold;">' + (stats.total_login_attempts || 0) + '</div>' +
                    '</div>' +
                    '<div style="background: rgba(34, 197, 94, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">' +
                        '<div style="color: #94a3b8; font-size: 0.9rem;">Approved Users</div>' +
                        '<div style="color: #22c55e; font-size: 2rem; font-weight: bold;">' + (stats.approved_users || 0) + '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }
        
        function showRegistrations(container) {
            const regs = comprehensiveData.active_registrations || {};
            let html = '<div style="background: rgba(54, 64, 73, 0.95); border-radius: 12px; padding: 2rem;">' +
                '<h3 style="color: #22c55e; margin-bottom: 1.5rem;">Active Registrations</h3>';
            
            if (Object.keys(regs).length === 0) {
                html += '<p style="color: rgba(255, 255, 255, 0.9);">No active registrations</p>';
            } else {
                html += '<div style="overflow-x: auto;"><table style="width: 100%; color: #e2e8f0;">';
                html += '<thead><tr style="border-bottom: 2px solid #475569;">';
                html += '<th style="padding: 10px; text-align: left;">Email</th>';
                html += '<th style="padding: 10px; text-align: left;">Name</th>';
                html += '<th style="padding: 10px; text-align: left;">Company</th>';
                html += '<th style="padding: 10px; text-align: left;">Verified</th>';
                html += '<th style="padding: 10px; text-align: left;">Approved</th>';
                html += '<th style="padding: 10px; text-align: left;">Actions</th>';
                html += '</tr></thead><tbody>';
                
                for (const [email, data] of Object.entries(regs)) {
                    html += '<tr style="border-bottom: 1px solid #364049;">';
                    html += '<td style="padding: 10px;">' + email + '</td>';
                    html += '<td style="padding: 10px;">' + (data.full_name || '-') + '</td>';
                    html += '<td style="padding: 10px;">' + (data.company_name || '-') + '</td>';
                    html += '<td style="padding: 10px;">' + (data.email_verified ? '✅' : '❌') + '</td>';
                    html += '<td style="padding: 10px;">' + (data.admin_approved ? '✅' : '❌') + '</td>';
                    html += '<td style="padding: 10px;">' +
                        '<button onclick="deleteData(\'registration\', \'' + email + '\')" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-right: 5px;">Delete</button>' +
                        (!data.admin_approved ? '<button onclick="approveUser(\'' + email + '\')" style="background: #22c55e; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Approve</button>' : '') +
                    '</td>';
                    html += '</tr>';
                }
                html += '</tbody></table></div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function showLockouts(container) {
            const lockouts = comprehensiveData.ip_lockouts || {};
            let html = '<div style="background: rgba(54, 64, 73, 0.95); border-radius: 12px; padding: 2rem;">' +
                '<h3 style="color: #ef4444; margin-bottom: 1.5rem;">IP Lockouts</h3>' +
                '<button onclick="deleteData(\'all_lockouts\', null)" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">Clear All Lockouts</button>';
            
            if (Object.keys(lockouts).length === 0) {
                html += '<p style="color: rgba(255, 255, 255, 0.9);">No IP lockouts</p>';
            } else {
                html += '<div style="overflow-x: auto;"><table style="width: 100%; color: #e2e8f0;">';
                html += '<thead><tr style="border-bottom: 2px solid #475569;">';
                html += '<th style="padding: 10px; text-align: left;">IP Address</th>';
                html += '<th style="padding: 10px; text-align: left;">Type</th>';
                html += '<th style="padding: 10px; text-align: left;">Reason</th>';
                html += '<th style="padding: 10px; text-align: left;">Locked Until</th>';
                html += '<th style="padding: 10px; text-align: left;">Actions</th>';
                html += '</tr></thead><tbody>';
                
                for (const [ip, data] of Object.entries(lockouts)) {
                    html += '<tr style="border-bottom: 1px solid #364049;">';
                    html += '<td style="padding: 10px; font-family: monospace;">' + ip + '</td>';
                    html += '<td style="padding: 10px;">' + (data.permanent ? 'Permanent' : 'Temporary') + '</td>';
                    html += '<td style="padding: 10px;">' + (data.reason || '-') + '</td>';
                    html += '<td style="padding: 10px;">' + (data.locked_until || 'Permanent') + '</td>';
                    html += '<td style="padding: 10px;">' +
                        '<button onclick="deleteData(\'ip_lockout\', \'' + ip + '\')" style="background: #22c55e; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Unblock</button>' +
                    '</td>';
                    html += '</tr>';
                }
                html += '</tbody></table></div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function showAttempts(container) {
            const attempts = comprehensiveData.login_attempts || {};
            let html = '<div style="background: rgba(54, 64, 73, 0.95); border-radius: 12px; padding: 2rem;">' +
                '<h3 style="color: #9333ea; margin-bottom: 1.5rem;">Login Attempts</h3>' +
                '<button onclick="deleteData(\'all_attempts\', null)" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">Clear All Attempts</button>';
            
            if (Object.keys(attempts).length === 0) {
                html += '<p style="color: rgba(255, 255, 255, 0.9);">No login attempts logged</p>';
            } else {
                html += '<div style="overflow-x: auto;"><table style="width: 100%; color: #e2e8f0;">';
                html += '<thead><tr style="border-bottom: 2px solid #475569;">';
                html += '<th style="padding: 10px; text-align: left;">IP Address</th>';
                html += '<th style="padding: 10px; text-align: left;">Total Attempts</th>';
                html += '<th style="padding: 10px; text-align: left;">Last Attempt</th>';
                html += '<th style="padding: 10px; text-align: left;">Actions</th>';
                html += '</tr></thead><tbody>';
                
                for (const [ip, data] of Object.entries(attempts)) {
                    html += '<tr style="border-bottom: 1px solid #364049;">';
                    html += '<td style="padding: 10px; font-family: monospace;">' + ip + '</td>';
                    html += '<td style="padding: 10px;">' + (data.total_attempts || 0) + '</td>';
                    html += '<td style="padding: 10px;">' + (data.last_attempt || '-') + '</td>';
                    html += '<td style="padding: 10px;">' +
                        '<button onclick="deleteData(\'login_attempt\', \'' + ip + '\')" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Delete</button>' +
                    '</td>';
                    html += '</tr>';
                }
                html += '</tbody></table></div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function showExpired(container) {
            const expired = comprehensiveData.expired_registrations || {};
            let html = '<div style="background: rgba(54, 64, 73, 0.95); border-radius: 12px; padding: 2rem;">' +
                '<h3 style="color: #ef4444; margin-bottom: 1.5rem;">Expired Registrations</h3>';
            
            if (Object.keys(expired).length === 0) {
                html += '<p style="color: rgba(255, 255, 255, 0.9);">No expired registrations</p>';
            } else {
                html += '<div style="overflow-x: auto;"><table style="width: 100%; color: #e2e8f0;">';
                html += '<thead><tr style="border-bottom: 2px solid #475569;">';
                html += '<th style="padding: 10px; text-align: left;">Email</th>';
                html += '<th style="padding: 10px; text-align: left;">Name</th>';
                html += '<th style="padding: 10px; text-align: left;">Expired At</th>';
                html += '<th style="padding: 10px; text-align: left;">Reason</th>';
                html += '<th style="padding: 10px; text-align: left;">Actions</th>';
                html += '</tr></thead><tbody>';
                
                for (const [email, data] of Object.entries(expired)) {
                    html += '<tr style="border-bottom: 1px solid #364049;">';
                    html += '<td style="padding: 10px;">' + email + '</td>';
                    html += '<td style="padding: 10px;">' + (data.full_name || '-') + '</td>';
                    html += '<td style="padding: 10px;">' + (data.expired_at || '-') + '</td>';
                    html += '<td style="padding: 10px;">' + (data.reason || '-') + '</td>';
                    html += '<td style="padding: 10px;">' +
                        '<button onclick="deleteData(\'expired_registration\', \'' + email + '\')" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Delete</button>' +
                    '</td>';
                    html += '</tr>';
                }
                html += '</tbody></table></div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function deleteData(type, identifier) {
            if (type.startsWith('all_') && !confirm('Are you sure you want to clear ALL ' + type.replace('all_', '') + '?')) {
                return;
            }
            if (!type.startsWith('all_') && !confirm('Are you sure you want to delete ' + identifier + '?')) {
                return;
            }
            
            fetch('/admin/delete-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: type, identifier: identifier })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Deleted successfully');
                    loadComprehensiveData();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => console.error('Error deleting data:', error));
        }
        
        function showIPDetails(ipAddress) {
            const ipInfo = currentIPData.find(ip => ip.ip === ipAddress);
            if (!ipInfo) return;
            
            let detailsHTML = '<div style="padding: 20px;">' +
                '<h3 style="color: #ef4444; margin-bottom: 20px;">Detailed Information for ' + ipAddress + '</h3>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">' +
                    '<div>' +
                        '<strong style="color: #60a5fa;">Status:</strong> ' +
                        '<span style="color: #60a5fa;">' + ipInfo.status + '</span>' +
                    '</div>' +
                    '<div>' +
                        '<strong style="color: #60a5fa;">Lock Type:</strong> ' +
                        '<span style="color: #60a5fa;">' + (ipInfo.lockout_type || 'Unknown') + '</span>' +
                    '</div>' +
                    '<div>' +
                        '<strong style="color: #60a5fa;">Reference Code:</strong> ' +
                        '<span style="color: white; font-family: monospace;">' + (ipInfo.reference_code || 'N/A') + '</span>' +
                    '</div>' +
                    '<div>' +
                        '<strong style="color: #60a5fa;">Total Attempts:</strong> ' +
                        '<span style="color: #ef4444; font-weight: bold;">' + (ipInfo.total_attempts || 0) + '</span>' +
                    '</div>' +
                    '<div>' +
                        '<strong style="color: #60a5fa;">First Seen:</strong> ' +
                        '<span style="color: rgba(255, 255, 255, 0.9);">' + (ipInfo.first_seen || 'Unknown') + '</span>' +
                    '</div>' +
                    '<div>' +
                        '<strong style="color: #60a5fa;">Locked At:</strong> ' +
                        '<span style="color: rgba(255, 255, 255, 0.9);">' + (ipInfo.locked_at || 'Unknown') + '</span>' +
                    '</div>' +
                '</div>' +
                '<div style="margin-bottom: 20px;">' +
                    '<strong style="color: #60a5fa;">User Agent:</strong>' +
                    '<div style="color: #94a3b8; font-size: 0.9rem; margin-top: 5px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px;">' +
                        (ipInfo.user_agent || 'Unknown') +
                    '</div>' +
                '</div>' +
                '<div style="margin-bottom: 20px;">' +
                    '<strong style="color: #60a5fa;">Failed Passwords:</strong>' +
                    '<div style="margin-top: 10px;">';
            
            // Handle failed passwords
            if (ipInfo.failed_passwords && ipInfo.failed_passwords.length > 0) {
                for (let i = 0; i < ipInfo.failed_passwords.length; i++) {
                    detailsHTML += '<span style="display: inline-block; background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 5px 10px; margin: 5px; border-radius: 5px; font-family: monospace;">' + 
                        ipInfo.failed_passwords[i] + '</span>';
                }
            } else {
                detailsHTML += '<span style="color: rgba(255, 255, 255, 0.9);">No passwords logged</span>';
            }
            
            detailsHTML += '</div></div>';
            
            // Handle attempt history
            if (ipInfo.attempt_history && ipInfo.attempt_history.length > 0) {
                detailsHTML += '<div style="margin-bottom: 20px;">' +
                    '<strong style="color: #60a5fa;">Recent Attempt History:</strong>' +
                    '<div style="margin-top: 10px; max-height: 200px; overflow-y: auto;">';
                
                for (let i = 0; i < ipInfo.attempt_history.length; i++) {
                    const attempt = ipInfo.attempt_history[i];
                    detailsHTML += '<div style="padding: 10px; margin: 5px 0; background: rgba(0,0,0,0.3); border-radius: 5px; border-left: 3px solid #ef4444;">' +
                        '<div style="color: #ef4444; font-family: monospace;">' + attempt.password + '</div>' +
                        '<div style="color: #94a3b8; font-size: 0.85rem; margin-top: 5px;">' +
                            new Date(attempt.timestamp).toLocaleString('en-GB') + ' | Type: ' + attempt.type +
                        '</div>' +
                    '</div>';
                }
                
                detailsHTML += '</div></div>';
            }
            
            detailsHTML += '<div style="margin-top: 20px; text-align: right;">' +
                '<button onclick="closeIPDetails()" style="background: #475569; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">' +
                    'Close' +
                '</button>' +
            '</div></div>';
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'ipDetailsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 20000; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = '<div style="background: rgba(54, 64, 73, 0.98); border: 2px solid #ef4444; border-radius: 12px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">' +
                detailsHTML +
                '</div>';
            document.body.appendChild(modal);
        }
        
        function closeIPDetails() {
            const modal = document.getElementById('ipDetailsModal');
            if (modal) modal.remove();
        }
        
        function displayIPData(ipData) {
            const container = document.getElementById('ipManagementContent');
            
            if (ipData.length === 0) {
                container.innerHTML = '<p style="color: rgba(255, 255, 255, 0.9);">No IP lockouts currently active</p>';
                return;
            }
            
            let html = '<div style="overflow-x: auto;">' +
                '<table style="width: 100%; border-collapse: collapse;">' +
                    '<thead>' +
                        '<tr style="border-bottom: 1px solid rgba(239, 68, 68, 0.3);">' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">IP Address</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">Status</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">Reason</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">Failed Passwords</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">Browser/Device</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">First Seen</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">Total Attempts</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">Time Remaining</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">Actions</th>' +
                        '</tr>' +
                    '</thead>' +
                    '<tbody>';
            
            ipData.forEach(ip => {
                const statusColor = ip.status === 'permanent' ? '#ef4444' : '#60a5fa';
                const statusText = ip.status === 'permanent' ? 'PERMANENT BAN' : 
                                   ip.lockout_type === 'blocked_30min' ? '30-MIN BLOCK' : 
                                   ip.lockout_type === 'blocked_24h' ? '24-HOUR BAN' : 'TEMPORARY BLOCK';
                
                // Parse browser info to make it shorter
                let browserInfo = 'Unknown';
                if (ip.user_agent && ip.user_agent !== 'Unknown') {
                    if (ip.user_agent.includes('Chrome')) browserInfo = 'Chrome';
                    else if (ip.user_agent.includes('Firefox')) browserInfo = 'Firefox';
                    else if (ip.user_agent.includes('Safari')) browserInfo = 'Safari';
                    else if (ip.user_agent.includes('Edge')) browserInfo = 'Edge';
                    else browserInfo = ip.user_agent.substring(0, 20) + '...';
                }
                
                // Format first seen date
                let firstSeen = 'Unknown';
                if (ip.first_seen) {
                    const date = new Date(ip.first_seen);
                    firstSeen = date.toLocaleString('en-GB', { 
                        day: '2-digit', 
                        month: 'short', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                }
                
                html += '<tr style="border-bottom: 1px solid rgba(239, 68, 68, 0.1);">' +
                    '<td style="padding: 10px; color: white; font-family: monospace; cursor: pointer;" ' +
                        'onclick="showIPDetails(\'' + ip.ip + '\')" ' +
                        'title="Click for details">' +
                        ip.ip + ' ' +
                        '<i class="fas fa-info-circle" style="color: #60a5fa; margin-left: 5px;"></i>' +
                    '</td>' +
                    '<td style="padding: 10px;">' +
                        '<span style="color: ' + statusColor + '; font-weight: 600; font-size: 0.8rem;">' + statusText + '</span>' +
                    '</td>' +
                    '<td style="padding: 10px; color: #94a3b8; font-size: 0.85rem;">' + ip.reason + '</td>' +
                    '<td style="padding: 10px; color: #ef4444; font-size: 0.8rem; max-width: 150px; overflow: hidden; text-overflow: ellipsis;" ' +
                        'title="' + (ip.failed_passwords ? ip.failed_passwords.join(', ') : 'N/A') + '">' +
                        (ip.failed_passwords ? ip.failed_passwords.join(', ') : 'N/A') +
                    '</td>' +
                    '<td style="padding: 10px; color: #60a5fa; font-size: 0.85rem;">' + browserInfo + '</td>' +
                    '<td style="padding: 10px; color: #94a3b8; font-size: 0.85rem;">' + firstSeen + '</td>' +
                    '<td style="padding: 10px; color: #60a5fa; font-weight: 600;">' + (ip.total_attempts || 0) + '</td>' +
                    '<td style="padding: 10px; color: #60a5fa; font-size: 0.85rem;">' +
                        (ip.remaining_time || (ip.status === 'permanent' ? 'PERMANENT' : 'Expired')) +
                    '</td>' +
                    '<td style="padding: 10px;">' +
                        '<button onclick="unbanIP(\'' + ip.ip + '\')" style="background: #22c55e; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 0.8rem;">' +
                            'Unban' +
                        '</button>' +
                        (ip.status !== 'permanent' ? 
                            '<button onclick="extendBan(\'' + ip.ip + '\')" style="background: #60a5fa; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 0.8rem;">' +
                                'Extend' +
                            '</button>' +
                            '<button onclick="permanentBan(\'' + ip.ip + '\')" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">' +
                                'Permanent' +
                            '</button>'
                        : '') +
                    '</td>' +
                '</tr>';
            });
            
            html += '</tbody>' +
                    '</table>' +
                '</div>';
            
            container.innerHTML = html;
        }
        
        function unbanIP(ip) {
            if (confirm('Unban IP address ' + ip + '?')) {
                fetch('/admin/manage-ip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ip, action: 'unban' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        loadIPManagement();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }
        
        function extendBan(ip) {
            const days = prompt('Extend ban for ' + ip + ' by how many days? (1-30)');
            if (days && !isNaN(days) && days >= 1 && days <= 30) {
                fetch('/admin/manage-ip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ip, action: 'extend', duration_days: days })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        loadIPManagement();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }
        
        function permanentBan(ip) {
            if (confirm('Permanently ban IP address ' + ip + '? This cannot be undone through the timeout.')) {
                fetch('/admin/manage-ip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ip, action: 'permanent' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        loadIPManagement();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }

        function approveUser(email) {
            // Get the selected account type
            const selectId = 'accountType_' + email.replace('@', '_').replace(/\./g, '_');
            const accountType = document.getElementById(selectId).value;
            
            const accountTypeNames = {
                'external': 'External Client',
                'investor': 'Investor',
                'execution': 'Execution Trader',
                'internal': 'Internal Team',
                'admin': 'Administrator'
            };
            
            if (confirm('Approve ' + email + ' as ' + accountTypeNames[accountType] + '?')) {
                fetch('/admin/approve-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: email,
                        account_type: accountType
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('User approved as ' + accountTypeNames[accountType] + '!\n\nPassword: ' + data.password + '\n\nThis has been sent to ' + email);
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }

        function rejectUser(email) {
            const reason = prompt('Rejection reason for ' + email + ':');
            if (reason) {
                fetch('/admin/reject-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email, reason: reason })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('User rejected');
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }

        function resetPassword(email) {
            if (confirm('Reset password for ' + email + '?')) {
                fetch('/admin/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Password reset! New password: ' + data.password);
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }
    </script>
    {% endif %}

    <!-- Footer -->
    <footer style="margin-top: 100px; padding: 60px 40px 30px; background: linear-gradient(135deg, #0a0e27, #020617); border-top: 1px solid rgba(96, 165, 250, 0.2); position: relative;">
        <div style="position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent 0%, #60a5fa 50%, transparent 100%);"></div>
        
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="margin-bottom: 40px; text-align: center;">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <svg width="28" height="28" viewBox="0 0 32 32" fill="none" style="margin-top: 2px;">
                            <path d="M16 3L26.5 9.5V22.5L16 29L5.5 22.5V9.5L16 3Z" stroke="#93c5fd" stroke-width="2" fill="rgba(147, 197, 253, 0.08)"/>
                            <path d="M16 8L22 11.5V20.5L16 24L10 20.5V11.5L16 8Z" stroke="rgba(147, 197, 253, 0.4)" stroke-width="1"/>
                            <circle cx="16" cy="16" r="3" fill="#dbeafe"/>
                        </svg>
                        <div style="display: flex; align-items: center;">
                            <span style="font-size: 1.3rem; font-weight: 700; background: linear-gradient(90deg, #dbeafe, #93c5fd); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ATLAS</span>
                            <span style="font-size: 1.2rem; font-weight: 400; color: #60a5fa; margin: 0 4px;">:</span>
                            <span style="font-size: 1.3rem; font-weight: 700; background: linear-gradient(90deg, #93c5fd, #dbeafe); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">NEXUS</span>
                        </div>
                    </div>
                    <p style="color: #92969C; font-size: 1rem; max-width: 600px; margin: 0 auto; line-height: 1.6;">
                        Executive Command Center - Full access to global financial intelligence, securitisation analysis, and risk management solutions.
                    </p>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 40px; margin-bottom: 40px; padding-top: 40px; border-top: 1px solid rgba(184, 192, 200, 0.1);">
                <div>
                    <h4 style="color: #E5E9F0; font-size: 0.875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 20px;">Platform Tools</h4>
                    <a href="#" onclick="showSection('dashboard'); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Dashboard</a>
                    <a href="#" onclick="showSection('analytics'); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Analytics</a>
                    <a href="#" onclick="showSection('risk'); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Risk Management</a>
                    <a href="#" onclick="showSection('market'); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Market Intelligence</a>
                    <a href="#" onclick="showSection('portfolio'); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Portfolio</a>
                    <a href="#" onclick="showSection('compliance'); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Compliance</a>
                </div>
                
                <div>
                    <h4 style="color: #E5E9F0; font-size: 0.875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 20px;">Resources</h4>
                    <a href="/api-docs" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">API Documentation</a>
                    <a href="/data-feeds" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Data Feeds</a>
                    <a href="/research" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Research Portal</a>
                    <a href="/training" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Training</a>
                    <a href="#" onclick="window.open('https://status.atlasnexus.co.uk', '_blank'); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">System Status</a>
                </div>
                
                <div>
                    <h4 style="color: #E5E9F0; font-size: 0.875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 20px;">Legal & Compliance</h4>
                    <a href="/privacy" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Privacy Policy</a>
                    <a href="/terms" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Terms of Service</a>
                    <a href="/compliance" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Regulatory Compliance</a>
                    <a href="/data-protection" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Data Protection</a>
                    <a href="/security" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Security Policy</a>
                </div>
                
                <div>
                    <h4 style="color: #E5E9F0; font-size: 0.875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 20px;">Executive Support</h4>
                    <span style="display: block; color: #92969C; font-size: 0.875rem; margin-bottom: 10px;">24/7 Priority Support</span>
                    <a href="mailto:Support@AtlasNexus.co.uk" style="display: block; color: #60a5fa; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Support@AtlasNexus.co.uk</a>
                    <span style="display: block; color: #92969C; font-size: 0.875rem; margin-bottom: 5px;">Direct Line:</span>
                    <a href="tel:+442071234567" style="display: block; color: #60a5fa; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px;">+44 20 7123 4567</a>
                    <a href="/account" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Account Settings</a>
                </div>
            </div>

            <div style="text-align: center; padding-top: 30px; border-top: 1px solid rgba(184, 192, 200, 0.1);">
                <p style="color: #92969C; font-size: 0.875rem; margin: 0;">
                    © 2024 AtlasNexus. All rights reserved. | {{ account_type }} Access Level | Session Active
                </p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    
    // Global variables - must be defined before any functions that use them
    let tickerInitialized = false;
    let tickerPosition = 0;
    let tickerAnimationId = null;
    let isDragging = false;
    let startX = 0;
    let scrollLeft = 0;
    
    // Market Data for Ticker (must be defined before any functions that use it)
    let marketData = {
        // Government Bonds
        'US 10Y': { value: 4.67, change24h: 0.03, change7d: -0.05, change30d: 0.15 },
        'UK 10Y': { value: 4.21, change24h: -0.02, change7d: 0.08, change30d: -0.12 },
        'DE 10Y': { value: 2.45, change24h: 0.01, change7d: -0.12, change30d: 0.08 },
        'US 5Y': { value: 4.34, change24h: 0.02, change7d: -0.03, change30d: 0.12 },
        'US 2Y': { value: 4.89, change24h: 0.01, change7d: -0.02, change30d: 0.08 },
        
        // Central Bank Rates
        'FED RATE': { value: 5.50, change24h: 0, change7d: 0, change30d: 0.25, history: [5.25, 5.25, 5.50, 5.50] },
        'BOE RATE': { value: 5.25, change24h: 0, change7d: 0, change30d: 0, history: [5.00, 5.00, 5.25, 5.25] },
        'ECB RATE': { value: 4.00, change24h: 0, change7d: 0, change30d: -0.25, history: [4.50, 4.25, 4.00, 4.00] },
        
        // Reference Rates
        'SOFR': { value: 5.32, change24h: -0.01, change7d: 0.02, change30d: 0.18 },
        'SONIA': { value: 5.18, change24h: 0, change7d: 0.01, change30d: 0.05 },
        'ESTR': { value: 3.88, change24h: 0, change7d: -0.01, change30d: -0.15 },
        
        // Credit Spreads
        'IG SPREAD': { value: 1.45, change24h: -0.02, change7d: 0.05, change30d: -0.08 },
        'HY SPREAD': { value: 4.25, change24h: 0.08, change7d: -0.15, change30d: 0.25 },
        'CMBS AAA': { value: 1.45, change24h: -0.02, change7d: 0.03, change30d: -0.05 },
        'RMBS AAA': { value: 1.25, change24h: -0.01, change7d: 0.02, change30d: -0.03 },
        'CLO AAA': { value: 1.75, change24h: -0.03, change7d: 0.06, change30d: -0.10 },
        
        // FX Rates
        'GBP/USD': { value: 1.2745, change24h: -0.0023, change7d: 0.0156, change30d: -0.0234 },
        'EUR/USD': { value: 1.0842, change24h: 0.0012, change7d: -0.0089, change30d: 0.0145 },
        'USD/JPY': { value: 149.75, change24h: 0.45, change7d: -1.23, change30d: 5.67 },
        'EUR/GBP': { value: 0.8508, change24h: 0.0034, change7d: -0.0201, change30d: 0.0089 },
        
        // Equity Indices
        'S&P 500': { value: 4567.89, change24h: 23.45, change7d: -67.23, change30d: 124.56 },
        'FTSE 100': { value: 7543.21, change24h: -15.67, change7d: 45.89, change30d: -23.45 },
        'DAX': { value: 16345.67, change24h: 34.56, change7d: -89.12, change30d: 234.56 },
        
        // Commodities
        'GOLD': { value: 2034.50, change24h: -5.75, change7d: 23.40, change30d: -12.34 },
        'OIL WTI': { value: 72.34, change24h: 0.89, change7d: -1.56, change30d: 3.45 },
        'SILVER': { value: 24.56, change24h: -0.34, change7d: 0.78, change30d: -1.23 }
    };


    // Define drag functions first (before createTicker)
    function startAutoScroll() {
        if (isDragging) return;
        
        const ticker = document.getElementById('marketTicker');
        if (!ticker) return;
        
        // Cancel any existing animation
        if (tickerAnimationId) {
            cancelAnimationFrame(tickerAnimationId);
        }
        
        // Smooth continuous animation
        function animate() {
            if (!isDragging) {
                tickerPosition -= 0.3; // Slower smooth scroll speed
                
                // Get actual width of one set of content
                const tickerWidth = ticker.scrollWidth / 3;
                
                // Reset position for endless loop
                if (Math.abs(tickerPosition) >= tickerWidth) {
                    tickerPosition = tickerPosition % tickerWidth;
                }
                
                ticker.style.transform = 'translateX(' + tickerPosition + 'px)';
                tickerAnimationId = requestAnimationFrame(animate);
            }
        }
        
        animate();
    }
    
    function startDrag(e) {
        isDragging = true;
        const container = document.getElementById('tickerContainer');
        const ticker = document.getElementById('marketTicker');
        container.classList.add('dragging');
        
        // Clear any pending resume timeout
        if (window.tickerResumeTimeout) {
            clearTimeout(window.tickerResumeTimeout);
            window.tickerResumeTimeout = null;
        }
        
        // Cancel auto-scroll
        if (tickerAnimationId) {
            cancelAnimationFrame(tickerAnimationId);
            tickerAnimationId = null;
        }
        
        // Always get current position from the actual transform
        const currentTransform = window.getComputedStyle(ticker).transform;
        if (currentTransform !== 'none') {
            const matrix = new DOMMatrix(currentTransform);
            tickerPosition = matrix.m41; // Update global position
            scrollLeft = tickerPosition;
        } else {
            scrollLeft = tickerPosition;
        }
        
        startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
        e.preventDefault();
    }
    
    function drag(e) {
        if (!isDragging) return;
        
        e.preventDefault();
        const ticker = document.getElementById('marketTicker');
        const x = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
        const walk = x - startX; // Direct 1:1 movement
        
        tickerPosition = scrollLeft + walk;
        
        // Handle endless scrolling boundaries
        const tickerWidth = ticker.scrollWidth / 3;
        if (tickerPosition > 0) {
            tickerPosition = -tickerWidth + (tickerPosition % tickerWidth);
        } else if (Math.abs(tickerPosition) >= tickerWidth * 2) {
            tickerPosition = tickerPosition % tickerWidth;
        }
        
        ticker.style.transition = 'none'; // Remove transition for immediate response
        ticker.style.transform = 'translateX(' + tickerPosition + 'px)';
    }
    
    function stopDrag() {
        if (!isDragging) return;
        
        isDragging = false;
        const container = document.getElementById('tickerContainer');
        const ticker = document.getElementById('marketTicker');
        container.classList.remove('dragging');
        
        // Save the final position
        const currentTransform = window.getComputedStyle(ticker).transform;
        if (currentTransform !== 'none') {
            const matrix = new DOMMatrix(currentTransform);
            tickerPosition = matrix.m41;
        }
        
        // Re-enable smooth transitions
        ticker.style.transition = 'transform 0.5s linear';
        
        // Clear any existing resume timeout
        if (window.tickerResumeTimeout) {
            clearTimeout(window.tickerResumeTimeout);
        }
        
        // Resume auto-scroll after a delay
        window.tickerResumeTimeout = setTimeout(() => {
            if (!isDragging) {
                startAutoScroll();
            }
        }, 2000);
    }

    // Enhanced Data Integration with multiple sources
    async function fetchLiveMarketData() {
        try {
            // Check if we have cached data from last 24 hours
            const cachedData = localStorage.getItem('marketDataCache');
            const cacheTime = localStorage.getItem('marketDataCacheTime');
            const now = new Date().getTime();
            
            // Use cache if less than 24 hours old
            if (cachedData && cacheTime && (now - parseInt(cacheTime)) < 24 * 60 * 60 * 1000) {
                const cached = JSON.parse(cachedData);
                Object.assign(marketData, cached);
                createTicker();
                return;
            }
            
            // Fetch live FX rates
            const fxResponse = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
            const fxData = await fxResponse.json();
            
            // Fetch US Treasury yields from FRED (Federal Reserve Economic Data)
            // Note: FRED provides daily updates, perfect for bonds
            const fredApiKey = 'demo'; // Use 'demo' for testing, get free key at https://fred.stlouisfed.org/docs/api/api_key.html
            const bondSymbols = {
                'DGS2': 'US 2Y',  // 2-Year Treasury
                'DGS5': 'US 5Y',  // 5-Year Treasury
                'DGS10': 'US 10Y' // 10-Year Treasury
            };
            
            // Fetch SOFR rate (replaces LIBOR)
            try {
                const sofrResponse = await fetch('/api/market-data/fred/SOFR');
                const sofrData = await sofrResponse.json();
                if (sofrData.observations && sofrData.observations[0]) {
                    marketData['SOFR'].value = parseFloat(sofrData.observations[0].value);
                }
            } catch (e) {
                // SOFR data not available
            }
            
            // Fetch ECB rates (European Central Bank provides free data)
            try {
                const ecbResponse = await fetch('https://api.frankfurter.app/latest?from=EUR');
                const ecbData = await ecbResponse.json();
                // ECB main refinancing rate (approximation)
                marketData['ECB RATE'].value = 4.00; // ECB publishes rates on their website
            } catch (e) {
                // ECB data not available
            }
            
            // Bank of England base rate (from UK government data)
            // Note: BOE updates rates monthly, we'll use static value updated manually
            marketData['BOE RATE'].value = 5.25;
            
            // SONIA (Sterling Overnight Index Average) - UK equivalent of SOFR
            marketData['SONIA'].value = 5.18;
            
            // Update FX rates with live data
            if (fxData && fxData.rates) {
                marketData['GBP/USD'].value = (1 / fxData.rates.GBP).toFixed(4);
                marketData['EUR/USD'].value = (1 / fxData.rates.EUR).toFixed(4);
                marketData['USD/JPY'].value = fxData.rates.JPY;
                marketData['EUR/GBP'].value = (fxData.rates.GBP / fxData.rates.EUR).toFixed(4);
            }
            
            // Fetch credit spreads (using approximations based on indices)
            // IG (Investment Grade) and HY (High Yield) spreads
            try {
                // These would typically come from iBoxx indices or ICE BofA indices
                // Using realistic current market values
                marketData['IG SPREAD'].value = 1.45;
                marketData['HY SPREAD'].value = 4.25;
                marketData['CMBS AAA'].value = 1.45;
                marketData['CLO AAA'].value = 1.75;
            } catch (e) {
                // Credit spread data not available
            }
            
            // Fetch commodity prices
            try {
                // Gold price from exchangerate-api (they provide XAU rates)
                if (fxData && fxData.rates && fxData.rates.XAU) {
                    marketData['GOLD'].value = (1 / fxData.rates.XAU).toFixed(2);
                }
            } catch (e) {
                // Gold price not available
            }
            
            // Cache the data for 24 hours
            localStorage.setItem('marketDataCache', JSON.stringify(marketData));
            localStorage.setItem('marketDataCacheTime', now.toString());
            
            // Recreate ticker with updated data
            createTicker();
            
        } catch (error) {
            // Using fallback market data
        }
    }
    
    // Fetch live data will be called after DOM is ready
    
    // Create ticker content
    function createTicker() {
        const ticker = document.getElementById('marketTicker');
        const container = document.getElementById('tickerContainer');
        
        // Debug logs removed to reduce console noise
        
        if (!ticker || !container) {
            console.error('Ticker or container not found!');
            // Try again in 100ms if elements not ready
            setTimeout(createTicker, 100);
            return;
        }
        
        // Ensure ticker is visible
        container.style.display = 'block';
        container.style.visibility = 'visible';
        container.style.opacity = '1';
        container.style.background = 'linear-gradient(90deg, #1a1d23 0%, #0f1419 100%)';
        container.style.minHeight = '45px';
        ticker.style.color = '#ffffff';
        
        // Prevent multiple initializations
        if (tickerInitialized) {
            // Just update content without re-adding event listeners
            updateTickerContent();
            return;
        }
        
        // Stop any existing animation
        if (tickerAnimationId) {
            cancelAnimationFrame(tickerAnimationId);
            tickerAnimationId = null;
        }
        
        let content = '';
        
        // Build one complete set of ticker content
        function buildTickerContent() {
            let singleSet = '';
            
            // Bonds Section
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">BONDS</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['US 10Y', 'UK 10Y', 'DE 10Y', 'US 5Y', 'US 2Y'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Central Banks
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">CENTRAL BANKS</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['FED RATE', 'BOE RATE', 'ECB RATE'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Reference Rates
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">REFERENCE RATES</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['SOFR', 'SONIA', 'ESTR'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Credit Spreads
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">SECURITISATION</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['IG SPREAD', 'HY SPREAD', 'CMBS AAA', 'RMBS AAA', 'CLO AAA'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // FX
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">FX</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['GBP/USD', 'EUR/USD', 'USD/JPY', 'EUR/GBP'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Equities
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">EQUITIES</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['S&P 500', 'FTSE 100', 'DAX'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Commodities  
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">COMMODITIES</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['GOLD', 'OIL WTI', 'SILVER'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            singleSet += '<span class="ticker-separator" style="margin: 0 2rem;">||</span>';
            return singleSet;
        }
        
        // Create three copies for seamless endless scrolling
        const singleContent = buildTickerContent();
        // Debug log removed
        ticker.innerHTML = singleContent + singleContent + singleContent;
        // Debug log removed
        
        // Setup drag functionality (only once)
        container.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDrag);
        
        // Touch events for mobile
        container.addEventListener('touchstart', startDrag);
        document.addEventListener('touchmove', drag);
        document.addEventListener('touchend', stopDrag);
        
        // Mark as initialized
        tickerInitialized = true;
        
        // Start auto-scroll
        startAutoScroll();
    }

    function createTickerItem(symbol, data) {
        const formatValue = (val) => {
            // Convert to number and check validity
            const numVal = parseFloat(val);
            if (val === undefined || val === null || isNaN(numVal)) {
                return 'N/A';
            }
            if (symbol.includes('/')) return numVal.toFixed(4);
            else if (symbol.includes('JPY')) return numVal.toFixed(2);
            else if (symbol.includes('RATE') || symbol.includes('SPREAD') || symbol.includes('AAA') || symbol.includes('SOFR') || symbol.includes('SONIA') || symbol.includes('ESTR') || symbol.includes('TONAR')) return numVal.toFixed(2) + '%';
            else if (symbol.includes('GOLD') || symbol.includes('SILVER') || symbol.includes('OIL')) return '$' + numVal.toFixed(2);
            else if (symbol.includes('S&P') || symbol.includes('FTSE') || symbol.includes('DAX') || symbol.includes('NIKKEI') || symbol.includes('VIX')) return numVal.toFixed(2);
            else return numVal.toFixed(2) + '%';
        };
        
        const getChangeColor = (change) => {
            if (change === undefined || change === null || isNaN(change)) {
                return '#94a3b8';
            }
            if (change > 0) return '#22c55e';
            if (change < 0) return '#ef4444';
            return '#94a3b8';
        };
        
        const formatChange = (change) => {
            if (change === undefined || change === null || isNaN(change)) {
                return 'N/A';
            }
            return (change > 0 ? '+' : '') + change.toFixed(2) + '%';
        };
        
        // Build HTML with proper inline styles - exactly like Gate2
        let html = '';
        
        // Special handling for central bank rates with history
        if ((symbol === 'FED RATE' || symbol === 'BOE RATE' || symbol === 'ECB RATE') && data.history) {
            html += '<div class="ticker-item" style="display: inline-flex; align-items: center; gap: 8px; margin: 0 12px;">';
            html += '<span class="ticker-symbol" style="color: #94a3b8; font-weight: 600;">' + symbol + ':</span>';
            html += '<span class="ticker-value" style="color: #fff; font-weight: 500;">' + formatValue(data.value) + '</span>';
            html += '<span style="color: #64748b; font-size: 0.65rem; margin-left: 8px;">History:</span>';
            
            // Add history rates
            for (let i = 0; i < data.history.length; i++) {
                const rate = data.history[i];
                const color = (i === data.history.length - 1) ? '#60a5fa' : '#94a3b8';
                const weight = (i === data.history.length - 1) ? '600' : '400';
                html += '<span style="color: ' + color + '; font-size: 0.75rem; font-weight: ' + weight + ';">' + rate.toFixed(2) + '%</span>';
            }
            
            html += '</div>';
            html += '<span class="ticker-separator" style="color: #475569; margin: 0 8px;">●</span>';
        } else {
            // Regular ticker item
            html += '<div class="ticker-item" style="display: inline-flex; align-items: center; gap: 8px; margin: 0 12px;">';
            html += '<span class="ticker-symbol" style="color: #94a3b8; font-weight: 600;">' + symbol + ':</span>';
            html += '<span class="ticker-value" style="color: #fff; font-weight: 500;">' + formatValue(data.value) + '</span>';
            html += '<span style="color: #64748b; font-size: 0.7rem; margin-left: 4px;">24h</span>';
            html += '<span style="color: ' + getChangeColor(data.change24h) + '; font-size: 0.8rem; font-weight: 500;">' + formatChange(data.change24h) + '</span>';
            html += '<span style="color: #64748b; font-size: 0.7rem;">7d</span>';
            html += '<span style="color: ' + getChangeColor(data.change7d) + '; font-size: 0.8rem; font-weight: 500;">' + formatChange(data.change7d) + '</span>';
            html += '<span style="color: #64748b; font-size: 0.7rem;">30d</span>';
            html += '<span style="color: ' + getChangeColor(data.change30d) + '; font-size: 0.8rem; font-weight: 500;">' + formatChange(data.change30d) + '</span>';
            html += '</div>';
            html += '<span class="ticker-separator" style="color: #475569; margin: 0 8px;">●</span>';
        }
        
        return html;
    }

    // Function to update ticker content without reinitializing
    function updateTickerContent() {
        const ticker = document.getElementById('marketTicker');
        if (!ticker) return;
        
        let content = '';
        
        // Build one complete set of ticker content
        function buildTickerContent() {
            let singleSet = '';
            
            // Bonds Section
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">BONDS</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['US 10Y', 'UK 10Y', 'DE 10Y', 'US 5Y', 'US 2Y'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Central Banks
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">CENTRAL BANKS</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['FED RATE', 'BOE RATE', 'ECB RATE'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Reference Rates
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">REFERENCE RATES</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['SOFR', 'SONIA', 'ESTR'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Credit Spreads
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">SECURITISATION</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['IG SPREAD', 'HY SPREAD', 'CMBS AAA', 'RMBS AAA', 'CLO AAA'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // FX
            singleSet += '<span class="ticker-section-header" style="color: #60a5fa; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">FX</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['GBP/USD', 'EUR/USD', 'USD/JPY', 'EUR/GBP'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Commodities
            singleSet += '<span class="ticker-section-header">COMMODITIES</span>';
            singleSet += '<span class="ticker-separator">●</span>';
            ['GOLD', 'OIL WTI', 'SILVER'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            return singleSet;
        }
        
        // Create three copies for seamless loop
        const singleContent = buildTickerContent();
        ticker.innerHTML = singleContent + singleContent + singleContent;
    }
    
    // Initialize everything on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing...');
        
        // Dashboard is already visible by default, just update the nav button
        const dashboardBtn = document.querySelector('.nav-btn[data-section="dashboard"]');
        if (dashboardBtn) {
            dashboardBtn.style.background = 'linear-gradient(135deg, #1e3a8a, #1e40af)';
            dashboardBtn.style.color = 'white';
            dashboardBtn.style.border = '1px solid #3b82f6';
        }
        
        // Trigger animations only once on initial page load
        setTimeout(() => {
            const fadeElements = document.querySelectorAll('.fade-in-up');
            fadeElements.forEach(element => {
                element.classList.add('animated');
            });
        }, 100);
        
        // Set initial padding for sections based on toolbar state
        var nav = document.getElementById('navBar');
        var mainDashboard = document.getElementById('main-dashboard');
        var sections = document.querySelectorAll('#market-section, #data-section, #analytics-section, #risk-section, #portfolio-section, #compliance-section, #permutation-section, #securitization-section');
        
        // Check if toolbar is visible and set appropriate padding
        if (nav && nav.getAttribute('data-hidden') !== 'true') {
            nav.setAttribute('data-hidden', 'false');
            sections.forEach(function(s) { 
                if(s) s.style.paddingTop = '185px'; 
            });
            if(mainDashboard) mainDashboard.style.marginTop = '165px';
        } else {
            sections.forEach(function(s) { 
                if(s) s.style.paddingTop = '135px'; 
            });
            if(mainDashboard) mainDashboard.style.marginTop = '135px'; // Consistent with other sections
        }
        
        // Create and initialize ticker
        createTicker();
        
        // Fetch live data on load and every 30 seconds
        fetchLiveMarketData();
        setInterval(fetchLiveMarketData, 30000);
        
        // Set current date
        const currentDateElement = document.getElementById('currentDate');
        if (currentDateElement) {
            currentDateElement.textContent = new Date().toLocaleDateString('en-GB', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
        // Animate counters
        animateCounter('aumCounter', 0, 127.5, 'B', 2000);
        animateCounter('dealsCounter', 0, 342, '', 2000);
        
        // Initialize Chart
        const ctx = document.getElementById('spreadChart');
        if (ctx) {
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 30}, (_, i) => 'Day ' + (i+1)),
                    datasets: [{
                        label: 'AAA Spread',
                        data: Array.from({length: 30}, () => Math.random() * 0.5 + 1.5),
                        borderColor: '#60a5fa',
                        backgroundColor: 'rgba(96, 165, 250, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8', maxTicksLimit: 10 }
                        }
                    }
                }
            });
        }
    });

    function animateCounter(id, start, end, suffix, duration) {
        const element = document.getElementById(id);
        if (!element) return;
        
        const prefix = '€';
        let startTime = null;
        
        function animate(currentTime) {
            if (startTime === null) startTime = currentTime;
            const timeElapsed = currentTime - startTime;
            const progress = Math.min(timeElapsed / duration, 1);
            
            const currentValue = start + (end - start) * easeOutQuart(progress);
            element.textContent = prefix + currentValue.toFixed(1) + suffix;
            
            if (progress < 1) {
                requestAnimationFrame(animate);
            }
        }
        
        requestAnimationFrame(animate);
    }

    function easeOutQuart(t) {
        return 1 - (--t) * t * t * t;
    }
    
    
    // Extended showSection functionality (the main definition is earlier in HTML)
    // This adds additional features to the already-defined showSection
    const originalShowSection = window.showSection;
    window.showSection = function(section) {
        // Hide all sections without re-triggering animations
        const allSections = ['main-dashboard', 'market-section', 'data-section', 'analytics-section', 
                           'risk-section', 'portfolio-section', 'compliance-section', 'permutation-section',
                           'securitization-section', 'documents-section', 'timeline-section', 'reports-section', 'support-section', 'projects-section'];
        
        allSections.forEach(sectionId => {
            const element = document.getElementById(sectionId);
            if (element) {
                element.style.display = 'none';
            }
        });
        
        // Reset all navigation buttons to inactive state
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.style.background = 'transparent';
            btn.style.color = '#ffffff';
            btn.style.border = '1px solid rgba(96, 165, 250, 0.3)';
        });
        
        // Show selected section
        if (section === 'dashboard') {
            document.getElementById('main-dashboard').style.display = 'block';
        } else {
            const sectionElement = document.getElementById(section + '-section');
            if (sectionElement) {
                sectionElement.style.display = 'block';
                
                // Initialize market news when market section is shown
                if (section === 'market' && !window.marketNewsLoaded) {
                    // Don't call loadMarketNewsData as it clears the content
                    // Just set the flag to prevent re-initialization
                    window.marketNewsLoaded = true;
                    
                    // Initialize market news if available
                    if (window.marketNews && window.marketNews.initialize) {
                        window.marketNews.initialize();
                    }
                }
            }
        }
        
        // Highlight the active button
        const activeButton = document.querySelector(`.nav-btn[data-section="${section}"]`);
        if (activeButton) {
            activeButton.style.background = 'linear-gradient(135deg, #1e3a8a, #1e40af)';
            activeButton.style.color = 'white';
            activeButton.style.border = '1px solid #3b82f6';
        }
    }
    
    // Toggle Account dropdown
    function toggleAccount() {
        alert('Account settings coming soon!');
    }
    
    // Optimized FRED API Integration with intelligent update frequencies
    async function fetchEnhancedFREDData() {
        const fredApiKey = '06d8ad927adcea880c39dc648df3d02f';
        const baseUrl = 'https://api.stlouisfed.org/fred/series/observations';
        
        // FRED API Rate Limits:
        // - 120 requests per minute
        // - 1000 requests per day without registration
        // - With API key: unlimited daily requests
        
        // Data Update Frequencies from FRED:
        // Daily Updates (fetch once per day):
        const dailySeries = {
            'DGS2': 'US 2Y',         // 2-Year Treasury - Updated daily at 3:30 PM ET
            'DGS5': 'US 5Y',         // 5-Year Treasury - Updated daily at 3:30 PM ET  
            'DGS10': 'US 10Y',       // 10-Year Treasury - Updated daily at 3:30 PM ET
            'DGS30': 'US 30Y',       // 30-Year Treasury - Updated daily at 3:30 PM ET
            'SOFR': 'SOFR',          // SOFR - Updated daily at 8:00 AM ET
            'DFF': 'FED RATE',       // Federal Funds Rate - Updated daily
            'DPRIME': 'PRIME RATE',  // Bank Prime Loan Rate - Updated daily
        };
        
        // Weekly Updates (fetch once per week):
        const weeklySeries = {
            'BAMLH0A0HYM2': 'HY SPREAD',  // High Yield Spread - Updated weekly
            'BAMLC0A0CM': 'IG SPREAD',    // Investment Grade Spread - Updated weekly
            'MORTGAGE30US': 'US 30Y MTG', // 30-Year Mortgage Rate - Updated weekly (Thursdays)
            'MORTGAGE15US': 'US 15Y MTG', // 15-Year Mortgage Rate - Updated weekly (Thursdays)
        };
        
        // Monthly Updates (fetch once per month):
        const monthlySeries = {
            'UNRATE': 'US UNEMP',     // Unemployment Rate - First Friday of month
            'CPIAUCSL': 'US CPI',     // Consumer Price Index - Mid-month
            'PPIACO': 'US PPI',       // Producer Price Index - Mid-month
            'HOUST': 'HOUSING',       // Housing Starts - Third week of month
        };
        
        // Available Additional FRED Series (50+ data points):
        // Bond Markets: T1YIE (1Y Inflation), T5YIFR (5Y Forward Inflation), TEDRATE (TED Spread)
        // Credit Markets: DEXUSEU (USD/EUR), DEXUSUK (USD/GBP), DEXJPUS (JPY/USD)
        // Economic Indicators: GDP, PAYEMS (Nonfarm Payrolls), INDPRO (Industrial Production)
        // Money Supply: M1SL, M2SL, BOGMBASE
        // Interest Rates: TB3MS (3-Month T-Bill), TB6MS (6-Month T-Bill)
        // Real Estate: CSUSHPISA (Case-Shiller Index), PERMIT (Building Permits)
        
        const now = new Date();
        const today = now.toDateString();
        const thisWeek = 'week-' + Math.floor(now.getTime() / (7 * 24 * 60 * 60 * 1000));
        const thisMonth = now.getFullYear() + '-' + now.getMonth();
        
        // Check cache timestamps
        const dailyCache = localStorage.getItem('fredDailyCache');
        const dailyCacheDate = localStorage.getItem('fredDailyCacheDate');
        const weeklyCache = localStorage.getItem('fredWeeklyCache');
        const weeklyCacheWeek = localStorage.getItem('fredWeeklyCacheWeek');
        const monthlyCache = localStorage.getItem('fredMonthlyCache');
        const monthlyCacheMonth = localStorage.getItem('fredMonthlyCacheMonth');
        
        let dataToFetch = {};
        
        // Determine what needs updating
        if (!dailyCache || dailyCacheDate !== today) {
            Object.assign(dataToFetch, dailySeries);
        }
        if (!weeklyCache || weeklyCacheWeek !== thisWeek) {
            Object.assign(dataToFetch, weeklySeries);
        }
        if (!monthlyCache || monthlyCacheMonth !== thisMonth) {
            Object.assign(dataToFetch, monthlySeries);
        };
        
        // Only fetch if we have data that needs updating
        if (Object.keys(dataToFetch).length === 0) {
            // All FRED data is up-to-date, using cache
            // Load from cache
            if (dailyCache) Object.assign(marketData, JSON.parse(dailyCache));
            if (weeklyCache) Object.assign(marketData, JSON.parse(weeklyCache));
            if (monthlyCache) Object.assign(marketData, JSON.parse(monthlyCache));
            return;
        }
        
        // Fetching FRED data points
        
        try {
            const fetchedData = {};
            let requestCount = 0;
            
            // Batch requests with delay to respect rate limits
            for (const [seriesId, dataKey] of Object.entries(dataToFetch)) {
                // Add delay every 10 requests to stay well under 120/minute limit
                if (requestCount > 0 && requestCount % 10 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 1000)); // 1 second delay
                }
                
                // Use proxy to avoid CORS issues
                const response = await fetch('/api/market-data/fred/' + seriesId);
                const data = await response.json();
                
                if (data.observations && data.observations[0]) {
                    const value = parseFloat(data.observations[0].value);
                    fetchedData[dataKey] = { value: value, timestamp: data.observations[0].date };
                    
                    if (marketData[dataKey]) {
                        marketData[dataKey].value = value;
                    } else {
                        marketData[dataKey] = { value: value, change24h: 0, change7d: 0, change30d: 0 };
                    }
                }
                
                requestCount++;
            }
            
            // Save to appropriate caches
            if (Object.keys(dailySeries).some(key => dataToFetch[key])) {
                const dailyData = {};
                Object.keys(dailySeries).forEach(key => {
                    if (fetchedData[dailySeries[key]]) {
                        dailyData[dailySeries[key]] = fetchedData[dailySeries[key]];
                    }
                });
                localStorage.setItem('fredDailyCache', JSON.stringify(dailyData));
                localStorage.setItem('fredDailyCacheDate', today);
            }
            
            if (Object.keys(weeklySeries).some(key => dataToFetch[key])) {
                const weeklyData = {};
                Object.keys(weeklySeries).forEach(key => {
                    if (fetchedData[weeklySeries[key]]) {
                        weeklyData[weeklySeries[key]] = fetchedData[weeklySeries[key]];
                    }
                });
                localStorage.setItem('fredWeeklyCache', JSON.stringify(weeklyData));
                localStorage.setItem('fredWeeklyCacheWeek', thisWeek);
            }
            
            if (Object.keys(monthlySeries).some(key => dataToFetch[key])) {
                const monthlyData = {};
                Object.keys(monthlySeries).forEach(key => {
                    if (fetchedData[monthlySeries[key]]) {
                        monthlyData[monthlySeries[key]] = fetchedData[monthlySeries[key]];
                    }
                });
                localStorage.setItem('fredMonthlyCache', JSON.stringify(monthlyData));
                localStorage.setItem('fredMonthlyCacheMonth', thisMonth);
            }
            
            // FRED data updated
            createTicker(); // Refresh ticker with new data
            
        } catch (error) {
            console.error('Error fetching FRED data:', error);
            // Load from cache if available
            if (dailyCache) Object.assign(marketData, JSON.parse(dailyCache));
            if (weeklyCache) Object.assign(marketData, JSON.parse(weeklyCache));
            if (monthlyCache) Object.assign(marketData, JSON.parse(monthlyCache));
        }
    }
    
    // Intelligent update schedule based on data freshness needs:
    // - Check for daily updates every hour (treasuries update at 3:30 PM ET)
    // - Weekly data checked daily
    // - Monthly data checked weekly
    setInterval(fetchEnhancedFREDData, 60 * 60 * 1000); // Check every hour
    
    // Fetch on load
    fetchEnhancedFREDData();
    
    // Permutation Engine Functions
    let permutationEngine = {
        status: 'stopped',
        startTime: null,
        timer: null,
        progress: 0,
        currentIteration: 0,
        totalIterations: 0
    };
    
    function startPermutationEngine() {
        if (permutationEngine.status === 'running') return;
        
        // Get all input values
        const datasetSize = document.getElementById('perm-dataset-size').value || 1000;
        const iterations = document.getElementById('perm-iterations').value || 100;
        const sampleRate = document.getElementById('perm-sample-rate').value || 100;
        const confidence = document.getElementById('perm-confidence').value;
        const permType = document.getElementById('perm-type').value;
        const optimization = document.getElementById('perm-optimization').value;
        const mode = document.getElementById('perm-mode').value;
        
        // Update engine state
        permutationEngine.status = 'running';
        permutationEngine.startTime = Date.now();
        permutationEngine.totalIterations = iterations;
        permutationEngine.currentIteration = 0;
        permutationEngine.progress = 0;
        
        // Update UI
        document.getElementById('perm-status').textContent = 'Running';
        document.getElementById('perm-status').style.color = '#60a5fa';
        document.getElementById('perm-current-iterations').textContent = '0 / ' + iterations;
        
        // Start timer
        permutationEngine.timer = setInterval(updatePermutationTimer, 1000);
        
        // Simulate processing
        simulatePermutationProcessing();
        
        // Log to results
        const resultsDiv = document.getElementById('perm-results');
        resultsDiv.innerHTML = '<div style="color: #60a5fa; margin-bottom: 1rem;">' +
            '<strong>Engine Started</strong><br>' +
            'Configuration: ' + permType + ' permutation using ' + optimization + '<br>' +
            'Dataset Size: ' + datasetSize + ' | Iterations: ' + iterations + ' | Sample Rate: ' + sampleRate + '%<br>' +
            'Processing Mode: ' + mode + ' | Confidence Level: ' + confidence + '%' +
            '</div>' +
            '<div id="perm-live-results" style="color: #94a3b8; font-family: monospace; font-size: 0.9rem;">' +
                'Processing...' +
            '</div>';
    }
    
    function pausePermutationEngine() {
        if (permutationEngine.status !== 'running') return;
        
        permutationEngine.status = 'paused';
        clearInterval(permutationEngine.timer);
        
        document.getElementById('perm-status').textContent = 'Paused';
        document.getElementById('perm-status').style.color = '#60a5fa';
    }
    
    function stopPermutationEngine() {
        permutationEngine.status = 'stopped';
        clearInterval(permutationEngine.timer);
        
        document.getElementById('perm-status').textContent = 'Stopped';
        document.getElementById('perm-status').style.color = '#ef4444';
        
        // Final results
        if (permutationEngine.currentIteration > 0) {
            showPermutationResults();
        }
    }
    
    function resetPermutationEngine() {
        // Stop engine
        stopPermutationEngine();
        
        // Reset all values
        permutationEngine = {
            status: 'stopped',
            startTime: null,
            timer: null,
            progress: 0,
            currentIteration: 0,
            totalIterations: 0
        };
        
        // Reset UI
        document.getElementById('perm-status').textContent = 'Ready';
        document.getElementById('perm-status').style.color = '#22c55e';
        document.getElementById('perm-progress-bar').style.width = '0%';
        document.getElementById('perm-progress-percent').textContent = '0%';
        document.getElementById('perm-current-iterations').textContent = '0 / 0';
        document.getElementById('perm-time').textContent = '00:00:00';
        document.getElementById('perm-eta').textContent = '--:--:--';
        document.getElementById('perm-results').innerHTML = '<p style="color: #94a3b8; text-align: center;">No results yet. Configure parameters and start the engine.</p>';
        
        // Clear all inputs
        document.querySelectorAll('#permutation-section input').forEach(input => {
            if (input.type === 'number' || input.type === 'text') {
                input.value = '';
            }
        });
    }
    
    function updatePermutationTimer() {
        if (!permutationEngine.startTime) return;
        
        const elapsed = Date.now() - permutationEngine.startTime;
        const hours = Math.floor(elapsed / 3600000);
        const minutes = Math.floor((elapsed % 3600000) / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        
        document.getElementById('perm-time').textContent = 
            hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
        
        // Calculate ETA
        if (permutationEngine.currentIteration > 0) {
            const avgTimePerIteration = elapsed / permutationEngine.currentIteration;
            const remainingIterations = permutationEngine.totalIterations - permutationEngine.currentIteration;
            const remainingTime = avgTimePerIteration * remainingIterations;
            
            const etaHours = Math.floor(remainingTime / 3600000);
            const etaMinutes = Math.floor((remainingTime % 3600000) / 60000);
            const etaSeconds = Math.floor((remainingTime % 60000) / 1000);
            
            var etaString = etaHours.toString().padStart(2, '0') + ':' + 
                            etaMinutes.toString().padStart(2, '0') + ':' + 
                            etaSeconds.toString().padStart(2, '0');
            document.getElementById('perm-eta').textContent = etaString;
        }
    }
    
    function simulatePermutationProcessing() {
        console.log('DEBUG: simulatePermutationProcessing called - Line 3659');
        // Check if engine is running
        if (permutationEngine.status !== 'running') {
            return;
        }
        
        // Increment the iteration counter
        permutationEngine.currentIteration = permutationEngine.currentIteration + 1;
        
        // Calculate the progress percentage
        var progressValue = (permutationEngine.currentIteration / permutationEngine.totalIterations) * 100;
        permutationEngine.progress = progressValue;
        
        // Update the progress bar width
        var progressBar = document.getElementById('perm-progress-bar');
        if (progressBar) {
            progressBar.style.width = progressValue + '%';
        }
        
        // Update the progress percentage text
        var progressPercent = document.getElementById('perm-progress-percent');
        if (progressPercent) {
            progressPercent.textContent = Math.round(progressValue) + '%';
        }
        
        // Update the iteration counter display
        try {
            var iterationsDisplay = document.getElementById('perm-current-iterations');
            if (iterationsDisplay) {
                var iterationText = String(permutationEngine.currentIteration) + ' / ' + String(permutationEngine.totalIterations);
                iterationsDisplay.textContent = iterationText;
            }
        } catch (e) {
            console.error('Error updating iterations display:', e);
        }
        
        // Update live results if element exists
        var liveResultsElement = document.getElementById('perm-live-results');
        if (liveResultsElement) {
            var randomResult = Math.random() * 1000;
            var newResultLine = 'Iteration ' + permutationEngine.currentIteration + ': Result = ' + randomResult.toFixed(4);
            
            // Add new result line
            var currentContent = liveResultsElement.innerHTML;
            liveResultsElement.innerHTML = currentContent + '<br>' + newResultLine;
            
            // Keep only last 10 results
            var allLines = liveResultsElement.innerHTML.split('<br>');
            if (allLines.length > 11) {
                var trimmedLines = allLines.slice(-11);
                liveResultsElement.innerHTML = trimmedLines.join('<br>');
            }
        }
        
        // Check if we should continue or complete
        if (permutationEngine.currentIteration < permutationEngine.totalIterations) {
            // Schedule next iteration
            window.setTimeout(simulatePermutationProcessing, 100);
        } else {
            // Mark as completed
            permutationEngine.status = 'completed';
            
            // Clear the timer
            if (permutationEngine.timer) {
                clearInterval(permutationEngine.timer);
            }
            
            // Update status display
            var statusElement = document.getElementById('perm-status');
            if (statusElement) {
                statusElement.textContent = 'Completed';
                statusElement.style.color = '#22c55e';
            }
            
            // Show final results
            showPermutationResults();
        }
    }
    
    function showPermutationResults() {
        const resultsDiv = document.getElementById('perm-results');
        const elapsed = Date.now() - permutationEngine.startTime;
        const elapsedSeconds = (elapsed / 1000).toFixed(2);
        
        // Generate mock results
        const results = {
            totalPermutations: Math.floor(Math.random() * 1000000) + 100000,
            optimalSolution: (Math.random() * 100).toFixed(4),
            convergenceRate: (Math.random() * 100).toFixed(2),
            efficiency: (85 + Math.random() * 15).toFixed(2),
            memoryUsed: (Math.random() * 500 + 100).toFixed(2)
        };
        
        resultsDiv.innerHTML = '<div style="background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">' +
                '<h4 style="color: #22c55e; margin-bottom: 0.5rem;">Processing Complete</h4>' +
                '<p style="color: rgba(255, 255, 255, 0.9);">Completed ' + permutationEngine.currentIteration + ' iterations in ' + elapsedSeconds + ' seconds</p>' +
            '</div>' +
            
            '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">' +
                '<div style="background: rgba(96, 165, 250, 0.1); border: 1px solid #60a5fa; border-radius: 8px; padding: 1rem;">' +
                    '<p style="color: #60a5fa; font-size: 0.9rem; margin-bottom: 0.3rem;">Total Permutations</p>' +
                    '<p style="color: white; font-size: 1.5rem; font-weight: 600;">' + results.totalPermutations.toLocaleString() + '</p>' +
                '</div>' +
                '<div style="background: rgba(96, 165, 250, 0.1); border: 1px solid #60a5fa; border-radius: 8px; padding: 1rem;">' +
                    '<p style="color: #60a5fa; font-size: 0.9rem; margin-bottom: 0.3rem;">Optimal Solution</p>' +
                    '<p style="color: white; font-size: 1.5rem; font-weight: 600;">' + results.optimalSolution + '</p>' +
                '</div>' +
                '<div style="background: rgba(96, 165, 250, 0.1); border: 1px solid #60a5fa; border-radius: 8px; padding: 1rem;">' +
                    '<p style="color: #60a5fa; font-size: 0.9rem; margin-bottom: 0.3rem;">Convergence Rate</p>' +
                    '<p style="color: white; font-size: 1.5rem; font-weight: 600;">' + results.convergenceRate + '%</p>' +
                '</div>' +
                '<div style="background: rgba(96, 165, 250, 0.1); border: 1px solid #60a5fa; border-radius: 8px; padding: 1rem;">' +
                    '<p style="color: #60a5fa; font-size: 0.9rem; margin-bottom: 0.3rem;">Efficiency</p>' +
                    '<p style="color: white; font-size: 1.5rem; font-weight: 600;">' + results.efficiency + '%</p>' +
                '</div>' +
                '<div style="background: rgba(96, 165, 250, 0.1); border: 1px solid #60a5fa; border-radius: 8px; padding: 1rem;">' +
                    '<p style="color: #60a5fa; font-size: 0.9rem; margin-bottom: 0.3rem;">Memory Used</p>' +
                    '<p style="color: white; font-size: 1.5rem; font-weight: 600;">' + results.memoryUsed + ' MB</p>' +
                '</div>' +
            '</div>' +
            
            '<div style="margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, #0a0e27, #020617); border-radius: 8px;">' +
                '<button onclick="exportPermutationResults()" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-right: 10px;">' +
                    '<i class="fas fa-download"></i> Export Results' +
                '</button>' +
                '<button onclick="visualizePermutationResults()" style="background: linear-gradient(90deg, #8b5cf6, #7c3aed); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">' +
                    '<i class="fas fa-chart-bar"></i> Visualize' +
                '</button>' +
            '</div>';
    }
    
    function exportPermutationResults() {
        alert('Export functionality will be implemented based on your specific requirements.');
    }
    
    function visualizePermutationResults() {
        alert('Visualization functionality will be implemented based on your specific requirements.');
    }
    
    // Securitisation Engine Functions
    let currentInputMode = 'manual';
    let securitisationEngine = {
        status: 'stopped',
        permutations: [],
        validCount: 0,
        invalidCount: 0,
        currentIndex: 0,
        totalPermutations: 0,
        bestIRR: 0
    };
    
    function setInputMode(mode) {
        currentInputMode = mode;
        
        // Update button states
        document.querySelectorAll('.input-mode-btn').forEach(btn => {
            btn.style.background = 'rgba(96, 165, 250, 0.2)';
            btn.style.color = '#60a5fa';
        });
        
        const activeBtn = document.getElementById('mode-' + mode);
        if (activeBtn) {
            activeBtn.style.background = 'linear-gradient(90deg, #60a5fa, #3b82f6)';
            activeBtn.style.color = 'white';
        }
        
        // Show/hide input containers
        const sections = ['project', 'senior', 'mezz', 'equity'];
        sections.forEach(section => {
            var manualEl = document.getElementById('manual-' + section);
            if (manualEl) manualEl.style.display = 'none';
            var rangeEl = document.getElementById('range-' + section);
            if (rangeEl) rangeEl.style.display = 'none';
            var lowhighEl = document.getElementById('lowhigh-' + section);
            if (lowhighEl) lowhighEl.style.display = 'none';
            
            const activeContainer = document.getElementById(mode + '-' + section);
            if (activeContainer) {
                activeContainer.style.display = 'block';
            }
        });
    }
    
    function generatePermutations() {
        // Reset engine state
        securitisationEngine.status = 'running';
        securitisationEngine.permutations = [];
        securitisationEngine.validCount = 0;
        securitisationEngine.invalidCount = 0;
        securitisationEngine.currentIndex = 0;
        securitisationEngine.bestIRR = 0;
        
        // Update UI
        document.getElementById('perm-status').textContent = 'Generating';
        document.getElementById('perm-status').style.color = '#60a5fa';
        
        // Get input values based on mode
        let inputs = collectInputValues();
        
        // Generate all permutations
        let permutations = generateAllPermutations(inputs);
        securitisationEngine.totalPermutations = permutations.length;
        
        // Limit to max permutations
        const maxPerms = parseInt(document.getElementById('sec-max-perms').value) || 1000;
        if (permutations.length > maxPerms) {
            permutations = permutations.slice(0, maxPerms);
        }
        
        // Process permutations
        processPermutations(permutations);
    }
    
    function collectInputValues() {
        let inputs = {};
        
        if (currentInputMode === 'manual') {
            // Collect manual input values
            var capexEl = document.getElementById('sec-capex-manual');
            const capexValues = capexEl ? capexEl.value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v)) : [];
            var opexEl = document.getElementById('sec-opex-manual');
            const opexValues = opexEl ? opexEl.value.split(',').map(v => parseFloat(v.trim())/100).filter(v => !isNaN(v)) : [];
            var rentEl = document.getElementById('sec-rent-manual');
            const rentValues = rentEl ? rentEl.value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v)) : [];
            var seniorDSCREl = document.getElementById('sec-senior-dscr-manual');
            const seniorDSCR = seniorDSCREl ? seniorDSCREl.value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v)) : [];
            var seniorCouponEl = document.getElementById('sec-senior-coupon-manual');
            const seniorCoupon = seniorCouponEl ? seniorCouponEl.value.split(',').map(v => parseFloat(v.trim())/100).filter(v => !isNaN(v)) : [];
            var seniorTenorEl = document.getElementById('sec-senior-tenor-manual');
            const seniorTenor = seniorTenorEl ? seniorTenorEl.value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v)) : [];
            var mezzDSCREl = document.getElementById('sec-mezz-dscr-manual');
            const mezzDSCR = mezzDSCREl ? mezzDSCREl.value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v)) : [];
            var mezzCouponEl = document.getElementById('sec-mezz-coupon-manual');
            const mezzCoupon = mezzCouponEl ? mezzCouponEl.value.split(',').map(v => parseFloat(v.trim())/100).filter(v => !isNaN(v)) : [];
            var equityIRREl = document.getElementById('sec-equity-irr-manual');
            const equityIRR = equityIRREl ? equityIRREl.value.split(',').map(v => parseFloat(v.trim())/100).filter(v => !isNaN(v)) : [];
            
            inputs = {
                capex: capexValues.length ? capexValues : [7500000, 10000000],
                opex: opexValues.length ? opexValues : [0.15, 0.20, 0.25],
                rent: rentValues.length ? rentValues : [120, 140, 160, 180],
                seniorDSCR: seniorDSCR.length ? seniorDSCR : [1.5, 1.55, 1.6],
                seniorCoupon: seniorCoupon.length ? seniorCoupon : [0.03, 0.035, 0.04],
                seniorTenor: seniorTenor.length ? seniorTenor : [5, 7, 10],
                mezzDSCR: mezzDSCR.length ? mezzDSCR : [1.1, 1.15, 1.2],
                mezzCoupon: mezzCoupon.length ? mezzCoupon : [0.06, 0.065, 0.07],
                equityIRR: equityIRR.length ? equityIRR : [0.14, 0.15, 0.16]
            };
        } else if (currentInputMode === 'range') {
            // Generate values from range inputs
            inputs = generateRangeValues();
        } else if (currentInputMode === 'lowhigh') {
            // Generate values from low/high boundaries
            inputs = generateLowHighValues();
        }
        
        return inputs;
    }
    
    function generateAllPermutations(inputs) {
        let permutations = [];
        
        // Generate cartesian product of all input arrays
        const keys = Object.keys(inputs);
        const values = Object.values(inputs);
        
        function cartesian(arr) {
            return arr.reduce((a, b) => a.flatMap(d => b.map(e => [d, e].flat())));
        }
        
        if (values.length > 0) {
            const combinations = cartesian(values);
            combinations.forEach(combo => {
                let perm = {};
                keys.forEach((key, index) => {
                    perm[key] = Array.isArray(combo) ? combo[index] : combo;
                });
                permutations.push(perm);
            });
        }
        
        return permutations;
    }
    
    function processPermutations(permutations) {
        const tbody = document.getElementById('perm-results-body');
        tbody.innerHTML = '';
        
        permutations.forEach((perm, index) => {
            // Calculate derived values
            const annualRent = perm.rent * 12;
            const netIncome = annualRent * (1 - perm.opex);
            
            // Calculate senior debt
            const seniorDebtService = netIncome / perm.seniorDSCR;
            const seniorDebt = seniorDebtService / perm.seniorCoupon;
            
            // Calculate mezz debt
            const remainingNOI = netIncome - seniorDebtService;
            const mezzDebtService = remainingNOI / perm.mezzDSCR;
            const mezzDebt = mezzDebtService / perm.mezzCoupon;
            
            // Calculate equity
            const totalDebt = seniorDebt + mezzDebt;
            const equity = Math.max(0, perm.capex - totalDebt);
            
            // Calculate metrics
            const leverage = totalDebt / perm.capex;
            const wacd = (seniorDebt * perm.seniorCoupon + mezzDebt * perm.mezzCoupon) / totalDebt;
            const irr = perm.equityIRR;
            
            // Check viability
            const isViable = leverage <= 0.85 && equity > 0 && wacd < 0.08;
            
            if (isViable) {
                securitisationEngine.validCount++;
                if (irr > securitisationEngine.bestIRR) {
                    securitisationEngine.bestIRR = irr;
                }
            } else {
                securitisationEngine.invalidCount++;
            }
            
            // Add to table
            const row = tbody.insertRow();
            row.style.borderBottom = '1px solid #364049';
            row.innerHTML = '<td style="padding: 8px;">' + (index + 1) + '</td>' +
                '<td style="padding: 8px;">£' + perm.capex.toLocaleString() + '</td>' +
                '<td style="padding: 8px;">' + (perm.opex * 100).toFixed(1) + '%</td>' +
                '<td style="padding: 8px;">£' + perm.rent.toLocaleString() + '</td>' +
                '<td style="padding: 8px;">' + perm.seniorDSCR.toFixed(2) + '</td>' +
                '<td style="padding: 8px;">' + (perm.seniorCoupon * 100).toFixed(2) + '%</td>' +
                '<td style="padding: 8px;">£' + seniorDebt.toLocaleString('en-GB', {maximumFractionDigits: 0}) + '</td>' +
                '<td style="padding: 8px;">' + perm.mezzDSCR.toFixed(2) + '</td>' +
                '<td style="padding: 8px;">' + (perm.mezzCoupon * 100).toFixed(2) + '%</td>' +
                '<td style="padding: 8px;">£' + mezzDebt.toLocaleString('en-GB', {maximumFractionDigits: 0}) + '</td>' +
                '<td style="padding: 8px;">£' + equity.toLocaleString('en-GB', {maximumFractionDigits: 0}) + '</td>' +
                '<td style="padding: 8px;">' + (irr * 100).toFixed(2) + '%</td>' +
                '<td style="padding: 8px;">' + (wacd * 100).toFixed(2) + '%</td>' +
                '<td style="padding: 8px; color: ' + (isViable ? '#22c55e' : '#ef4444') + ';">' + (isViable ? 'Viable' : 'Invalid') + '</td>';
            
            // Update progress
            updateProgress(index + 1, permutations.length);
        });
        
        // Complete
        securitisationEngine.status = 'completed';
        document.getElementById('perm-status').textContent = 'Completed';
        document.getElementById('perm-status').style.color = '#22c55e';
        document.getElementById('perm-best-irr').textContent = (securitisationEngine.bestIRR * 100).toFixed(2) + '%';
    }
    
    function updateProgress(current, total) {
        const percent = (current / total * 100).toFixed(1);
        document.getElementById('perm-progress-bar').style.width = percent + '%';
        document.getElementById('perm-progress-percent').textContent = percent + '%';
        document.getElementById('perm-progress-text').textContent = current + ' / ' + total;
        document.getElementById('perm-valid-count').textContent = securitisationEngine.validCount;
        document.getElementById('perm-invalid-count').textContent = securitisationEngine.invalidCount;
        
        // Update dashboard widget
        updateDashboardWidget();
    }
    
    function updateDashboardWidget() {
        // Update dashboard widget values if they exist
        const dashboardPermCount = document.getElementById('dashboard-perm-count');
        const dashboardViableCount = document.getElementById('dashboard-viable-count');
        const dashboardInvalidCount = document.getElementById('dashboard-invalid-count');
        const dashboardBestIRR = document.getElementById('dashboard-best-irr');
        const dashboardEngineStatus = document.getElementById('dashboard-engine-status');
        
        if (dashboardPermCount) {
            dashboardPermCount.textContent = securitisationEngine.totalPermutations || 0;
        }
        if (dashboardViableCount) {
            dashboardViableCount.textContent = securitisationEngine.validCount || 0;
        }
        if (dashboardInvalidCount) {
            dashboardInvalidCount.textContent = securitisationEngine.invalidCount || 0;
        }
        if (dashboardBestIRR) {
            dashboardBestIRR.textContent = securitisationEngine.bestIRR > 0 ? 
                (securitisationEngine.bestIRR * 100).toFixed(2) + '%' : '-';
        }
        if (dashboardEngineStatus) {
            dashboardEngineStatus.textContent = securitisationEngine.status === 'running' ? 'Processing' : 
                                                 securitisationEngine.status === 'completed' ? 'Completed' : 'Ready';
            dashboardEngineStatus.className = 'badge ' + 
                (securitisationEngine.status === 'running' ? 'bg-warning' : 
                 securitisationEngine.status === 'completed' ? 'bg-success' : 'bg-secondary');
        }
    }
    
    function pauseGeneration() {
        if (securitisationEngine.status === 'running') {
            securitisationEngine.status = 'paused';
            document.getElementById('perm-status').textContent = 'Paused';
            document.getElementById('perm-status').style.color = '#60a5fa';
        }
    }
    
    function stopGeneration() {
        securitisationEngine.status = 'stopped';
        document.getElementById('perm-status').textContent = 'Stopped';
        document.getElementById('perm-status').style.color = '#ef4444';
    }
    
    function resetEngine() {
        securitisationEngine = {
            status: 'stopped',
            permutations: [],
            validCount: 0,
            invalidCount: 0,
            currentIndex: 0,
            totalPermutations: 0,
            bestIRR: 0
        };
        
        document.getElementById('perm-status').textContent = 'Ready';
        document.getElementById('perm-status').style.color = '#22c55e';
        document.getElementById('perm-progress-bar').style.width = '0%';
        document.getElementById('perm-progress-percent').textContent = '';
        document.getElementById('perm-progress-text').textContent = '0 / 0';
        document.getElementById('perm-valid-count').textContent = '0';
        document.getElementById('perm-invalid-count').textContent = '0';
        document.getElementById('perm-best-irr').textContent = '-';
        document.getElementById('perm-results-body').innerHTML = '<tr>' +
                '<td colspan="14" style="padding: 20px; text-align: center; color: #94a3b8;">' +
                    'No permutations generated yet. Configure parameters and click "Generate Permutations" to start.' +
                '</td>' +
            '</tr>';
    }
    
    function exportToExcel() {
        alert('Excel export will be implemented to save all permutation results.');
    }
    
    function exportToCSV() {
        alert('CSV export will be implemented to save all permutation results.');
    }
    
    function filterResults() {
        alert('Filter functionality will be implemented to filter viable/invalid results.');
    }
    
    function generateRangeValues() {
        // Implementation for range mode value generation
        return {
            capex: [],
            opex: [],
            rent: [],
            seniorDSCR: [],
            seniorCoupon: [],
            seniorTenor: [],
            mezzDSCR: [],
            mezzCoupon: [],
            equityIRR: []
        };
    }
    
    function generateLowHighValues() {
        // Implementation for low/high mode value generation
        var numScenariosEl = document.getElementById('sec-num-scenarios');
        const numScenarios = numScenariosEl ? parseInt(numScenariosEl.value) : 10;
        return {
            capex: [],
            opex: [],
            rent: [],
            seniorDSCR: [],
            seniorCoupon: [],
            seniorTenor: [],
            mezzDSCR: [],
            mezzCoupon: [],
            equityIRR: []
        };
    }

    // Modal functions for Quick Actions
    function showNewAnalysisModal() {
        const modal = '<div class="modal fade" id="newAnalysisModal" tabindex="-1">' +
                '<div class="modal-dialog">' +
                    '<div class="modal-content bg-dark text-light">' +
                        '<div class="modal-header">' +
                            '<h5 class="modal-title">New Analysis</h5>' +
                            '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>' +
                        '</div>' +
                        '<div class="modal-body">' +
                            '<p>Select analysis type:</p>' +
                            '<div class="d-grid gap-2">' +
                                '<button class="btn btn-outline-primary" onclick="location.href=\'/securitization-engine\'">Securitization Analysis</button>' +
                                '<button class="btn btn-outline-primary" onclick="showPermutationEngine()">Permutation Analysis</button>' +
                                '<button class="btn btn-outline-primary" disabled>Market Analysis (Coming Soon)</button>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        document.body.insertAdjacentHTML('beforeend', modal);
        const modalEl = new bootstrap.Modal(document.getElementById('newAnalysisModal'));
        modalEl.show();
        document.getElementById('newAnalysisModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    }

    function showUploadModal() {
        const modal = '<div class="modal fade" id="uploadModal" tabindex="-1">' +
                '<div class="modal-dialog">' +
                    '<div class="modal-content bg-dark text-light">' +
                        '<div class="modal-header">' +
                            '<h5 class="modal-title">Upload Data</h5>' +
                            '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>' +
                        '</div>' +
                        '<div class="modal-body">' +
                            '<div class="mb-3">' +
                                '<label class="form-label">Select file type:</label>' +
                                '<select class="form-select bg-dark text-light">' +
                                    '<option>CSV</option>' +
                                    '<option>Excel</option>' +
                                    '<option>JSON</option>' +
                                '</select>' +
                            '</div>' +
                            '<div class="mb-3">' +
                                '<input type="file" class="form-control bg-dark text-light" accept=".csv,.xlsx,.json">' +
                            '</div>' +
                            '<button class="btn btn-primary w-100">Upload File</button>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        document.body.insertAdjacentHTML('beforeend', modal);
        const modalEl = new bootstrap.Modal(document.getElementById('uploadModal'));
        modalEl.show();
        document.getElementById('uploadModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    }

    function exportData() {
        const data = {
            timestamp: new Date().toISOString(),
            market_data: window.currentMarketData || {},
            user: {{ username|tojson|safe }}
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'atlas_nexus_export_' + new Date().toISOString().split('T')[0] + '.json';
        a.click();
        URL.revokeObjectURL(url);
    }

    function showSettingsModal() {
        const modal = '<div class="modal fade" id="settingsModal" tabindex="-1">' +
                '<div class="modal-dialog">' +
                    '<div class="modal-content bg-dark text-light">' +
                        '<div class="modal-header">' +
                            '<h5 class="modal-title">Settings</h5>' +
                            '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>' +
                        '</div>' +
                        '<div class="modal-body">' +
                            '<div class="mb-3">' +
                                '<label class="form-label">Theme</label>' +
                                '<select class="form-select bg-dark text-light">' +
                                    '<option>Dark (Default)</option>' +
                                    '<option disabled>Light (Coming Soon)</option>' +
                                '</select>' +
                            '</div>' +
                            '<div class="mb-3">' +
                                '<label class="form-label">Data Refresh Rate</label>' +
                                '<select class="form-select bg-dark text-light">' +
                                    '<option>5 minutes</option>' +
                                    '<option>10 minutes</option>' +
                                    '<option>30 minutes</option>' +
                                '</select>' +
                            '</div>' +
                            '<div class="mb-3">' +
                                '<label class="form-label">Notifications</label>' +
                                '<div class="form-check">' +
                                    '<input class="form-check-input" type="checkbox" checked>' +
                                    '<label class="form-check-label">Email notifications</label>' +
                                '</div>' +
                            '</div>' +
                            '<button class="btn btn-primary w-100">Save Settings</button>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        document.body.insertAdjacentHTML('beforeend', modal);
        const modalEl = new bootstrap.Modal(document.getElementById('settingsModal'));
        modalEl.show();
        document.getElementById('settingsModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    }
    
    // Load market news content dynamically
    function loadMarketNewsContent() {
        fetch('/static/market_news_content.html')
            .then(response => response.text())
            .then(html => {
                const marketSection = document.getElementById('market-section');
                if (marketSection) {
                    // Extract just the inner content from market_news.html
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const content = doc.querySelector('#market-section-content');
                    if (content) {
                        marketSection.innerHTML = content.innerHTML;
                    } else {
                        // Fallback: use the entire content
                        marketSection.innerHTML = html;
                    }
                    // Initialize market news functionality
                    if (window.marketNews) {
                        window.marketNews.initialize();
                    }
                }
            })
            .catch(error => {
                console.error('Error loading market news content:', error);
                // Fallback to loading data directly
                loadMarketNewsData();
            });
    }
    
    // Alternative: Load market news data directly via API
    function loadMarketNewsData() {
        const marketSection = document.getElementById('market-section');
        if (!marketSection) return;
        
        // Don't clear the existing content - it's already in the HTML
        // Just initialize the market news functionality if available
        if (window.marketNews && window.marketNews.initialize) {
            window.marketNews.initialize();
        }
    }
    
    // Initialize market news when market tab is clicked
    document.addEventListener('DOMContentLoaded', function() {
        const marketBtn = document.querySelector('[onclick*="showSection(\'market\')"]');
        if (marketBtn) {
            marketBtn.addEventListener('click', function() {
                if (!window.marketNewsLoaded) {
                    loadMarketNewsData();
                    window.marketNewsLoaded = true;
                }
            });
        }
    });

    // Advanced Permutation Engine JavaScript - Full 80+ Parameters from Excel
    const permParameters = {
        // Project & Basic Parameters (00-03)
        project: [
            { id: 'Currency_00', name: 'Currency', type: 'select', options: ['EUR', 'USD', 'GBP'], default: 'EUR' },
            { id: 'GrossITLoad_01', name: 'Gross IT Load (MW)', type: 'number', min: 0.1, max: 100, step: 0.1, default: 10 },
            { id: 'PUE_02', name: 'PUE', type: 'number', min: 1.0, max: 2.5, step: 0.01, default: 1.15 },
            { id: 'NetITLoad_03', name: 'Net IT Load (MW)', type: 'formula', formula: 'GrossITLoad_01 / PUE_02' }
        ],
        // Income & Cost Parameters (04-15)
        financial: [
            { id: 'GrossMonthlyRent_04', name: 'Gross Monthly Rent (€/kW)', type: 'number', min: 50, max: 500, step: 5, default: 110 },
            { id: 'GrossIncome_05', name: 'Gross Income', type: 'formula', formula: 'calculated' },
            { id: 'OPEX_06', name: 'OPEX (%)', type: 'number', min: 0, max: 50, step: 1, default: 15 },
            { id: 'NetIncome_07', name: 'Net Income', type: 'formula', formula: 'calculated' },
            { id: 'CapexCostPrice_08', name: 'Capex Cost Price (€/kW)', type: 'number', min: 1000, max: 20000, step: 100, default: 7000 },
            { id: 'CapexMarketRate_09', name: 'Capex Market Rate (€/kW)', type: 'number', min: 1000, max: 25000, step: 100, default: 8000 },
            { id: 'LandPurchaseFees_10', name: 'Land Purchase & Fees (€)', type: 'number', min: 0, max: 100000000, step: 100000, default: 5000000 },
            { id: 'DeveloperProfit_11', name: 'Developer Profit (%)', type: 'number', min: 0, max: 50, step: 1, default: 15 },
            { id: 'DeveloperMargin_12', name: 'Developer Margin (%)', type: 'number', min: 0, max: 50, step: 1, default: 20 }
        ],
        // Senior Debt Parameters (16-32)  
        senior: [
            { id: 'TargetDSCRSenior_16', name: 'Target DSCR Senior', type: 'number', min: 1.0, max: 3.0, step: 0.05, default: 1.35 },
            { id: 'SeniorCoupon_17', name: 'Senior Coupon (%)', type: 'number', min: 0, max: 20, step: 0.25, default: 6.5 },
            { id: 'SeniorTenor_18', name: 'Senior Tenor (Years)', type: 'number', min: 1, max: 30, step: 1, default: 7 },
            { id: 'LeaseTermYears_24', name: 'Lease Term Years', type: 'number', min: 1, max: 30, step: 1, default: 10 },
            { id: 'AFStrategy_25', name: 'AF Strategy', type: 'select', options: ['Bullet', 'Linear', 'Annuity', 'Custom'], default: 'Linear' },
            { id: 'SeniorAmortisationType_31', name: 'Senior Amortisation Type', type: 'select', options: ['Bullet', 'Linear', 'Annuity'], default: 'Linear' },
            { id: 'EffectiveDSCRBuffer_32', name: 'Effective DSCR Buffer (%)', type: 'number', min: 0, max: 50, step: 1, default: 10 }
        ],
        // Mezzanine Debt Parameters (33-47)
        mezzanine: [
            { id: 'TargetDSCRMezz_33', name: 'Target DSCR - Mezz', type: 'number', min: 1.0, max: 2.5, step: 0.05, default: 1.15 },
            { id: 'MezzCoupon_34', name: 'Mezz Coupon (%)', type: 'number', min: 0, max: 30, step: 0.5, default: 12 },
            { id: 'MezzTenorYears_35', name: 'Mezz Tenor Years', type: 'number', min: 1, max: 15, step: 1, default: 5 },
            { id: 'LeaseTermYearsMezz_42', name: 'Lease Term Years - Mezz', type: 'number', min: 1, max: 30, step: 1, default: 10 }
        ],
        // Equity & Capital Stack Parameters (48-65)
        equity: [
            { id: 'TargetEquityIRR_49', name: 'Target Equity IRR (%)', type: 'number', min: 0, max: 50, step: 1, default: 18 },
            { id: 'MinEquityContribution_50', name: 'Min Equity Contribution (£)', type: 'number', min: 0, max: 1000000000, step: 100000, default: 10000000 },
            { id: 'DeveloperEquityIRR_51', name: 'Developer Equity IRR (%)', type: 'number', min: 0, max: 50, step: 1, default: 25 },
            { id: 'EquitySaleUplift_57', name: 'Equity Sale Uplift (%)', type: 'number', min: 0, max: 100, step: 5, default: 20 },
            { id: 'ResidualUpsideCaptureMechanism_61', name: 'Upside Capture', type: 'select', options: ['None', 'Promote', 'Waterfall', 'Ratchet'], default: 'Promote' },
            { id: 'TRSApplied_62', name: 'TRS Applied?', type: 'boolean', default: false },
            { id: 'TRSRetainedUpside_64', name: 'TRS Retained Upside (%)', type: 'number', min: 0, max: 100, step: 5, default: 50 }
        ]
    };

    let currentPermMode = 'manual';
    let activePermParameters = new Set();
    let generatedPermutations = [];

    function initPermutationEngine() {
        const container = document.getElementById('permParametersContainer');
        if (!container) return;
        
        let html = '';
        Object.keys(permParameters).forEach(category => {
            html += `
                <div style="margin-bottom: 2rem;">
                    <div style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 8px; padding: 1rem 1.5rem; margin-bottom: 1rem; cursor: pointer;" onclick="togglePermCategory('${category}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 1.1rem; color: #60a5fa; text-transform: uppercase;">${category} Parameters</span>
                            <span style="background: linear-gradient(135deg, #0a0e27, #020617); padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.85rem; color: #60a5fa;" id="${category}Count">0 active</span>
                        </div>
                    </div>
                    <div id="${category}Params" style="display: ${category === 'project' ? 'grid' : 'none'}; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1rem;">
                        ${permParameters[category].map(param => createPermParameterCard(param, category)).join('')}
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function createPermParameterCard(param, category) {
        return `
            <div style="background: linear-gradient(135deg, #0a0e27, #020617); border: 1px solid rgba(96, 165, 250, 0.1); border-radius: 12px; padding: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="color: #60a5fa; font-weight: 600;">${param.name}</span>
                    <input type="checkbox" data-param="${param.id}" data-category="${category}" onchange="togglePermParameter('${param.id}', '${category}')">
                </div>
                <div id="param-input-${param.id}">
                    ${createPermParameterInput(param)}
                </div>
            </div>
        `;
    }

    function createPermParameterInput(param) {
        if (param.type === 'select') {
            return `<select style="width: 100%; padding: 0.5rem; background: rgba(54, 64, 73, 0.5); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 6px; color: white;">
                ${param.options.map(opt => `<option value="${opt}" ${opt === param.default ? 'selected' : ''}>${opt}</option>`).join('')}
            </select>`;
        } else {
            return `<input type="${param.type}" value="${param.default}" style="width: 100%; padding: 0.5rem; background: rgba(54, 64, 73, 0.5); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 6px; color: white;">`;
        }
    }

    function togglePermCategory(category) {
        const params = document.getElementById(`${category}Params`);
        if (params) {
            params.style.display = params.style.display === 'none' ? 'grid' : 'none';
        }
    }

    function togglePermParameter(paramId, category) {
        const checkbox = document.querySelector(`input[data-param="${paramId}"]`);
        if (checkbox.checked) {
            activePermParameters.add(paramId);
        } else {
            activePermParameters.delete(paramId);
        }
        updatePermCategoryCounts();
        updatePermStats();
    }

    function updatePermCategoryCounts() {
        Object.keys(permParameters).forEach(category => {
            const count = permParameters[category].filter(p => activePermParameters.has(p.id)).length;
            const countEl = document.getElementById(`${category}Count`);
            if (countEl) countEl.textContent = `${count} active`;
        });
    }

    function updatePermStats() {
        document.getElementById('statActive').textContent = activePermParameters.size;
        const combinations = Math.min(Math.pow(10, activePermParameters.size), 1000000);
        document.getElementById('statCombinations').textContent = combinations > 1000000 ? '1M+' : combinations;
    }

    function setPermInputMode(mode) {
        currentPermMode = mode;
        document.querySelectorAll('[data-perm-mode]').forEach(btn => {
            if (btn.dataset.permMode === mode) {
                btn.classList.add('active');
                btn.style.background = 'linear-gradient(135deg, #1e3a8a, #1e40af)';
                btn.style.color = 'white';
            } else {
                btn.classList.remove('active');
                btn.style.background = 'rgba(255, 255, 255, 0.1)';
                btn.style.color = '#60a5fa';
            }
        });
    }

    function selectAllPermParameters() {
        document.querySelectorAll('input[data-param]').forEach(cb => {
            cb.checked = true;
            activePermParameters.add(cb.dataset.param);
        });
        updatePermCategoryCounts();
        updatePermStats();
    }

    function deselectAllPermParameters() {
        document.querySelectorAll('input[data-param]').forEach(cb => cb.checked = false);
        activePermParameters.clear();
        updatePermCategoryCounts();
        updatePermStats();
    }

    function generateAdvancedPermutations() {
        const startTime = Date.now();
        const maxPerms = parseInt(document.getElementById('maxPermutations').value);
        
        // Simple permutation generation for demo
        generatedPermutations = [];
        for (let i = 0; i < Math.min(maxPerms, 100); i++) {
            const perm = {};
            activePermParameters.forEach(paramId => {
                perm[paramId] = Math.random() * 100;
            });
            generatedPermutations.push(perm);
        }
        
        // Update results
        const resultsEl = document.getElementById('permResultsContent');
        let html = '';
        generatedPermutations.forEach((perm, i) => {
            html += `
                <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(96, 165, 250, 0.1); border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
                    <div style="color: #60a5fa; margin-bottom: 0.5rem;">Permutation ${i + 1}</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem;">
                        ${Object.entries(perm).map(([key, val]) => 
                            `<div style="font-size: 0.85rem;"><span style="color: #64748b;">${key}:</span> <span style="color: #2ecc71;">${val.toFixed(2)}</span></div>`
                        ).join('')}
                    </div>
                </div>
            `;
        });
        resultsEl.innerHTML = html || '<div style="text-align: center; padding: 2rem; color: #64748b;">No permutations generated</div>';
        
        // Update stats
        const endTime = Date.now();
        document.getElementById('totalPermutations').textContent = generatedPermutations.length;
        document.getElementById('generatedTime').textContent = new Date().toLocaleTimeString();
        document.getElementById('statTime').textContent = `${endTime - startTime}ms`;
        document.getElementById('statReduction').textContent = '95%';
    }

    function exportPermCSV() {
        if (generatedPermutations.length === 0) {
            alert('No permutations to export');
            return;
        }
        const csv = 'data:text/csv;charset=utf-8,' + Object.keys(generatedPermutations[0]).join(',');
        const link = document.createElement('a');
        link.href = encodeURI(csv);
        link.download = 'permutations.csv';
        link.click();
    }

    function exportPermJSON() {
        if (generatedPermutations.length === 0) {
            alert('No permutations to export');
            return;
        }
        const json = 'data:text/json;charset=utf-8,' + JSON.stringify(generatedPermutations, null, 2);
        const link = document.createElement('a');
        link.href = encodeURI(json);
        link.download = 'permutations.json';
        link.click();
    }

    function loadPermPreset() {
        alert('Loading preset configuration...');
    }

    function savePermPreset() {
        alert('Saving current configuration as preset...');
    }

    function resetPermAll() {
        deselectAllPermParameters();
        generatedPermutations = [];
        document.getElementById('permResultsContent').innerHTML = '<div style="text-align: center; color: #64748b; padding: 3rem;"><i class="fas fa-cube" style="font-size: 3rem; margin-bottom: 1rem;"></i><p>No permutations generated yet</p></div>';
        document.getElementById('totalPermutations').textContent = '0';
        document.getElementById('generatedTime').textContent = '--:--';
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
        initPermutationEngine();
    });
    
    // Timeline View Switcher
    function setTimelineView(view) {
        // Reset all timeline view buttons
        document.querySelectorAll('#timeline-section .btn-secondary').forEach(btn => {
            btn.classList.remove('active');
            btn.style.background = 'rgba(96, 165, 250, 0.1)';
            btn.style.color = '#60a5fa';
        });
        
        // Activate selected view button
        const activeBtn = event.target.closest('button');
        if (activeBtn) {
            activeBtn.classList.add('active');
            activeBtn.style.background = 'linear-gradient(90deg, #60a5fa, #3b82f6)';
            activeBtn.style.color = 'white';
        }
        
        // Here you would implement different view rendering
        console.log('Switching to timeline view:', view);
    }
    
    // Project Management Functions with Drag & Drop
    let projectsData = [];
    let currentEditingProject = null;
    let currentEditingSeries = null;
    let draggedElement = null;
    let draggedIndex = null;
    let ghostPlaceholder = null;
    let originalNextSibling = null;
    let lastValidDropTarget = null;
    let pendingDeleteItem = null;  // For delete confirmation modal
    let pendingDeleteType = null;  // For delete confirmation modal
    let currentDropPosition = null;

    // Current viewing context for projects
    let currentViewingUser = null;
    let allUsersList = [];
    
    // Load users list for admin selector
    async function loadUsersList() {
        // Double-check admin status before making API call
        if (!isAdmin || accountType !== 'admin') {
            return;
        }
        
        try {
            const response = await fetch('/api/admin/users', {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                allUsersList = data.users || [];
                
                // Update the user selector dropdown
                const selector = document.getElementById('user-selector');
                if (selector && allUsersList.length > 0) {
                    // Clear existing options
                    selector.innerHTML = '<option value="">My Projects</option>';
                    selector.innerHTML += '<option value="all" style="color: #fbbf24;">All Users</option>';
                    
                    // Add each user as an option
                    allUsersList.forEach(user => {
                        if (user.email !== userEmail) {
                            const option = document.createElement('option');
                            option.value = user.email;
                            option.textContent = `${user.full_name || user.email} (${user.account_type})`;
                            option.style.color = user.account_type === 'admin' ? '#ef4444' : 
                                               user.account_type === 'internal' ? '#60a5fa' : '#94a3b8';
                            selector.appendChild(option);
                        }
                    });
                }
            } else if (response.status === 403) {
                // Not admin - hide the user selector
                const selector = document.getElementById('user-selector');
                if (selector) {
                    selector.style.display = 'none';
                }
                // This is expected for non-admin users, don't log error
            }
        } catch (error) {
            // Only log unexpected errors, not 403s
            if (!error.message || !error.message.includes('403')) {
                console.error('Error loading users list:', error);
            }
        }
    }
    
    // Load projects for a specific user
    async function loadUserProjects(userEmail) {
        currentViewingUser = userEmail;
        
        // Show loading indicator
        document.getElementById('projects-loading').style.display = 'block';
        document.getElementById('projects-grid').style.display = 'none';
        
        // Hide Add Project button when viewing other users' projects
        const addProjectBtn = document.getElementById('add-project-btn');
        if (addProjectBtn) {
            if (userEmail && userEmail !== '') {
                addProjectBtn.style.display = 'none';
            } else {
                addProjectBtn.style.display = 'block';
            }
        }
        
        try {
            let url = '/api/projects';
            if (userEmail && userEmail !== '' && isAdmin) {
                url += `?user=${encodeURIComponent(userEmail)}`;
            }
            
            const response = await fetch(url, {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                
                // If viewing all users, combine projects with user info
                if (userEmail === 'all') {
                    projectsData = [];
                    for (const user of data.users || []) {
                        if (user.projects && user.projects.length > 0) {
                            user.projects.forEach(project => {
                                project.ownerEmail = user.email;
                                project.ownerName = user.full_name || user.email;
                                project.ownerType = user.account_type;
                                projectsData.push(project);
                            });
                        }
                    }
                } else {
                    projectsData = data.projects || [];
                }
                
                // Update UI
                document.getElementById('projects-loading').style.display = 'none';
                
                if (projectsData.length === 0) {
                    document.getElementById('projects-empty').style.display = 'block';
                    document.getElementById('projects-grid').style.display = 'none';
                    document.getElementById('project-stats').style.display = 'none';
                } else {
                    document.getElementById('projects-empty').style.display = 'none';
                    document.getElementById('projects-grid').style.display = 'grid';
                    document.getElementById('project-stats').style.display = 'grid';
                }
                
                renderProjects();
                updateProjectStats();
                
                // Show notification if viewing another user's projects
                if (userEmail && userEmail !== '' && userEmail !== 'all') {
                    const user = allUsersList.find(u => u.email === userEmail);
                    if (user) {
                        showNotification(`Viewing projects for: ${user.full_name || user.email}`, 'info');
                    }
                } else if (userEmail === 'all') {
                    showNotification(`Viewing all users' projects`, 'info');
                }
            } else {
                console.error('Failed to load projects');
                document.getElementById('projects-loading').style.display = 'none';
                showNotification('Failed to load projects', 'error');
            }
        } catch (error) {
            console.error('Error loading projects:', error);
            document.getElementById('projects-loading').style.display = 'none';
            showNotification('Error loading projects', 'error');
        }
    }
    
    // Show notification helper
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        const bgColor = type === 'error' ? '#ef4444' : 
                       type === 'success' ? '#22c55e' : 
                       type === 'warning' ? '#f59e0b' : '#60a5fa';
        
        notification.style.cssText = `
            position: fixed;
            top: 200px;
            right: 20px;
            background: ${bgColor};
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        `;
        notification.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
    
    // Initialize projects when section becomes visible
    function initializeProjects() {
        loadProjects();
        setupProjectsDragAndDrop();
        
        // Load users list if admin
        if (isAdmin && accountType === 'admin') {
            loadUsersList();
        }
        
        // Setup the main grid as a drop zone for standalone projects
        const gridElement = document.getElementById('projects-grid');
        if (gridElement) {
            gridElement.addEventListener('dragover', function(e) {
                // Check if we're not over a series or project
                if (e.target === gridElement) {
                    handleStandaloneAreaDragOver.call(this, e);
                }
            });
            gridElement.addEventListener('drop', function(e) {
                // Check if we're not over a series or project
                if (e.target === gridElement) {
                    handleStandaloneAreaDrop.call(this, e);
                }
            });
        }
    }

    // Load and display deleted items
    async function loadDeletedItems() {
        try {
            const response = await fetch('/api/deleted-items');
            if (response.ok) {
                const data = await response.json();
                const deletedItems = data.deleted_items || [];
                
                // Update trash badge
                const badge = document.getElementById('deleted-count-badge');
                if (badge) {
                    if (deletedItems.length > 0) {
                        badge.textContent = deletedItems.length;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
                
                // Store deleted items globally
                window.deletedItemsList = deletedItems;
            }
        } catch (error) {
            console.error('Error loading deleted items:', error);
        }
    }
    
    // Show deleted items section
    function showDeletedItems() {
        const section = document.getElementById('deleted-items-section');
        const list = document.getElementById('deleted-items-list');
        const empty = document.getElementById('deleted-items-empty');
        
        if (!section) return;
        
        section.style.display = 'block';
        
        if (window.deletedItemsList && window.deletedItemsList.length > 0) {
            list.innerHTML = '';
            empty.style.display = 'none';
            
            window.deletedItemsList.forEach(item => {
                const card = document.createElement('div');
                card.style.cssText = 'background: #0a0e27; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 1rem;';
                
                const timeRemaining = item.days_remaining > 0 
                    ? `${item.days_remaining}d ${item.hours_remaining}h remaining`
                    : `${item.hours_remaining}h remaining`;
                
                card.innerHTML = `
                    <div style="margin-bottom: 0.75rem;">
                        <h4 style="color: #ef4444; font-size: 1rem; margin: 0 0 0.25rem 0;">
                            ${item.title || item.name || 'Untitled'}
                        </h4>
                        <p style="color: #94a3b8; font-size: 0.75rem; margin: 0;">
                            Deleted ${new Date(item.deleted_at).toLocaleDateString()}
                        </p>
                        <p style="color: #fbbf24; font-size: 0.75rem; margin: 0.25rem 0 0 0;">
                            <i class="fas fa-clock"></i> ${timeRemaining}
                        </p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="restoreItem('${item.id}', '${item.item_type}')" style="flex: 1; background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); padding: 6px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                            <i class="fas fa-undo"></i> Restore
                        </button>
                        <button onclick="permanentlyDelete('${item.id}')" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                            <i class="fas fa-times"></i> Delete
                        </button>
                    </div>
                `;
                
                list.appendChild(card);
            });
        } else {
            list.innerHTML = '';
            empty.style.display = 'block';
        }
    }
    
    // Toggle deleted items visibility
    function toggleDeletedItems() {
        const section = document.getElementById('deleted-items-section');
        const icon = document.getElementById('deleted-toggle-icon');
        
        if (!section) return;
        
        if (section.style.display === 'none') {
            showDeletedItems();
            if (icon) icon.className = 'fas fa-chevron-up';
        } else {
            section.style.display = 'none';
            if (icon) icon.className = 'fas fa-chevron-down';
        }
    }
    
    // Restore item from trash
    async function restoreItem(itemId, itemType) {
        try {
            const response = await fetch('/api/deleted-items/restore', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ item_id: itemId, item_type: itemType })
            });
            
            if (response.ok) {
                // Reload everything
                await loadProjects();
                await loadDeletedItems();
                showDeletedItems(); // Refresh display
            }
        } catch (error) {
            console.error('Error restoring item:', error);
        }
    }
    
    // Permanently delete item
    async function permanentlyDelete(itemId) {
        if (!confirm('Are you sure? This action cannot be undone.')) return;
        
        try {
            const response = await fetch('/api/deleted-items/permanent-delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ item_id: itemId })
            });
            
            if (response.ok) {
                await loadDeletedItems();
                showDeletedItems(); // Refresh display
            }
        } catch (error) {
            console.error('Error permanently deleting item:', error);
        }
    }
    
    // Load projects from API
    async function loadProjects(showLoading = true) {
        const loadingElement = document.getElementById('projects-loading');

        // Store user email if available
        try {
            const userResponse = await fetch('/api/user', {
                credentials: 'include'
            });
            if (userResponse.ok) {
                const userData = await userResponse.json();
                if (userData.email) {
                    localStorage.setItem('userEmail', userData.email);
                }
            }
        } catch (err) {
            // Ignore user fetch errors
        }
        const gridElement = document.getElementById('projects-grid');
        const emptyElement = document.getElementById('projects-empty');
        const statsElement = document.getElementById('project-stats');

        try {
            console.log('Loading projects from API...');
            
            // Only show loading spinner on first load or explicit request
            if (showLoading && loadingElement) {
                loadingElement.style.display = 'block';
                if (gridElement) gridElement.style.display = 'none';
                if (emptyElement) emptyElement.style.display = 'none';
                if (statsElement) statsElement.style.display = 'none';
            }

            // Fetch both series and projects from the backend
            const response = await fetch('/api/series', {
                credentials: 'include'  // Include cookies for session
            });
            
            if (!response.ok) {
                console.error('API response not OK:', response.status);
                throw new Error(`Failed to load data: ${response.status}`);
            }

            const data = await response.json();
            
            // Extract series and projects from response
            if (data.status === 'success') {
                seriesData = data.series || [];
                projectsData = data.projects || [];
            } else {
                // Fallback for old API format
                if (Array.isArray(data)) {
                    projectsData = data;
                    seriesData = [];
                } else if (data && typeof data === 'object') {
                    projectsData = data.projects || [];
                    seriesData = data.series || [];
                } else {
                    projectsData = [];
                    seriesData = [];
                }
            }
            
            // Hide loading smoothly
            if (window.projectsLoadedOnce) {
                loadingElement.style.display = 'none';
            } else {
                // First load - fade out loading
                setTimeout(() => {
                    loadingElement.style.display = 'none';
                }, 100);
            }
            
            // Show empty state only if projects are empty
            if (projectsData.length === 0) {
                emptyElement.style.display = 'block';
            } else {
                gridElement.style.display = 'grid';
                statsElement.style.display = 'grid';
                renderProjects();
                updateProjectStats();
            }
            
            // Mark as loaded
            window.projectsLoadedOnce = true;
            window.lastProjectsLoad = Date.now();
            
        } catch (error) {
            console.error('Error loading data from server:', error);
            if (loadingElement) loadingElement.style.display = 'none';
            
            // Initialize with empty data
            projectsData = [];
            seriesData = [];
            
            // Show empty state if element exists
            if (emptyElement) {
                emptyElement.style.display = 'block';
            }
            if (gridElement) {
                gridElement.style.display = 'none';
            }
            
            // Only show alert for real errors, not on initial load
            if (window.projectsLoadedOnce) {
                alert('Failed to load your projects. Please refresh the page or check your connection.');
            }
        }
    }

    // Series Modal Functions
    
    // Project Edit Modal Functions
    function showProjectEditModal(projectId) {
        const project = findProjectById(projectId);
        if (!project) return;
        
        currentEditingProject = project;
        const modal = document.getElementById('project-edit-modal');
        if (!modal) return;
        
        // Populate form with project data
        const titleInput = document.getElementById('edit-project-title');
        const statusInput = document.getElementById('edit-project-status');
        const descInput = document.getElementById('edit-project-description');
        const valueInput = document.getElementById('edit-project-value');
        const progressInput = document.getElementById('edit-project-progress');
        const detailsInput = document.getElementById('edit-project-details');
        
        // Permutation Engine Fields
        const currencyInput = document.getElementById('edit-project-currency');
        const grossITLoadInput = document.getElementById('edit-project-gross-it-load');
        const pueInput = document.getElementById('edit-project-pue');
        const capexCostInput = document.getElementById('edit-project-capex-cost');
        const capexRateInput = document.getElementById('edit-project-capex-rate');
        const landFeesInput = document.getElementById('edit-project-land-fees');
        const monthlyRentInput = document.getElementById('edit-project-monthly-rent');
        const opexInput = document.getElementById('edit-project-opex');
        
        if (titleInput) titleInput.value = project.title || '';
        if (statusInput) statusInput.value = project.status || 'draft';
        if (descInput) descInput.value = project.description || '';
        if (valueInput) valueInput.value = project.value || 0;
        if (progressInput) progressInput.value = project.progress || 0;
        if (detailsInput) detailsInput.value = project.details || '';
        
        // Populate Permutation Engine Fields
        if (currencyInput) currencyInput.value = project.currency || '';
        if (grossITLoadInput) grossITLoadInput.value = project.grossITLoad || '';
        if (pueInput) pueInput.value = project.pue || '';
        if (capexCostInput) capexCostInput.value = project.capexCost || '';
        if (capexRateInput) capexRateInput.value = project.capexRate || '';
        if (landFeesInput) landFeesInput.value = project.landPurchaseFees || '';
        if (monthlyRentInput) monthlyRentInput.value = project.grossMonthlyRent || '';
        if (opexInput) opexInput.value = project.opex || '';
        
        modal.style.display = 'flex';
    }
    
    function closeProjectEditModal() {
        const modal = document.getElementById('project-edit-modal');
        if (modal) modal.style.display = 'none';
        currentEditingProject = null;
    }

    // New Sponsor Input Modal Functions
    let currentSponsorProjectId = null;
    let sponsorUploadedData = null;

    function showSponsorEditModal(projectId) {
        currentSponsorProjectId = projectId || generateProjectId();
        const project = findProjectById(projectId);
        
        // Update modal to show new sponsor input form
        const modal = document.getElementById('project-edit-modal');
        if (!modal) return;
        
        // Transform the modal content to sponsor input format
        transformToSponsorModal(modal, project);
        modal.style.display = 'flex';
    }

    function transformToSponsorModal(modal, project) {
        // Replace modal content with comprehensive sponsor input form
        const modalContent = modal.querySelector('div');
        modalContent.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 1.5rem; font-weight: 700; margin: 0;">
                    <i class="fas fa-edit"></i> ${project ? 'Edit Project' : 'Create New Project'}
                </h2>
                <button onclick="closeSponsorModal()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                    ×
                </button>
            </div>

            <!-- Tabs -->
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid rgba(96, 165, 250, 0.2);">
                <button type="button" class="sponsor-tab active" onclick="switchSponsorTab('upload')" style="padding: 0.75rem 1rem; background: none; border: none; color: #60a5fa; cursor: pointer;">Upload Template</button>
                <button type="button" class="sponsor-tab" onclick="switchSponsorTab('manual')" style="padding: 0.75rem 1rem; background: none; border: none; color: #94a3b8; cursor: pointer;">Manual Entry</button>
            </div>

            <!-- Upload Tab -->
            <div id="uploadSponsorTab" class="sponsor-tab-content" style="display: block;">
                <div style="border: 2px dashed rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer;" onclick="document.getElementById('sponsorFileInput').click()">
                    <input type="file" id="sponsorFileInput" accept=".xlsx" style="display: none;" onchange="handleSponsorFileSelect(event)">
                    <h3 style="color: #60a5fa;">Upload Sponsor Input Template</h3>
                    <p style="color: #94a3b8;">Drag and drop your Excel file here or click to browse</p>
                    <p style="font-size: 0.875rem; color: #64748b;">Accepts: Project_Sponsor_Input_Template.xlsx</p>
                </div>
                <div id="uploadSponsorPreview" style="display: none; margin-top: 1rem; padding: 1rem; background: #0a0e27; border-radius: 8px;">
                    <h4 style="color: #60a5fa;">Uploaded Data Preview</h4>
                    <div id="sponsorPreviewContent"></div>
                </div>
            </div>

            <!-- Manual Entry Tab -->
            <div id="manualSponsorTab" class="sponsor-tab-content" style="display: none; overflow-y: auto; max-height: 60vh;">
                ${getSponsorManualForm(project)}
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button onclick="closeSponsorModal()" style="background: rgba(75, 85, 99, 0.3); color: #94a3b8; border: 1px solid rgba(75, 85, 99, 0.5); padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                    Cancel
                </button>
                <button onclick="saveSponsorProject()" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    Save Changes
                </button>
            </div>
        `;
    }

    function getSponsorManualForm(project) {
        return `
            <form id="sponsor-form">
                <!-- Project Metadata -->
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: #60a5fa; margin-bottom: 1rem;">Project Metadata</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div>
                            <label style="color: #94a3b8; font-size: 0.9rem;">Project Title *</label>
                            <input type="text" id="sponsor-projectTitle" required value="${project?.title || ''}" style="width: 100%; padding: 10px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: white;">
                        </div>
                        <div>
                            <label style="color: #94a3b8; font-size: 0.9rem;">Location Country *</label>
                            <input type="text" id="sponsor-locationCountry" required value="${project?.location || ''}" style="width: 100%; padding: 10px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: white;">
                        </div>
                        <div>
                            <label style="color: #94a3b8; font-size: 0.9rem;">Status</label>
                            <select id="sponsor-status" style="width: 100%; padding: 10px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: white;">
                                <option value="Draft">Draft</option>
                                <option value="Final">Final</option>
                                <option value="Submitted">Submitted</option>
                            </select>
                        </div>
                        <div>
                            <label style="color: #94a3b8; font-size: 0.9rem;">Currency *</label>
                            <select id="sponsor-currency" required style="width: 100%; padding: 10px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: white;">
                                <option value="EUR">EUR</option>
                                <option value="USD">USD</option>
                                <option value="GBP">GBP</option>
                                <option value="JPY">JPY</option>
                                <option value="AED">AED</option>
                            </select>
                        </div>
                        <div>
                            <label style="color: #94a3b8; font-size: 0.9rem;">Gross IT Load (MW) *</label>
                            <input type="number" id="sponsor-grossITLoadMW" min="0.1" step="0.01" required value="${project?.grossITLoad || ''}" style="width: 100%; padding: 10px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: white;">
                        </div>
                        <div>
                            <label style="color: #94a3b8; font-size: 0.9rem;">PUE *</label>
                            <input type="number" id="sponsor-pue" min="1.0" max="2.5" step="0.01" value="${project?.pue || '1.25'}" required style="width: 100%; padding: 10px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: white;">
                        </div>
                    </div>
                </div>

                <!-- Build (CapEx) -->
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: #60a5fa; margin-bottom: 1rem;">Build (CapEx) - EUR</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div>
                            <label style="color: #94a3b8; font-size: 0.9rem;">Architectural</label>
                            <input type="number" id="sponsor-buildArchitectural" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 10px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: white;">
                        </div>
                        <div>
                            <label style="color: #94a3b8; font-size: 0.9rem;">Civil & Structural</label>
                            <input type="number" id="sponsor-buildCivilStructural" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 10px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: white;">
                        </div>
                        <div>
                            <label style="color: #94a3b8; font-size: 0.9rem;">Substations</label>
                            <input type="number" id="sponsor-buildSubstations" min="0" onchange="calculateSponsorTotals()" style="width: 100%; padding: 10px; background: #0a0e27; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: white;">
                        </div>
                    </div>
                </div>

                <!-- Totals Display -->
                <div style="background: #0a0e27; border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                    <h4 style="color: #60a5fa; margin-bottom: 1rem;">Totals</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #94a3b8;">Build Total</span>
                            <span id="sponsor-buildTotal" style="color: white;">€0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #94a3b8;">Land Total</span>
                            <span id="sponsor-landTotal" style="color: white;">€0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #94a3b8;">Grand Total</span>
                            <span id="sponsor-grandTotal" style="color: #60a5fa; font-weight: bold;">€0</span>
                        </div>
                    </div>
                </div>
            </form>
        `;
    }

    function closeSponsorModal() {
        const modal = document.getElementById('project-edit-modal');
        if (modal) modal.style.display = 'none';
        currentSponsorProjectId = null;
        sponsorUploadedData = null;
    }

    // Formatting helper functions
    function formatCurrencyInput(value, currencyCode = 'EUR') {
        const num = parseFloat(value.toString().replace(/[^0-9.-]/g, '')) || 0;
        const symbol = currencyCode === 'EUR' ? '€' : currencyCode === 'USD' ? '$' : currencyCode === 'GBP' ? '£' : currencyCode;
        return symbol + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    function formatPercentageInput(value) {
        const num = parseFloat(value.toString().replace(/[^0-9.-]/g, '')) || 0;
        return num.toFixed(2) + '%';
    }
    
    function parseCurrencyValue(value) {
        return parseFloat(value.toString().replace(/[^0-9.-]/g, '')) || 0;
    }
    
    function parsePercentageValue(value) {
        return parseFloat(value.toString().replace(/[^0-9.-]/g, '')) || 0;
    }
    
    // Add formatting to currency inputs
    function addCurrencyFormatting(inputId, currencySelectId) {
        const input = document.getElementById(inputId);
        const currencySelect = document.getElementById(currencySelectId);
        
        if (!input) return;
        
        // For gross monthly rent, limit to 0-300
        if (inputId === 'sponsor-grossMonthlyRent') {
            input.addEventListener('input', function() {
                let value = parseFloat(this.value.replace(/[^0-9.]/g, '')) || 0;
                if (value > 300) {
                    this.value = 300;
                    value = 300;
                }
                if (value < 0) {
                    this.value = 0;
                    value = 0;
                }
            });
            
            input.addEventListener('blur', function() {
                let value = parseFloat(this.value) || 0;
                if (value > 0) {
                    const currency = currencySelect ? currencySelect.value : 'EUR';
                    const symbol = currency === 'EUR' ? '€' : currency === 'USD' ? '$' : currency === 'GBP' ? '£' : '';
                    this.value = symbol + value.toFixed(2);
                }
            });
            
            input.addEventListener('focus', function() {
                this.value = parseCurrencyValue(this.value);
            });
            return;
        }
        
        // For Cost per MW fields (limit to 0-25M)
        if (inputId === 'sponsor-capexInternalPerMW' || inputId === 'sponsor-capexMarketPerMW') {
            input.addEventListener('focus', function() {
                this.value = parseCurrencyValue(this.value);
            });
            
            input.addEventListener('blur', function() {
                let value = parseCurrencyValue(this.value);
                if (value > 25000000) value = 25000000;
                if (value < 0) value = 0;
                
                if (value > 0) {
                    const currency = currencySelect ? currencySelect.value : 'EUR';
                    const symbol = currency === 'EUR' ? '€' : currency === 'USD' ? '$' : currency === 'GBP' ? '£' : '';
                    this.value = symbol + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }
            });
            
            input.addEventListener('input', function() {
                let value = parseCurrencyValue(this.value);
                if (value > 25000000) {
                    this.value = '25000000';
                }
            });
            return;
        }
        
        // For Land Purchase (limit to 1B)
        if (inputId === 'sponsor-landPurchase') {
            input.addEventListener('focus', function() {
                this.value = parseCurrencyValue(this.value);
            });
            
            input.addEventListener('blur', function() {
                let value = parseCurrencyValue(this.value);
                if (value > 1000000000) value = 1000000000;
                if (value < 0) value = 0;
                
                if (value > 0) {
                    const currency = currencySelect ? currencySelect.value : 'EUR';
                    const symbol = currency === 'EUR' ? '€' : currency === 'USD' ? '$' : currency === 'GBP' ? '£' : '';
                    this.value = symbol + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }
            });
            return;
        }
        
        // For other currency fields
        let rawValue = '';
        
        input.addEventListener('focus', function() {
            this.value = rawValue || parseCurrencyValue(this.value);
        });
        
        input.addEventListener('blur', function() {
            rawValue = parseCurrencyValue(this.value);
            if (rawValue > 0) {
                const currency = currencySelect ? currencySelect.value : 'EUR';
                const symbol = currency === 'EUR' ? '€' : currency === 'USD' ? '$' : currency === 'GBP' ? '£' : '';
                this.value = symbol + rawValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
        });
        
        input.addEventListener('input', function() {
            rawValue = parseCurrencyValue(this.value);
        });
    }
    
    // Add formatting to percentage inputs
    function addPercentageFormatting(inputId) {
        const input = document.getElementById(inputId);
        if (!input) return;
        
        // For OPEX percent, limit to 0-100 and format as %
        if (inputId === 'sponsor-opexPercent') {
            input.addEventListener('input', function() {
                // Remove any non-numeric characters except decimal point
                let value = this.value.replace(/[^0-9.]/g, '');
                let numValue = parseFloat(value) || 0;
                
                // Limit to 0-100
                if (numValue > 100) {
                    numValue = 100;
                }
                if (numValue < 0) {
                    numValue = 0;
                }
                
                this.value = numValue || '';
            });
            
            input.addEventListener('blur', function() {
                // Add % sign on blur
                let value = parseFloat(this.value) || 0;
                if (value > 0) {
                    this.value = value + '%';
                }
            });
            
            input.addEventListener('focus', function() {
                // Remove % sign on focus
                this.value = this.value.replace('%', '');
            });
            return;
        }
        
        // For Stamp Duty percent, limit to 0-20 and format as %
        if (inputId === 'sponsor-stampDutyPercent') {
            input.addEventListener('input', function() {
                let value = this.value.replace(/[^0-9.]/g, '');
                let numValue = parseFloat(value) || 0;
                
                // Limit to 0-20
                if (numValue > 20) {
                    numValue = 20;
                }
                if (numValue < 0) {
                    numValue = 0;
                }
                
                this.value = numValue || '';
            });
            
            input.addEventListener('blur', function() {
                let value = parseFloat(this.value) || 0;
                if (value > 0) {
                    this.value = value + '%';
                }
            });
            
            input.addEventListener('focus', function() {
                this.value = this.value.replace('%', '');
            });
            return;
        }
        
        // For other percentage fields
        let rawValue = '';
        
        input.addEventListener('focus', function() {
            this.value = rawValue || parsePercentageValue(this.value);
        });
        
        input.addEventListener('blur', function() {
            rawValue = parsePercentageValue(this.value);
            if (rawValue >= 0) {
                this.value = rawValue + '%';
            }
        });
        
        input.addEventListener('input', function() {
            rawValue = parsePercentageValue(this.value);
        });
    }
    
    // Format date consistently
    function formatDateDisplay(dateValue) {
        if (!dateValue) return '';
        const date = new Date(dateValue + '-01'); // Add day for month input
        return date.toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
    }
    
    // Update currency displays and initialize CapEx functionality
    document.addEventListener('DOMContentLoaded', function() {
        const kwhCurrencySelect = document.getElementById('sponsor-kwh-currency');
        const kwhCurrencyDisplay = document.getElementById('sponsor-kwh-currency-display');
        const capexCurrencySelect = document.getElementById('sponsor-capex-currency');
        
        if (kwhCurrencySelect && kwhCurrencyDisplay) {
            kwhCurrencySelect.addEventListener('change', function() {
                kwhCurrencyDisplay.textContent = this.value;
                // Re-format gross monthly rent when currency changes
                const rentInput = document.getElementById('sponsor-grossMonthlyRent');
                if (rentInput && rentInput.value) {
                    const rawValue = parseCurrencyValue(rentInput.value);
                    if (rawValue > 0) {
                        rentInput.value = formatCurrencyInput(rawValue, this.value);
                    }
                }
            });
        }
        
        // Update CapEx currency displays
        if (capexCurrencySelect) {
            capexCurrencySelect.addEventListener('change', function() {
                const currency = this.value;
                const internalCurrencySpan = document.getElementById('capex-internal-currency');
                const marketCurrencySpan = document.getElementById('capex-market-currency');
                if (internalCurrencySpan) internalCurrencySpan.textContent = currency;
                if (marketCurrencySpan) marketCurrencySpan.textContent = currency;
                
                // Re-format all CapEx fields when currency changes
                const capexFields = [
                    'sponsor-capexInternalPerMW', 'sponsor-capexMarketPerMW',
                    'sponsor-buildArchitectural', 'sponsor-buildCivilStructural',
                    'sponsor-buildSubstations', 'sponsor-buildUndergroundUtilities',
                    'sponsor-buildCrusaderModules', 'sponsor-buildBess',
                    'sponsor-buildMainContractorInstallation', 'sponsor-buildPhotovoltaicSystem',
                    'sponsor-buildLandscaping', 'sponsor-buildPreliminariesGeneral',
                    'sponsor-buildMainContractorMargin'
                ];
                
                capexFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field && field.value) {
                        const rawValue = parseCurrencyValue(field.value);
                        if (rawValue > 0) {
                            field.value = formatCurrencyInput(rawValue, currency);
                        }
                    }
                });
            });
        }
        
        // Update land and fees currency displays
        if (capexCurrencySelect) {
            capexCurrencySelect.addEventListener('change', function() {
                const landCurrencySpan = document.getElementById('land-currency');
                const feesCurrencySpan = document.getElementById('fees-currency');
                if (landCurrencySpan) landCurrencySpan.textContent = this.value;
                if (feesCurrencySpan) feesCurrencySpan.textContent = this.value;
            });
        }
        
        // Apply formatting to currency fields
        addCurrencyFormatting('sponsor-grossMonthlyRent', 'sponsor-kwh-currency');
        addCurrencyFormatting('sponsor-capexInternalPerMW', 'sponsor-capex-currency');
        addCurrencyFormatting('sponsor-capexMarketPerMW', 'sponsor-capex-currency');
        
        // Apply formatting to land & infrastructure fields
        addCurrencyFormatting('sponsor-landPurchase', 'sponsor-capex-currency');
        addCurrencyFormatting('sponsor-gridConnectionCosts', 'sponsor-capex-currency');
        addCurrencyFormatting('sponsor-stampDutyFixed', 'sponsor-capex-currency');
        
        // Apply formatting to fees fields
        addCurrencyFormatting('sponsor-feesDM', 'sponsor-capex-currency');
        addCurrencyFormatting('sponsor-feesManagement', 'sponsor-capex-currency');
        
        // Apply formatting to all build/capex fields
        const capexFields = [
            'sponsor-buildArchitectural', 'sponsor-buildCivilStructural',
            'sponsor-buildSubstations', 'sponsor-buildUndergroundUtilities',
            'sponsor-buildCrusaderModules', 'sponsor-buildBess',
            'sponsor-buildMainContractorInstallation', 'sponsor-buildPhotovoltaicSystem',
            'sponsor-buildLandscaping', 'sponsor-buildPreliminariesGeneral',
            'sponsor-buildMainContractorMargin',
            'sponsor-marketArchitectural', 'sponsor-marketCivilStructural',
            'sponsor-marketSubstations', 'sponsor-marketUndergroundUtilities',
            'sponsor-marketCrusaderModules', 'sponsor-marketBess',
            'sponsor-marketMainContractorInstallation', 'sponsor-marketPhotovoltaicSystem',
            'sponsor-marketLandscaping', 'sponsor-marketPreliminariesGeneral',
            'sponsor-marketMainContractorMargin'
        ];
        
        capexFields.forEach(fieldId => {
            addCurrencyFormatting(fieldId, 'sponsor-capex-currency');
            
            // Add event listener to trigger calculation and override
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('input', function() {
                    calculateSponsorTotals();
                });
                field.addEventListener('blur', function() {
                    calculateSponsorTotals();
                });
            }
        });
        
        // Apply formatting to percentage fields
        addPercentageFormatting('sponsor-opexPercent');
        addPercentageFormatting('sponsor-stampDutyPercent');
        addPercentageFormatting('sponsor-contingencyPercent');
        
        // Update MW displays when gross IT load changes
        const grossITLoadInput = document.getElementById('sponsor-grossITLoadMW');
        if (grossITLoadInput) {
            grossITLoadInput.addEventListener('input', function() {
                const mw = parseFloat(this.value) || 0;
                const internalMWSpan = document.getElementById('capex-internal-mw');
                const marketMWSpan = document.getElementById('capex-market-mw');
                if (internalMWSpan) internalMWSpan.textContent = mw.toFixed(2);
                if (marketMWSpan) marketMWSpan.textContent = mw.toFixed(2);
                
                // Recalculate totals including override logic
                calculateSponsorTotals();
                
                // Recalculate per MW totals if per MW costs are entered
                calculateCapexFromPerMW('internal');
                calculateCapexFromPerMW('market');
            });
        }
        
        // Format construction date display
        const constructionStartInput = document.getElementById('sponsor-constructionStart');
        if (constructionStartInput) {
            // Set min date to today
            const today = new Date();
            const dd = String(today.getDate()).padStart(2, '0');
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const yyyy = today.getFullYear();
            constructionStartInput.min = `${yyyy}-${mm}-${dd}`;
            
            // Set max date to 3 years from today
            const maxDate = new Date();
            maxDate.setFullYear(maxDate.getFullYear() + 3);
            const maxDd = String(maxDate.getDate()).padStart(2, '0');
            const maxMm = String(maxDate.getMonth() + 1).padStart(2, '0');
            const maxYyyy = maxDate.getFullYear();
            constructionStartInput.max = `${maxYyyy}-${maxMm}-${maxDd}`;
            
            // Set default construction start date to next January if not set
            if (!constructionStartInput.value) {
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth();
                
                // If we're past January, use next year's January, otherwise use this year's January
                const targetYear = currentMonth >= 0 ? currentYear + 1 : currentYear;
                const defaultDate = `${targetYear}-01`;
                constructionStartInput.value = defaultDate;
                
                // Set min to current month and max to 24 months from now
                const minDate = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const maxYear = currentYear + 2;
                const maxDate = `${maxYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                
                constructionStartInput.min = minDate;
                constructionStartInput.max = maxDate;
            }
            
            // Add label to show formatted date
            constructionStartInput.addEventListener('change', function() {
                const formattedDate = formatDateDisplay(this.value);
                // Update a display label if needed
                const label = this.parentElement.querySelector('.date-display');
                if (label) {
                    label.textContent = formattedDate;
                }
            });
        }
    });
    
    function toggleCapexDetails(type) {
        const detailsDiv = document.getElementById(`capex-${type}-details`);
        const chevron = document.getElementById(`capex-${type}-chevron`);
        
        if (detailsDiv) {
            if (detailsDiv.style.display === 'none' || detailsDiv.style.display === '') {
                detailsDiv.style.display = 'grid';
                if (chevron) {
                    chevron.classList.remove('fa-chevron-down');
                    chevron.classList.add('fa-chevron-up');
                }
            } else {
                detailsDiv.style.display = 'none';
                if (chevron) {
                    chevron.classList.remove('fa-chevron-up');
                    chevron.classList.add('fa-chevron-down');
                }
            }
        }
    }
    
    function calculateCapexFromPerMW(type) {
        const perMWInput = document.getElementById(`sponsor-capex${type === 'internal' ? 'Internal' : 'Market'}PerMW`);
        const mwValue = parseFloat(document.getElementById('sponsor-grossITLoadMW')?.value) || 0;
        const totalSpan = document.getElementById(`capex-${type}-permw-total`);
        const currency = document.getElementById('sponsor-capex-currency')?.value || 'EUR';
        
        if (perMWInput && totalSpan) {
            const perMWCost = parseFloat(perMWInput.value) || 0;
            const total = perMWCost * mwValue;
            
            const currencySymbol = currency === 'EUR' ? '€' : currency === 'USD' ? '$' : currency === 'GBP' ? '£' : currency;
            totalSpan.textContent = currencySymbol + total.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        }
        
        calculateSponsorTotals();
    }
    
    function switchSponsorTab(tabName) {
        // Switch tabs
        const tabs = document.querySelectorAll('.sponsor-tab');
        const indicator = document.querySelector('.sponsor-tab-indicator');
        
        tabs.forEach(tab => {
            tab.classList.remove('active');
            tab.style.color = '#94a3b8';
        });
        
        document.querySelectorAll('.sponsor-tab-content').forEach(content => {
            content.style.display = 'none';
        });

        if (tabName === 'upload') {
            // Move indicator to first tab
            if (indicator && tabs[0]) {
                indicator.style.left = '0';
                indicator.style.width = tabs[0].offsetWidth + 'px';
            }
            tabs[0].classList.add('active');
            tabs[0].style.color = '#60a5fa';
            document.getElementById('uploadSponsorTab').style.display = 'block';
        } else {
            // Move indicator to second tab
            if (indicator && tabs[1]) {
                indicator.style.left = tabs[0].offsetWidth + 32 + 'px'; // 32px is the gap (2rem)
                indicator.style.width = tabs[1].offsetWidth + 'px';
            }
            tabs[1].classList.add('active');
            tabs[1].style.color = '#60a5fa';
            document.getElementById('manualSponsorTab').style.display = 'block';
        }
    }

    function calculateSponsorTotals() {
        // Check if sponsor editor is visible
        const sponsorEditor = document.getElementById('sponsor-editor-section');
        if (!sponsorEditor || sponsorEditor.style.display === 'none') {
            return; // Don't calculate if editor is not visible
        }
        
        // Calculate build total from internal fields
        const internalBuildFields = [
            'buildArchitectural', 'buildCivilStructural', 'buildSubstations',
            'buildUndergroundUtilities', 'buildCrusaderModules', 'buildBess',
            'buildMainContractorInstallation', 'buildPhotovoltaicSystem',
            'buildLandscaping', 'buildPreliminariesGeneral', 'buildMainContractorMargin'
        ];
        let internalBuildTotal = 0;
        let hasInternalBuildValues = false;
        
        internalBuildFields.forEach(field => {
            const element = document.getElementById('sponsor-' + field);
            if (element) {
                const value = parseCurrencyValue(element.value);
                if (value > 0) {
                    hasInternalBuildValues = true;
                    internalBuildTotal += value;
                }
            }
        });
        
        // Calculate build total from market fields
        const marketBuildFields = [
            'marketArchitectural', 'marketCivilStructural', 'marketSubstations',
            'marketUndergroundUtilities', 'marketCrusaderModules', 'marketBess',
            'marketMainContractorInstallation', 'marketPhotovoltaicSystem',
            'marketLandscaping', 'marketPreliminariesGeneral', 'marketMainContractorMargin'
        ];
        let marketBuildTotal = 0;
        let hasMarketBuildValues = false;
        
        marketBuildFields.forEach(field => {
            const element = document.getElementById('sponsor-' + field);
            if (element) {
                const value = parseCurrencyValue(element.value);
                if (value > 0) {
                    hasMarketBuildValues = true;
                    marketBuildTotal += value;
                }
            }
        });
        
        // Get MW value
        const mwValue = parseFloat(document.getElementById('sponsor-grossITLoadMW')?.value) || 0;
        const currency = document.getElementById('sponsor-capex-currency')?.value || 'EUR';
        
        // Override Internal Cost per MW if individual build fields are filled
        if (hasInternalBuildValues && mwValue > 0) {
            const internalPerMW = internalBuildTotal / mwValue;
            const internalPerMWInput = document.getElementById('sponsor-capexInternalPerMW');
            if (internalPerMWInput) {
                internalPerMWInput.value = formatCurrencyInput(internalPerMW, currency);
                internalPerMWInput.disabled = true; // Disable when override is active
                // Add visual indicator that it's calculated
                internalPerMWInput.style.backgroundColor = 'rgba(96, 165, 250, 0.1)';
                internalPerMWInput.title = 'Auto-calculated from individual build fields';
            }
            
            // Update the total display
            const internalTotalSpan = document.getElementById('capex-internal-permw-total');
            if (internalTotalSpan) {
                const currencySymbol = currency === 'EUR' ? '€' : currency === 'USD' ? '$' : currency === 'GBP' ? '£' : '';
                internalTotalSpan.textContent = currencySymbol + internalBuildTotal.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
            }
        } else {
            // Re-enable the input if no individual fields are filled
            const internalPerMWInput = document.getElementById('sponsor-capexInternalPerMW');
            if (internalPerMWInput) {
                internalPerMWInput.disabled = false;
                internalPerMWInput.style.backgroundColor = '#0a0e27';
                internalPerMWInput.title = '';
            }
        }
        
        // Override Market Cost per MW if individual build fields are filled
        if (hasMarketBuildValues && mwValue > 0) {
            const marketPerMW = marketBuildTotal / mwValue;
            const marketPerMWInput = document.getElementById('sponsor-capexMarketPerMW');
            if (marketPerMWInput) {
                marketPerMWInput.value = formatCurrencyInput(marketPerMW, currency);
                marketPerMWInput.disabled = true; // Disable when override is active
                // Add visual indicator that it's calculated
                marketPerMWInput.style.backgroundColor = 'rgba(96, 165, 250, 0.1)';
                marketPerMWInput.title = 'Auto-calculated from individual build fields';
            }
            
            // Update the total display
            const marketTotalSpan = document.getElementById('capex-market-permw-total');
            if (marketTotalSpan) {
                const currencySymbol = currency === 'EUR' ? '€' : currency === 'USD' ? '$' : currency === 'GBP' ? '£' : '';
                marketTotalSpan.textContent = currencySymbol + marketBuildTotal.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
            }
        } else {
            // Re-enable the input if no individual fields are filled
            const marketPerMWInput = document.getElementById('sponsor-capexMarketPerMW');
            if (marketPerMWInput) {
                marketPerMWInput.disabled = false;
                marketPerMWInput.style.backgroundColor = '#0a0e27';
                marketPerMWInput.title = '';
            }
        }
        
        // Use internal build total for remaining calculations
        let buildTotal = hasInternalBuildValues ? internalBuildTotal : 0;
        
        // If no internal build fields but per MW is set, calculate from that
        if (!hasInternalBuildValues) {
            const internalPerMW = parseCurrencyValue(document.getElementById('sponsor-capexInternalPerMW')?.value) || 0;
            if (internalPerMW > 0 && mwValue > 0) {
                buildTotal = internalPerMW * mwValue;
            }
        }

        // Calculate land total
        const landPurchase = parseCurrencyValue(document.getElementById('sponsor-landPurchase')?.value) || 0;
        const gridConnection = parseCurrencyValue(document.getElementById('sponsor-gridConnectionCosts')?.value) || 0;
        
        // Calculate stamp duty
        let stampDuty = 0;
        const stampDutyFixed = parseCurrencyValue(document.getElementById('sponsor-stampDutyFixed')?.value) || 0;
        if (stampDutyFixed > 0) {
            stampDuty = stampDutyFixed;
        } else {
            const stampDutyPercentValue = document.getElementById('sponsor-stampDutyPercent')?.value || '0';
            const stampDutyPercent = parseFloat(stampDutyPercentValue.replace('%', '')) / 100 || 0;
            stampDuty = stampDutyPercent * landPurchase;
        }
        
        const landTotal = landPurchase + gridConnection + stampDuty;

        // Calculate contingency percentage first
        const contingencyPercentValue = document.getElementById('sponsor-contingencyPercent')?.value || '0';
        const contingencyPercent = parseFloat(contingencyPercentValue.replace('%', '')) / 100 || 0;
        
        // Calculate Internal CapEx with contingency
        const internalCapexBase = hasInternalBuildValues ? internalBuildTotal : (parseCurrencyValue(document.getElementById('sponsor-capexInternalPerMW')?.value) || 0) * mwValue;
        const internalCapexContingency = internalCapexBase * contingencyPercent;
        const internalCapexTotal = internalCapexBase + internalCapexContingency;
        
        // Calculate Market CapEx with contingency  
        const marketCapexBase = hasMarketBuildValues ? marketBuildTotal : (parseCurrencyValue(document.getElementById('sponsor-capexMarketPerMW')?.value) || 0) * mwValue;
        const marketCapexContingency = marketCapexBase * contingencyPercent;
        const marketCapexTotal = marketCapexBase + marketCapexContingency;


        // Calculate fees total
        const feesDM = parseCurrencyValue(document.getElementById('sponsor-feesDM')?.value) || 0;
        
        // Calculate Management 3% based on total build costs (without contingency)
        const managementFeeBase = internalCapexBase + landPurchase + gridConnection;
        const managementFee = managementFeeBase * 0.03;
        
        // Update Management 3% display
        const managementFeeInput = document.getElementById('sponsor-feesManagement');
        if (managementFeeInput) {
            managementFeeInput.value = formatCurrencyInput(managementFee, currency);
        }
        
        const feesTotal = feesDM + managementFee;

        // Calculate grand total (using internal capex for the total)
        const grandTotal = internalCapexTotal + landTotal + feesTotal;

        // Update display with null checks
        const capexInternalTotalEl = document.getElementById('sponsor-capexInternalTotal');
        const capexMarketTotalEl = document.getElementById('sponsor-capexMarketTotal');
        const landTotalEl = document.getElementById('sponsor-landTotal');
        const feesTotalEl = document.getElementById('sponsor-feesTotal');
        const grandTotalEl = document.getElementById('sponsor-grandTotal');
        
        const currencySymbol = currency === 'EUR' ? '€' : currency === 'USD' ? '$' : currency === 'GBP' ? '£' : '';
        
        if (capexInternalTotalEl) capexInternalTotalEl.textContent = currencySymbol + internalCapexTotal.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        if (capexMarketTotalEl) capexMarketTotalEl.textContent = currencySymbol + marketCapexTotal.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        if (landTotalEl) landTotalEl.textContent = currencySymbol + landTotal.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        if (feesTotalEl) feesTotalEl.textContent = currencySymbol + feesTotal.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        if (grandTotalEl) grandTotalEl.textContent = currencySymbol + grandTotal.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
    }

    async function handleSponsorFileSelect(event) {
        const file = event.target.files[0];
        if (!file || !file.name.endsWith('.xlsx')) {
            alert('Please upload an Excel (.xlsx) file');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch(`/api/projects/${currentSponsorProjectId}/upload`, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            if (data.success) {
                sponsorUploadedData = data.parsed;
                displaySponsorUploadPreview();
            } else {
                alert(data.message);
            }
        } catch (error) {
            console.error('Upload error:', error);
            alert('Failed to upload file');
        }
    }

    function displaySponsorUploadPreview() {
        if (!sponsorUploadedData) return;

        const preview = document.getElementById('uploadSponsorPreview');
        const content = document.getElementById('sponsorPreviewContent');

        content.innerHTML = `
            <div style="display: grid; gap: 0.5rem;">
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: #94a3b8;">Project Title</span>
                    <span style="color: white;">${sponsorUploadedData.meta.projectTitle || 'Not set'}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: #94a3b8;">Location</span>
                    <span style="color: white;">${sponsorUploadedData.meta.locationCountry || 'Not set'}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: #94a3b8;">IT Load</span>
                    <span style="color: white;">${sponsorUploadedData.meta.grossITLoadMW} MW</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: #94a3b8;">Grand Total</span>
                    <span style="color: #60a5fa; font-weight: bold;">€${(sponsorUploadedData.rollups.grandTotalEUR || 0).toLocaleString()}</span>
                </div>
            </div>
        `;

        preview.style.display = 'block';
    }

    async function saveSponsorProject() {
        let projectData;

        if (sponsorUploadedData) {
            projectData = sponsorUploadedData;
        } else {
            // Collect from manual form - parse formatted values
            projectData = {
                meta: {
                    projectTitle: document.getElementById('sponsor-projectTitle').value,
                    locationCountry: document.getElementById('sponsor-locationCountry').value,
                    status: document.getElementById('sponsor-status').value,
                    capexCurrency: document.getElementById('sponsor-capex-currency').value,
                    kwhCurrency: document.getElementById('sponsor-kwh-currency').value,
                    grossITLoadMW: parseFloat(document.getElementById('sponsor-grossITLoadMW').value) || 0,
                    pue: parseFloat(document.getElementById('sponsor-pue').value) || 1.25,
                    grossMonthlyRent: parseCurrencyValue(document.getElementById('sponsor-grossMonthlyRent').value) || 0,
                    opexPercent: parsePercentageValue(document.getElementById('sponsor-opexPercent').value) || 0,
                    constructionStart: document.getElementById('sponsor-constructionStart').value,
                    constructionDurationMonths: parseInt(document.getElementById('sponsor-constructionDurationMonths').value) || 0
                },
                capex: {
                    internal: {
                        perMW: parseCurrencyValue(document.getElementById('sponsor-capexInternalPerMW')?.value) || 0,
                        architectural: parseCurrencyValue(document.getElementById('sponsor-buildArchitectural')?.value) || 0,
                        civilStructural: parseCurrencyValue(document.getElementById('sponsor-buildCivilStructural')?.value) || 0,
                        substations: parseCurrencyValue(document.getElementById('sponsor-buildSubstations')?.value) || 0,
                        undergroundUtilities: parseCurrencyValue(document.getElementById('sponsor-buildUndergroundUtilities')?.value) || 0,
                        crusaderModules: parseCurrencyValue(document.getElementById('sponsor-buildCrusaderModules')?.value) || 0,
                        bess: parseCurrencyValue(document.getElementById('sponsor-buildBess')?.value) || 0,
                        mainContractorInstallation: parseCurrencyValue(document.getElementById('sponsor-buildMainContractorInstallation')?.value) || 0,
                        photovoltaicSystem: parseCurrencyValue(document.getElementById('sponsor-buildPhotovoltaicSystem')?.value) || 0,
                        landscaping: parseCurrencyValue(document.getElementById('sponsor-buildLandscaping')?.value) || 0,
                        preliminariesGeneral: parseCurrencyValue(document.getElementById('sponsor-buildPreliminariesGeneral')?.value) || 0,
                        mainContractorMargin: parseCurrencyValue(document.getElementById('sponsor-buildMainContractorMargin')?.value) || 0
                    },
                    market: {
                        perMW: parseCurrencyValue(document.getElementById('sponsor-capexMarketPerMW')?.value) || 0,
                        architectural: parseCurrencyValue(document.getElementById('sponsor-marketArchitectural')?.value) || 0,
                        civilStructural: parseCurrencyValue(document.getElementById('sponsor-marketCivilStructural')?.value) || 0,
                        substations: parseCurrencyValue(document.getElementById('sponsor-marketSubstations')?.value) || 0,
                        undergroundUtilities: parseCurrencyValue(document.getElementById('sponsor-marketUndergroundUtilities')?.value) || 0,
                        crusaderModules: parseCurrencyValue(document.getElementById('sponsor-marketCrusaderModules')?.value) || 0,
                        bess: parseCurrencyValue(document.getElementById('sponsor-marketBess')?.value) || 0,
                        mainContractorInstallation: parseCurrencyValue(document.getElementById('sponsor-marketMainContractorInstallation')?.value) || 0,
                        photovoltaicSystem: parseCurrencyValue(document.getElementById('sponsor-marketPhotovoltaicSystem')?.value) || 0,
                        landscaping: parseCurrencyValue(document.getElementById('sponsor-marketLandscaping')?.value) || 0,
                        preliminariesGeneral: parseCurrencyValue(document.getElementById('sponsor-marketPreliminariesGeneral')?.value) || 0,
                        mainContractorMargin: parseCurrencyValue(document.getElementById('sponsor-marketMainContractorMargin')?.value) || 0
                    }
                },
                rollups: {
                    capexCostPriceEUR: 0,
                    grandTotalEUR: 0
                }
            };
        }

        // Save to projects array
        const existingIndex = projectsData.findIndex(p => p.id === currentSponsorProjectId);
        const project = {
            id: currentSponsorProjectId,
            title: projectData.meta.projectTitle,
            location: projectData.meta.locationCountry,
            status: projectData.meta.status?.toLowerCase() || 'draft',
            currency: projectData.meta.currency,
            grossITLoad: projectData.meta.grossITLoadMW,
            pue: projectData.meta.pue,
            value: projectData.rollups.grandTotalEUR || 0,
            ...projectData
        };

        if (existingIndex >= 0) {
            projectsData[existingIndex] = project;
        } else {
            projectsData.push(project);
        }

        renderProjects();
        closeSponsorModal();
        await saveProjects();
    }

    function generateProjectId() {
        return 'proj_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    function saveProjectEdit(event) {
        event.preventDefault();
        
        if (!currentEditingProject) return;
        
        // Update project data
        currentEditingProject.title = document.getElementById('edit-project-title').value;
        currentEditingProject.status = document.getElementById('edit-project-status').value;
        currentEditingProject.description = document.getElementById('edit-project-description').value;
        currentEditingProject.value = parseInt(document.getElementById('edit-project-value').value || 0);
        currentEditingProject.progress = parseInt(document.getElementById('edit-project-progress').value || 0);
        currentEditingProject.details = document.getElementById('edit-project-details').value;
        
        // Update Permutation Engine Fields
        currentEditingProject.currency = document.getElementById('edit-project-currency').value;
        currentEditingProject.grossITLoad = parseFloat(document.getElementById('edit-project-gross-it-load').value) || null;
        currentEditingProject.pue = parseFloat(document.getElementById('edit-project-pue').value) || null;
        currentEditingProject.capexCost = parseFloat(document.getElementById('edit-project-capex-cost').value) || null;
        currentEditingProject.capexRate = parseFloat(document.getElementById('edit-project-capex-rate').value) || null;
        currentEditingProject.landPurchaseFees = parseFloat(document.getElementById('edit-project-land-fees').value) || null;
        currentEditingProject.grossMonthlyRent = parseFloat(document.getElementById('edit-project-monthly-rent').value) || null;
        currentEditingProject.opex = parseFloat(document.getElementById('edit-project-opex').value) || null;
        
        closeProjectEditModal();
        renderProjects();
        updateProjectStats();
        saveSeriesData();
    }
    
    // Helper function to find project by ID
    function findProjectById(projectId) {
        // Search in standalone projects
        let project = projectsData.find(p => p.id === projectId);
        if (project) return project;
        
        // Project not found
        return null;
    }
    
    
    // Variables for delete confirmation
    // let pendingDeleteItem = null;  // Temporarily commented
    // let pendingDeleteType = null;   // Temporarily commented
    
    // Delete project with confirmation modal
    function deleteProject(projectId) {
        pendingDeleteItem = { id: projectId };
        pendingDeleteType = 'project';
        
        const modal = document.getElementById('delete-confirm-modal');
        const message = document.getElementById('delete-confirm-message');
        message.textContent = 'Are you sure you want to delete this project? This action cannot be undone.';
        modal.style.display = 'flex';
    }
    
    // Delete series with confirmation
    function deleteSeries(seriesId) {
        const series = seriesData.find(s => s.id === seriesId);
        if (!series) return;
        
        if (series.projects && series.projects.length > 0) {
            pendingDeleteItem = { id: seriesId };
            pendingDeleteType = 'series';
            
            const modal = document.getElementById('delete-confirm-modal');
            const message = document.getElementById('delete-confirm-message');
            message.textContent = `Are you sure you want to delete this series? It contains ${series.projects.length} project(s). This action cannot be undone.`;
            modal.style.display = 'flex';
        } else {
            pendingDeleteItem = { id: seriesId };
            pendingDeleteType = 'series';
            
            const modal = document.getElementById('delete-confirm-modal');
            const message = document.getElementById('delete-confirm-message');
            message.textContent = 'Are you sure you want to delete this series? This action cannot be undone.';
            modal.style.display = 'flex';
        }
    }
    
    // Cancel delete
    function cancelDelete() {
        const modal = document.getElementById('delete-confirm-modal');
        modal.style.display = 'none';
        pendingDeleteItem = null;
        pendingDeleteType = null;
    }
    
    // Toggle Trash Section
    async function toggleTrashSection() {
        const trashSection = document.getElementById('trash-section');
        if (!trashSection) return;

        if (trashSection.style.display === 'none') {
            // Show trash section and load items
            trashSection.style.display = 'block';
            await loadTrashItems();
        } else {
            // Hide trash section
            trashSection.style.display = 'none';
        }
    }

    // Empty Trash - Delete all items permanently
    async function emptyTrash() {
        if (!confirm('⚠️ WARNING: This will permanently delete ALL items in trash. This cannot be undone!\n\nAre you absolutely sure?')) {
            return;
        }

        try {
            const response = await fetch('/api/trash/empty', {
                method: 'DELETE',
                credentials: 'include'
            });

            const result = await response.json();

            if (result.status === 'success') {
                showNotification('All items permanently deleted from trash', 'success');
                await loadTrashItems();  // Reload to show empty state
            } else {
                showNotification('Failed to empty trash: ' + (result.message || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Error emptying trash:', error);
            showNotification('Error emptying trash', 'error');
        }
    }

    // Load Trash Items
    async function loadTrashItems() {
        const loadingEl = document.getElementById('trash-loading');
        const gridEl = document.getElementById('trash-grid');
        const emptyEl = document.getElementById('trash-empty');

        if (loadingEl) loadingEl.style.display = 'block';
        if (gridEl) gridEl.style.display = 'none';
        if (emptyEl) emptyEl.style.display = 'none';

        try {
            const response = await fetch('/api/trash', {
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                const items = data.items || [];

                if (loadingEl) loadingEl.style.display = 'none';

                if (items.length > 0) {
                    displayTrashItems(items);
                    if (gridEl) gridEl.style.display = 'grid';
                } else {
                    if (emptyEl) emptyEl.style.display = 'block';
                }
            } else {
                console.error('Failed to load trash items');
                if (loadingEl) loadingEl.style.display = 'none';
                if (emptyEl) emptyEl.style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading trash:', error);
            if (loadingEl) loadingEl.style.display = 'none';
            if (emptyEl) emptyEl.style.display = 'block';
        }
    }

    // Display Trash Items
    function displayTrashItems(items) {
        const gridEl = document.getElementById('trash-grid');
        if (!gridEl) return;

        gridEl.innerHTML = '';

        items.forEach(item => {
            const projectData = item.project_data || {};
            const deletedBy = item.deleted_by || 'Unknown';
            const originalOwner = item.original_owner || 'Unknown';
            const deletedAt = new Date(item.deleted_at).toLocaleDateString();

            const card = document.createElement('div');
            card.style.cssText = 'background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 1rem;';

            card.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <h4 style="color: #ef4444; font-size: 1.1rem; margin: 0 0 0.5rem 0;">
                        ${projectData.title || projectData.name || 'Untitled Project'}
                    </h4>
                    <p style="color: #94a3b8; font-size: 0.85rem; margin: 0.25rem 0;">
                        <i class="fas fa-user"></i> Owner: ${originalOwner}
                    </p>
                    <p style="color: #94a3b8; font-size: 0.85rem; margin: 0.25rem 0;">
                        <i class="fas fa-trash"></i> Deleted by: ${deletedBy}
                    </p>
                    <p style="color: #94a3b8; font-size: 0.85rem; margin: 0.25rem 0;">
                        <i class="fas fa-calendar"></i> Deleted: ${deletedAt}
                    </p>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="restoreFromTrash('${item._id}')" style="flex: 1; background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); padding: 8px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                        <i class="fas fa-undo"></i> Restore
                    </button>
                    <button onclick="permanentlyDeleteFromTrash('${item._id}')" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                        <i class="fas fa-times"></i> Delete
                    </button>
                </div>
            `;

            gridEl.appendChild(card);
        });
    }

    // Restore from Trash
    async function restoreFromTrash(itemId) {
        if (!confirm('Restore this project?')) return;

        try {
            const response = await fetch(`/api/trash/${itemId}/restore`, {
                method: 'POST',
                credentials: 'include'
            });

            if (response.ok) {
                await loadTrashItems();
                await loadProjects(); // Reload main projects
                alert('Project restored successfully!');
            } else {
                alert('Failed to restore project');
            }
        } catch (error) {
            console.error('Error restoring:', error);
            alert('Error restoring project');
        }
    }

    // Permanently Delete from Trash
    async function permanentlyDeleteFromTrash(itemId) {
        if (!confirm('Permanently delete this project? This cannot be undone!')) return;

        try {
            const response = await fetch(`/api/trash/${itemId}/delete`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (response.ok) {
                await loadTrashItems();
                alert('Project permanently deleted');
            } else {
                alert('Failed to delete project');
            }
        } catch (error) {
            console.error('Error deleting:', error);
            alert('Error deleting project');
        }
    }

    // Confirm delete
    async function confirmDelete() {
        if (!pendingDeleteItem || !pendingDeleteType) return;
        
        const modal = document.getElementById('delete-confirm-modal');
        modal.style.display = 'none';
        
        if (pendingDeleteType === 'project') {
            // Call backend to soft delete
            try {
                // First get user info from session
                const userResponse = await fetch('/api/user', {
                    credentials: 'include'
                });

                let userEmail = null;
                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    userEmail = userData.email;
                }

                // If no email from session, use the owner from the project
                if (!userEmail && pendingDeleteItem.owner) {
                    userEmail = pendingDeleteItem.owner;
                }

                // Use the existing backend endpoint format
                const response = await fetch(`/api/projects/${pendingDeleteItem.id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'  // Include cookies for session
                });
                
                const data = await response.json();
                
                if (response.ok || response.status === 404) {
                    // If OK or not found in backend, proceed with local deletion
                    if (response.ok) {
                        console.log('Project deleted successfully from backend');
                    } else {
                        console.log('Project not found in backend, deleting locally');
                    }
                    
                    // Remove from local data
                    if (pendingDeleteItem.seriesId) {
                        const series = seriesData.find(s => s.id === pendingDeleteItem.seriesId);
                        if (series && series.projects) {
                            series.projects = series.projects.filter(p => p.id !== pendingDeleteItem.id);
                        }
                    } else {
                        projectsData = projectsData.filter(p => p.id !== pendingDeleteItem.id);
                    }
                    
                    renderProjects();
                    updateProjectStats();
                    await saveSeriesData();
                    showSaveIndicator('success');
                } else {
                    console.error('Delete failed:', data);
                    alert(`Failed to delete project: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('Failed to delete project. Please try again.');
            }
        } else if (pendingDeleteType === 'series') {
            // Handle series deletion
            const series = seriesData.find(s => s.id === pendingDeleteItem.id);
            if (series) {
                // Move all projects in series to deleted
                for (const project of series.projects) {
                    try {
                        await fetch(`/api/projects/${project.id}`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include'  // Include cookies for session
                        });
                    } catch (error) {
                        console.error('Error deleting project in series:', error);
                    }
                }
                
                // Remove series from local data
                seriesData = seriesData.filter(s => s.id !== pendingDeleteItem.id);
                renderProjects();
                updateProjectStats();
                saveSeriesData();
                // Deleted permanently
            }
        }
        
        pendingDeleteItem = null;
        pendingDeleteType = null;
    }
    
    // Save series data
    async function saveProjects() {
        try {
            // Save to backend database (cloud storage)
            const response = await fetch('/api/projects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',  // Include cookies for session
                body: JSON.stringify({ projects: projectsData })
            });
            
            if (!response.ok) {
                throw new Error('Failed to save data to server');
            }
            
            console.log('Projects saved to cloud successfully');
            
            // Show a subtle success indicator
            showSaveIndicator('success');
        } catch (error) {
            console.error('Error saving projects:', error);
            showSaveIndicator('error');
            alert('Failed to save changes. Please check your connection and try again.');
        }
    }
    
    // Alias for backward compatibility
    async function saveSeriesData() {
        return saveProjects();
    }
    
    // Show save status indicator
    function showSaveIndicator(status) {
        // Create or get save indicator
        let indicator = document.getElementById('save-indicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'save-indicator';
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 10px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 10000;
                transition: all 0.3s ease;
                opacity: 0;
                transform: translateY(-20px);
            `;
            document.body.appendChild(indicator);
        }
        
        // Set status styles
        if (status === 'success') {
            indicator.style.background = 'rgba(34, 197, 94, 0.9)';
            indicator.style.border = '1px solid rgba(34, 197, 94, 0.5)';
            indicator.textContent = '✓ Saved to cloud';
        } else if (status === 'error') {
            indicator.style.background = 'rgba(239, 68, 68, 0.9)';
            indicator.style.border = '1px solid rgba(239, 68, 68, 0.5)';
            indicator.textContent = '✗ Save failed';
        } else if (status === 'saving') {
            indicator.style.background = 'rgba(96, 165, 250, 0.9)';
            indicator.style.border = '1px solid rgba(96, 165, 250, 0.5)';
            indicator.textContent = '↻ Saving...';
        }
        
        // Show indicator
        indicator.style.opacity = '1';
        indicator.style.transform = 'translateY(0)';
        
        // Hide after 2 seconds
        setTimeout(() => {
            indicator.style.opacity = '0';
            indicator.style.transform = 'translateY(-20px)';
        }, 2000);
    }
    
    // Create new project (with series support)
    async function createNewProject() {
        // Create project locally (works without backend)
        const newProject = {
            id: 'project-' + Date.now(),
            title: 'New Project',
            description: 'Click edit to configure this project',
            status: 'draft',
            value: 0,
            progress: 0,
            order: projectsData.length,
            // Permutation Engine Fields (defaults)
            currency: '',
            grossITLoad: null,
            pue: null,
            capexCost: null,
            capexRate: null,
            landPurchaseFees: null,
            grossMonthlyRent: null,
            opex: null
        };
        
        // Try to save to backend if available
        try {
            const response = await fetch('/api/projects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',  // Include cookies for session
                body: JSON.stringify(newProject)
            });
            
            if (response.ok) {
                const savedProject = await response.json();
                // Use the server's ID if available
                newProject.id = savedProject.id || newProject.id;
            }
        } catch (error) {
            // API not available, but we can continue with local storage
            console.log('Using local storage only - API not available');
        }
        
        // Add project to list
        projectsData.push(newProject);
        
        // Hide empty state and show grid
        document.getElementById('projects-empty').style.display = 'none';
        document.getElementById('projects-grid').style.display = 'grid';
        document.getElementById('project-stats').style.display = 'grid';
        
        // Update UI and save
        renderProjects();
        updateProjectStats();
        saveProjects();
    }

    // Legacy function for compatibility
    function openProjectModal() {
        createNewProject();
    }

    // View project details
    function viewProjectDetails(projectId) {
        console.log('Viewing project:', projectId);
        showProjectSpecifications(projectId, 'view');
    }
    
    // Edit project
    function editProject(projectId) {
        // Show the sponsor input form inline in projects section
        showSection('projects');
        setTimeout(() => showSponsorEditForm(projectId), 100);
    }
    
    function showSponsorEditForm(projectId) {
        currentSponsorProjectId = projectId || generateProjectId();
        const project = findProjectById(projectId);
        
        // Show the inline editor
        const editor = document.getElementById('sponsor-editor-section');
        if (editor) {
            editor.style.display = 'block';
            
            // Update title
            document.getElementById('sponsor-editor-title').textContent = project ? 
                `Edit Project - ${project.title || 'Untitled'}` : 'Create New Project';
            
            // Populate form if editing
            if (project) {
                populateSponsorForm(project);
            }
            
            // Scroll to editor
            editor.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
    
    function closeSponsorEditor() {
        const editor = document.getElementById('sponsor-editor-section');
        if (editor) {
            editor.style.display = 'none';
        }
        currentSponsorProjectId = null;
        sponsorUploadedData = null;
    }
    
    function populateSponsorForm(project) {
        // Populate metadata
        document.getElementById('sponsor-projectTitle').value = project.title || '';
        document.getElementById('sponsor-locationCountry').value = project.location || '';
        document.getElementById('sponsor-status').value = project.status || '1. Site Identified';
        
        // Handle separate currency fields
        const capexCurrency = document.getElementById('sponsor-capex-currency');
        const kwhCurrency = document.getElementById('sponsor-kwh-currency');
        if (capexCurrency) capexCurrency.value = project.capexCurrency || project.meta?.capexCurrency || project.currency || 'EUR';
        if (kwhCurrency) kwhCurrency.value = project.kwhCurrency || project.meta?.kwhCurrency || project.currency || 'EUR';
        
        document.getElementById('sponsor-grossITLoadMW').value = project.grossITLoad || project.meta?.grossITLoadMW || '';
        document.getElementById('sponsor-pue').value = project.pue || project.meta?.pue || '1.25';
        
        // Populate new fields with formatting
        const grossMonthlyRent = document.getElementById('sponsor-grossMonthlyRent');
        const opexPercent = document.getElementById('sponsor-opexPercent');
        
        if (grossMonthlyRent) {
            const rentValue = project.grossMonthlyRent || project.meta?.grossMonthlyRent || 0;
            if (rentValue > 0) {
                grossMonthlyRent.value = formatCurrencyInput(rentValue, kwhCurrency?.value || 'EUR');
            } else {
                grossMonthlyRent.value = '';
            }
        }
        
        if (opexPercent) {
            const opexValue = project.opexPercent || project.meta?.opexPercent || 0;
            if (opexValue > 0) {
                opexPercent.value = formatPercentageInput(opexValue);
            } else {
                opexPercent.value = '';
            }
        }
        
        // Populate construction fields
        const constructionStart = document.getElementById('sponsor-constructionStart');
        const constructionDuration = document.getElementById('sponsor-constructionDurationMonths');
        if (constructionStart) constructionStart.value = project.constructionStart || project.meta?.constructionStart || '';
        if (constructionDuration) constructionDuration.value = project.constructionDuration || project.meta?.constructionDurationMonths || '';
        
        // Populate CapEx fields if they exist
        if (project.capex) {
            // Internal CapEx
            if (project.capex.internal) {
                const currency = capexCurrency?.value || 'EUR';
                if (project.capex.internal.perMW > 0) {
                    const perMWInput = document.getElementById('sponsor-capexInternalPerMW');
                    if (perMWInput) perMWInput.value = formatCurrencyInput(project.capex.internal.perMW, currency);
                }
                
                // Populate internal detail fields
                const internalFields = [
                    ['sponsor-buildArchitectural', project.capex.internal.architectural],
                    ['sponsor-buildCivilStructural', project.capex.internal.civilStructural],
                    ['sponsor-buildSubstations', project.capex.internal.substations],
                    ['sponsor-buildUndergroundUtilities', project.capex.internal.undergroundUtilities],
                    ['sponsor-buildCrusaderModules', project.capex.internal.crusaderModules],
                    ['sponsor-buildBess', project.capex.internal.bess],
                    ['sponsor-buildMainContractorInstallation', project.capex.internal.mainContractorInstallation],
                    ['sponsor-buildPhotovoltaicSystem', project.capex.internal.photovoltaicSystem],
                    ['sponsor-buildLandscaping', project.capex.internal.landscaping],
                    ['sponsor-buildPreliminariesGeneral', project.capex.internal.preliminariesGeneral],
                    ['sponsor-buildMainContractorMargin', project.capex.internal.mainContractorMargin]
                ];
                
                internalFields.forEach(([fieldId, value]) => {
                    const field = document.getElementById(fieldId);
                    if (field && value > 0) {
                        field.value = formatCurrencyInput(value, currency);
                    }
                });
            }
            
            // Market CapEx
            if (project.capex.market) {
                const currency = capexCurrency?.value || 'EUR';
                if (project.capex.market.perMW > 0) {
                    const perMWInput = document.getElementById('sponsor-capexMarketPerMW');
                    if (perMWInput) perMWInput.value = formatCurrencyInput(project.capex.market.perMW, currency);
                }
                
                // Populate market detail fields
                const marketFields = [
                    ['sponsor-marketArchitectural', project.capex.market.architectural],
                    ['sponsor-marketCivilStructural', project.capex.market.civilStructural],
                    ['sponsor-marketSubstations', project.capex.market.substations],
                    ['sponsor-marketUndergroundUtilities', project.capex.market.undergroundUtilities],
                    ['sponsor-marketCrusaderModules', project.capex.market.crusaderModules],
                    ['sponsor-marketBess', project.capex.market.bess],
                    ['sponsor-marketMainContractorInstallation', project.capex.market.mainContractorInstallation],
                    ['sponsor-marketPhotovoltaicSystem', project.capex.market.photovoltaicSystem],
                    ['sponsor-marketLandscaping', project.capex.market.landscaping],
                    ['sponsor-marketPreliminariesGeneral', project.capex.market.preliminariesGeneral],
                    ['sponsor-marketMainContractorMargin', project.capex.market.mainContractorMargin]
                ];
                
                marketFields.forEach(([fieldId, value]) => {
                    const field = document.getElementById(fieldId);
                    if (field && value > 0) {
                        field.value = formatCurrencyInput(value, currency);
                    }
                });
            }
        }
        
        // Trigger currency display updates
        if (capexCurrency) {
            const event = new Event('change');
            capexCurrency.dispatchEvent(event);
        }
        if (kwhCurrency) {
            const event = new Event('change');
            kwhCurrency.dispatchEvent(event);
        }
        
        // Trigger MW calculations
        const grossITInput = document.getElementById('sponsor-grossITLoadMW');
        if (grossITInput) {
            const event = new Event('input');
            grossITInput.dispatchEvent(event);
        }
    }
    
    function downloadSponsorTemplate() {
        // Create a download link for the Excel template
        const link = document.createElement('a');
        link.href = '/static/templates/Project_Sponsor_Input_Template.xlsx';
        link.download = 'Project_Sponsor_Input_Template.xlsx';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function handleSponsorDrop(e) {
        e.preventDefault();
        e.currentTarget.style.background = 'rgba(96, 165, 250, 0.05)';
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            processSponsorFile(files[0]);
        }
    }
    
    function handleSponsorDragOver(e) {
        e.preventDefault();
        e.currentTarget.style.background = 'rgba(96, 165, 250, 0.15)';
    }
    
    function handleSponsorDragLeave(e) {
        e.currentTarget.style.background = 'rgba(96, 165, 250, 0.05)';
    }
    
    function processSponsorFile(file) {
        if (!file.name.endsWith('.xlsx')) {
            alert('Please upload an Excel (.xlsx) file');
            return;
        }
        
        const input = document.getElementById('sponsorFileInput');
        const dt = new DataTransfer();
        dt.items.add(file);
        input.files = dt.files;
        
        handleSponsorFileSelect({ target: input });
    }
    
    // Launch permutation tool with project data
    function launchPermutationWithProject(projectId) {
        const project = findProjectById(projectId);
        if (!project) {
            alert('Project not found');
            return;
        }
        
        // Switch to permutation section
        showSection('permutation');
        
        // Populate permutation fields with project data
        setTimeout(() => {
            // Set project selector if exists
            const projectSelector = document.getElementById('project-selector');
            if (projectSelector) {
                projectSelector.value = projectId;
            }
            
            // Populate the permutation form fields with project data
            if (project.currency) {
                const currencyField = document.getElementById('perm-currency');
                if (currencyField) currencyField.value = project.currency;
            }
            
            if (project.grossITLoad) {
                const grossITField = document.getElementById('perm-gross-it-load');
                if (grossITField) grossITField.value = project.grossITLoad;
            }
            
            if (project.pue) {
                const pueField = document.getElementById('perm-pue');
                if (pueField) pueField.value = project.pue;
            }
            
            if (project.capexCost) {
                const capexCostField = document.getElementById('perm-capex-cost');
                if (capexCostField) capexCostField.value = project.capexCost;
            }
            
            if (project.capexRate) {
                const capexRateField = document.getElementById('perm-capex-rate');
                if (capexRateField) capexRateField.value = project.capexRate;
            }
            
            if (project.landPurchaseFees) {
                const landFeesField = document.getElementById('perm-land-fees');
                if (landFeesField) landFeesField.value = project.landPurchaseFees;
            }
            
            if (project.grossMonthlyRent) {
                const monthlyRentField = document.getElementById('perm-monthly-rent');
                if (monthlyRentField) monthlyRentField.value = project.grossMonthlyRent;
            }
            
            if (project.opex) {
                const opexField = document.getElementById('perm-opex');
                if (opexField) opexField.value = project.opex;
            }
            
            // Store project reference for later use
            window.currentPermutationProject = project;
            
            // Show success message
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = 'position: fixed; top: 200px; right: 20px; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 1rem 1.5rem; border-radius: 8px; z-index: 10000; animation: slideIn 0.3s ease;';
            messageDiv.innerHTML = `<i class="fas fa-check-circle"></i> Project "${project.title}" loaded into Permutation Engine`;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }, 500);
    }

    // Render projects in the grid
    function renderProjects() {
        const gridElement = document.getElementById('projects-grid');
        gridElement.innerHTML = '';
        
        // Set grid layout for proper card arrangement
        gridElement.style.cssText = `
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 20px 0;
        `;

        // Ensure array is valid
        if (!Array.isArray(projectsData)) {
            projectsData = [];
        }

        // Render projects directly in the grid
        projectsData.forEach((project, index) => {
            const projectCard = createProjectCard(project, index);
            gridElement.appendChild(projectCard);
        });
    }
    
    // Get status color helper
    function getStatusColor(status) {
        const colors = {
            'draft': 'rgba(75, 85, 99, 0.8)',
            'in-progress': 'rgba(96, 165, 250, 0.8)',
            'active': 'rgba(34, 197, 94, 0.8)',
            'completed': 'rgba(168, 85, 247, 0.8)'
        };
        return colors[status] || colors['draft'];
    }
    
    /* ALL DUPLICATE FUNCTIONS REMOVED - These functions are already defined earlier in the file */

    // Create a project card element
    function createProjectCard(project, index, seriesId = null) {
        const card = document.createElement('div');
        card.className = 'project-card';
        card.draggable = true;
        card.dataset.index = index;
        card.dataset.projectId = project.id;
        
        // Debug admin status for delete button
        if (project.ownerEmail && project.ownerEmail !== userEmail) {
            console.log(`Project from ${project.ownerEmail}:`, {
                isAdmin: isAdmin,
                accountType: accountType,
                userEmail: userEmail,
                shouldShowDelete: (isAdmin === true || accountType === 'admin')
            });
        }
        
        // Set seriesId if project is in a series
        if (seriesId) {
            card.dataset.seriesId = seriesId;
        }
        
        const statusColors = {
            'active': { bg: '#22c55e', text: 'Active' },
            'in-progress': { bg: '#60a5fa', text: 'In Progress' },
            'draft': { bg: '#64748b', text: 'Draft' },
            'completed': { bg: '#10b981', text: 'Completed' },
            'paused': { bg: '#f59e0b', text: 'Paused' }
        };

        const status = statusColors[project.status] || statusColors.draft;
        const progressColor = project.status === 'draft' ? '#64748b' : '#60a5fa';
        const progressGradient = project.status === 'draft' ? 
            'linear-gradient(90deg, #64748b, #475569)' : 
            'linear-gradient(90deg, #60a5fa, #3b82f6)';

        card.innerHTML = `
            <div style="cursor: grab;">
                ${project.ownerName ? `
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; padding: 6px 10px; background: rgba(96, 165, 250, 0.1); border-radius: 6px;">
                    <i class="fas fa-user" style="color: ${project.ownerType === 'admin' ? '#ef4444' : project.ownerType === 'internal' ? '#60a5fa' : '#94a3b8'}; font-size: 0.8rem;"></i>
                    <span style="color: #94a3b8; font-size: 0.85rem;">${project.ownerName}</span>
                    <span style="color: ${project.ownerType === 'admin' ? '#ef4444' : project.ownerType === 'internal' ? '#60a5fa' : '#64748b'}; font-size: 0.75rem; text-transform: uppercase;">(${project.ownerType})</span>
                </div>
                ` : ''}
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <h3 style="color: #93c5fd; font-size: 1.25rem; font-weight: 600;">${project.title}</h3>
                    <span style="background: ${status.bg}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem;">${status.text}</span>
                </div>
                <p style="color: #94a3b8; margin-bottom: 1rem; font-size: 0.9rem;">${project.description}</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <p style="color: #64748b; font-size: 0.8rem;">Value</p>
                        <p style="color: #60a5fa; font-weight: 600;">${formatCurrency(project.value)}</p>
                    </div>
                    <div>
                        <p style="color: #64748b; font-size: 0.8rem;">Progress</p>
                        <p style="color: #60a5fa; font-weight: 600;">${project.progress}%</p>
                    </div>
                </div>
                <div style="background: rgba(96, 165, 250, 0.1); border-radius: 4px; height: 8px; margin-bottom: 1rem;">
                    <div style="background: ${progressGradient}; border-radius: 4px; height: 100%; width: ${project.progress}%;"></div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="viewProjectDetails('${project.id}')" style="flex: 1; background: linear-gradient(135deg, #0a0e27, #020617); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); padding: 8px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                        <i class="fas fa-eye"></i> View
                    </button>
                    ${!project.ownerEmail || project.ownerEmail === userEmail ? `
                    <button onclick="editProject('${project.id}')" style="flex: 1; background: linear-gradient(135deg, #0a0e27, #020617); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); padding: 8px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                        <i class="fas fa-edit"></i> Edit
                    </button>` : ''}
                    ${isAdmin ? `<button onclick="launchPermutationWithProject('${project.id}')" style="flex: 1; background: linear-gradient(135deg, #0a0e27, #020617); color: #a855f7; border: 1px solid rgba(168, 85, 247, 0.3); padding: 8px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                        <i class="fas fa-cogs"></i> Permutation
                    </button>` : ''}
                    ${(isAdmin === true || accountType === 'admin' || !project.ownerEmail || project.ownerEmail === userEmail) ? `
                    <button onclick="deleteProject('${project.id}')" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;" title="${isAdmin ? 'Delete project from ' + (project.ownerEmail || 'unknown') : 'Delete project'}">
                        <i class="fas fa-trash"></i>
                    </button>` : ''}
                </div>
            </div>
        `;

        // Add drag and drop event listeners
        setupCardDragEvents(card);
        
        // Add hover effects with smooth transitions
        card.style.cssText = `
            background: linear-gradient(135deg, #0a0e27, #020617);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: grab;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            transform: translateZ(0);
        `;
        
        card.addEventListener('mouseenter', function() {
            if (!this.classList.contains('dragging')) {
                this.style.transform = 'translateY(-5px)';
                this.style.boxShadow = '0 10px 30px rgba(96, 165, 250, 0.3)';
            }
        });
        
        card.addEventListener('mouseleave', function() {
            if (!this.classList.contains('dragging')) {
                this.style.transform = '';
                this.style.boxShadow = '';
            }
        });

        return card;
    }

    // Setup drag and drop events for project cards
    function setupCardDragEvents(card) {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
        
        // No longer need individual card drag events as we handle at grid level
    }

    // Setup drag and drop for the projects grid
    function setupProjectsDragAndDrop() {
        const grid = document.getElementById('projects-grid');
        grid.addEventListener('dragover', handleGridDragOver);
        grid.addEventListener('drop', handleGridDrop);
    }
    
    // Setup drag events for series cards
    function setupSeriesDragEvents(card) {
        card.addEventListener('dragstart', handleSeriesDragStart);
        card.addEventListener('dragend', handleSeriesDragEnd);
    }
    
    // Handle series drag start
    function handleSeriesDragStart(e) {
        // Check if we're dragging the series itself or a project within it
        if (e.target.classList.contains('project-card')) {
            // Let the project drag handler handle this
            return;
        }
        
        // Store that we're dragging a series
        draggedElement = this;
        draggedElement.dataset.dragType = 'series';
        draggedIndex = parseInt(this.dataset.index);
        
        // Visual feedback
        this.style.opacity = '0.4';
        this.style.cursor = 'grabbing';
        
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', '');
        
        // Stop propagation to prevent project cards from also being dragged
        e.stopPropagation();
    }
    
    // Handle series drag end
    function handleSeriesDragEnd(e) {
        this.style.opacity = '';
        this.style.cursor = 'grab';
        delete this.dataset.dragType;
        
        // Clean up any visual feedback
        document.querySelectorAll('.drag-over-series').forEach(el => {
            el.classList.remove('drag-over-series');
        });
    }
    
    // Handle drop zone drag over for series
    function handleSeriesDropZoneDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Only accept project cards
        if (draggedElement && draggedElement.classList.contains('project-card')) {
            e.dataTransfer.dropEffect = 'move';
            
            // Visual feedback
            this.style.border = '2px dashed rgba(96, 165, 250, 0.6)';
            this.style.background = 'rgba(96, 165, 250, 0.05)';
        }
    }
    
    // Handle drop zone drop for series
    function handleSeriesDropZoneDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (!draggedElement || !draggedElement.classList.contains('project-card')) {
            console.log('Drop rejected: not a project card');
            return;
        }
        
        const targetSeriesId = this.dataset.seriesId;
        const projectId = draggedElement.dataset.projectId;
        const sourceSeriesId = draggedElement.dataset.seriesId || draggedElement.dataset.sourceSeriesId;
        
        console.log('Series drop:', {projectId, sourceSeriesId, targetSeriesId});
        
        // Move project to this series
        moveProjectToSeries(projectId, sourceSeriesId, targetSeriesId);
        
        // Reset visual feedback
        this.style.border = '2px dashed rgba(96, 165, 250, 0.4)';
        this.style.background = 'rgba(96, 165, 250, 0.03)';
    }
    
    // Handle drop zone leave for series
    function handleSeriesDropZoneLeave(e) {
        this.style.border = '2px dashed rgba(96, 165, 250, 0.4)';
        this.style.background = 'rgba(96, 165, 250, 0.03)';
    }
    
    // Handle dragging over standalone area
    function handleStandaloneAreaDragOver(e) {
        e.preventDefault();
        
        // Only accept project cards from series
        if (draggedElement && draggedElement.classList.contains('project-card')) {
            const sourceSeriesId = draggedElement.dataset.seriesId || draggedElement.dataset.sourceSeriesId;
            
            // Only show feedback if dragging from a series
            if (sourceSeriesId && sourceSeriesId !== 'null' && sourceSeriesId !== 'undefined') {
                e.dataTransfer.dropEffect = 'move';
                
                // Subtle visual feedback
                if (this.classList.contains('standalone-drop-helper')) {
                    this.style.border = '2px dashed rgba(34, 197, 94, 0.6)';
                    this.style.background = 'rgba(34, 197, 94, 0.05)';
                }
            }
        }
    }
    
    // Handle drop in standalone area
    function handleStandaloneAreaDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (!draggedElement || !draggedElement.classList.contains('project-card')) return;
        
        const projectId = draggedElement.dataset.projectId;
        const sourceSeriesId = draggedElement.dataset.seriesId || draggedElement.dataset.sourceSeriesId;
        
        // Only move if coming from a series
        if (sourceSeriesId && sourceSeriesId !== 'null' && sourceSeriesId !== 'undefined') {
            console.log('Moving project to standalone:', projectId, 'from series:', sourceSeriesId);
            moveProjectToSeries(projectId, sourceSeriesId, null);
        }
        
        // Reset visual feedback
        if (this.classList.contains('standalone-drop-helper')) {
            this.style.border = '2px dashed transparent';
            this.style.background = 'transparent';
        }
    }
    
    // Handle leave from standalone area
    function handleStandaloneAreaLeave(e) {
        if (this.classList.contains('standalone-drop-helper')) {
            this.style.border = '2px dashed transparent';
            this.style.background = 'transparent';
        }
    }
    
    // Move project between series or to/from standalone
    function moveProjectToSeries(projectId, sourceSeriesId, targetSeriesId) {
        console.log(`Moving project ${projectId} from ${sourceSeriesId || 'standalone'} to ${targetSeriesId || 'standalone'}`);
        let project = null;
        
        // Find and remove project from source
        if (sourceSeriesId && sourceSeriesId !== 'null' && sourceSeriesId !== 'undefined') {
            // Moving from a series
            const sourceSeries = seriesData.find(s => s.id === sourceSeriesId);
            if (sourceSeries && sourceSeries.projects) {
                const projectIndex = sourceSeries.projects.findIndex(p => p.id === projectId);
                if (projectIndex !== -1) {
                    project = sourceSeries.projects.splice(projectIndex, 1)[0];
                    console.log('Removed project from series:', sourceSeries.title);
                }
            }
        } else {
            // Moving from standalone projects
            const projectIndex = projectsData.findIndex(p => p.id === projectId);
            if (projectIndex !== -1) {
                project = projectsData.splice(projectIndex, 1)[0];
                console.log('Removed project from standalone');
            }
        }
        
        // Add project to target
        if (project) {
            if (targetSeriesId && targetSeriesId !== 'null' && targetSeriesId !== 'undefined') {
                // Moving to a series
                const targetSeries = seriesData.find(s => s.id === targetSeriesId);
                if (targetSeries) {
                    if (!targetSeries.projects) {
                        targetSeries.projects = [];
                    }
                    targetSeries.projects.push(project);
                    console.log('Added project to series:', targetSeries.title);
                }
            } else {
                // Moving to standalone projects
                projectsData.push(project);
                console.log('Added project to standalone');
            }
            
            // Re-render and save
            renderProjects();
            updateProjectStats();
            saveSeriesData();
            showSaveIndicator('success');
        }
    }

    // Global variables for smooth drag and drop (removed duplicates - defined earlier)
    // let ghostPlaceholder = null; // Already defined at line 5232
    // let originalNextSibling = null; // Already defined at line 5232
    // let lastValidDropTarget = null; // Already defined at line 5232
    // let draggedElement = null; // Already defined at line 5235
    // let draggedIndex = null; // Already defined at line 5236
    // let currentDropPosition = null; // Already defined earlier

    // Create ghost placeholder element
    function createGhostPlaceholder() {
        const placeholder = document.createElement('div');
        placeholder.className = 'drag-placeholder';
        placeholder.style.cssText = `
            height: 200px;
            margin: 0.75rem;
            border: 3px dashed rgba(96, 165, 250, 0.8);
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(96, 165, 250, 0.1), rgba(59, 130, 246, 0.05));
            position: relative;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0.95);
            animation: placeholderPulse 1.5s ease-in-out infinite;
        `;
        
        // Add animation keyframes
        if (!document.querySelector('#drag-placeholder-styles')) {
            const style = document.createElement('style');
            style.id = 'drag-placeholder-styles';
            style.textContent = `
                @keyframes placeholderPulse {
                    0%, 100% { 
                        border-color: rgba(96, 165, 250, 0.8);
                        background: linear-gradient(135deg, rgba(96, 165, 250, 0.1), rgba(59, 130, 246, 0.05));
                    }
                    50% { 
                        border-color: rgba(96, 165, 250, 1);
                        background: linear-gradient(135deg, rgba(96, 165, 250, 0.15), rgba(59, 130, 246, 0.1));
                    }
                }
                .project-card.dragging {
                    opacity: 0.3 !important;
                    transform: scale(0.95) !important;
                    cursor: grabbing !important;
                }
                .project-card.drag-preview {
                    position: fixed;
                    pointer-events: none;
                    z-index: 10000;
                    opacity: 0.9;
                    transform: rotate(2deg) scale(1.05);
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                }
            `;
            document.head.appendChild(style);
        }
        
        // Add placeholder content
        const content = document.createElement('div');
        content.style.cssText = `
            color: rgba(96, 165, 250, 0.9);
            font-size: 14px;
            text-align: center;
            pointer-events: none;
        `;
        content.innerHTML = `
            <div style="font-size: 28px; margin-bottom: 8px;">⬇</div>
            <div style="font-weight: 600;">Drop here</div>
        `;
        placeholder.appendChild(content);
        
        return placeholder;
    }

    // Drag event handlers with smooth animations
    function handleDragStart(e) {
        draggedElement = this;
        draggedIndex = parseInt(this.dataset.index);
        
        // Store what type of element we're dragging
        if (this.classList.contains('series-card')) {
            draggedElement.dataset.dragType = 'series';
        } else if (this.classList.contains('project-card')) {
            draggedElement.dataset.dragType = 'project';
            // Store the source series ID if dragging from a series
            draggedElement.dataset.sourceSeriesId = this.dataset.seriesId || 'standalone';
        }
        
        // Store original position for restoration
        originalNextSibling = this.nextSibling;
        
        // Create and insert ghost placeholder immediately at dragged element's position
        ghostPlaceholder = createGhostPlaceholder();
        this.parentNode.insertBefore(ghostPlaceholder, this);
        
        // Move the dragged element out of the flow
        this.style.position = 'fixed';
        this.style.pointerEvents = 'none';
        this.style.left = e.clientX + 'px';
        this.style.top = e.clientY + 'px';
        
        // Animate placeholder in
        setTimeout(() => {
            if (ghostPlaceholder) {
                ghostPlaceholder.style.opacity = '1';
                ghostPlaceholder.style.transform = 'scale(1)';
            }
        }, 10);
        
        // Style the dragged element
        this.classList.add('dragging');
        
        // Add dragging class to grid for global styles
        document.getElementById('projects-grid').classList.add('dragging-active');
        
        // Create a custom drag image (optional, for better visual feedback)
        const dragImage = this.cloneNode(true);
        dragImage.style.position = 'absolute';
        dragImage.style.top = '-1000px';
        document.body.appendChild(dragImage);
        e.dataTransfer.setDragImage(dragImage, e.offsetX, e.offsetY);
        setTimeout(() => document.body.removeChild(dragImage), 0);
        
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', '');
    }

    function handleDragEnd(e) {
        // Reset the dragged element's position
        this.style.position = '';
        this.style.pointerEvents = '';
        this.style.left = '';
        this.style.top = '';
        
        // Clean up dragged element
        this.classList.remove('dragging');
        this.style.opacity = '';
        this.style.cursor = 'grab';
        this.style.transform = '';
        this.style.zIndex = '';
        this.style.boxShadow = '';
        
        // Remove dragging state from grid
        document.getElementById('projects-grid').classList.remove('dragging-active');
        
        // Remove placeholder with animation
        if (ghostPlaceholder) {
            ghostPlaceholder.style.opacity = '0';
            ghostPlaceholder.style.transform = 'scale(0.9)';
            setTimeout(() => {
                if (ghostPlaceholder && ghostPlaceholder.parentNode) {
                    ghostPlaceholder.parentNode.removeChild(ghostPlaceholder);
                }
                ghostPlaceholder = null;
            }, 200);
        }
        
        // Clean up all card effects with smooth transition
        document.querySelectorAll('.project-card').forEach(card => {
            card.classList.remove('drag-over', 'drag-over-top', 'drag-over-bottom');
            card.style.transform = '';
            card.style.transition = 'transform 0.3s ease';
            setTimeout(() => {
                card.style.transition = '';
            }, 300);
        });
        
        // Reset variables
        draggedElement = null;
        draggedIndex = null;
        lastValidDropTarget = null;
        originalNextSibling = null;
        currentDropPosition = null;
    }

    function handleGridDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        
        if (!draggedElement) return;
        
        // Visual feedback for main grid as drop zone
        const grid = document.getElementById('projects-grid');
        if (draggedElement.classList.contains('project-card') && draggedElement.dataset.seriesId) {
            // Show visual feedback when dragging a project from a series
            grid.style.border = '2px dashed rgba(96, 165, 250, 0.4)';
            grid.style.background = 'rgba(96, 165, 250, 0.02)';
        }
        
        if (!ghostPlaceholder) return;
        
        const cards = [...grid.querySelectorAll('.project-card:not(.dragging), .series-card:not(.dragging)')];
        
        // Get mouse position
        const mouseX = e.clientX;
        const mouseY = e.clientY;
        
        // Find the closest insertion point
        let closestCard = null;
        let insertBefore = true;
        let minDistance = Infinity;
        
        // Check each card to find the closest insertion point
        cards.forEach(card => {
            const rect = card.getBoundingClientRect();
            const cardCenterX = rect.left + rect.width / 2;
            const cardCenterY = rect.top + rect.height / 2;
            
            // Calculate distance from mouse to card center
            const distance = Math.sqrt(
                Math.pow(mouseX - cardCenterX, 2) + 
                Math.pow(mouseY - cardCenterY, 2)
            );
            
            if (distance < minDistance) {
                minDistance = distance;
                closestCard = card;
                
                // Determine if we should insert before or after based on mouse position
                // For horizontal layouts, use X position; for vertical, use Y
                const isHorizontalLayout = window.innerWidth > 768;
                if (isHorizontalLayout) {
                    insertBefore = mouseX < cardCenterX;
                } else {
                    insertBefore = mouseY < cardCenterY;
                }
            }
        });
        
        // Clear all hover effects
        cards.forEach(card => {
            card.classList.remove('drag-over-top', 'drag-over-bottom');
            card.style.transform = '';
        });
        
        // Move placeholder to the appropriate position
        if (closestCard) {
            // Add visual feedback to the closest card
            closestCard.classList.add(insertBefore ? 'drag-over-top' : 'drag-over-bottom');
            
            // Smoothly move placeholder
            if (insertBefore) {
                if (ghostPlaceholder.nextSibling !== closestCard) {
                    grid.insertBefore(ghostPlaceholder, closestCard);
                }
            } else {
                if (ghostPlaceholder.previousSibling !== closestCard) {
                    grid.insertBefore(ghostPlaceholder, closestCard.nextSibling);
                }
            }
            
            // Add subtle animation to surrounding cards
            const closestIndex = cards.indexOf(closestCard);
            cards.forEach((card, index) => {
                if (Math.abs(index - closestIndex) <= 1 && card !== closestCard) {
                    card.style.transform = 'scale(0.98)';
                    card.style.transition = 'transform 0.2s ease';
                }
            });
        } else if (cards.length === 0) {
            // If no cards, append to grid
            grid.appendChild(ghostPlaceholder);
        } else {
            // Check if we should append to the end
            const lastCard = cards[cards.length - 1];
            const lastCardRect = lastCard.getBoundingClientRect();
            
            if (mouseY > lastCardRect.bottom || mouseX > lastCardRect.right) {
                grid.appendChild(ghostPlaceholder);
            }
        }
        
        currentDropPosition = ghostPlaceholder.nextSibling;
    }

    function handleGridDrop(e) {
        e.preventDefault();
        
        if (!draggedElement || !ghostPlaceholder) return;
        
        // Get all cards and find the new index
        const grid = document.getElementById('projects-grid');
        const allElements = [...grid.children];
        const placeholderIndex = allElements.indexOf(ghostPlaceholder);
        
        // Calculate the new index accounting for the dragged element
        let newIndex = placeholderIndex;
        if (draggedIndex < placeholderIndex) {
            newIndex--; // Account for the dragged element being removed
        }
        
        // Only reorder if the position actually changed
        if (newIndex !== draggedIndex && newIndex >= 0) {
            reorderProjects(draggedIndex, newIndex);
        }
    }

    // Helper function to find the element after which we should insert
    function getDragAfterElement(container, x, y) {
        const draggableElements = [...container.querySelectorAll('.project-card:not(.dragging)')];
        
        if (draggableElements.length === 0) return null;
        
        // Determine if we're in a horizontal or vertical layout
        const isHorizontalLayout = window.innerWidth > 768;
        
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            let offset;
            
            if (isHorizontalLayout) {
                // For horizontal layout, use X position
                offset = x - box.left - box.width / 2;
            } else {
                // For vertical layout, use Y position
                offset = y - box.top - box.height / 2;
            }
            
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // Reorder projects and save to backend
    async function reorderProjects(fromIndex, toIndex) {
        if (fromIndex === toIndex) return;

        // Move project in array
        const [movedProject] = projectsData.splice(fromIndex, 1);
        projectsData.splice(toIndex, 0, movedProject);

        // Update order values
        projectsData.forEach((project, index) => {
            project.order = index;
        });

        // Re-render projects
        renderProjects();

        // Save new order to backend
        await saveProjectOrder();
    }

    // Save project order to backend
    async function saveProjectOrder() {
        try {
            const orderData = projectsData.map((project, index) => ({
                id: project.id,
                order: index
            }));

            const response = await fetch('/api/projects/order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ projects: orderData })
            });

            if (!response.ok) {
                console.warn('Failed to save project order to backend');
            }
        } catch (error) {
            console.error('Error saving project order:', error);
        }
    }

    // Update project statistics
    function updateProjectStats() {
        const stats = {
            active: 0,
            inProgress: 0,
            drafts: 0,
            totalValue: 0
        };

        // Count standalone projects
        projectsData.forEach(project => {
            switch (project.status) {
                case 'active':
                    stats.active++;
                    break;
                case 'in-progress':
                    stats.inProgress++;
                    break;
                case 'draft':
                    stats.drafts++;
                    break;
            }
            stats.totalValue += project.value || 0;
        });
        
        // Count projects in series
        seriesData.forEach(series => {
            series.projects.forEach(project => {
                switch (project.status) {
                    case 'active':
                        stats.active++;
                        break;
                    case 'in-progress':
                        stats.inProgress++;
                        break;
                    case 'draft':
                        stats.drafts++;
                        break;
                }
                stats.totalValue += project.value || 0;
            });
        });

        document.getElementById('active-count').textContent = stats.active;
        document.getElementById('progress-count').textContent = stats.inProgress;
        document.getElementById('draft-count').textContent = stats.drafts;
        document.getElementById('total-value').textContent = formatCurrency(stats.totalValue);
    }

    // Format currency
    function formatCurrency(value) {
        if (value === 0) return '€0';
        if (value >= 1000000000) {
            return '€' + (value / 1000000000).toFixed(1) + 'B';
        }
        if (value >= 1000000) {
            return '€' + (value / 1000000).toFixed(0) + 'M';
        }
        if (value >= 1000) {
            return '€' + (value / 1000).toFixed(0) + 'K';
        }
        return '€' + value.toLocaleString();
    }

    // Sample projects for demo
    function getSampleProjects() {
        return [
            {
                id: 'infrastructure-2024',
                title: 'Infrastructure Bond 2024',
                description: '€500M infrastructure financing project for renewable energy development',
                status: 'active',
                value: 500000000,
                progress: 65,
                order: 0
            },
            {
                id: 'realestate-clo',
                title: 'Real Estate CLO',
                description: 'Commercial real estate collateralized loan obligation structure',
                status: 'in-progress',
                value: 750000000,
                progress: 40,
                order: 1
            },
            {
                id: 'auto-abs',
                title: 'Auto Loan ABS',
                description: 'Asset-backed securities for automotive loan portfolio',
                status: 'draft',
                value: 300000000,
                progress: 15,
                order: 2
            }
        ];
    }

    // Initialize projects when projects section is shown
    document.addEventListener('DOMContentLoaded', function() {
        // Data will be loaded from cloud database when projects section is shown
        // No localStorage needed - everything is stored in the cloud
        
        // Override the showSection function to initialize projects
        const originalShowSection = window.showSection;
        window.showSection = function(sectionId) {
            if (originalShowSection) {
                originalShowSection(sectionId);
            }
            if (sectionId === 'projects' && !window.projectsInitialized) {
                // Always reload from cloud when switching to projects tab
                console.log('Initializing projects section...');
                setTimeout(initializeProjects, 100);
                window.projectsInitialized = true;
            } else if (sectionId === 'projects') {
                // Just refresh if already initialized
                loadProjects(false);
            }
        };
        
        // Auto-reload data when page becomes visible (user returns to tab)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page is now visible - only reload if been away for a while
                const projectsSection = document.getElementById('projects-section');
                if (projectsSection && projectsSection.style.display !== 'none') {
                    const now = Date.now();
                    const lastLoad = window.lastProjectsLoad || 0;
                    const timeSinceLastLoad = now - lastLoad;
                    
                    // Only reload if it's been more than 30 seconds
                    if (timeSinceLastLoad > 30000) {
                        console.log('Page became visible after 30s, refreshing data...');
                        loadProjects(false); // Don't show loading spinner
                        window.lastProjectsLoad = now;
                    }
                }
            }
        });
        
        // Also reload on window focus (when user switches back to this window)
        window.addEventListener('focus', function() {
            const projectsSection = document.getElementById('projects-section');
            if (projectsSection && projectsSection.style.display !== 'none') {
                const now = Date.now();
                const lastLoad = window.lastProjectsLoad || 0;
                const timeSinceLastLoad = now - lastLoad;
                
                // Only reload if it's been more than 30 seconds
                if (timeSinceLastLoad > 30000) {
                    console.log('Window focused after 30s, refreshing data...');
                    // Debounce to avoid multiple reloads
                    clearTimeout(window.reloadTimeout);
                    window.reloadTimeout = setTimeout(() => {
                        loadProjects(false); // Don't show loading spinner
                        window.lastProjectsLoad = Date.now();
                    }, 500);
                }
            }
        });
    });
    
    function showProjectSpecifications(projectId = null, mode = 'new') {
        const projectEditorSection = document.getElementById('project-editor-section');
        const projectEditorTitle = document.getElementById('project-editor-title');
        const projectEditorContent = document.getElementById('project-editor-content');
        
        // Set the title based on mode
        if (mode === 'edit') {
            projectEditorTitle.textContent = 'Edit Project';
        } else {
            projectEditorTitle.textContent = 'View Project';
        }
        
        // Build URL with parameters
        let url = '/project-specifications';
        const params = [];
        if (projectId) params.push('project=' + projectId);
        if (mode) params.push('mode=' + mode);
        if (params.length > 0) url += '?' + params.join('&');
        
        // Calculate optimal height based on viewport
        const viewportHeight = window.innerHeight;
        const headerHeight = 250; // Approximate header and padding
        const optimalHeight = Math.max(600, viewportHeight - headerHeight);
        
        // Update container height
        projectEditorContent.style.height = `${optimalHeight}px`;
        projectEditorContent.style.minHeight = `${optimalHeight}px`;
        
        // Create or update iframe in the content area
        let iframe = projectEditorContent.querySelector('iframe');
        if (!iframe) {
            iframe = document.createElement('iframe');
            iframe.style.cssText = `
                width: 100%;
                height: 100%;
                border: none;
                border-radius: 8px;
                background: white;
            `;
            projectEditorContent.innerHTML = '';
            projectEditorContent.appendChild(iframe);
        }
        
        // Update iframe source and show the editor section
        iframe.src = url;
        projectEditorSection.style.display = 'block';
        
        // Scroll to the editor section
        projectEditorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // Add resize listener to adjust on window resize
        const resizeHandler = () => {
            const newHeight = Math.max(600, window.innerHeight - headerHeight);
            projectEditorContent.style.height = `${newHeight}px`;
            projectEditorContent.style.minHeight = `${newHeight}px`;
        };
        
        // Remove any existing resize listener and add new one
        window.removeEventListener('resize', window.projectEditorResizeHandler);
        window.projectEditorResizeHandler = resizeHandler;
        window.addEventListener('resize', resizeHandler);
    }
    
    function closeProjectEditor() {
        const projectEditorSection = document.getElementById('project-editor-section');
        const projectEditorContent = document.getElementById('project-editor-content');
        
        // Hide the editor section
        projectEditorSection.style.display = 'none';
        
        // Clear iframe source to stop any running scripts
        const iframe = projectEditorContent.querySelector('iframe');
        if (iframe) {
            iframe.src = 'about:blank';
        }
        
        // Remove resize listener
        if (window.projectEditorResizeHandler) {
            window.removeEventListener('resize', window.projectEditorResizeHandler);
            window.projectEditorResizeHandler = null;
        }
    }
    
    // Legacy function for compatibility
    function closeProjectSpecifications() {
        closeProjectEditor();
    }
    
    // Document link hover effects
    document.addEventListener('DOMContentLoaded', function() {
        // Add hover effects to document links
        const docLinks = document.querySelectorAll('.doc-link');
        docLinks.forEach(link => {
            link.addEventListener('mouseenter', function() {
                this.style.background = 'rgba(96, 165, 250, 0.2)';
                this.style.transform = 'translateX(5px)';
            });
            link.addEventListener('mouseleave', function() {
                this.style.background = 'rgba(96, 165, 250, 0.1)';
                this.style.transform = 'translateX(0)';
            });
        });
        
        // FAQ details animation
        const detailsElements = document.querySelectorAll('details');
        detailsElements.forEach(details => {
            details.addEventListener('toggle', function() {
                const icon = this.querySelector('.fa-chevron-down');
                if (icon) {
                    if (this.open) {
                        icon.style.transform = 'rotate(180deg)';
                    } else {
                        icon.style.transform = 'rotate(0deg)';
                    }
                }
            });
        });
    });
    
    // Securitization Engine Functions
    let currentProjectData = null;
    let currentPermProjectData = null;
    let permutationResults = [];
    
    // Fetch projects from API
    function fetchProjects() {
        fetch('/api/project-specifications/list')
            .then(response => response.json())
            .then(data => {
                const selector = document.getElementById('project-selector');
                selector.innerHTML = '<option value="">Select a Project...</option>';
                
                if (data.specifications && data.specifications.length > 0) {
                    data.specifications.forEach(spec => {
                        const option = document.createElement('option');
                        option.value = spec.id;
                        option.textContent = `${spec.project_code} - ${spec.project_name}`;
                        option.dataset.spec = JSON.stringify(spec);
                        selector.appendChild(option);
                    });
                } else {
                    selector.innerHTML = '<option value="">No projects available</option>';
                }
            })
            .catch(error => {
                console.error('Error fetching projects:', error);
                alert('Failed to fetch projects');
            });
    }
    
    // Load project data when selected
    function loadProjectData() {
        const selector = document.getElementById('project-selector');
        const selectedOption = selector.options[selector.selectedIndex];
        
        if (selectedOption.value) {
            try {
                currentProjectData = JSON.parse(selectedOption.dataset.spec);
                
                // Display imported data
                const preview = document.getElementById('project-data-preview');
                const display = document.getElementById('imported-data-display');
                
                display.innerHTML = `
                    <div><strong>Project:</strong> ${currentProjectData.project_name}</div>
                    <div><strong>Location:</strong> ${currentProjectData.project_location}</div>
                    <div><strong>Total CapEx:</strong> £${(currentProjectData.capex_total || 0).toLocaleString()}</div>
                    <div><strong>Land Cost:</strong> £${(currentProjectData.capex_land_purchase || 0).toLocaleString()}</div>
                    <div><strong>Building Cost:</strong> £${(currentProjectData.capex_building || 0).toLocaleString()}</div>
                    <div><strong>Infrastructure:</strong> £${(currentProjectData.capex_infrastructure || 0).toLocaleString()}</div>
                    <div><strong>IT Equipment:</strong> £${(currentProjectData.capex_it_equipment || 0).toLocaleString()}</div>
                    <div><strong>Offtaker:</strong> ${currentProjectData.offtaker_name || 'N/A'}</div>
                    <div><strong>Rent per kWh:</strong> £${currentProjectData.offtaker_rent_per_kwh || 0}</div>
                `;
                
                preview.style.display = 'block';
                
                // Auto-populate pool size with total CapEx
                document.getElementById('sec-pool-size').value = currentProjectData.capex_total || 0;
                
                // Set asset type to datacenter since we're dealing with data center projects
                document.getElementById('sec-asset-type').value = 'datacenter';
                
            } catch (error) {
                console.error('Error loading project data:', error);
            }
        } else {
            document.getElementById('project-data-preview').style.display = 'none';
            currentProjectData = null;
        }
    }
    
    // Run securitization engine
    function runSecuritization() {
        const assetType = document.getElementById('sec-asset-type').value;
        const poolSize = document.getElementById('sec-pool-size').value;
        const numTranches = document.getElementById('sec-tranches').value;
        const method = document.getElementById('sec-method').value;
        
        if (!poolSize) {
            alert('Please enter a pool size or load project data');
            return;
        }
        
        // Update status
        document.getElementById('sec-status').textContent = 'Running...';
        document.getElementById('sec-status').style.color = '#60a5fa';
        
        const startTime = Date.now();
        
        // Prepare parameters
        const params = {
            assetType: assetType,
            poolData: currentProjectData || { principal: poolSize },
            numTranches: numTranches,
            structMethod: method,
            stressTest: false,
            regulatory: true
        };
        
        // Call securitization API
        fetch('/api/securitization/calculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(params)
        })
        .then(response => response.json())
        .then(data => {
            const runtime = ((Date.now() - startTime) / 1000).toFixed(2);
            document.getElementById('sec-runtime').textContent = `${runtime}s`;
            document.getElementById('sec-status').textContent = 'Complete';
            document.getElementById('sec-status').style.color = '#22c55e';
            
            // Display results
            displaySecuritizationResults(data);
        })
        .catch(error => {
            console.error('Error running securitization:', error);
            document.getElementById('sec-status').textContent = 'Error';
            document.getElementById('sec-status').style.color = '#ef4444';
            alert('Failed to run securitization');
        });
    }
    
    // Display securitization results
    function displaySecuritizationResults(data) {
        if (data.results) {
            // Update metrics
            const metrics = data.results.performance || {};
            document.getElementById('metric-irr').textContent = metrics.expected_return || '--%';
            document.getElementById('metric-rating').textContent = data.results.tranches ? 
                data.results.tranches[0].rating || '--' : '--';
            document.getElementById('metric-leverage').textContent = metrics.leverage_ratio || '--x';
            document.getElementById('metric-coverage').textContent = metrics.coverage_ratio || '--x';
            
            // Display capital stack
            const vizContainer = document.getElementById('capital-stack-viz');
            let stackHtml = '<div style="max-width: 600px; margin: 0 auto;">';
            
            if (data.results.tranches && data.results.tranches.length > 0) {
                stackHtml += '<h4 style="color: #60a5fa; margin-bottom: 1rem;">Capital Stack Structure</h4>';
                
                data.results.tranches.forEach((tranche, index) => {
                    const color = index === 0 ? '#22c55e' : index === 1 ? '#60a5fa' : '#ffd700';
                    stackHtml += `
                        <div style="background: linear-gradient(135deg, ${color}22, ${color}11); 
                                    border: 1px solid ${color}; border-radius: 8px; 
                                    padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: ${color}; font-weight: bold; font-size: 1.1rem;">
                                        ${tranche.name}
                                    </div>
                                    <div style="color: #94a3b8; font-size: 0.9rem; margin-top: 0.25rem;">
                                        Rating: ${tranche.rating} | Subordination: ${tranche.subordination}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: ${color}; font-size: 1.5rem; font-weight: bold;">
                                        ${tranche.size}
                                    </div>
                                    <div style="color: #94a3b8; font-size: 0.9rem;">
                                        Coupon: ${tranche.coupon}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            stackHtml += '</div>';
            vizContainer.innerHTML = stackHtml;
        }
    }
    
    // Run stress test
    function runStressTest() {
        if (!currentProjectData && !document.getElementById('sec-pool-size').value) {
            alert('Please load project data or enter parameters first');
            return;
        }
        alert('Stress testing functionality coming soon');
    }
    
    // Generate report
    function generateReport() {
        alert('Report generation functionality coming soon');
    }
    
    // Reset securitization
    function resetSecuritization() {
        document.getElementById('sec-asset-type').value = 'datacenter';
        document.getElementById('sec-pool-size').value = '';
        document.getElementById('sec-tranches').value = '3';
        document.getElementById('sec-method').value = 'waterfall';
        document.getElementById('project-selector').value = '';
        document.getElementById('project-data-preview').style.display = 'none';
        document.getElementById('sec-status').textContent = 'Ready';
        document.getElementById('sec-status').style.color = '#ffd700';
        document.getElementById('sec-runtime').textContent = '--:--';
        
        // Reset metrics
        document.getElementById('metric-irr').textContent = '--%';
        document.getElementById('metric-rating').textContent = '--';
        document.getElementById('metric-leverage').textContent = '--x';
        document.getElementById('metric-coverage').textContent = '--x';
        
        // Reset visualization
        document.getElementById('capital-stack-viz').innerHTML = `
            <div style="text-align: center; color: #64748b; padding: 3rem;">
                <i class="fas fa-layer-group" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <p>No securitization results yet</p>
                <p style="margin-top: 0.5rem; font-size: 0.9rem;">Configure parameters and run securitization</p>
            </div>
        `;
        
        currentProjectData = null;
    }
    
    // Load from permutation engine
    function loadFromPermutation() {
        // Get the current project from the projects section
        if (window.projectsData && window.projectsData.length > 0) {
            const firstProject = window.projectsData[0];
            
            // Map project data to securitization inputs
            if (firstProject.grossITLoad) {
                document.getElementById('sec-pool-size').value = firstProject.value || 100000000;
            }
            
            // Load project parameters if available
            if (firstProject.capexCost) {
                const capexField = document.getElementById('sec-capex');
                if (capexField) capexField.value = firstProject.capexCost;
            }
            
            if (firstProject.opex) {
                const opexField = document.getElementById('sec-opex');
                if (opexField) opexField.value = firstProject.opex;
            }
            
            alert('Project data loaded from Projects tool');
        } else {
            alert('No projects available. Please create a project first in the Projects section.');
        }
    }
    
    // Load template
    function loadTemplate() {
        document.getElementById('sec-pool-size').value = '100000000';
        document.getElementById('sec-tranches').value = '3';
        document.getElementById('sec-method').value = 'waterfall';
        alert('Template loaded with default values');
    }
    
    // Apply project data to permutation engine
    async function applyProjectToPermutation(event) {
        try {
            // Show loading state
            const button = event ? event.target : document.querySelector('button[onclick*="applyProjectToPermutation"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading Projects...';
            button.disabled = true;
            
            // Fetch all projects from cloud database (admin only)
            const response = await fetch('/api/permutation/projects');
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'Failed to load projects');
            }
            
            if (data.projects && data.projects.length > 0) {
                // Create a modal to select project
                const modalHtml = `
                    <div id="project-select-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: #1e293b; border-radius: 12px; padding: 2rem; max-width: 600px; max-height: 80vh; overflow-y: auto; border: 1px solid #60a5fa;">
                            <h3 style="color: #60a5fa; margin-bottom: 1.5rem;">Select Project to Load</h3>
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${data.projects.map(project => `
                                    <div onclick="loadProjectToPermutation('${project.projectId}')" style="padding: 1rem; margin-bottom: 0.5rem; background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                                        <div style="color: #e2e8f0; font-weight: 600;">${project.title || 'Untitled Project'}</div>
                                        <div style="color: #94a3b8; font-size: 0.85rem; margin-top: 0.25rem;">
                                            Owner: ${project.owner} | Status: ${project.status || 'draft'}
                                        </div>
                                        <div style="color: #60a5fa; font-size: 0.85rem; margin-top: 0.25rem;">
                                            ${project.currency} | ${project.grossITLoad} MW | PUE: ${project.pue}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <button onclick="document.getElementById('project-select-modal').remove()" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: rgba(239, 68, 68, 0.8); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            } else {
                alert('No projects available in the system.');
            }
            
            // Restore button
            button.innerHTML = originalText;
            button.disabled = false;
            
        } catch (error) {
            console.error('Error loading projects:', error);
            alert('Failed to load projects: ' + error.message);
            
            // Restore button
            if (button) {
                button.innerHTML = '<i class="fas fa-download"></i> Load Project from Projects Tool';
                button.disabled = false;
            }
        }
    }
    
    // Load specific project to permutation engine
    async function loadProjectToPermutation(projectId) {
        try {
            // Close modal
            const modal = document.getElementById('project-select-modal');
            if (modal) modal.remove();
            
            // Fetch specific project details
            const response = await fetch(`/api/permutation/project/${projectId}`);
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'Failed to load project');
            }
            
            const project = data.project.data;
            
            // Map project fields to permutation inputs - using correct field names
            const mappings = {
                'GrossITLoad_02': project.grossITLoad || project.meta?.grossITLoadMW || 100,
                'PUE_03': project.pue || project.meta?.pue || 1.3,
                'GrossMonthlyRent_07': project.grossMonthlyRent || project.meta?.grossMonthlyRent || 2500000,
                'OPEX_08': project.opex || ((project.meta?.opexPercent || 0.25) * 100) // Already in percentage or convert
            };
            
            // Additional fields from project data if they exist in permutation engine
            if (project.capexCost && document.getElementById('CapexCostPrice_04')) {
                mappings['CapexCostPrice_04'] = project.capexCost;
            }
            if (project.capexRate && document.getElementById('CapexMarketRate_05')) {
                mappings['CapexMarketRate_05'] = project.capexRate;
            }
            if (project.landFees && document.getElementById('LandPurchaseFees_06')) {
                mappings['LandPurchaseFees_06'] = project.landFees;
            }
            
            // Log the project data for debugging
            console.log('Project data received:', project);
            console.log('Mapping to permutation fields:', mappings);
            
            // Apply values to inputs
            for (const [fieldId, value] of Object.entries(mappings)) {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = value;
                    field.dispatchEvent(new Event('input'));
                }
            }
            
            // Update project info display
            const projectInfo = document.getElementById('project-info');
            const projectName = document.getElementById('project-name');
            if (projectInfo && projectName) {
                projectName.textContent = `${project.meta?.projectTitle || 'Untitled'} (${data.project.owner})`;
                projectInfo.style.display = 'block';
            }
            
            // Save a snapshot of the project data to the permutation engine
            try {
                const snapshotResponse = await fetch('/api/permutation/snapshot', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        projectId: projectId,
                        projectData: project,
                        mappedValues: mappings
                    })
                });
                
                if (snapshotResponse.ok) {
                    console.log('Snapshot saved for permutation engine');
                }
            } catch (error) {
                console.error('Failed to save snapshot:', error);
            }
            
            console.log('Project loaded to permutation engine:', project);
            alert(`Project "${project.meta?.projectTitle || 'Untitled'}" loaded successfully!`);
            
        } catch (error) {
            console.error('Error loading project:', error);
            alert('Failed to load project: ' + error.message);
        }
    }
    
    // Initialize securitization on page load
    window.addEventListener('load', function() {
        // Auto-fetch projects if on securitization section
        if (window.location.hash === '#securitization') {
            console.log('Loading securitization projects...');
            fetchProjects();
        }
    });
    
    // Permutation Engine Functions
    let permutationInputs = {
        fixed: {},
        calculated: {},
        variable: {}
    };
    
    // Update permutation estimate in real-time
    function updatePermutationEstimate() {
        // Early return - PermutationEngine is not properly initialized
        console.log('updatePermutationEstimate called but PermutationEngine not available');
        return;
        
        /* Disabled until PermutationEngine is fixed
        if (!window.PermutationEngine || typeof window.PermutationEngine.getCurrentRanges !== 'function') {
            console.log('PermutationEngine not available yet');
            return;
        }
        */
        
        // Get current ranges from the engine
        const ranges = PermutationEngine.getCurrentRanges();
        
        // Calculate total permutations
        let totalPermutations = 1;
        Object.values(ranges).forEach(range => {
            totalPermutations *= range.length;
        });
        
        // Get minimum funding requirement
        const minFundingElement = document.getElementById('min-funding-required');
        const minFunding = minFundingElement ? parseFloat(minFundingElement.value) || 0 : 0;
        
        // Estimate viable permutations based on constraints
        let viableEstimate = totalPermutations;
        
        // Apply constraint reductions
        // Lease-tenor matching reduces by ~85% (only matching pairs are valid)
        viableEstimate *= 0.15;
        
        // Funding requirement reduces by another ~30%
        if (minFunding > 0) {
            viableEstimate *= 0.7;
        }
        
        // DSCR and IRR requirements reduce by another ~50%
        viableEstimate *= 0.5;
        
        viableEstimate = Math.floor(viableEstimate);
        const excludedPermutations = totalPermutations - viableEstimate;
        const reductionPercentage = totalPermutations > 0 ? 
            ((excludedPermutations / totalPermutations) * 100).toFixed(1) : 0;
        
        // Update display
        document.getElementById('total-permutations').textContent = totalPermutations.toLocaleString();
        document.getElementById('viable-permutations').textContent = viableEstimate.toLocaleString();
        document.getElementById('excluded-permutations').textContent = excludedPermutations.toLocaleString();
        document.getElementById('reduction-percentage').textContent = reductionPercentage + '%';
        
        // Color code based on permutation count
        const totalElement = document.getElementById('total-permutations');
        if (totalPermutations > 100000) {
            totalElement.style.color = '#ef4444'; // Red for too many
        } else if (totalPermutations > 10000) {
            totalElement.style.color = '#ffd700'; // Yellow for caution
        } else {
            totalElement.style.color = '#22c55e'; // Green for good
        }
    }
    
    // Run only viable permutations
    function runViablePermutations() {
        const minFundingElement = document.getElementById('min-funding-required');
        const minFunding = minFundingElement ? parseFloat(minFundingElement.value) : 0;
        if (!minFunding) {
            alert('Please set the minimum funding required to filter viable permutations');
            return;
        }
        
        // Show loading
        document.getElementById('sec-status').textContent = 'Generating viable permutations...';
        
        // Run permutation engine with constraints
        const results = PermutationEngine.generatePermutations({
            onlyViable: true,
            minFunding: minFunding,
            maxPermutations: 10000
        });
        
        // Display results
        displayPermutationResults(results);
        
        console.log(`Generated ${results.viable} viable permutations out of ${results.totalGenerated} total`);
    }
    
    // Display permutation results
    function displayPermutationResults(results) {
        const container = document.getElementById('permResultsContent');
        if (!container) return;
        
        if (results.permutations.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; color: #ef4444; padding: 3rem;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <p>No viable permutations found!</p>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem;">Try adjusting your ranges or constraints</p>
                </div>
            `;
            return;
        }
        
        // Create results table
        let html = `
            <div style="margin-bottom: 1rem;">
                <span style="color: #60a5fa;">Found ${results.viable} viable permutations</span>
                <span style="color: #64748b; margin-left: 1rem;">Excluded: ${results.excluded} (${results.reductionPercent}%)</span>
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #60a5fa;">
                            <th style="padding: 0.5rem; text-align: left; color: #60a5fa;">#</th>
                            <th style="padding: 0.5rem; text-align: left; color: #60a5fa;">Monthly Rent</th>
                            <th style="padding: 0.5rem; text-align: left; color: #60a5fa;">OPEX %</th>
                            <th style="padding: 0.5rem; text-align: left; color: #60a5fa;">Senior DSCR</th>
                            <th style="padding: 0.5rem; text-align: left; color: #60a5fa;">Senior Rate</th>
                            <th style="padding: 0.5rem; text-align: left; color: #60a5fa;">Equity IRR</th>
                            <th style="padding: 0.5rem; text-align: left; color: #60a5fa;">Total Stack</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        // Show first 100 results
        results.permutations.slice(0, 100).forEach((perm, idx) => {
            html += `
                <tr style="border-bottom: 1px solid rgba(96, 165, 250, 0.2);">
                    <td style="padding: 0.5rem; color: #94a3b8;">${idx + 1}</td>
                    <td style="padding: 0.5rem; color: white;">£${(perm.GrossMonthlyRent_04 || 0).toLocaleString()}</td>
                    <td style="padding: 0.5rem; color: white;">${perm.OPEX_06 || 0}%</td>
                    <td style="padding: 0.5rem; color: white;">${(perm.TargetDSCRSenior_16 || 0).toFixed(2)}x</td>
                    <td style="padding: 0.5rem; color: white;">${perm.SeniorCoupon_17 || 0}%</td>
                    <td style="padding: 0.5rem; color: #22c55e;">${(perm.TargetEquityIRR || 0).toFixed(1)}%</td>
                    <td style="padding: 0.5rem; color: #60a5fa;">£${(perm.TotalCapitalStack || 0).toLocaleString()}</td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        if (results.permutations.length > 100) {
            html += `<p style="color: #64748b; text-align: center; margin-top: 1rem;">Showing first 100 of ${results.permutations.length} results</p>`;
        }
        
        container.innerHTML = html;
    }
    
    // Optimize ranges automatically
    function optimizeRanges() {
        // Analyze current inputs and suggest optimal ranges
        alert('Analyzing inputs to suggest optimal ranges...\n\nThis will:\n- Narrow ranges based on market conditions\n- Remove unlikely scenarios\n- Focus on fundable outcomes');
        
        // You'll implement the actual optimization logic
        // updatePermutationEstimate(); // Disabled temporarily
    }
    
    // Reset to default ranges
    function resetToDefaults() {
        // Reset all variable inputs to default ranges
        const variableInputs = document.querySelectorAll('[data-input-type="variable"]');
        variableInputs.forEach(input => {
            if (input.dataset.defaultMin && input.dataset.defaultMax) {
                // Reset to defaults
            }
        });
        
        // updatePermutationEstimate(); // Disabled temporarily
    }
    
    // Permutation Engine Project Data Functions
    function fetchPermProjects() {
        fetch('/api/project-specifications/list')
            .then(response => response.json())
            .then(data => {
                const selector = document.getElementById('perm-project-selector');
                selector.innerHTML = '<option value="">Select a Project to Import...</option>';
                
                if (data.specifications && data.specifications.length > 0) {
                    data.specifications.forEach(spec => {
                        const option = document.createElement('option');
                        option.value = spec.id;
                        option.textContent = `${spec.project_code} - ${spec.project_name}`;
                        option.dataset.spec = JSON.stringify(spec);
                        selector.appendChild(option);
                    });
                } else {
                    selector.innerHTML = '<option value="">No projects available</option>';
                }
            })
            .catch(error => {
                console.error('Error fetching projects:', error);
                alert('Failed to fetch projects');
            });
    }
    
    function loadPermProjectData() {
        const selector = document.getElementById('perm-project-selector');
        const selectedOption = selector.options[selector.selectedIndex];
        
        if (selectedOption.value) {
            try {
                currentPermProjectData = JSON.parse(selectedOption.dataset.spec);
                
                // Display preview
                const preview = document.getElementById('perm-project-preview');
                preview.innerHTML = `
                    <strong style="color: #60a5fa;">Selected Project:</strong> ${currentPermProjectData.project_name}<br>
                    <strong>CapEx Total:</strong> £${(currentPermProjectData.capex_total || 0).toLocaleString()} | 
                    <strong>Land:</strong> £${(currentPermProjectData.capex_land_purchase || 0).toLocaleString()} | 
                    <strong>Building:</strong> £${(currentPermProjectData.capex_building || 0).toLocaleString()}<br>
                    <strong>Infrastructure:</strong> £${(currentPermProjectData.capex_infrastructure || 0).toLocaleString()} | 
                    <strong>IT Equipment:</strong> £${(currentPermProjectData.capex_it_equipment || 0).toLocaleString()}<br>
                    <strong>Offtaker:</strong> ${currentPermProjectData.offtaker_name || 'N/A'} | 
                    <strong>Rent:</strong> £${currentPermProjectData.offtaker_rent_per_kwh || 0}/kWh
                `;
                preview.style.display = 'block';
            } catch (error) {
                console.error('Error loading project data:', error);
            }
        } else {
            document.getElementById('perm-project-preview').style.display = 'none';
            currentPermProjectData = null;
        }
    }
    
    function applyProjectDataToPermutation() {
        if (!currentPermProjectData) {
            alert('Please select a project first');
            return;
        }
        
        // Load project data into the permutation engine
        if (window.PermutationEngine) {
            PermutationEngine.loadProjectData(currentPermProjectData);
            
            // Update the estimate display
            // updatePermutationEstimate(); // Disabled temporarily
            
            // Show success message
            const message = document.createElement('div');
            message.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 1rem 2rem; border-radius: 8px; z-index: 10000; font-weight: 600;';
            message.innerHTML = `
                <div style="text-align: center;">
                    <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                    <div>Project data loaded into engine!</div>
                    <div style="font-size: 0.9rem; margin-top: 0.5rem;">83 inputs configured</div>
                </div>
            `;
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 3000);
            
            console.log('Project data applied to permutation engine:', currentPermProjectData);
        }
    }
    
    // Initialize permutation engine on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Delay initialization to ensure all elements are loaded
        setTimeout(function() {
            // Temporarily disable PermutationEngine initialization to prevent errors
            // TODO: Fix PermutationEngine object creation
            console.log('Permutation Engine initialization disabled temporarily');
        }, 100);
    });
    </script>
    
    <!-- Market News Script -->
    <script src="/static/js/market-news.js"></script>
    
    <!-- Market Tab Switching Function -->
    <script>
    function showMarketTab(tabName) {
        // Hide all tab contents
        const tabContents = document.querySelectorAll('.market-tab-content');
        tabContents.forEach(tab => {
            tab.style.display = 'none';
        });
        
        // Show selected tab
        const selectedTab = document.getElementById('market-tab-' + tabName);
        if (selectedTab) {
            selectedTab.style.display = 'block';
        }
        
        // Update button styles
        const tabButtons = document.querySelectorAll('.market-tab-btn');
        tabButtons.forEach(btn => {
            btn.style.background = 'transparent';
            btn.style.color = '#60a5fa';
            btn.style.border = '1px solid #60a5fa';
        });
        
        // Highlight active button
        event.target.style.background = '#60a5fa';
        event.target.style.color = 'white';
    }
    </script>
    
    <!-- Smooth Keyboard Scrolling -->
    <script src="{{ url_for('static', filename='js/smooth-scroll.js') }}"></script>
    
    <!-- Permutation Engine Core -->
    <script src="{{ url_for('static', filename='js/permutation-engine.js') }}"></script>
    
    <!-- FORCE DARK BLUE COLOR v2 - FINAL FIX -->
    <style>
        /* DARK BLUE FOR EVERYTHING */
        .card, 
        div.card,
        .card.shadow-lg,
        .card.fade-in-up,
        .stat-card,
        div.stat-card,
        .stat-card.hover-lift,
        div[class*="card"] {
            background: linear-gradient(135deg, #0a0e27, #020617) !important;
            background-image: linear-gradient(135deg, #0a0e27, #020617) !important;
        }
        
        /* Override Bootstrap card backgrounds */
        .card:not(.stat-card) {
            background: linear-gradient(135deg, #0a0e27, #020617) !important;
        }
        
        /* Fix table to show dark blue background */
        .table-dark {
            background-color: transparent !important;
        }
        .table-dark th,
        .table-dark td {
            background-color: transparent !important;
        }
        .table-dark tbody tr:hover td {
            background-color: rgba(30, 58, 138, 0.2) !important;
        }
        
        /* Fix any remaining sections */
        [style*="background: linear-gradient(135deg, #60a5fa"] {
            background: linear-gradient(135deg, #0a0e27, #020617) !important;
        }
        
        /* Market Ticker Animation */
        @keyframes scroll-left {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(-50%);
            }
        }
        
        #live-ticker {
            white-space: nowrap;
        }
        
        #live-ticker span {
            display: inline-block;
            padding-right: 3rem;
        }
    </style>
</body>
</html>