<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>AtlasNexus - Securitisation Command Centre</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="alternate icon" href="/favicon.ico">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700;800&family=SF+Pro+Text:wght@400;500;600&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Modern Financial Institution Palette */
            --deep-charcoal: #1A1D23;
            --slate-grey: #2C3137;
            --steel-blue: #364049;
            --silver-mist: #92969C;
            --silver-light: #B8C0C8;
            --pearl-grey: #E5E9F0;
            --pure-white: #FFFFFF;
            
            /* Accent Colors */
            --platinum-gold: #60a5fa;
            --amber-yellow: #93c5fd;
            --market-green: #22C55E;
            --market-red: #EF4444;
            --emerald-green: #059669;
            --crimson-red: #B91C1C;
            --royal-blue: #4169E1;
            
            /* Typography */
            --font-display: 'SF Pro Display', -apple-system, system-ui, sans-serif;
            --font-text: 'SF Pro Text', -apple-system, system-ui, sans-serif;
            --font-mono: 'JetBrains Mono', 'Courier New', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-text);
            background: var(--deep-charcoal);
            color: var(--pearl-grey);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
        }
        
        /* Global text color fixes for dark theme */
        .text-muted {
            color: #B8C0C8 !important; /* Light silver for muted text */
        }
        
        .text-secondary {
            color: #92969C !important; /* Medium silver for secondary text */
        }
        
        .small {
            color: #B8C0C8 !important; /* Ensure small text is visible */
        }
        
        label {
            color: #B8C0C8 !important; /* Ensure labels are visible */
        }
        
        /* Override Bootstrap dark text colors */
        .text-dark {
            color: #E5E9F0 !important;
        }
        
        /* Ensure all headings are visible */
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
            color: #E5E9F0 !important;
        }
        
        /* Table text colors */
        .table-dark {
            color: #E5E9F0 !important;
        }
        
        .table-dark th,
        .table-dark td {
            color: #E5E9F0 !important;
        }
        
        /* Ensure all paragraph text is visible */
        p {
            color: #B8C0C8 !important;
        }
        
        /* Fix any remaining dark text */
        div, span {
            color: inherit;
        }

        /* Premium Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0F1419 0%, #1A2332 100%);
            z-index: -2;
        }

        /* Animated Mesh Gradient */
        .gradient-mesh {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.4;
            z-index: -1;
            background: 
                radial-gradient(circle at 20% 50%, rgba(96, 165, 250, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(65, 105, 225, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(34, 197, 94, 0.1) 0%, transparent 50%);
            animation: meshMove 20s ease-in-out infinite;
        }

        @keyframes meshMove {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(-20px, -20px) rotate(1deg); }
            66% { transform: translate(20px, -10px) rotate(-1deg); }
        }

        /* Premium Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--steel-blue) 0%, var(--slate-grey) 100%);
            border-bottom: 2px solid var(--platinum-gold);
            z-index: 1000;
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
            height: 70px;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Market Ticker - Working version from Gate2 */
        .market-ticker-container {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            width: 100%;
            overflow: hidden;
            background: linear-gradient(90deg, #1a1d23 0%, #0f1419 100%);
            border-top: 1px solid rgba(96, 165, 250, 0.3);
            border-bottom: 1px solid rgba(96, 165, 250, 0.3);
            padding: 12px 0;
            cursor: grab;
            user-select: none;
            height: auto;
            min-height: 45px;
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .market-ticker-container.dragging {
            cursor: grabbing;
        }

        .market-ticker {
            display: flex;
            width: max-content;
            will-change: transform;
            transition: transform 0.5s linear;
            padding-left: 0;
            margin-left: 0;
        }

        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .ticker-content {
            display: flex;
            width: max-content;
        }
        
        .ticker-group {
            display: flex;
            gap: 2rem;
            padding-right: 2rem;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .ticker-item {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0 1rem;
            border-right: 1px solid rgba(96, 165, 250, 0.2);
            white-space: nowrap;
        }

        .ticker-symbol {
            font-weight: 700;
            color: #93c5fd;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .ticker-value {
            color: #ffffff;
            font-size: 0.85rem;
            font-family: var(--font-mono);
        }

        .ticker-section-header {
            display: inline-block;
            padding: 0 1rem;
            color: var(--platinum-gold);
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .ticker-symbol {
            font-weight: 700;
            color: #93c5fd !important;
            font-size: 0.85rem;
            font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif;
            display: inline-block;
            text-transform: uppercase;
        }
        
        .ticker-value {
            color: #ffffff !important;
            font-size: 0.85rem;
            font-family: 'JetBrains Mono', monospace;
            display: inline-block;
        }
        
        .ticker-section-header {
            display: inline-block;
            padding: 0 1rem;
            color: #60a5fa;
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .ticker-separator {
            color: rgba(96, 165, 250, 0.4);
            margin: 0 0.5rem;
        }

        /* Main Container */
        .main-container {
            margin-top: 165px; /* Account for header + ticker + nav bar */
            padding: 2rem;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Animation Classes */
        .fade-in-up {
            animation: fadeInUp 0.8s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .animated-atlas-nexus {
            animation: gradientShift 3s ease infinite;
            background-size: 200% 200%;
        }

        .hover-lift {
            transition: all 0.3s ease;
        }

        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* Cards */
        .card {
            background: linear-gradient(135deg, rgba(44, 49, 55, 0.95) 0%, rgba(54, 64, 73, 0.95) 100%);
            border: 1px solid rgba(96, 165, 250, 0.2);
            backdrop-filter: blur(10px);
            color: #E5E9F0 !important; /* Ensure light text color */
        }
        
        .card-body {
            color: #E5E9F0 !important; /* Light text for card bodies */
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(44, 49, 55, 0.9) 0%, rgba(54, 64, 73, 0.9) 100%);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            color: #E5E9F0 !important; /* Ensure light text color */
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--platinum-gold);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            /* Fix header for mobile */
            .header {
                flex-direction: column;
                padding: 15px;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 1000;
            }
            
            .header-left {
                margin-bottom: 10px;
                text-align: center;
            }
            
            .header-right {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .header-btn {
                width: 100%;
                padding: 10px !important;
                font-size: 0.9rem !important;
            }
            
            /* Fix ticker for mobile */
            .market-ticker-container {
                top: 100px !important;
                height: 40px;
                min-height: 40px;
                padding: 8px 0;
            }
            
            .market-ticker {
                font-size: 0.75rem;
            }
            
            .ticker-item {
                margin: 0 8px !important;
            }
            
            /* Fix toolbar for mobile */
            .toolbar {
                top: 140px !important;
                padding: 10px;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .nav-btn {
                padding: 8px 12px !important;
                font-size: 0.8rem !important;
                min-width: auto;
            }
            
            /* Fix main container for mobile */
            .main-container {
                margin-top: 200px !important;
                padding: 1rem;
            }
            
            /* Fix cards for mobile */
            .card {
                margin-bottom: 15px;
            }
            
            .card-body {
                padding: 15px !important;
            }
            
            /* Fix stats cards for mobile */
            .stats-card {
                padding: 15px !important;
            }
            
            .stats-card h3 {
                font-size: 1.5rem !important;
            }
            
            .stats-card p {
                font-size: 0.8rem !important;
            }
            
            /* Fix footer for mobile */
            footer {
                padding: 20px 10px !important;
            }
            
            footer .container {
                padding: 0 !important;
            }
            
            footer h4 {
                font-size: 1rem !important;
            }
            
            footer a {
                font-size: 0.85rem !important;
            }
            
            /* Hide some elements on mobile for cleaner view */
            .desktop-only {
                display: none !important;
            }
            
            /* Fix sections for mobile */
            #market-section, #data-section, #analytics-section, 
            #risk-section, #portfolio-section, #compliance-section {
                padding: 200px 1rem 2rem !important;
            }
            
            /* Fix dropdown for mobile */
            .dropdown-content {
                width: 100%;
                right: 0;
                left: 0;
            }
            
            /* Fix chart container for mobile */
            canvas {
                max-width: 100% !important;
                height: auto !important;
            }
            
            /* Fix table responsiveness */
            table {
                font-size: 0.8rem;
            }
            
            th, td {
                padding: 8px !important;
            }
            
            /* Fix modals for mobile */
            .modal-content {
                width: 95% !important;
                margin: 10px !important;
            }
        }
        
        @media (max-width: 480px) {
            /* Extra small devices */
            .header {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.2rem !important;
            }
            
            .market-ticker-container {
                font-size: 0.65rem;
            }
            
            .toolbar {
                padding: 8px 5px;
            }
            
            .nav-btn {
                padding: 6px 10px !important;
                font-size: 0.75rem !important;
            }
            
            .main-container {
                padding: 0.5rem;
            }
            
            .card-title {
                font-size: 1rem !important;
            }
            
            footer {
                font-size: 0.8rem;
            }
        }
        
        /* Ensure horizontal scrolling is prevented */
        body {
            overflow-x: hidden;
        }
        
        /* Mobile-specific utility classes */
        @media (max-width: 768px) {
            .mobile-center {
                text-align: center !important;
            }
            
            .mobile-full-width {
                width: 100% !important;
            }
            
            .mobile-padding {
                padding: 10px !important;
            }
            
            .hide-mobile {
                display: none !important;
            }
        }
        
        @media (min-width: 769px) {
            .show-mobile {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Animated Gradient Mesh -->
    <div class="gradient-mesh"></div>

    <!-- Header from Gate2 -->
    <header class="header">
        <div class="header-content">
            <!-- Logo from Gate2 -->
            <div class="logo" style="display: flex; align-items: center; gap: 12px;">
                <div style="position: relative; width: 32px; height: 32px;">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" style="overflow: visible;">
                        <!-- Rotating hexagon -->
                        <path d="M16 3L26.5 9.5V22.5L16 29L5.5 22.5V9.5L16 3Z" stroke="#93c5fd" stroke-width="2" fill="rgba(147, 197, 253, 0.08)">
                            <animateTransform attributeName="transform" type="rotate" from="0 16 16" to="360 16 16" dur="8s" repeatCount="indefinite"/>
                        </path>
                        <!-- Inner hexagon -->
                        <path d="M16 8L22 11.5V20.5L16 24L10 20.5V11.5L16 8Z" stroke="rgba(147, 197, 253, 0.4)" stroke-width="1"/>
                        <!-- Center circle -->
                        <circle cx="16" cy="16" r="3" fill="#dbeafe"/>
                        <!-- Orbiting dot -->
                        <g>
                            <animateTransform attributeName="transform" type="rotate" from="0 16 16" to="360 16 16" dur="3s" repeatCount="indefinite"/>
                            <circle cx="16" cy="1" r="1.5" fill="#60a5fa">
                                <animate attributeName="opacity" values="0.4;1;0.4" dur="1.5s" repeatCount="indefinite"/>
                            </circle>
                        </g>
                    </svg>
                </div>
                <div style="display: flex; align-items: center;">
                    <span style="font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif; font-size: 1.35rem; font-weight: 700; background: linear-gradient(90deg, #dbeafe, #93c5fd); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ATLAS</span>
                    <span style="font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif; font-size: 1.2rem; font-weight: 400; color: #60a5fa; margin: 0 4px;">:</span>
                    <span style="font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif; font-size: 1.35rem; font-weight: 700; background: linear-gradient(90deg, #93c5fd, #dbeafe); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">NEXUS</span>
                </div>
            </div>
            <!-- User Info Section -->
            <div class="user-section" style="display: flex; align-items: center; gap: 2rem; color: rgba(255, 255, 255, 0.8);">
                <span style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                    <span style="width: 8px; height: 8px; background: #00ff00; border-radius: 50%; box-shadow: 0 0 10px #00ff00;"></span>
                    Dashboard Active
                </span>
                {% if is_admin %}
                <a href="/admin-panel" style="background: linear-gradient(90deg, #fbbf24, #f59e0b); color: white; border: none; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; margin-right: 8px; text-decoration: none; display: inline-block;">
                    <i class="fas fa-cog"></i> Control Panel
                </a>
                {% endif %}
                <a href="/logout" style="background: linear-gradient(90deg, #ef4444, #dc2626); color: white; border: none; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; text-decoration: none;">
                    Logout
                </a>
            </div>
        </div>
    </header>

    <!-- Market Ticker -->
    <div class="market-ticker-container" id="tickerContainer">
        <div class="market-ticker" id="marketTicker">
            <!-- Content populated by JavaScript -->
        </div>
    </div>

    <!-- Navigation Bar -->
    <div id="navBar" style="position: fixed; top: 115px; left: 0; right: 0; background: linear-gradient(90deg, #1e293b 0%, #334155 100%); border-bottom: 1px solid rgba(96, 165, 250, 0.3); z-index: 998; padding: 10px 0; transition: all 0.3s ease;">
        <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; flex-wrap: wrap;">
            <button class="nav-btn" data-section="dashboard" onclick="showSection('dashboard')" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; border: 1px solid #60a5fa; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-home"></i> Dashboard
            </button>
            <button class="nav-btn" data-section="market" onclick="showSection('market')" style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-chart-line"></i> Market
            </button>
            <button class="nav-btn" data-section="analytics" onclick="showSection('analytics')" style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-chart-bar"></i> Analytics
            </button>
            <button class="nav-btn" data-section="risk" onclick="showSection('risk')" style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-shield-alt"></i> Risk
            </button>
            <button class="nav-btn" data-section="portfolio" onclick="showSection('portfolio')" style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-briefcase"></i> Portfolio
            </button>
            <button class="nav-btn" data-section="compliance" onclick="showSection('compliance')" style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-gavel"></i> Compliance
            </button>
            <button class="nav-btn" data-section="permutation" onclick="showSection('permutation')" style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 6px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-cogs"></i> Engine
            </button>
        </div>
    </div>
    
    <!-- Toggle Button -->
    <button onclick="(function(){
        var nav = document.getElementById('navBar');
        var icon = document.getElementById('navToggleIcon');
        var mainDashboard = document.getElementById('main-dashboard');
        var sections = document.querySelectorAll('#market-section, #data-section, #analytics-section, #risk-section, #portfolio-section, #compliance-section, #permutation-section');
        
        if (nav.style.display === 'none') {
            // Show toolbar
            nav.style.display = 'block';
            icon.className = 'fas fa-chevron-up';
            // Adjust padding for sections when toolbar is visible
            sections.forEach(function(s) { 
                if(s) s.style.paddingTop = '140px'; 
            });
        } else {
            // Hide toolbar
            nav.style.display = 'none';
            icon.className = 'fas fa-chevron-down';
            // Reduce padding for sections when toolbar is hidden
            sections.forEach(function(s) { 
                if(s) s.style.paddingTop = '90px'; 
            });
        }
    })()" style="position: fixed; top: 115px; right: 20px; background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; z-index: 999;">
        <i class="fas fa-chevron-up" id="navToggleIcon"></i> Tools
    </button>

    <!-- Main Dashboard Content -->
    <div class="main-container" id="main-dashboard" style="display: block;">
        <!-- Executive Dashboard Header -->
        <div class="row mb-4 fade-in-up">
            <div class="col-12">
                <div class="card shadow-lg" style="border-radius: 20px;">
                    <div class="card-body p-4 text-white">
                        <div class="row align-items-center">
                            <div class="col-lg-8">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="bg-white bg-opacity-10 rounded-circle p-3 me-4">
                                        <i class="fas fa-chart-line fa-2x"></i>
                                    </div>
                                    <div>
                                        <h1 class="display-6 fw-bold mb-1">Securitisation Command Centre</h1>
                                        <p class="lead mb-0 opacity-90">
                                            <span class="animated-atlas-nexus" style="font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif; font-size: 1.1rem; font-weight: 700; background: linear-gradient(90deg, #dbeafe, #93c5fd, #60a5fa, #93c5fd, #dbeafe); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-size: 200% 200%;">ATLAS</span>
                                            <span style="font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif; font-size: 1rem; font-weight: 400; color: #60a5fa; margin: 0 4px;">:</span>
                                            <span class="animated-atlas-nexus" style="font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif; font-size: 1.1rem; font-weight: 700; background: linear-gradient(90deg, #93c5fd, #dbeafe, #60a5fa, #dbeafe, #93c5fd); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-size: 200% 200%;">NEXUS</span>
                                        </p>
                                    </div>
                                </div>
                                <div class="row g-3">
                                    <div class="col-auto">
                                        <div class="badge bg-success bg-opacity-90 text-white px-3 py-2">
                                            <i class="fas fa-circle me-2"></i>Live Markets
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="badge bg-info bg-opacity-90 text-white px-3 py-2">
                                            <i class="fas fa-user-tie me-2"></i>{{ account_type }} Access
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="badge bg-dark bg-opacity-75 text-white px-3 py-2">
                                            <i class="fas fa-calendar me-2"></i><span id="currentDate"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 text-end">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="text-center">
                                            <div class="h2 fw-bold mb-0" id="aumCounter">€127.5B</div>
                                            <small class="opacity-75">Assets Under Management</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center">
                                            <div class="h2 fw-bold mb-0" id="dealsCounter">342</div>
                                            <small class="opacity-75">Active Structures</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-Time KPI Grid -->
        <div class="row g-4 mb-4">
            <div class="col-lg-3 col-md-6 fade-in-up" style="animation-delay: 0.1s">
                <div class="stat-card hover-lift">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="small fw-semibold mb-1" style="color: #B8C0C8;">TOTAL AUM</div>
                            <div class="h3 fw-bold text-primary mb-0">€2.4B</div>
                            <div class="text-success small">
                                <i class="fas fa-arrow-up me-1"></i>+12.3% YoY
                            </div>
                        </div>
                        <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-euro-sign fa-lg text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 fade-in-up" style="animation-delay: 0.2s">
                <div class="stat-card hover-lift">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="small fw-semibold mb-1" style="color: #B8C0C8;">ACTIVE DEALS</div>
                            <div class="h3 fw-bold text-success mb-0">127</div>
                            <div class="text-info small">
                                <i class="fas fa-plus me-1"></i>8 new this week
                            </div>
                        </div>
                        <div class="bg-success bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-handshake fa-lg text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 fade-in-up" style="animation-delay: 0.3s">
                <div class="stat-card hover-lift">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="small fw-semibold mb-1" style="color: #B8C0C8;">AVG DSCR</div>
                            <div class="h3 fw-bold text-warning mb-0">1.47x</div>
                            <div class="text-success small">
                                <i class="fas fa-arrow-up me-1"></i>+0.08 vs target
                            </div>
                        </div>
                        <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-chart-bar fa-lg text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 fade-in-up" style="animation-delay: 0.4s">
                <div class="stat-card hover-lift">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="small fw-semibold mb-1" style="color: #B8C0C8;">RISK RATING</div>
                            <div class="h3 fw-bold text-info mb-0">AA-</div>
                            <div class="small" style="color: #B8C0C8;">
                                <i class="fas fa-shield-alt me-1"></i>Stable outlook
                            </div>
                        </div>
                        <div class="bg-info bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-star fa-lg text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="row g-4">
            <!-- Left Column: Market Data & Analytics -->
            <div class="col-lg-8">
                <!-- Market Overview -->
                <div class="card shadow-lg mb-4 fade-in-up" style="border-radius: 16px; animation-delay: 0.5s">
                    <div class="card-header border-0 text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px 16px 0 0;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0 fw-bold">
                                    <i class="fas fa-globe-europe me-2"></i>Live Market Overview
                                </h5>
                                <small class="opacity-90">Real-time European ABS markets</small>
                            </div>
                            <div class="badge bg-white bg-opacity-20 text-white">
                                <i class="fas fa-circle text-success me-2"></i>Live
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <div class="col-md-4">
                                <div class="text-center p-3 rounded-3 bg-dark bg-opacity-25">
                                    <div class="h4 fw-bold text-primary mb-1">€847M</div>
                                    <div class="small mb-2" style="color: #B8C0C8;">Week Issuance</div>
                                    <div class="progress" style="height: 4px;">
                                        <div class="progress-bar bg-primary" style="width: 78%"></div>
                                    </div>
                                    <small class="text-success">78% of target</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-3 rounded-3 bg-dark bg-opacity-25">
                                    <div class="h4 fw-bold text-success mb-1">1.85%</div>
                                    <div class="small mb-2" style="color: #B8C0C8;">AAA Spread</div>
                                    <div class="text-success small">
                                        <i class="fas fa-arrow-down me-1"></i>-12 bps
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-3 rounded-3 bg-dark bg-opacity-25">
                                    <div class="h4 fw-bold text-warning mb-1">€2.1B</div>
                                    <div class="small mb-2" style="color: #B8C0C8;">Pipeline</div>
                                    <div class="text-info small">
                                        <i class="fas fa-clock me-1"></i>Next 30 days
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chart Area -->
                        <div class="mt-4 p-4 bg-dark bg-opacity-25 rounded-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold text-white mb-0">Spread Evolution (Last 30 Days)</h6>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary active">AAA</button>
                                    <button class="btn btn-outline-primary">AA</button>
                                    <button class="btn btn-outline-primary">BBB</button>
                                </div>
                            </div>
                            <div style="height: 200px; display: flex; align-items: center; justify-content: center;">
                                <canvas id="spreadChart" style="max-width: 100%; max-height: 100%;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Deal Pipeline -->
                <div class="card shadow-lg fade-in-up" style="border-radius: 16px; animation-delay: 0.6s">
                    <div class="card-header border-0 text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 16px 16px 0 0;">
                        <h5 class="mb-0 fw-bold">
                            <i class="fas fa-stream me-2"></i>Active Deal Pipeline
                        </h5>
                        <small class="opacity-90">Current structures in progress</small>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th class="border-0 fw-semibold">Deal Name</th>
                                        <th class="border-0 fw-semibold">Type</th>
                                        <th class="border-0 fw-semibold">Size</th>
                                        <th class="border-0 fw-semibold">DSCR</th>
                                        <th class="border-0 fw-semibold">Status</th>
                                        <th class="border-0 fw-semibold">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="py-3">
                                            <div class="fw-semibold">European Data Centers 2024-1</div>
                                            <small style="color: #B8C0C8;">Lead: Digital Realty</small>
                                        </td>
                                        <td class="py-3">
                                            <span class="badge bg-primary bg-opacity-25 text-primary">Data Center</span>
                                        </td>
                                        <td class="py-3 fw-semibold">€450M</td>
                                        <td class="py-3">
                                            <span class="text-success fw-bold">1.52x</span>
                                        </td>
                                        <td class="py-3">
                                            <span class="badge bg-warning">Structuring</span>
                                        </td>
                                        <td class="py-3">
                                            <button class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="py-3">
                                            <div class="fw-semibold">UK Logistics Portfolio 2024-A</div>
                                            <small style="color: #B8C0C8;">Lead: Prologis UK</small>
                                        </td>
                                        <td class="py-3">
                                            <span class="badge bg-success bg-opacity-25 text-success">Logistics</span>
                                        </td>
                                        <td class="py-3 fw-semibold">€320M</td>
                                        <td class="py-3">
                                            <span class="text-success fw-bold">1.48x</span>
                                        </td>
                                        <td class="py-3">
                                            <span class="badge bg-info">Rating</span>
                                        </td>
                                        <td class="py-3">
                                            <button class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="py-3">
                                            <div class="fw-semibold">German Renewable Energy 2024-3</div>
                                            <small style="color: #B8C0C8;">Lead: RWE Renewables</small>
                                        </td>
                                        <td class="py-3">
                                            <span class="badge bg-warning bg-opacity-25 text-warning">Renewable</span>
                                        </td>
                                        <td class="py-3 fw-semibold">€680M</td>
                                        <td class="py-3">
                                            <span class="text-success fw-bold">1.65x</span>
                                        </td>
                                        <td class="py-3">
                                            <span class="badge bg-success">Marketing</span>
                                        </td>
                                        <td class="py-3">
                                            <button class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Portfolio & Risk Management -->
            <div class="col-lg-4">
                <!-- Portfolio Performance -->
                <div class="card shadow-lg mb-4 fade-in-up" style="border-radius: 16px; animation-delay: 0.7s">
                    <div class="card-header border-0 text-white" style="background: linear-gradient(135deg, #4ade80, #22c55e); border-radius: 16px 16px 0 0;">
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-briefcase me-2"></i>Portfolio Performance
                        </h6>
                        <small class="opacity-90">YTD Overview</small>
                    </div>
                    <div class="card-body p-4">
                        <div class="text-center mb-4">
                            <div class="h2 fw-bold text-success mb-1">+14.2%</div>
                            <div class="small" style="color: #B8C0C8;">Total Return YTD</div>
                            <div class="progress mt-2" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: 85%"></div>
                            </div>
                            <small class="text-success">85% of annual target</small>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="text-center p-2 bg-dark bg-opacity-25 rounded">
                                    <div class="fw-bold text-white">€1.8B</div>
                                    <small style="color: #B8C0C8;">Net Assets</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-2 bg-dark bg-opacity-25 rounded">
                                    <div class="fw-bold text-white">0.12%</div>
                                    <small style="color: #B8C0C8;">Mgmt Fee</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-2 bg-dark bg-opacity-25 rounded">
                                    <div class="fw-bold text-white">4.2%</div>
                                    <small style="color: #B8C0C8;">Yield</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-2 bg-dark bg-opacity-25 rounded">
                                    <div class="fw-bold text-white">AA-</div>
                                    <small style="color: #B8C0C8;">Rating</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Dashboard -->
                <div class="card shadow-lg mb-4 fade-in-up" style="border-radius: 16px; animation-delay: 0.8s">
                    <div class="card-header border-0 text-white" style="background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 16px 16px 0 0;">
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-shield-alt me-2"></i>Risk Monitor
                        </h6>
                        <small class="opacity-90">Real-time exposure</small>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small fw-semibold">Concentration Risk</span>
                                <span class="badge bg-success">Low</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: 25%"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small fw-semibold">Credit Risk</span>
                                <span class="badge bg-warning">Medium</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-warning" style="width: 45%"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small fw-semibold">Market Risk</span>
                                <span class="badge bg-success">Low</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: 20%"></div>
                            </div>
                        </div>
                        
                        <div class="border-top pt-3 mt-3">
                            <div class="text-center">
                                <div class="h5 fw-bold text-warning mb-1">7.2%</div>
                                <small style="color: #B8C0C8;">VaR (95%, 1D)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card shadow-lg fade-in-up mb-4" style="border-radius: 16px; animation-delay: 0.9s">
                    <div class="card-header border-0 text-white" style="background: linear-gradient(135deg, #06b6d4, #0891b2); border-radius: 16px 16px 0 0;">
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-bolt me-2"></i>Quick Actions
                        </h6>
                    </div>
                    <div class="card-body p-4">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="showNewAnalysisModal()">
                                <i class="fas fa-plus me-2"></i>New Analysis
                            </button>
                            <button class="btn btn-outline-secondary" onclick="showUploadModal()">
                                <i class="fas fa-upload me-2"></i>Upload Data
                            </button>
                            <button class="btn btn-outline-secondary" onclick="exportData()">
                                <i class="fas fa-download me-2"></i>Export Report
                            </button>
                            <button class="btn btn-outline-secondary" onclick="showSettingsModal()">
                                <i class="fas fa-cog me-2"></i>Settings
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Securitisation Engine Widget -->
                <div class="card shadow-lg fade-in-up" style="border-radius: 16px; animation-delay: 1.0s">
                    <div class="card-header border-0 text-white" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 16px 16px 0 0;">
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-cogs me-2"></i>Securitisation Engine
                        </h6>
                        <small class="opacity-90">Permutation Analysis</small>
                    </div>
                    <div class="card-body p-4">
                        <div class="text-center mb-3">
                            <div class="h3 fw-bold text-primary mb-1" id="dashboard-perm-count">0</div>
                            <div class="small" style="color: #B8C0C8;">Total Permutations</div>
                        </div>
                        
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <div class="text-center p-2 bg-success bg-opacity-10 rounded">
                                    <div class="fw-bold text-success" id="dashboard-viable-count">0</div>
                                    <small style="color: #22c55e;">Viable</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-2 bg-danger bg-opacity-10 rounded">
                                    <div class="fw-bold text-danger" id="dashboard-invalid-count">0</div>
                                    <small style="color: #ef4444;">Invalid</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-top pt-3 mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small fw-semibold">Best IRR Found</span>
                                <span class="badge bg-success" id="dashboard-best-irr">-</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small fw-semibold">Avg WACD</span>
                                <span class="badge bg-info" id="dashboard-avg-wacd">-</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="small fw-semibold">Status</span>
                                <span class="badge bg-secondary" id="dashboard-engine-status">Ready</span>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary w-100" onclick="showSection('permutation')">
                            <i class="fas fa-rocket me-2"></i>Launch Engine
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Analytics Section -->
        <div class="row g-4 mt-4">
            <div class="col-12 fade-in-up" style="animation-delay: 1s">
                <div class="card shadow-lg" style="border-radius: 20px;">
                    <div class="card-header border-0 text-white py-4" style="background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%); border-radius: 20px 20px 0 0;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h4 class="mb-1 fw-bold">
                                    <i class="fas fa-chart-area me-3"></i>Advanced Analytics Centre
                                </h4>
                                <p class="mb-0 opacity-90">Comprehensive market intelligence and portfolio optimisation</p>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-light btn-sm">
                                    <i class="fas fa-expand me-2"></i>Fullscreen
                                </button>
                                <button class="btn btn-outline-light btn-sm">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <!-- Performance Attribution -->
                            <div class="col-lg-12">
                                <div class="p-4 bg-dark bg-opacity-25 rounded-3">
                                    <h6 class="fw-bold mb-3 text-white">
                                        <i class="fas fa-chart-bar text-warning me-2"></i>Performance Attribution Analysis
                                    </h6>
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <div class="text-center p-3 bg-dark bg-opacity-50 rounded">
                                                <div class="h5 fw-bold text-primary mb-1">+2.8%</div>
                                                <small style="color: #B8C0C8;">Credit Selection</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-3 bg-dark bg-opacity-50 rounded">
                                                <div class="h5 fw-bold text-success mb-1">+1.2%</div>
                                                <small style="color: #B8C0C8;">Duration Management</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-3 bg-dark bg-opacity-50 rounded">
                                                <div class="h5 fw-bold text-info mb-1">+0.6%</div>
                                                <small style="color: #B8C0C8;">Sector Allocation</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-3 bg-dark bg-opacity-50 rounded">
                                                <div class="h5 fw-bold text-danger mb-1">-0.4%</div>
                                                <small style="color: #B8C0C8;">Currency Impact</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Market Updates Section -->
    <div id="market-section" style="display: none; padding: 140px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div class="container">
            <h2 class="text-white mb-4"><i class="fas fa-chart-line me-2"></i>Market Updates</h2>
            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="card shadow-lg" style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa;">
                        <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);">
                            <h5 class="mb-0">Bond Markets</h5>
                        </div>
                        <div class="card-body text-white">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>US 10Y Treasury</span>
                                    <span class="text-success">4.25% <i class="fas fa-arrow-up"></i></span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>German 10Y Bund</span>
                                    <span class="text-danger">2.45% <i class="fas fa-arrow-down"></i></span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>UK 10Y Gilt</span>
                                    <span class="text-success">4.10% <i class="fas fa-arrow-up"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card shadow-lg" style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa;">
                        <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);">
                            <h5 class="mb-0">Credit Spreads</h5>
                        </div>
                        <div class="card-body text-white">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>IG Corporate</span>
                                    <span class="text-warning">+95 bps</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>HY Corporate</span>
                                    <span class="text-warning">+385 bps</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>EM Sovereign</span>
                                    <span class="text-danger">+425 bps</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Section -->
    <div id="data-section" style="display: none; padding: 140px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div class="container">
            <h2 class="text-white mb-4"><i class="fas fa-database me-2"></i>Data Center</h2>
            <div class="row g-4">
                <div class="col-lg-12">
                    <div class="card shadow-lg" style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa;">
                        <div class="card-body text-white">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover">
                                    <thead>
                                        <tr>
                                            <th>Asset Class</th>
                                            <th>Region</th>
                                            <th>Current Yield</th>
                                            <th>Change (24h)</th>
                                            <th>Volume</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>RMBS</td>
                                            <td>Europe</td>
                                            <td>3.45%</td>
                                            <td class="text-success">+0.12%</td>
                                            <td>€2.3B</td>
                                            <td><span class="badge bg-success">Active</span></td>
                                        </tr>
                                        <tr>
                                            <td>CMBS</td>
                                            <td>North America</td>
                                            <td>4.15%</td>
                                            <td class="text-danger">-0.08%</td>
                                            <td>$1.8B</td>
                                            <td><span class="badge bg-success">Active</span></td>
                                        </tr>
                                        <tr>
                                            <td>CLO</td>
                                            <td>Asia Pacific</td>
                                            <td>5.25%</td>
                                            <td class="text-success">+0.22%</td>
                                            <td>¥450B</td>
                                            <td><span class="badge bg-warning">Limited</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Section -->
    <div id="analytics-section" style="display: none; padding: 140px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div class="container">
            <h2 class="text-white mb-4"><i class="fas fa-chart-bar me-2"></i>Analytics & Insights</h2>
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="card shadow-lg" style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa;">
                        <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);">
                            <h5 class="mb-0">Performance Analytics</h5>
                        </div>
                        <div class="card-body text-white">
                            <canvas id="analyticsChart" style="height: 300px;"></canvas>
                            <div class="mt-3 text-center">
                                <button class="btn btn-sm btn-outline-light me-2">1D</button>
                                <button class="btn btn-sm btn-outline-light me-2">1W</button>
                                <button class="btn btn-sm btn-primary me-2">1M</button>
                                <button class="btn btn-sm btn-outline-light me-2">3M</button>
                                <button class="btn btn-sm btn-outline-light">1Y</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card shadow-lg" style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa;">
                        <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);">
                            <h5 class="mb-0">Key Metrics</h5>
                        </div>
                        <div class="card-body text-white">
                            <div class="mb-3">
                                <label class="small" style="color: #B8C0C8;">Sharpe Ratio</label>
                                <div class="h4">1.85</div>
                            </div>
                            <div class="mb-3">
                                <label class="small" style="color: #B8C0C8;">Information Ratio</label>
                                <div class="h4">0.92</div>
                            </div>
                            <div class="mb-3">
                                <label class="small" style="color: #B8C0C8;">Max Drawdown</label>
                                <div class="h4 text-danger">-4.2%</div>
                            </div>
                            <div class="mb-3">
                                <label class="small" style="color: #B8C0C8;">Volatility</label>
                                <div class="h4">8.5%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Risk Management Section -->
    <div id="risk-section" style="display: none; padding: 140px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div class="container">
            <h2 class="text-white mb-4"><i class="fas fa-shield-alt me-2"></i>Risk Management</h2>
            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="card shadow-lg" style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa;">
                        <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                            <h5 class="mb-0">Risk Indicators</h5>
                        </div>
                        <div class="card-body text-white">
                            <div class="mb-4">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Market Risk</span>
                                    <span class="text-warning">Medium</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-warning" style="width: 60%"></div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Credit Risk</span>
                                    <span class="text-success">Low</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-success" style="width: 30%"></div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Liquidity Risk</span>
                                    <span class="text-success">Low</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-success" style="width: 25%"></div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Operational Risk</span>
                                    <span class="text-info">Very Low</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-info" style="width: 15%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card shadow-lg" style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa;">
                        <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                            <h5 class="mb-0">VaR Analysis</h5>
                        </div>
                        <div class="card-body text-white">
                            <div class="row text-center">
                                <div class="col-6 mb-3">
                                    <label class="small" style="color: #B8C0C8;">1-Day VaR (95%)</label>
                                    <div class="h3 text-warning">€2.4M</div>
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="small" style="color: #B8C0C8;">1-Day VaR (99%)</label>
                                    <div class="h3 text-danger">€4.1M</div>
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="small" style="color: #B8C0C8;">10-Day VaR (95%)</label>
                                    <div class="h3 text-warning">€7.6M</div>
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="small" style="color: #B8C0C8;">10-Day VaR (99%)</label>
                                    <div class="h3 text-danger">€13.0M</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Portfolio Section -->
    <div id="portfolio-section" style="display: none; padding: 140px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div class="container">
            <h2 class="text-white mb-4"><i class="fas fa-briefcase me-2"></i>Portfolio Management</h2>
            <div class="row g-4">
                <div class="col-lg-12">
                    <div class="card shadow-lg" style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa;">
                        <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
                            <h5 class="mb-0">Active Positions</h5>
                        </div>
                        <div class="card-body text-white">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover">
                                    <thead>
                                        <tr>
                                            <th>Security</th>
                                            <th>ISIN</th>
                                            <th>Notional</th>
                                            <th>Market Value</th>
                                            <th>P&L</th>
                                            <th>Weight</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>ATLAS 2024-1 A</td>
                                            <td>XS2745892341</td>
                                            <td>€100M</td>
                                            <td>€102.5M</td>
                                            <td class="text-success">+€2.5M</td>
                                            <td>4.3%</td>
                                            <td><button class="btn btn-sm btn-outline-info">Details</button></td>
                                        </tr>
                                        <tr>
                                            <td>NEXUS 2023-3 AAA</td>
                                            <td>XS2698754123</td>
                                            <td>€150M</td>
                                            <td>€148.2M</td>
                                            <td class="text-danger">-€1.8M</td>
                                            <td>6.2%</td>
                                            <td><button class="btn btn-sm btn-outline-info">Details</button></td>
                                        </tr>
                                        <tr>
                                            <td>EURO CLO 2024-2</td>
                                            <td>XS2756891234</td>
                                            <td>€75M</td>
                                            <td>€76.1M</td>
                                            <td class="text-success">+€1.1M</td>
                                            <td>3.2%</td>
                                            <td><button class="btn btn-sm btn-outline-info">Details</button></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-4">
                <a href="/portfolio" class="btn btn-primary btn-lg" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border: none;">
                    <i class="fas fa-arrow-right me-2"></i>Access Full Portfolio Manager
                </a>
            </div>
        </div>
    </div>

    <!-- Compliance Section -->
    <div id="compliance-section" style="display: none; padding: 140px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div class="container">
            <h2 class="text-white mb-4"><i class="fas fa-gavel me-2"></i>Compliance & Regulatory</h2>
            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="card shadow-lg" style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa;">
                        <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                            <h5 class="mb-0">Regulatory Status</h5>
                        </div>
                        <div class="card-body text-white">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span><i class="fas fa-check-circle text-success me-2"></i>MiFID II</span>
                                    <span class="badge bg-success">Compliant</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span><i class="fas fa-check-circle text-success me-2"></i>AIFMD</span>
                                    <span class="badge bg-success">Compliant</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span><i class="fas fa-check-circle text-success me-2"></i>EMIR</span>
                                    <span class="badge bg-success">Compliant</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span><i class="fas fa-exclamation-triangle text-warning me-2"></i>SFDR</span>
                                    <span class="badge bg-warning">Review Needed</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card shadow-lg" style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa;">
                        <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                            <h5 class="mb-0">Upcoming Deadlines</h5>
                        </div>
                        <div class="card-body text-white">
                            <div class="mb-3">
                                <div class="mb-3 p-2 border-start border-warning border-3">
                                    <div class="small" style="color: #B8C0C8;">15 Jan 2025</div>
                                    <div>ESMA Quarterly Report</div>
                                </div>
                                <div class="mb-3 p-2 border-start border-info border-3">
                                    <div class="small" style="color: #B8C0C8;">31 Jan 2025</div>
                                    <div>Annual Risk Assessment</div>
                                </div>
                                <div class="mb-3 p-2 border-start border-primary border-3">
                                    <div class="small" style="color: #B8C0C8;">28 Feb 2025</div>
                                    <div>Investor Disclosure Update</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-4">
                <a href="/compliance" class="btn btn-primary btn-lg" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border: none;">
                    <i class="fas fa-arrow-right me-2"></i>Open Full Compliance Tool
                </a>
            </div>
        </div>
    </div>

    <!-- Permutation Engine Command Centre Section -->
    <div id="permutation-section" style="display: none; padding: 140px 2rem 2rem; min-height: 100vh; transition: padding-top 0.3s ease;">
        <div style="max-width: 1800px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95)); border: 2px solid #60a5fa; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                <h2 style="color: #60a5fa; font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem; text-align: center;">
                    <i class="fas fa-cogs"></i> Securitisation Permutation Engine
                </h2>
                <p style="color: #94a3b8; text-align: center; margin-bottom: 2rem;">Advanced Securitisation Permutation Generator & Analysis System</p>
                
                <!-- Control Panel -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <!-- Input Parameters Section -->
                    <div style="background: rgba(44, 49, 55, 0.8); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #60a5fa; margin-bottom: 1rem; font-size: 1.2rem;">
                            <i class="fas fa-sliders-h"></i> Input Parameters
                        </h3>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.3rem;">Dataset Size</label>
                                <input type="number" id="perm-dataset-size" placeholder="Enter dataset size" style="width: 100%; padding: 8px; background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 6px; color: white;">
                            </div>
                            <div>
                                <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.3rem;">Iteration Count</label>
                                <input type="number" id="perm-iterations" placeholder="Number of iterations" style="width: 100%; padding: 8px; background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 6px; color: white;">
                            </div>
                            <div>
                                <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.3rem;">Sample Rate (%)</label>
                                <input type="number" id="perm-sample-rate" min="0" max="100" placeholder="0-100" style="width: 100%; padding: 8px; background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 6px; color: white;">
                            </div>
                            <div>
                                <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.3rem;">Confidence Level</label>
                                <select id="perm-confidence" style="width: 100%; padding: 8px; background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 6px; color: white;">
                                    <option value="90">90%</option>
                                    <option value="95" selected>95%</option>
                                    <option value="99">99%</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Algorithm Selection -->
                    <div style="background: rgba(44, 49, 55, 0.8); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #60a5fa; margin-bottom: 1rem; font-size: 1.2rem;">
                            <i class="fas fa-microchip"></i> Algorithm Selection
                        </h3>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.3rem;">Permutation Type</label>
                                <select id="perm-type" style="width: 100%; padding: 8px; background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 6px; color: white;">
                                    <option value="standard">Standard Permutation</option>
                                    <option value="circular">Circular Permutation</option>
                                    <option value="restricted">Restricted Permutation</option>
                                    <option value="multiset">Multiset Permutation</option>
                                </select>
                            </div>
                            <div>
                                <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.3rem;">Optimization Method</label>
                                <select id="perm-optimization" style="width: 100%; padding: 8px; background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 6px; color: white;">
                                    <option value="genetic">Genetic Algorithm</option>
                                    <option value="simulated">Simulated Annealing</option>
                                    <option value="particle">Particle Swarm</option>
                                    <option value="gradient">Gradient Descent</option>
                                </select>
                            </div>
                            <div>
                                <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.3rem;">Processing Mode</label>
                                <select id="perm-mode" style="width: 100%; padding: 8px; background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 6px; color: white;">
                                    <option value="sequential">Sequential</option>
                                    <option value="parallel">Parallel</option>
                                    <option value="distributed">Distributed</option>
                                </select>
                            </div>
                            <div>
                                <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.3rem;">Memory Allocation (MB)</label>
                                <input type="number" id="perm-memory" placeholder="Memory limit" style="width: 100%; padding: 8px; background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 6px; color: white;">
                            </div>
                        </div>
                    </div>

                    <!-- Data Sources -->
                    <div style="background: rgba(44, 49, 55, 0.8); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #60a5fa; margin-bottom: 1rem; font-size: 1.2rem;">
                            <i class="fas fa-database"></i> Data Sources
                        </h3>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.3rem;">Primary Dataset</label>
                                <input type="text" id="perm-primary-data" placeholder="Dataset name or path" style="width: 100%; padding: 8px; background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 6px; color: white;">
                            </div>
                            <div>
                                <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.3rem;">Secondary Dataset</label>
                                <input type="text" id="perm-secondary-data" placeholder="Optional secondary dataset" style="width: 100%; padding: 8px; background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 6px; color: white;">
                            </div>
                            <div>
                                <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.3rem;">Filter Expression</label>
                                <input type="text" id="perm-filter" placeholder="e.g., value > 100" style="width: 100%; padding: 8px; background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 6px; color: white;">
                            </div>
                            <div>
                                <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.3rem;">Group By</label>
                                <input type="text" id="perm-groupby" placeholder="Column name" style="width: 100%; padding: 8px; background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 6px; color: white;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Configuration -->
                <div style="background: rgba(44, 49, 55, 0.8); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                    <h3 style="color: #60a5fa; margin-bottom: 1rem; font-size: 1.2rem;">
                        <i class="fas fa-cog"></i> Advanced Configuration
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div>
                            <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.3rem;">Seed Value</label>
                            <input type="number" id="perm-seed" placeholder="Random seed" style="width: 100%; padding: 8px; background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 6px; color: white;">
                        </div>
                        <div>
                            <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.3rem;">Batch Size</label>
                            <input type="number" id="perm-batch" placeholder="Processing batch size" style="width: 100%; padding: 8px; background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 6px; color: white;">
                        </div>
                        <div>
                            <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.3rem;">Timeout (seconds)</label>
                            <input type="number" id="perm-timeout" placeholder="Max execution time" style="width: 100%; padding: 8px; background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 6px; color: white;">
                        </div>
                        <div>
                            <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.3rem;">Output Format</label>
                            <select id="perm-output" style="width: 100%; padding: 8px; background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 6px; color: white;">
                                <option value="json">JSON</option>
                                <option value="csv">CSV</option>
                                <option value="xml">XML</option>
                                <option value="binary">Binary</option>
                            </select>
                        </div>
                        <div>
                            <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.3rem;">Compression</label>
                            <select id="perm-compression" style="width: 100%; padding: 8px; background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 6px; color: white;">
                                <option value="none">None</option>
                                <option value="gzip">GZIP</option>
                                <option value="lz4">LZ4</option>
                                <option value="zstd">ZSTD</option>
                            </select>
                        </div>
                        <div>
                            <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.3rem;">Cache Strategy</label>
                            <select id="perm-cache" style="width: 100%; padding: 8px; background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 6px; color: white;">
                                <option value="none">No Cache</option>
                                <option value="memory">Memory Cache</option>
                                <option value="disk">Disk Cache</option>
                                <option value="hybrid">Hybrid Cache</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Control Buttons -->
                <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 2rem;">
                    <button onclick="startPermutationEngine()" style="background: linear-gradient(90deg, #22c55e, #16a34a); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                        <i class="fas fa-play"></i> Start Engine
                    </button>
                    <button onclick="pausePermutationEngine()" style="background: linear-gradient(90deg, #f59e0b, #d97706); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                        <i class="fas fa-pause"></i> Pause
                    </button>
                    <button onclick="stopPermutationEngine()" style="background: linear-gradient(90deg, #ef4444, #dc2626); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                    <button onclick="resetPermutationEngine()" style="background: linear-gradient(90deg, #64748b, #475569); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                </div>

                <!-- Progress & Status -->
                <div style="background: rgba(44, 49, 55, 0.8); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                    <h3 style="color: #60a5fa; margin-bottom: 1rem; font-size: 1.2rem;">
                        <i class="fas fa-tasks"></i> Progress & Status
                    </h3>
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: #94a3b8;">Overall Progress</span>
                            <span id="perm-progress-percent" style="color: #60a5fa; font-weight: 600;">0%</span>
                        </div>
                        <div style="background: rgba(30, 41, 59, 0.8); border-radius: 8px; height: 24px; overflow: hidden;">
                            <div id="perm-progress-bar" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div style="text-align: center;">
                            <p style="color: #94a3b8; font-size: 0.9rem;">Status</p>
                            <p id="perm-status" style="color: #22c55e; font-weight: 600;">Ready</p>
                        </div>
                        <div style="text-align: center;">
                            <p style="color: #94a3b8; font-size: 0.9rem;">Iterations</p>
                            <p id="perm-current-iterations" style="color: white; font-weight: 600;">0 / 0</p>
                        </div>
                        <div style="text-align: center;">
                            <p style="color: #94a3b8; font-size: 0.9rem;">Time Elapsed</p>
                            <p id="perm-time" style="color: white; font-weight: 600;">00:00:00</p>
                        </div>
                        <div style="text-align: center;">
                            <p style="color: #94a3b8; font-size: 0.9rem;">Est. Remaining</p>
                            <p id="perm-eta" style="color: white; font-weight: 600;">--:--:--</p>
                        </div>
                    </div>
                </div>

                <!-- Results Display -->
                <div style="background: rgba(44, 49, 55, 0.8); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 12px; padding: 1.5rem;">
                    <h3 style="color: #60a5fa; margin-bottom: 1rem; font-size: 1.2rem;">
                        <i class="fas fa-chart-line"></i> Results
                    </h3>
                    <div id="perm-results" style="min-height: 300px; background: rgba(30, 41, 59, 0.8); border-radius: 8px; padding: 1rem;">
                        <p style="color: #94a3b8; text-align: center;">No results yet. Configure parameters and start the engine.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if is_admin %}
    <!-- Admin Panel -->
    <div id="adminPanel" style="display: none; position: fixed; top: 70px; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 1400px; margin: 0 auto; padding: 2rem;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 2rem;">
                <h2 style="color: #22c55e; font-size: 2rem; font-weight: 700;">Admin Control Center</h2>
                <button onclick="toggleAdminPanel()" style="position: absolute; right: 2rem; top: 2rem; background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>

            <!-- Pending Registrations -->
            <div style="background: rgba(54, 64, 73, 0.95); border: 2px solid #22c55e; border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
                <h3 style="color: #22c55e; margin-bottom: 1.5rem;">Pending Registrations</h3>
                {% if pending_registrations %}
                    {% for reg in pending_registrations %}
                    <div style="background: rgba(44, 49, 55, 0.8); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Name</p>
                                <p style="color: white; font-weight: 600;">{{ reg.full_name }}</p>
                            </div>
                            <div>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Email</p>
                                <p style="color: #60a5fa; font-weight: 600;">{{ reg.email }}</p>
                            </div>
                            <div>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Company</p>
                                <p style="color: white;">{{ reg.company_name }}</p>
                            </div>
                            <div>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Job Title</p>
                                <p style="color: white;">{{ reg.job_title }}</p>
                            </div>
                            <div>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Phone</p>
                                <p style="color: white;">{{ reg.country_code }} {{ reg.phone }}</p>
                            </div>
                            <div>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Submitted</p>
                                <p style="color: white;">{{ reg.created_at }}</p>
                            </div>
                            <div>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Generated Password</p>
                                <p style="color: #fbbf24; font-weight: 600; font-family: monospace;">{{ reg.generated_password }}</p>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <label style="color: #94a3b8; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Select Account Type:</label>
                            <select id="accountType_{{ reg.email|replace('@', '_')|replace('.', '_') }}" style="background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(96, 165, 250, 0.3); padding: 8px 12px; border-radius: 6px; width: 100%; margin-bottom: 1rem;">
                                <option value="external" selected>External - Client Access</option>
                                <option value="investor">Investor - Portfolio Access</option>
                                <option value="execution">Execution - Trading Access</option>
                                <option value="internal">Internal - Team Member</option>
                                <option value="admin">Admin - Full Control</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button onclick="approveUser({{ reg.email|tojson|safe }})" style="background: #22c55e; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button onclick="rejectUser({{ reg.email|tojson|safe }})" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: #94a3b8;">No pending registrations</p>
                {% endif %}
            </div>

            <!-- Active Users -->
            <div style="background: rgba(54, 64, 73, 0.95); border: 2px solid #60a5fa; border-radius: 12px; padding: 2rem;">
                <h3 style="color: #60a5fa; margin-bottom: 1.5rem;">Active Users</h3>
                {% if all_users %}
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid rgba(96, 165, 250, 0.3);">
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Name</th>
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Email</th>
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Company</th>
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Login Count</th>
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Total Time</th>
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Last Login</th>
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Password</th>
                                    <th style="padding: 10px; text-align: left; color: #94a3b8;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in all_users %}
                                <tr style="border-bottom: 1px solid rgba(96, 165, 250, 0.1);">
                                    <td style="padding: 10px; color: white;">{{ user.full_name }}</td>
                                    <td style="padding: 10px; color: #60a5fa;">{{ user.email }}</td>
                                    <td style="padding: 10px; color: white;">{{ user.company_name }}</td>
                                    <td style="padding: 10px; color: #22c55e; font-weight: 600;">{{ user.login_count|default(0) }}</td>
                                    <td style="padding: 10px; color: white;">
                                        {% if user.total_login_time %}
                                            {{ (user.total_login_time / 3600)|round(1) }} hrs
                                        {% else %}
                                            0 hrs
                                        {% endif %}
                                    </td>
                                    <td style="padding: 10px; color: white;">
                                        {% if user.last_login %}
                                            {{ user.last_login|truncate(19, True, '') }}
                                        {% else %}
                                            Never
                                        {% endif %}
                                    </td>
                                    <td style="padding: 10px; color: #fbbf24; font-family: monospace; font-size: 0.85rem;">{{ user.password }}</td>
                                    <td style="padding: 10px;">
                                        <button onclick="resetPassword({{ user.email|tojson|safe }})" style="background: #fbbf24; color: black; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                                            Reset Password
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p style="color: #94a3b8;">No active users</p>
                {% endif %}
            </div>
            
            <!-- Comprehensive Admin Control Panel -->
            <div style="margin-top: 2rem;">
                <!-- Tab Navigation -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #364049;">
                    <button onclick="showAdminTab('overview')" class="admin-tab active" style="background: transparent; color: #60a5fa; border: none; padding: 10px 20px; cursor: pointer; border-bottom: 3px solid #60a5fa;">Overview</button>
                    <button onclick="showAdminTab('registrations')" class="admin-tab" style="background: transparent; color: #94a3b8; border: none; padding: 10px 20px; cursor: pointer;">Registrations</button>
                    <button onclick="showAdminTab('lockouts')" class="admin-tab" style="background: transparent; color: #94a3b8; border: none; padding: 10px 20px; cursor: pointer;">IP Lockouts</button>
                    <button onclick="showAdminTab('attempts')" class="admin-tab" style="background: transparent; color: #94a3b8; border: none; padding: 10px 20px; cursor: pointer;">Login Attempts</button>
                    <button onclick="showAdminTab('expired')" class="admin-tab" style="background: transparent; color: #94a3b8; border: none; padding: 10px 20px; cursor: pointer;">Expired</button>
                </div>
                
                <!-- Tab Content -->
                <div id="adminTabContent">
                    <p style="color: #94a3b8;">Loading admin data...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let comprehensiveData = {}; // Store all admin data
        let currentTab = 'overview';
        let currentSection = 'dashboard';
        
        // Removed duplicate function - using the main showSection function instead
        
        function showPlaceholderContent(title, description) {
            let placeholderDiv = document.getElementById('placeholder-content');
            if (!placeholderDiv) {
                // Create placeholder div if it doesn't exist
                placeholderDiv = document.createElement('div');
                placeholderDiv.id = 'placeholder-content';
                placeholderDiv.style.cssText = 'padding: 160px 2rem 2rem; min-height: 100vh;';
                document.body.appendChild(placeholderDiv);
            }
            
            // Hide main content
            const mainContent = document.getElementById('main-content');
            if (mainContent) mainContent.style.display = 'none';
            
            const complianceSection = document.getElementById('compliance-section');
            if (complianceSection) complianceSection.style.display = 'none';
            
            const permSection = document.getElementById('permutation-section');
            if (permSection) permSection.style.display = 'none';
            
            // Show placeholder
            placeholderDiv.style.display = 'block';
            placeholderDiv.innerHTML = '<div class="container">' +
                '<div class="text-center" style="margin-top: 100px;">' +
                    '<h1 style="color: #60a5fa; margin-bottom: 2rem;">' +
                        '<i class="fas fa-cogs"></i> ' + title +
                    '</h1>' +
                    '<div style="background: rgba(54, 64, 73, 0.95); border: 1px solid #60a5fa; border-radius: 12px; padding: 3rem; max-width: 600px; margin: 0 auto;">' +
                        '<p style="color: #94a3b8; font-size: 1.1rem; margin-bottom: 2rem;">' + description + '</p>' +
                        '<div style="color: #fbbf24;">' +
                            '<i class="fas fa-clock fa-3x mb-3"></i>' +
                            '<p>Coming Soon</p>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }
        
        function toggleAdminPanel() {
            const panel = document.getElementById('adminPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            if (panel.style.display === 'block') {
                loadComprehensiveData();
            }
        }
        
        function loadComprehensiveData() {
            fetch('/admin/comprehensive-data')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        comprehensiveData = data.data;
                        showAdminTab(currentTab);
                    }
                })
                .catch(error => console.error('Error loading admin data:', error));
        }
        
        function showAdminTab(tab) {
            currentTab = tab;
            
            // Update tab styling
            document.querySelectorAll('.admin-tab').forEach(btn => {
                btn.style.color = '#94a3b8';
                btn.style.borderBottom = 'none';
                btn.classList.remove('active');
            });
            event.target.style.color = '#60a5fa';
            event.target.style.borderBottom = '3px solid #60a5fa';
            event.target.classList.add('active');
            
            const content = document.getElementById('adminTabContent');
            
            switch(tab) {
                case 'overview':
                    showOverview(content);
                    break;
                case 'registrations':
                    showRegistrations(content);
                    break;
                case 'lockouts':
                    showLockouts(content);
                    break;
                case 'attempts':
                    showAttempts(content);
                    break;
                case 'expired':
                    showExpired(content);
                    break;
            }
        }
        
        function showOverview(container) {
            const stats = comprehensiveData.statistics || {};
            container.innerHTML = '<div style="background: rgba(54, 64, 73, 0.95); border-radius: 12px; padding: 2rem;">' +
                '<h3 style="color: #60a5fa; margin-bottom: 1.5rem;">System Overview</h3>' +
                '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">' +
                    '<div style="background: rgba(96, 165, 250, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(96, 165, 250, 0.3);">' +
                        '<div style="color: #94a3b8; font-size: 0.9rem;">Locked IPs</div>' +
                        '<div style="color: #ef4444; font-size: 2rem; font-weight: bold;">' + (stats.total_locked_ips || 0) + '</div>' +
                    '</div>' +
                    '<div style="background: rgba(34, 197, 94, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">' +
                        '<div style="color: #94a3b8; font-size: 0.9rem;">Active Registrations</div>' +
                        '<div style="color: #22c55e; font-size: 2rem; font-weight: bold;">' + (stats.active_registrations || 0) + '</div>' +
                    '</div>' +
                    '<div style="background: rgba(251, 191, 36, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(251, 191, 36, 0.3);">' +
                        '<div style="color: #94a3b8; font-size: 0.9rem;">Pending Verification</div>' +
                        '<div style="color: #fbbf24; font-size: 2rem; font-weight: bold;">' + (stats.pending_verification || 0) + '</div>' +
                    '</div>' +
                    '<div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3);">' +
                        '<div style="color: #94a3b8; font-size: 0.9rem;">Expired Registrations</div>' +
                        '<div style="color: #ef4444; font-size: 2rem; font-weight: bold;">' + (stats.expired_registrations || 0) + '</div>' +
                    '</div>' +
                    '<div style="background: rgba(147, 51, 234, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(147, 51, 234, 0.3);">' +
                        '<div style="color: #94a3b8; font-size: 0.9rem;">Total Login Attempts</div>' +
                        '<div style="color: #9333ea; font-size: 2rem; font-weight: bold;">' + (stats.total_login_attempts || 0) + '</div>' +
                    '</div>' +
                    '<div style="background: rgba(34, 197, 94, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">' +
                        '<div style="color: #94a3b8; font-size: 0.9rem;">Approved Users</div>' +
                        '<div style="color: #22c55e; font-size: 2rem; font-weight: bold;">' + (stats.approved_users || 0) + '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }
        
        function showRegistrations(container) {
            const regs = comprehensiveData.active_registrations || {};
            let html = '<div style="background: rgba(54, 64, 73, 0.95); border-radius: 12px; padding: 2rem;">' +
                '<h3 style="color: #22c55e; margin-bottom: 1.5rem;">Active Registrations</h3>';
            
            if (Object.keys(regs).length === 0) {
                html += '<p style="color: #94a3b8;">No active registrations</p>';
            } else {
                html += '<div style="overflow-x: auto;"><table style="width: 100%; color: #e2e8f0;">';
                html += '<thead><tr style="border-bottom: 2px solid #475569;">';
                html += '<th style="padding: 10px; text-align: left;">Email</th>';
                html += '<th style="padding: 10px; text-align: left;">Name</th>';
                html += '<th style="padding: 10px; text-align: left;">Company</th>';
                html += '<th style="padding: 10px; text-align: left;">Verified</th>';
                html += '<th style="padding: 10px; text-align: left;">Approved</th>';
                html += '<th style="padding: 10px; text-align: left;">Actions</th>';
                html += '</tr></thead><tbody>';
                
                for (const [email, data] of Object.entries(regs)) {
                    html += '<tr style="border-bottom: 1px solid #364049;">';
                    html += '<td style="padding: 10px;">' + email + '</td>';
                    html += '<td style="padding: 10px;">' + (data.full_name || '-') + '</td>';
                    html += '<td style="padding: 10px;">' + (data.company_name || '-') + '</td>';
                    html += '<td style="padding: 10px;">' + (data.email_verified ? '✅' : '❌') + '</td>';
                    html += '<td style="padding: 10px;">' + (data.admin_approved ? '✅' : '❌') + '</td>';
                    html += '<td style="padding: 10px;">' +
                        '<button onclick="deleteData(\'registration\', \'' + email + '\')" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-right: 5px;">Delete</button>' +
                        (!data.admin_approved ? '<button onclick="approveUser(\'' + email + '\')" style="background: #22c55e; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Approve</button>' : '') +
                    '</td>';
                    html += '</tr>';
                }
                html += '</tbody></table></div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function showLockouts(container) {
            const lockouts = comprehensiveData.ip_lockouts || {};
            let html = '<div style="background: rgba(54, 64, 73, 0.95); border-radius: 12px; padding: 2rem;">' +
                '<h3 style="color: #ef4444; margin-bottom: 1.5rem;">IP Lockouts</h3>' +
                '<button onclick="deleteData(\'all_lockouts\', null)" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">Clear All Lockouts</button>';
            
            if (Object.keys(lockouts).length === 0) {
                html += '<p style="color: #94a3b8;">No IP lockouts</p>';
            } else {
                html += '<div style="overflow-x: auto;"><table style="width: 100%; color: #e2e8f0;">';
                html += '<thead><tr style="border-bottom: 2px solid #475569;">';
                html += '<th style="padding: 10px; text-align: left;">IP Address</th>';
                html += '<th style="padding: 10px; text-align: left;">Type</th>';
                html += '<th style="padding: 10px; text-align: left;">Reason</th>';
                html += '<th style="padding: 10px; text-align: left;">Locked Until</th>';
                html += '<th style="padding: 10px; text-align: left;">Actions</th>';
                html += '</tr></thead><tbody>';
                
                for (const [ip, data] of Object.entries(lockouts)) {
                    html += '<tr style="border-bottom: 1px solid #364049;">';
                    html += '<td style="padding: 10px; font-family: monospace;">' + ip + '</td>';
                    html += '<td style="padding: 10px;">' + (data.permanent ? 'Permanent' : 'Temporary') + '</td>';
                    html += '<td style="padding: 10px;">' + (data.reason || '-') + '</td>';
                    html += '<td style="padding: 10px;">' + (data.locked_until || 'Permanent') + '</td>';
                    html += '<td style="padding: 10px;">' +
                        '<button onclick="deleteData(\'ip_lockout\', \'' + ip + '\')" style="background: #22c55e; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Unblock</button>' +
                    '</td>';
                    html += '</tr>';
                }
                html += '</tbody></table></div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function showAttempts(container) {
            const attempts = comprehensiveData.login_attempts || {};
            let html = '<div style="background: rgba(54, 64, 73, 0.95); border-radius: 12px; padding: 2rem;">' +
                '<h3 style="color: #9333ea; margin-bottom: 1.5rem;">Login Attempts</h3>' +
                '<button onclick="deleteData(\'all_attempts\', null)" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">Clear All Attempts</button>';
            
            if (Object.keys(attempts).length === 0) {
                html += '<p style="color: #94a3b8;">No login attempts logged</p>';
            } else {
                html += '<div style="overflow-x: auto;"><table style="width: 100%; color: #e2e8f0;">';
                html += '<thead><tr style="border-bottom: 2px solid #475569;">';
                html += '<th style="padding: 10px; text-align: left;">IP Address</th>';
                html += '<th style="padding: 10px; text-align: left;">Total Attempts</th>';
                html += '<th style="padding: 10px; text-align: left;">Last Attempt</th>';
                html += '<th style="padding: 10px; text-align: left;">Actions</th>';
                html += '</tr></thead><tbody>';
                
                for (const [ip, data] of Object.entries(attempts)) {
                    html += '<tr style="border-bottom: 1px solid #364049;">';
                    html += '<td style="padding: 10px; font-family: monospace;">' + ip + '</td>';
                    html += '<td style="padding: 10px;">' + (data.total_attempts || 0) + '</td>';
                    html += '<td style="padding: 10px;">' + (data.last_attempt || '-') + '</td>';
                    html += '<td style="padding: 10px;">' +
                        '<button onclick="deleteData(\'login_attempt\', \'' + ip + '\')" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Delete</button>' +
                    '</td>';
                    html += '</tr>';
                }
                html += '</tbody></table></div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function showExpired(container) {
            const expired = comprehensiveData.expired_registrations || {};
            let html = '<div style="background: rgba(54, 64, 73, 0.95); border-radius: 12px; padding: 2rem;">' +
                '<h3 style="color: #ef4444; margin-bottom: 1.5rem;">Expired Registrations</h3>';
            
            if (Object.keys(expired).length === 0) {
                html += '<p style="color: #94a3b8;">No expired registrations</p>';
            } else {
                html += '<div style="overflow-x: auto;"><table style="width: 100%; color: #e2e8f0;">';
                html += '<thead><tr style="border-bottom: 2px solid #475569;">';
                html += '<th style="padding: 10px; text-align: left;">Email</th>';
                html += '<th style="padding: 10px; text-align: left;">Name</th>';
                html += '<th style="padding: 10px; text-align: left;">Expired At</th>';
                html += '<th style="padding: 10px; text-align: left;">Reason</th>';
                html += '<th style="padding: 10px; text-align: left;">Actions</th>';
                html += '</tr></thead><tbody>';
                
                for (const [email, data] of Object.entries(expired)) {
                    html += '<tr style="border-bottom: 1px solid #364049;">';
                    html += '<td style="padding: 10px;">' + email + '</td>';
                    html += '<td style="padding: 10px;">' + (data.full_name || '-') + '</td>';
                    html += '<td style="padding: 10px;">' + (data.expired_at || '-') + '</td>';
                    html += '<td style="padding: 10px;">' + (data.reason || '-') + '</td>';
                    html += '<td style="padding: 10px;">' +
                        '<button onclick="deleteData(\'expired_registration\', \'' + email + '\')" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Delete</button>' +
                    '</td>';
                    html += '</tr>';
                }
                html += '</tbody></table></div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function deleteData(type, identifier) {
            if (type.startsWith('all_') && !confirm('Are you sure you want to clear ALL ' + type.replace('all_', '') + '?')) {
                return;
            }
            if (!type.startsWith('all_') && !confirm('Are you sure you want to delete ' + identifier + '?')) {
                return;
            }
            
            fetch('/admin/delete-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: type, identifier: identifier })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Deleted successfully');
                    loadComprehensiveData();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => console.error('Error deleting data:', error));
        }
        
        function showIPDetails(ipAddress) {
            const ipInfo = currentIPData.find(ip => ip.ip === ipAddress);
            if (!ipInfo) return;
            
            let detailsHTML = '<div style="padding: 20px;">' +
                '<h3 style="color: #ef4444; margin-bottom: 20px;">Detailed Information for ' + ipAddress + '</h3>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">' +
                    '<div>' +
                        '<strong style="color: #60a5fa;">Status:</strong> ' +
                        '<span style="color: #f59e0b;">' + ipInfo.status + '</span>' +
                    '</div>' +
                    '<div>' +
                        '<strong style="color: #60a5fa;">Lock Type:</strong> ' +
                        '<span style="color: #f59e0b;">' + (ipInfo.lockout_type || 'Unknown') + '</span>' +
                    '</div>' +
                    '<div>' +
                        '<strong style="color: #60a5fa;">Reference Code:</strong> ' +
                        '<span style="color: white; font-family: monospace;">' + (ipInfo.reference_code || 'N/A') + '</span>' +
                    '</div>' +
                    '<div>' +
                        '<strong style="color: #60a5fa;">Total Attempts:</strong> ' +
                        '<span style="color: #ef4444; font-weight: bold;">' + (ipInfo.total_attempts || 0) + '</span>' +
                    '</div>' +
                    '<div>' +
                        '<strong style="color: #60a5fa;">First Seen:</strong> ' +
                        '<span style="color: #94a3b8;">' + (ipInfo.first_seen || 'Unknown') + '</span>' +
                    '</div>' +
                    '<div>' +
                        '<strong style="color: #60a5fa;">Locked At:</strong> ' +
                        '<span style="color: #94a3b8;">' + (ipInfo.locked_at || 'Unknown') + '</span>' +
                    '</div>' +
                '</div>' +
                '<div style="margin-bottom: 20px;">' +
                    '<strong style="color: #60a5fa;">User Agent:</strong>' +
                    '<div style="color: #94a3b8; font-size: 0.9rem; margin-top: 5px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px;">' +
                        (ipInfo.user_agent || 'Unknown') +
                    '</div>' +
                '</div>' +
                '<div style="margin-bottom: 20px;">' +
                    '<strong style="color: #60a5fa;">Failed Passwords:</strong>' +
                    '<div style="margin-top: 10px;">';
            
            // Handle failed passwords
            if (ipInfo.failed_passwords && ipInfo.failed_passwords.length > 0) {
                for (let i = 0; i < ipInfo.failed_passwords.length; i++) {
                    detailsHTML += '<span style="display: inline-block; background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 5px 10px; margin: 5px; border-radius: 5px; font-family: monospace;">' + 
                        ipInfo.failed_passwords[i] + '</span>';
                }
            } else {
                detailsHTML += '<span style="color: #94a3b8;">No passwords logged</span>';
            }
            
            detailsHTML += '</div></div>';
            
            // Handle attempt history
            if (ipInfo.attempt_history && ipInfo.attempt_history.length > 0) {
                detailsHTML += '<div style="margin-bottom: 20px;">' +
                    '<strong style="color: #60a5fa;">Recent Attempt History:</strong>' +
                    '<div style="margin-top: 10px; max-height: 200px; overflow-y: auto;">';
                
                for (let i = 0; i < ipInfo.attempt_history.length; i++) {
                    const attempt = ipInfo.attempt_history[i];
                    detailsHTML += '<div style="padding: 10px; margin: 5px 0; background: rgba(0,0,0,0.3); border-radius: 5px; border-left: 3px solid #ef4444;">' +
                        '<div style="color: #ef4444; font-family: monospace;">' + attempt.password + '</div>' +
                        '<div style="color: #94a3b8; font-size: 0.85rem; margin-top: 5px;">' +
                            new Date(attempt.timestamp).toLocaleString('en-GB') + ' | Type: ' + attempt.type +
                        '</div>' +
                    '</div>';
                }
                
                detailsHTML += '</div></div>';
            }
            
            detailsHTML += '<div style="margin-top: 20px; text-align: right;">' +
                '<button onclick="closeIPDetails()" style="background: #475569; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">' +
                    'Close' +
                '</button>' +
            '</div></div>';
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'ipDetailsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 20000; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = '<div style="background: rgba(54, 64, 73, 0.98); border: 2px solid #ef4444; border-radius: 12px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">' +
                detailsHTML +
                '</div>';
            document.body.appendChild(modal);
        }
        
        function closeIPDetails() {
            const modal = document.getElementById('ipDetailsModal');
            if (modal) modal.remove();
        }
        
        function displayIPData(ipData) {
            const container = document.getElementById('ipManagementContent');
            
            if (ipData.length === 0) {
                container.innerHTML = '<p style="color: #94a3b8;">No IP lockouts currently active</p>';
                return;
            }
            
            let html = '<div style="overflow-x: auto;">' +
                '<table style="width: 100%; border-collapse: collapse;">' +
                    '<thead>' +
                        '<tr style="border-bottom: 1px solid rgba(239, 68, 68, 0.3);">' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">IP Address</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">Status</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">Reason</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">Failed Passwords</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">Browser/Device</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">First Seen</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">Total Attempts</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">Time Remaining</th>' +
                            '<th style="padding: 10px; text-align: left; color: #94a3b8;">Actions</th>' +
                        '</tr>' +
                    '</thead>' +
                    '<tbody>';
            
            ipData.forEach(ip => {
                const statusColor = ip.status === 'permanent' ? '#ef4444' : '#f59e0b';
                const statusText = ip.status === 'permanent' ? 'PERMANENT BAN' : 
                                   ip.lockout_type === 'blocked_30min' ? '30-MIN BLOCK' : 
                                   ip.lockout_type === 'blocked_24h' ? '24-HOUR BAN' : 'TEMPORARY BLOCK';
                
                // Parse browser info to make it shorter
                let browserInfo = 'Unknown';
                if (ip.user_agent && ip.user_agent !== 'Unknown') {
                    if (ip.user_agent.includes('Chrome')) browserInfo = 'Chrome';
                    else if (ip.user_agent.includes('Firefox')) browserInfo = 'Firefox';
                    else if (ip.user_agent.includes('Safari')) browserInfo = 'Safari';
                    else if (ip.user_agent.includes('Edge')) browserInfo = 'Edge';
                    else browserInfo = ip.user_agent.substring(0, 20) + '...';
                }
                
                // Format first seen date
                let firstSeen = 'Unknown';
                if (ip.first_seen) {
                    const date = new Date(ip.first_seen);
                    firstSeen = date.toLocaleString('en-GB', { 
                        day: '2-digit', 
                        month: 'short', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                }
                
                html += '<tr style="border-bottom: 1px solid rgba(239, 68, 68, 0.1);">' +
                    '<td style="padding: 10px; color: white; font-family: monospace; cursor: pointer;" ' +
                        'onclick="showIPDetails(\'' + ip.ip + '\')" ' +
                        'title="Click for details">' +
                        ip.ip + ' ' +
                        '<i class="fas fa-info-circle" style="color: #60a5fa; margin-left: 5px;"></i>' +
                    '</td>' +
                    '<td style="padding: 10px;">' +
                        '<span style="color: ' + statusColor + '; font-weight: 600; font-size: 0.8rem;">' + statusText + '</span>' +
                    '</td>' +
                    '<td style="padding: 10px; color: #94a3b8; font-size: 0.85rem;">' + ip.reason + '</td>' +
                    '<td style="padding: 10px; color: #ef4444; font-size: 0.8rem; max-width: 150px; overflow: hidden; text-overflow: ellipsis;" ' +
                        'title="' + (ip.failed_passwords ? ip.failed_passwords.join(', ') : 'N/A') + '">' +
                        (ip.failed_passwords ? ip.failed_passwords.join(', ') : 'N/A') +
                    '</td>' +
                    '<td style="padding: 10px; color: #60a5fa; font-size: 0.85rem;">' + browserInfo + '</td>' +
                    '<td style="padding: 10px; color: #94a3b8; font-size: 0.85rem;">' + firstSeen + '</td>' +
                    '<td style="padding: 10px; color: #f59e0b; font-weight: 600;">' + (ip.total_attempts || 0) + '</td>' +
                    '<td style="padding: 10px; color: #f59e0b; font-size: 0.85rem;">' +
                        (ip.remaining_time || (ip.status === 'permanent' ? 'PERMANENT' : 'Expired')) +
                    '</td>' +
                    '<td style="padding: 10px;">' +
                        '<button onclick="unbanIP(\'' + ip.ip + '\')" style="background: #22c55e; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 0.8rem;">' +
                            'Unban' +
                        '</button>' +
                        (ip.status !== 'permanent' ? 
                            '<button onclick="extendBan(\'' + ip.ip + '\')" style="background: #f59e0b; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 0.8rem;">' +
                                'Extend' +
                            '</button>' +
                            '<button onclick="permanentBan(\'' + ip.ip + '\')" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">' +
                                'Permanent' +
                            '</button>'
                        : '') +
                    '</td>' +
                '</tr>';
            });
            
            html += '</tbody>' +
                    '</table>' +
                '</div>';
            
            container.innerHTML = html;
        }
        
        function unbanIP(ip) {
            if (confirm('Unban IP address ' + ip + '?')) {
                fetch('/admin/manage-ip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ip, action: 'unban' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        loadIPManagement();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }
        
        function extendBan(ip) {
            const days = prompt('Extend ban for ' + ip + ' by how many days? (1-30)');
            if (days && !isNaN(days) && days >= 1 && days <= 30) {
                fetch('/admin/manage-ip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ip, action: 'extend', duration_days: days })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        loadIPManagement();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }
        
        function permanentBan(ip) {
            if (confirm('Permanently ban IP address ' + ip + '? This cannot be undone through the timeout.')) {
                fetch('/admin/manage-ip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ip, action: 'permanent' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        loadIPManagement();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }

        function approveUser(email) {
            // Get the selected account type
            const selectId = 'accountType_' + email.replace('@', '_').replace(/\./g, '_');
            const accountType = document.getElementById(selectId).value;
            
            const accountTypeNames = {
                'external': 'External Client',
                'investor': 'Investor',
                'execution': 'Execution Trader',
                'internal': 'Internal Team',
                'admin': 'Administrator'
            };
            
            if (confirm('Approve ' + email + ' as ' + accountTypeNames[accountType] + '?')) {
                fetch('/admin/approve-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: email,
                        account_type: accountType
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('User approved as ' + accountTypeNames[accountType] + '!\n\nPassword: ' + data.password + '\n\nThis has been sent to ' + email);
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }

        function rejectUser(email) {
            const reason = prompt('Rejection reason for ' + email + ':');
            if (reason) {
                fetch('/admin/reject-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email, reason: reason })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('User rejected');
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }

        function resetPassword(email) {
            if (confirm('Reset password for ' + email + '?')) {
                fetch('/admin/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Password reset! New password: ' + data.password);
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }
    </script>
    {% endif %}

    <!-- Footer -->
    <footer style="margin-top: 100px; padding: 60px 40px 30px; background: linear-gradient(135deg, rgba(20, 25, 31, 0.98) 0%, rgba(31, 41, 55, 0.95) 100%); border-top: 1px solid rgba(96, 165, 250, 0.2); position: relative;">
        <div style="position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent 0%, #60a5fa 50%, transparent 100%);"></div>
        
        <div style="max-width: 1400px; margin: 0 auto;">
            <div style="margin-bottom: 40px; text-align: center;">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <svg width="28" height="28" viewBox="0 0 32 32" fill="none" style="margin-top: 2px;">
                            <path d="M16 3L26.5 9.5V22.5L16 29L5.5 22.5V9.5L16 3Z" stroke="#93c5fd" stroke-width="2" fill="rgba(147, 197, 253, 0.08)"/>
                            <path d="M16 8L22 11.5V20.5L16 24L10 20.5V11.5L16 8Z" stroke="rgba(147, 197, 253, 0.4)" stroke-width="1"/>
                            <circle cx="16" cy="16" r="3" fill="#dbeafe"/>
                        </svg>
                        <div style="display: flex; align-items: center;">
                            <span style="font-size: 1.3rem; font-weight: 700; background: linear-gradient(90deg, #dbeafe, #93c5fd); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ATLAS</span>
                            <span style="font-size: 1.2rem; font-weight: 400; color: #60a5fa; margin: 0 4px;">:</span>
                            <span style="font-size: 1.3rem; font-weight: 700; background: linear-gradient(90deg, #93c5fd, #dbeafe); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">NEXUS</span>
                        </div>
                    </div>
                    <p style="color: #92969C; font-size: 1rem; max-width: 600px; margin: 0 auto; line-height: 1.6;">
                        Executive Command Center - Full access to global financial intelligence, securitisation analysis, and risk management solutions.
                    </p>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 40px; margin-bottom: 40px; padding-top: 40px; border-top: 1px solid rgba(184, 192, 200, 0.1);">
                <div>
                    <h4 style="color: #E5E9F0; font-size: 0.875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 20px;">Platform Tools</h4>
                    <a href="#" onclick="showSection('dashboard'); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Dashboard</a>
                    <a href="#" onclick="showSection('analytics'); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Analytics</a>
                    <a href="#" onclick="showSection('risk'); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Risk Management</a>
                    <a href="#" onclick="showSection('market'); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Market Intelligence</a>
                    <a href="#" onclick="showSection('portfolio'); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Portfolio</a>
                    <a href="#" onclick="showSection('compliance'); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Compliance</a>
                </div>
                
                <div>
                    <h4 style="color: #E5E9F0; font-size: 0.875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 20px;">Resources</h4>
                    <a href="/api-docs" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">API Documentation</a>
                    <a href="/data-feeds" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Data Feeds</a>
                    <a href="/research" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Research Portal</a>
                    <a href="/training" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Training</a>
                    <a href="#" onclick="window.open('https://status.atlasnexus.co.uk', '_blank'); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">System Status</a>
                </div>
                
                <div>
                    <h4 style="color: #E5E9F0; font-size: 0.875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 20px;">Legal & Compliance</h4>
                    <a href="/privacy" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Privacy Policy</a>
                    <a href="/terms" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Terms of Service</a>
                    <a href="/compliance" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Regulatory Compliance</a>
                    <a href="/data-protection" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Data Protection</a>
                    <a href="/security" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Security Policy</a>
                </div>
                
                <div>
                    <h4 style="color: #E5E9F0; font-size: 0.875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 20px;">Executive Support</h4>
                    <span style="display: block; color: #92969C; font-size: 0.875rem; margin-bottom: 10px;">24/7 Priority Support</span>
                    <a href="mailto:Support@AtlasNexus.co.uk" style="display: block; color: #60a5fa; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Support@AtlasNexus.co.uk</a>
                    <span style="display: block; color: #92969C; font-size: 0.875rem; margin-bottom: 5px;">Direct Line:</span>
                    <a href="tel:+442071234567" style="display: block; color: #60a5fa; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px;">+44 20 7123 4567</a>
                    <a href="#" onclick="toggleAccount(); return false;" style="display: block; color: #92969C; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; transition: all 0.3s ease;">Account Settings</a>
                </div>
            </div>

            <div style="text-align: center; padding-top: 30px; border-top: 1px solid rgba(184, 192, 200, 0.1);">
                <p style="color: #92969C; font-size: 0.875rem; margin: 0;">
                    © 2024 AtlasNexus. All rights reserved. | {{ account_type }} Access Level | Session Active
                </p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    
    // Global variables - must be defined before any functions that use them
    let tickerInitialized = false;
    let tickerPosition = 0;
    let tickerAnimationId = null;
    let isDragging = false;
    let startX = 0;
    let scrollLeft = 0;
    
    // Market Data for Ticker (must be defined before any functions that use it)
    let marketData = {
        // Government Bonds
        'US 10Y': { value: 4.67, change24h: 0.03, change7d: -0.05, change30d: 0.15 },
        'UK 10Y': { value: 4.21, change24h: -0.02, change7d: 0.08, change30d: -0.12 },
        'DE 10Y': { value: 2.45, change24h: 0.01, change7d: -0.12, change30d: 0.08 },
        'US 5Y': { value: 4.34, change24h: 0.02, change7d: -0.03, change30d: 0.12 },
        'US 2Y': { value: 4.89, change24h: 0.01, change7d: -0.02, change30d: 0.08 },
        
        // Central Bank Rates
        'FED RATE': { value: 5.50, change24h: 0, change7d: 0, change30d: 0.25, history: [5.25, 5.25, 5.50, 5.50] },
        'BOE RATE': { value: 5.25, change24h: 0, change7d: 0, change30d: 0, history: [5.00, 5.00, 5.25, 5.25] },
        'ECB RATE': { value: 4.00, change24h: 0, change7d: 0, change30d: -0.25, history: [4.50, 4.25, 4.00, 4.00] },
        
        // Reference Rates
        'SOFR': { value: 5.32, change24h: -0.01, change7d: 0.02, change30d: 0.18 },
        'SONIA': { value: 5.18, change24h: 0, change7d: 0.01, change30d: 0.05 },
        'ESTR': { value: 3.88, change24h: 0, change7d: -0.01, change30d: -0.15 },
        
        // Credit Spreads
        'IG SPREAD': { value: 1.45, change24h: -0.02, change7d: 0.05, change30d: -0.08 },
        'HY SPREAD': { value: 4.25, change24h: 0.08, change7d: -0.15, change30d: 0.25 },
        'CMBS AAA': { value: 1.45, change24h: -0.02, change7d: 0.03, change30d: -0.05 },
        'RMBS AAA': { value: 1.25, change24h: -0.01, change7d: 0.02, change30d: -0.03 },
        'CLO AAA': { value: 1.75, change24h: -0.03, change7d: 0.06, change30d: -0.10 },
        
        // FX Rates
        'GBP/USD': { value: 1.2745, change24h: -0.0023, change7d: 0.0156, change30d: -0.0234 },
        'EUR/USD': { value: 1.0842, change24h: 0.0012, change7d: -0.0089, change30d: 0.0145 },
        'USD/JPY': { value: 149.75, change24h: 0.45, change7d: -1.23, change30d: 5.67 },
        'EUR/GBP': { value: 0.8508, change24h: 0.0034, change7d: -0.0201, change30d: 0.0089 },
        
        // Equity Indices
        'S&P 500': { value: 4567.89, change24h: 23.45, change7d: -67.23, change30d: 124.56 },
        'FTSE 100': { value: 7543.21, change24h: -15.67, change7d: 45.89, change30d: -23.45 },
        'DAX': { value: 16345.67, change24h: 34.56, change7d: -89.12, change30d: 234.56 },
        
        // Commodities
        'GOLD': { value: 2034.50, change24h: -5.75, change7d: 23.40, change30d: -12.34 },
        'OIL WTI': { value: 72.34, change24h: 0.89, change7d: -1.56, change30d: 3.45 },
        'SILVER': { value: 24.56, change24h: -0.34, change7d: 0.78, change30d: -1.23 }
    };


    // Define drag functions first (before createTicker)
    function startAutoScroll() {
        if (isDragging) return;
        
        const ticker = document.getElementById('marketTicker');
        if (!ticker) return;
        
        // Cancel any existing animation
        if (tickerAnimationId) {
            cancelAnimationFrame(tickerAnimationId);
        }
        
        // Smooth continuous animation
        function animate() {
            if (!isDragging) {
                tickerPosition -= 0.3; // Slower smooth scroll speed
                
                // Get actual width of one set of content
                const tickerWidth = ticker.scrollWidth / 3;
                
                // Reset position for endless loop
                if (Math.abs(tickerPosition) >= tickerWidth) {
                    tickerPosition = tickerPosition % tickerWidth;
                }
                
                ticker.style.transform = 'translateX(' + tickerPosition + 'px)';
                tickerAnimationId = requestAnimationFrame(animate);
            }
        }
        
        animate();
    }
    
    function startDrag(e) {
        isDragging = true;
        const container = document.getElementById('tickerContainer');
        const ticker = document.getElementById('marketTicker');
        container.classList.add('dragging');
        
        // Clear any pending resume timeout
        if (window.tickerResumeTimeout) {
            clearTimeout(window.tickerResumeTimeout);
            window.tickerResumeTimeout = null;
        }
        
        // Cancel auto-scroll
        if (tickerAnimationId) {
            cancelAnimationFrame(tickerAnimationId);
            tickerAnimationId = null;
        }
        
        // Always get current position from the actual transform
        const currentTransform = window.getComputedStyle(ticker).transform;
        if (currentTransform !== 'none') {
            const matrix = new DOMMatrix(currentTransform);
            tickerPosition = matrix.m41; // Update global position
            scrollLeft = tickerPosition;
        } else {
            scrollLeft = tickerPosition;
        }
        
        startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
        e.preventDefault();
    }
    
    function drag(e) {
        if (!isDragging) return;
        
        e.preventDefault();
        const ticker = document.getElementById('marketTicker');
        const x = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
        const walk = x - startX; // Direct 1:1 movement
        
        tickerPosition = scrollLeft + walk;
        
        // Handle endless scrolling boundaries
        const tickerWidth = ticker.scrollWidth / 3;
        if (tickerPosition > 0) {
            tickerPosition = -tickerWidth + (tickerPosition % tickerWidth);
        } else if (Math.abs(tickerPosition) >= tickerWidth * 2) {
            tickerPosition = tickerPosition % tickerWidth;
        }
        
        ticker.style.transition = 'none'; // Remove transition for immediate response
        ticker.style.transform = 'translateX(' + tickerPosition + 'px)';
    }
    
    function stopDrag() {
        if (!isDragging) return;
        
        isDragging = false;
        const container = document.getElementById('tickerContainer');
        const ticker = document.getElementById('marketTicker');
        container.classList.remove('dragging');
        
        // Save the final position
        const currentTransform = window.getComputedStyle(ticker).transform;
        if (currentTransform !== 'none') {
            const matrix = new DOMMatrix(currentTransform);
            tickerPosition = matrix.m41;
        }
        
        // Re-enable smooth transitions
        ticker.style.transition = 'transform 0.5s linear';
        
        // Clear any existing resume timeout
        if (window.tickerResumeTimeout) {
            clearTimeout(window.tickerResumeTimeout);
        }
        
        // Resume auto-scroll after a delay
        window.tickerResumeTimeout = setTimeout(() => {
            if (!isDragging) {
                startAutoScroll();
            }
        }, 2000);
    }

    // Enhanced Data Integration with multiple sources
    async function fetchLiveMarketData() {
        try {
            // Check if we have cached data from last 24 hours
            const cachedData = localStorage.getItem('marketDataCache');
            const cacheTime = localStorage.getItem('marketDataCacheTime');
            const now = new Date().getTime();
            
            // Use cache if less than 24 hours old
            if (cachedData && cacheTime && (now - parseInt(cacheTime)) < 24 * 60 * 60 * 1000) {
                const cached = JSON.parse(cachedData);
                Object.assign(marketData, cached);
                createTicker();
                return;
            }
            
            // Fetch live FX rates
            const fxResponse = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
            const fxData = await fxResponse.json();
            
            // Fetch US Treasury yields from FRED (Federal Reserve Economic Data)
            // Note: FRED provides daily updates, perfect for bonds
            const fredApiKey = 'demo'; // Use 'demo' for testing, get free key at https://fred.stlouisfed.org/docs/api/api_key.html
            const bondSymbols = {
                'DGS2': 'US 2Y',  // 2-Year Treasury
                'DGS5': 'US 5Y',  // 5-Year Treasury
                'DGS10': 'US 10Y' // 10-Year Treasury
            };
            
            // Fetch SOFR rate (replaces LIBOR)
            try {
                const sofrResponse = await fetch('/api/market-data/fred/SOFR');
                const sofrData = await sofrResponse.json();
                if (sofrData.observations && sofrData.observations[0]) {
                    marketData['SOFR'].value = parseFloat(sofrData.observations[0].value);
                }
            } catch (e) {
                // SOFR data not available
            }
            
            // Fetch ECB rates (European Central Bank provides free data)
            try {
                const ecbResponse = await fetch('https://api.frankfurter.app/latest?from=EUR');
                const ecbData = await ecbResponse.json();
                // ECB main refinancing rate (approximation)
                marketData['ECB RATE'].value = 4.00; // ECB publishes rates on their website
            } catch (e) {
                // ECB data not available
            }
            
            // Bank of England base rate (from UK government data)
            // Note: BOE updates rates monthly, we'll use static value updated manually
            marketData['BOE RATE'].value = 5.25;
            
            // SONIA (Sterling Overnight Index Average) - UK equivalent of SOFR
            marketData['SONIA'].value = 5.18;
            
            // Update FX rates with live data
            if (fxData && fxData.rates) {
                marketData['GBP/USD'].value = (1 / fxData.rates.GBP).toFixed(4);
                marketData['EUR/USD'].value = (1 / fxData.rates.EUR).toFixed(4);
                marketData['USD/JPY'].value = fxData.rates.JPY;
                marketData['EUR/GBP'].value = (fxData.rates.GBP / fxData.rates.EUR).toFixed(4);
            }
            
            // Fetch credit spreads (using approximations based on indices)
            // IG (Investment Grade) and HY (High Yield) spreads
            try {
                // These would typically come from iBoxx indices or ICE BofA indices
                // Using realistic current market values
                marketData['IG SPREAD'].value = 1.45;
                marketData['HY SPREAD'].value = 4.25;
                marketData['CMBS AAA'].value = 1.45;
                marketData['CLO AAA'].value = 1.75;
            } catch (e) {
                // Credit spread data not available
            }
            
            // Fetch commodity prices
            try {
                // Gold price from exchangerate-api (they provide XAU rates)
                if (fxData && fxData.rates && fxData.rates.XAU) {
                    marketData['GOLD'].value = (1 / fxData.rates.XAU).toFixed(2);
                }
            } catch (e) {
                // Gold price not available
            }
            
            // Cache the data for 24 hours
            localStorage.setItem('marketDataCache', JSON.stringify(marketData));
            localStorage.setItem('marketDataCacheTime', now.toString());
            
            // Recreate ticker with updated data
            createTicker();
            
        } catch (error) {
            // Using fallback market data
        }
    }
    
    // Fetch live data will be called after DOM is ready
    
    // Create ticker content
    function createTicker() {
        const ticker = document.getElementById('marketTicker');
        const container = document.getElementById('tickerContainer');
        
        console.log('CreateTicker called - ticker element:', ticker);
        console.log('CreateTicker called - container element:', container);
        console.log('Market data:', marketData);
        
        if (!ticker || !container) {
            console.error('Ticker or container not found!');
            // Try again in 100ms if elements not ready
            setTimeout(createTicker, 100);
            return;
        }
        
        // Ensure ticker is visible
        container.style.display = 'block';
        container.style.visibility = 'visible';
        container.style.opacity = '1';
        container.style.background = 'linear-gradient(90deg, #1a1d23 0%, #0f1419 100%)';
        container.style.minHeight = '45px';
        ticker.style.color = '#ffffff';
        
        // Prevent multiple initializations
        if (tickerInitialized) {
            // Just update content without re-adding event listeners
            updateTickerContent();
            return;
        }
        
        // Stop any existing animation
        if (tickerAnimationId) {
            cancelAnimationFrame(tickerAnimationId);
            tickerAnimationId = null;
        }
        
        let content = '';
        
        // Build one complete set of ticker content
        function buildTickerContent() {
            let singleSet = '';
            
            // Bonds Section
            singleSet += '<span class="ticker-section-header" style="color: #fbbf24; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">BONDS</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['US 10Y', 'UK 10Y', 'DE 10Y', 'US 5Y', 'US 2Y'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Central Banks
            singleSet += '<span class="ticker-section-header" style="color: #fbbf24; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">CENTRAL BANKS</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['FED RATE', 'BOE RATE', 'ECB RATE'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Reference Rates
            singleSet += '<span class="ticker-section-header" style="color: #fbbf24; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">REFERENCE RATES</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['SOFR', 'SONIA', 'ESTR'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Credit Spreads
            singleSet += '<span class="ticker-section-header" style="color: #fbbf24; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">SECURITISATION</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['IG SPREAD', 'HY SPREAD', 'CMBS AAA', 'RMBS AAA', 'CLO AAA'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // FX
            singleSet += '<span class="ticker-section-header" style="color: #fbbf24; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">FX</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['GBP/USD', 'EUR/USD', 'USD/JPY', 'EUR/GBP'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Equities
            singleSet += '<span class="ticker-section-header" style="color: #fbbf24; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">EQUITIES</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['S&P 500', 'FTSE 100', 'DAX'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Commodities  
            singleSet += '<span class="ticker-section-header" style="color: #fbbf24; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">COMMODITIES</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['GOLD', 'OIL WTI', 'SILVER'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            singleSet += '<span class="ticker-separator" style="margin: 0 2rem;">||</span>';
            return singleSet;
        }
        
        // Create three copies for seamless endless scrolling
        const singleContent = buildTickerContent();
        console.log('Built ticker content length:', singleContent.length);
        ticker.innerHTML = singleContent + singleContent + singleContent;
        console.log('Ticker innerHTML set, scrollWidth:', ticker.scrollWidth);
        
        // Setup drag functionality (only once)
        container.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDrag);
        
        // Touch events for mobile
        container.addEventListener('touchstart', startDrag);
        document.addEventListener('touchmove', drag);
        document.addEventListener('touchend', stopDrag);
        
        // Mark as initialized
        tickerInitialized = true;
        
        // Start auto-scroll
        startAutoScroll();
    }

    function createTickerItem(symbol, data) {
        const formatValue = (val) => {
            if (val === undefined || val === null || isNaN(val)) {
                return 'N/A';
            }
            if (symbol.includes('/')) return val.toFixed(4);
            else if (symbol.includes('JPY')) return val.toFixed(2);
            else if (symbol.includes('RATE') || symbol.includes('SPREAD') || symbol.includes('AAA') || symbol.includes('SOFR') || symbol.includes('SONIA') || symbol.includes('ESTR') || symbol.includes('TONAR')) return val.toFixed(2) + '%';
            else if (symbol.includes('GOLD') || symbol.includes('SILVER') || symbol.includes('OIL')) return '$' + val.toFixed(2);
            else if (symbol.includes('S&P') || symbol.includes('FTSE') || symbol.includes('DAX') || symbol.includes('NIKKEI') || symbol.includes('VIX')) return val.toFixed(2);
            else return val.toFixed(2) + '%';
        };
        
        const getChangeColor = (change) => {
            if (change === undefined || change === null || isNaN(change)) {
                return '#94a3b8';
            }
            if (change > 0) return '#22c55e';
            if (change < 0) return '#ef4444';
            return '#94a3b8';
        };
        
        const formatChange = (change) => {
            if (change === undefined || change === null || isNaN(change)) {
                return 'N/A';
            }
            return (change > 0 ? '+' : '') + change.toFixed(2) + '%';
        };
        
        // Build HTML with proper inline styles - exactly like Gate2
        let html = '';
        
        // Special handling for central bank rates with history
        if ((symbol === 'FED RATE' || symbol === 'BOE RATE' || symbol === 'ECB RATE') && data.history) {
            html += '<div class="ticker-item" style="display: inline-flex; align-items: center; gap: 8px; margin: 0 12px;">';
            html += '<span class="ticker-symbol" style="color: #dbeafe; font-weight: 600;">' + symbol + ':</span>';
            html += '<span class="ticker-value" style="color: #fff; font-weight: 500;">' + formatValue(data.value) + '</span>';
            html += '<span style="color: #64748b; font-size: 0.65rem; margin-left: 8px;">History:</span>';
            
            // Add history rates
            for (let i = 0; i < data.history.length; i++) {
                const rate = data.history[i];
                const color = (i === data.history.length - 1) ? '#fbbf24' : '#94a3b8';
                const weight = (i === data.history.length - 1) ? '600' : '400';
                html += '<span style="color: ' + color + '; font-size: 0.75rem; font-weight: ' + weight + ';">' + rate.toFixed(2) + '%</span>';
            }
            
            html += '</div>';
            html += '<span class="ticker-separator" style="color: #475569; margin: 0 8px;">●</span>';
        } else {
            // Regular ticker item
            html += '<div class="ticker-item" style="display: inline-flex; align-items: center; gap: 8px; margin: 0 12px;">';
            html += '<span class="ticker-symbol" style="color: #dbeafe; font-weight: 600;">' + symbol + ':</span>';
            html += '<span class="ticker-value" style="color: #fff; font-weight: 500;">' + formatValue(data.value) + '</span>';
            html += '<span style="color: #64748b; font-size: 0.7rem; margin-left: 4px;">24h</span>';
            html += '<span style="color: ' + getChangeColor(data.change24h) + '; font-size: 0.8rem; font-weight: 500;">' + formatChange(data.change24h) + '</span>';
            html += '<span style="color: #64748b; font-size: 0.7rem;">7d</span>';
            html += '<span style="color: ' + getChangeColor(data.change7d) + '; font-size: 0.8rem; font-weight: 500;">' + formatChange(data.change7d) + '</span>';
            html += '<span style="color: #64748b; font-size: 0.7rem;">30d</span>';
            html += '<span style="color: ' + getChangeColor(data.change30d) + '; font-size: 0.8rem; font-weight: 500;">' + formatChange(data.change30d) + '</span>';
            html += '</div>';
            html += '<span class="ticker-separator" style="color: #475569; margin: 0 8px;">●</span>';
        }
        
        return html;
    }

    // Function to update ticker content without reinitializing
    function updateTickerContent() {
        const ticker = document.getElementById('marketTicker');
        if (!ticker) return;
        
        let content = '';
        
        // Build one complete set of ticker content
        function buildTickerContent() {
            let singleSet = '';
            
            // Bonds Section
            singleSet += '<span class="ticker-section-header" style="color: #fbbf24; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">BONDS</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['US 10Y', 'UK 10Y', 'DE 10Y', 'US 5Y', 'US 2Y'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Central Banks
            singleSet += '<span class="ticker-section-header" style="color: #fbbf24; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">CENTRAL BANKS</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['FED RATE', 'BOE RATE', 'ECB RATE'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Reference Rates
            singleSet += '<span class="ticker-section-header" style="color: #fbbf24; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">REFERENCE RATES</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['SOFR', 'SONIA', 'ESTR'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Credit Spreads
            singleSet += '<span class="ticker-section-header" style="color: #fbbf24; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">SECURITISATION</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['IG SPREAD', 'HY SPREAD', 'CMBS AAA', 'RMBS AAA', 'CLO AAA'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // FX
            singleSet += '<span class="ticker-section-header" style="color: #fbbf24; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">FX</span>';
            singleSet += '<span class="ticker-separator" style="color: rgba(96, 165, 250, 0.4); margin: 0 0.5rem;">●</span>';
            ['GBP/USD', 'EUR/USD', 'USD/JPY', 'EUR/GBP'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            // Commodities
            singleSet += '<span class="ticker-section-header">COMMODITIES</span>';
            singleSet += '<span class="ticker-separator">●</span>';
            ['GOLD', 'OIL WTI', 'SILVER'].forEach(key => {
                const data = marketData[key];
                if (data) singleSet += createTickerItem(key, data);
            });
            
            return singleSet;
        }
        
        // Create three copies for seamless loop
        const singleContent = buildTickerContent();
        ticker.innerHTML = singleContent + singleContent + singleContent;
    }
    
    // Initialize everything on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing...');
        
        // Set initial padding for sections based on toolbar state
        var nav = document.getElementById('navBar');
        var sections = document.querySelectorAll('#market-section, #data-section, #analytics-section, #risk-section, #portfolio-section, #compliance-section, #permutation-section');
        
        // Check if toolbar is visible and set appropriate padding
        if (nav && nav.style.display !== 'none') {
            sections.forEach(function(s) { 
                if(s) s.style.paddingTop = '140px'; 
            });
        } else {
            sections.forEach(function(s) { 
                if(s) s.style.paddingTop = '90px'; 
            });
        }
        
        // Create and initialize ticker
        createTicker();
        
        // Fetch live data on load and every 30 seconds
        fetchLiveMarketData();
        setInterval(fetchLiveMarketData, 30000);
        
        // Set current date
        const currentDateElement = document.getElementById('currentDate');
        if (currentDateElement) {
            currentDateElement.textContent = new Date().toLocaleDateString('en-GB', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
        // Animate counters
        animateCounter('aumCounter', 0, 127.5, 'B', 2000);
        animateCounter('dealsCounter', 0, 342, '', 2000);
        
        // Initialize Chart
        const ctx = document.getElementById('spreadChart');
        if (ctx) {
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 30}, (_, i) => 'Day ' + (i+1)),
                    datasets: [{
                        label: 'AAA Spread',
                        data: Array.from({length: 30}, () => Math.random() * 0.5 + 1.5),
                        borderColor: '#60a5fa',
                        backgroundColor: 'rgba(96, 165, 250, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8', maxTicksLimit: 10 }
                        }
                    }
                }
            });
        }
    });

    function animateCounter(id, start, end, suffix, duration) {
        const element = document.getElementById(id);
        if (!element) return;
        
        const prefix = '€';
        let startTime = null;
        
        function animate(currentTime) {
            if (startTime === null) startTime = currentTime;
            const timeElapsed = currentTime - startTime;
            const progress = Math.min(timeElapsed / duration, 1);
            
            const currentValue = start + (end - start) * easeOutQuart(progress);
            element.textContent = prefix + currentValue.toFixed(1) + suffix;
            
            if (progress < 1) {
                requestAnimationFrame(animate);
            }
        }
        
        requestAnimationFrame(animate);
    }

    function easeOutQuart(t) {
        return 1 - (--t) * t * t * t;
    }
    
    
    // Show section based on navigation
    function showSection(section) {
        // Hide all sections
        document.getElementById('main-dashboard').style.display = 'none';
        document.getElementById('market-section').style.display = 'none';
        document.getElementById('data-section').style.display = 'none';
        document.getElementById('analytics-section').style.display = 'none';
        document.getElementById('risk-section').style.display = 'none';
        document.getElementById('portfolio-section').style.display = 'none';
        document.getElementById('compliance-section').style.display = 'none';
        document.getElementById('permutation-section').style.display = 'none';
        
        // Reset all navigation buttons to inactive state
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.style.background = 'transparent';
            btn.style.color = '#60a5fa';
            btn.style.border = '1px solid #60a5fa';
        });
        
        // Show selected section
        if (section === 'dashboard') {
            document.getElementById('main-dashboard').style.display = 'block';
        } else {
            const sectionElement = document.getElementById(section + '-section');
            if (sectionElement) {
                sectionElement.style.display = 'block';
            }
        }
        
        // Highlight the active button
        const activeButton = document.querySelector(`.nav-btn[data-section="${section}"]`);
        if (activeButton) {
            activeButton.style.background = 'linear-gradient(90deg, #60a5fa, #3b82f6)';
            activeButton.style.color = 'white';
            activeButton.style.border = '1px solid #60a5fa';
        }
    }
    
    // Toggle Account dropdown
    function toggleAccount() {
        alert('Account settings coming soon!');
    }
    
    // Optimized FRED API Integration with intelligent update frequencies
    async function fetchEnhancedFREDData() {
        const fredApiKey = '06d8ad927adcea880c39dc648df3d02f';
        const baseUrl = 'https://api.stlouisfed.org/fred/series/observations';
        
        // FRED API Rate Limits:
        // - 120 requests per minute
        // - 1000 requests per day without registration
        // - With API key: unlimited daily requests
        
        // Data Update Frequencies from FRED:
        // Daily Updates (fetch once per day):
        const dailySeries = {
            'DGS2': 'US 2Y',         // 2-Year Treasury - Updated daily at 3:30 PM ET
            'DGS5': 'US 5Y',         // 5-Year Treasury - Updated daily at 3:30 PM ET  
            'DGS10': 'US 10Y',       // 10-Year Treasury - Updated daily at 3:30 PM ET
            'DGS30': 'US 30Y',       // 30-Year Treasury - Updated daily at 3:30 PM ET
            'SOFR': 'SOFR',          // SOFR - Updated daily at 8:00 AM ET
            'DFF': 'FED RATE',       // Federal Funds Rate - Updated daily
            'DPRIME': 'PRIME RATE',  // Bank Prime Loan Rate - Updated daily
        };
        
        // Weekly Updates (fetch once per week):
        const weeklySeries = {
            'BAMLH0A0HYM2': 'HY SPREAD',  // High Yield Spread - Updated weekly
            'BAMLC0A0CM': 'IG SPREAD',    // Investment Grade Spread - Updated weekly
            'MORTGAGE30US': 'US 30Y MTG', // 30-Year Mortgage Rate - Updated weekly (Thursdays)
            'MORTGAGE15US': 'US 15Y MTG', // 15-Year Mortgage Rate - Updated weekly (Thursdays)
        };
        
        // Monthly Updates (fetch once per month):
        const monthlySeries = {
            'UNRATE': 'US UNEMP',     // Unemployment Rate - First Friday of month
            'CPIAUCSL': 'US CPI',     // Consumer Price Index - Mid-month
            'PPIACO': 'US PPI',       // Producer Price Index - Mid-month
            'HOUST': 'HOUSING',       // Housing Starts - Third week of month
        };
        
        // Available Additional FRED Series (50+ data points):
        // Bond Markets: T1YIE (1Y Inflation), T5YIFR (5Y Forward Inflation), TEDRATE (TED Spread)
        // Credit Markets: DEXUSEU (USD/EUR), DEXUSUK (USD/GBP), DEXJPUS (JPY/USD)
        // Economic Indicators: GDP, PAYEMS (Nonfarm Payrolls), INDPRO (Industrial Production)
        // Money Supply: M1SL, M2SL, BOGMBASE
        // Interest Rates: TB3MS (3-Month T-Bill), TB6MS (6-Month T-Bill)
        // Real Estate: CSUSHPISA (Case-Shiller Index), PERMIT (Building Permits)
        
        const now = new Date();
        const today = now.toDateString();
        const thisWeek = 'week-' + Math.floor(now.getTime() / (7 * 24 * 60 * 60 * 1000));
        const thisMonth = now.getFullYear() + '-' + now.getMonth();
        
        // Check cache timestamps
        const dailyCache = localStorage.getItem('fredDailyCache');
        const dailyCacheDate = localStorage.getItem('fredDailyCacheDate');
        const weeklyCache = localStorage.getItem('fredWeeklyCache');
        const weeklyCacheWeek = localStorage.getItem('fredWeeklyCacheWeek');
        const monthlyCache = localStorage.getItem('fredMonthlyCache');
        const monthlyCacheMonth = localStorage.getItem('fredMonthlyCacheMonth');
        
        let dataToFetch = {};
        
        // Determine what needs updating
        if (!dailyCache || dailyCacheDate !== today) {
            Object.assign(dataToFetch, dailySeries);
        }
        if (!weeklyCache || weeklyCacheWeek !== thisWeek) {
            Object.assign(dataToFetch, weeklySeries);
        }
        if (!monthlyCache || monthlyCacheMonth !== thisMonth) {
            Object.assign(dataToFetch, monthlySeries);
        };
        
        // Only fetch if we have data that needs updating
        if (Object.keys(dataToFetch).length === 0) {
            // All FRED data is up-to-date, using cache
            // Load from cache
            if (dailyCache) Object.assign(marketData, JSON.parse(dailyCache));
            if (weeklyCache) Object.assign(marketData, JSON.parse(weeklyCache));
            if (monthlyCache) Object.assign(marketData, JSON.parse(monthlyCache));
            return;
        }
        
        // Fetching FRED data points
        
        try {
            const fetchedData = {};
            let requestCount = 0;
            
            // Batch requests with delay to respect rate limits
            for (const [seriesId, dataKey] of Object.entries(dataToFetch)) {
                // Add delay every 10 requests to stay well under 120/minute limit
                if (requestCount > 0 && requestCount % 10 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 1000)); // 1 second delay
                }
                
                // Use proxy to avoid CORS issues
                const response = await fetch('/api/market-data/fred/' + seriesId);
                const data = await response.json();
                
                if (data.observations && data.observations[0]) {
                    const value = parseFloat(data.observations[0].value);
                    fetchedData[dataKey] = { value: value, timestamp: data.observations[0].date };
                    
                    if (marketData[dataKey]) {
                        marketData[dataKey].value = value;
                    } else {
                        marketData[dataKey] = { value: value, change24h: 0, change7d: 0, change30d: 0 };
                    }
                }
                
                requestCount++;
            }
            
            // Save to appropriate caches
            if (Object.keys(dailySeries).some(key => dataToFetch[key])) {
                const dailyData = {};
                Object.keys(dailySeries).forEach(key => {
                    if (fetchedData[dailySeries[key]]) {
                        dailyData[dailySeries[key]] = fetchedData[dailySeries[key]];
                    }
                });
                localStorage.setItem('fredDailyCache', JSON.stringify(dailyData));
                localStorage.setItem('fredDailyCacheDate', today);
            }
            
            if (Object.keys(weeklySeries).some(key => dataToFetch[key])) {
                const weeklyData = {};
                Object.keys(weeklySeries).forEach(key => {
                    if (fetchedData[weeklySeries[key]]) {
                        weeklyData[weeklySeries[key]] = fetchedData[weeklySeries[key]];
                    }
                });
                localStorage.setItem('fredWeeklyCache', JSON.stringify(weeklyData));
                localStorage.setItem('fredWeeklyCacheWeek', thisWeek);
            }
            
            if (Object.keys(monthlySeries).some(key => dataToFetch[key])) {
                const monthlyData = {};
                Object.keys(monthlySeries).forEach(key => {
                    if (fetchedData[monthlySeries[key]]) {
                        monthlyData[monthlySeries[key]] = fetchedData[monthlySeries[key]];
                    }
                });
                localStorage.setItem('fredMonthlyCache', JSON.stringify(monthlyData));
                localStorage.setItem('fredMonthlyCacheMonth', thisMonth);
            }
            
            // FRED data updated
            createTicker(); // Refresh ticker with new data
            
        } catch (error) {
            console.error('Error fetching FRED data:', error);
            // Load from cache if available
            if (dailyCache) Object.assign(marketData, JSON.parse(dailyCache));
            if (weeklyCache) Object.assign(marketData, JSON.parse(weeklyCache));
            if (monthlyCache) Object.assign(marketData, JSON.parse(monthlyCache));
        }
    }
    
    // Intelligent update schedule based on data freshness needs:
    // - Check for daily updates every hour (treasuries update at 3:30 PM ET)
    // - Weekly data checked daily
    // - Monthly data checked weekly
    setInterval(fetchEnhancedFREDData, 60 * 60 * 1000); // Check every hour
    
    // Fetch on load
    fetchEnhancedFREDData();
    
    // Permutation Engine Functions
    let permutationEngine = {
        status: 'stopped',
        startTime: null,
        timer: null,
        progress: 0,
        currentIteration: 0,
        totalIterations: 0
    };
    
    function startPermutationEngine() {
        if (permutationEngine.status === 'running') return;
        
        // Get all input values
        const datasetSize = document.getElementById('perm-dataset-size').value || 1000;
        const iterations = document.getElementById('perm-iterations').value || 100;
        const sampleRate = document.getElementById('perm-sample-rate').value || 100;
        const confidence = document.getElementById('perm-confidence').value;
        const permType = document.getElementById('perm-type').value;
        const optimization = document.getElementById('perm-optimization').value;
        const mode = document.getElementById('perm-mode').value;
        
        // Update engine state
        permutationEngine.status = 'running';
        permutationEngine.startTime = Date.now();
        permutationEngine.totalIterations = iterations;
        permutationEngine.currentIteration = 0;
        permutationEngine.progress = 0;
        
        // Update UI
        document.getElementById('perm-status').textContent = 'Running';
        document.getElementById('perm-status').style.color = '#f59e0b';
        document.getElementById('perm-current-iterations').textContent = '0 / ' + iterations;
        
        // Start timer
        permutationEngine.timer = setInterval(updatePermutationTimer, 1000);
        
        // Simulate processing
        simulatePermutationProcessing();
        
        // Log to results
        const resultsDiv = document.getElementById('perm-results');
        resultsDiv.innerHTML = '<div style="color: #60a5fa; margin-bottom: 1rem;">' +
            '<strong>Engine Started</strong><br>' +
            'Configuration: ' + permType + ' permutation using ' + optimization + '<br>' +
            'Dataset Size: ' + datasetSize + ' | Iterations: ' + iterations + ' | Sample Rate: ' + sampleRate + '%<br>' +
            'Processing Mode: ' + mode + ' | Confidence Level: ' + confidence + '%' +
            '</div>' +
            '<div id="perm-live-results" style="color: #94a3b8; font-family: monospace; font-size: 0.9rem;">' +
                'Processing...' +
            '</div>';
    }
    
    function pausePermutationEngine() {
        if (permutationEngine.status !== 'running') return;
        
        permutationEngine.status = 'paused';
        clearInterval(permutationEngine.timer);
        
        document.getElementById('perm-status').textContent = 'Paused';
        document.getElementById('perm-status').style.color = '#f59e0b';
    }
    
    function stopPermutationEngine() {
        permutationEngine.status = 'stopped';
        clearInterval(permutationEngine.timer);
        
        document.getElementById('perm-status').textContent = 'Stopped';
        document.getElementById('perm-status').style.color = '#ef4444';
        
        // Final results
        if (permutationEngine.currentIteration > 0) {
            showPermutationResults();
        }
    }
    
    function resetPermutationEngine() {
        // Stop engine
        stopPermutationEngine();
        
        // Reset all values
        permutationEngine = {
            status: 'stopped',
            startTime: null,
            timer: null,
            progress: 0,
            currentIteration: 0,
            totalIterations: 0
        };
        
        // Reset UI
        document.getElementById('perm-status').textContent = 'Ready';
        document.getElementById('perm-status').style.color = '#22c55e';
        document.getElementById('perm-progress-bar').style.width = '0%';
        document.getElementById('perm-progress-percent').textContent = '0%';
        document.getElementById('perm-current-iterations').textContent = '0 / 0';
        document.getElementById('perm-time').textContent = '00:00:00';
        document.getElementById('perm-eta').textContent = '--:--:--';
        document.getElementById('perm-results').innerHTML = '<p style="color: #94a3b8; text-align: center;">No results yet. Configure parameters and start the engine.</p>';
        
        // Clear all inputs
        document.querySelectorAll('#permutation-section input').forEach(input => {
            if (input.type === 'number' || input.type === 'text') {
                input.value = '';
            }
        });
    }
    
    function updatePermutationTimer() {
        if (!permutationEngine.startTime) return;
        
        const elapsed = Date.now() - permutationEngine.startTime;
        const hours = Math.floor(elapsed / 3600000);
        const minutes = Math.floor((elapsed % 3600000) / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        
        document.getElementById('perm-time').textContent = 
            hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
        
        // Calculate ETA
        if (permutationEngine.currentIteration > 0) {
            const avgTimePerIteration = elapsed / permutationEngine.currentIteration;
            const remainingIterations = permutationEngine.totalIterations - permutationEngine.currentIteration;
            const remainingTime = avgTimePerIteration * remainingIterations;
            
            const etaHours = Math.floor(remainingTime / 3600000);
            const etaMinutes = Math.floor((remainingTime % 3600000) / 60000);
            const etaSeconds = Math.floor((remainingTime % 60000) / 1000);
            
            var etaString = etaHours.toString().padStart(2, '0') + ':' + 
                            etaMinutes.toString().padStart(2, '0') + ':' + 
                            etaSeconds.toString().padStart(2, '0');
            document.getElementById('perm-eta').textContent = etaString;
        }
    }
    
    function simulatePermutationProcessing() {
        console.log('DEBUG: simulatePermutationProcessing called - Line 3659');
        // Check if engine is running
        if (permutationEngine.status !== 'running') {
            return;
        }
        
        // Increment the iteration counter
        permutationEngine.currentIteration = permutationEngine.currentIteration + 1;
        
        // Calculate the progress percentage
        var progressValue = (permutationEngine.currentIteration / permutationEngine.totalIterations) * 100;
        permutationEngine.progress = progressValue;
        
        // Update the progress bar width
        var progressBar = document.getElementById('perm-progress-bar');
        if (progressBar) {
            progressBar.style.width = progressValue + '%';
        }
        
        // Update the progress percentage text
        var progressPercent = document.getElementById('perm-progress-percent');
        if (progressPercent) {
            progressPercent.textContent = Math.round(progressValue) + '%';
        }
        
        // Update the iteration counter display
        try {
            var iterationsDisplay = document.getElementById('perm-current-iterations');
            if (iterationsDisplay) {
                var iterationText = String(permutationEngine.currentIteration) + ' / ' + String(permutationEngine.totalIterations);
                iterationsDisplay.textContent = iterationText;
            }
        } catch (e) {
            console.error('Error updating iterations display:', e);
        }
        
        // Update live results if element exists
        var liveResultsElement = document.getElementById('perm-live-results');
        if (liveResultsElement) {
            var randomResult = Math.random() * 1000;
            var newResultLine = 'Iteration ' + permutationEngine.currentIteration + ': Result = ' + randomResult.toFixed(4);
            
            // Add new result line
            var currentContent = liveResultsElement.innerHTML;
            liveResultsElement.innerHTML = currentContent + '<br>' + newResultLine;
            
            // Keep only last 10 results
            var allLines = liveResultsElement.innerHTML.split('<br>');
            if (allLines.length > 11) {
                var trimmedLines = allLines.slice(-11);
                liveResultsElement.innerHTML = trimmedLines.join('<br>');
            }
        }
        
        // Check if we should continue or complete
        if (permutationEngine.currentIteration < permutationEngine.totalIterations) {
            // Schedule next iteration
            window.setTimeout(simulatePermutationProcessing, 100);
        } else {
            // Mark as completed
            permutationEngine.status = 'completed';
            
            // Clear the timer
            if (permutationEngine.timer) {
                clearInterval(permutationEngine.timer);
            }
            
            // Update status display
            var statusElement = document.getElementById('perm-status');
            if (statusElement) {
                statusElement.textContent = 'Completed';
                statusElement.style.color = '#22c55e';
            }
            
            // Show final results
            showPermutationResults();
        }
    }
    
    function showPermutationResults() {
        const resultsDiv = document.getElementById('perm-results');
        const elapsed = Date.now() - permutationEngine.startTime;
        const elapsedSeconds = (elapsed / 1000).toFixed(2);
        
        // Generate mock results
        const results = {
            totalPermutations: Math.floor(Math.random() * 1000000) + 100000,
            optimalSolution: (Math.random() * 100).toFixed(4),
            convergenceRate: (Math.random() * 100).toFixed(2),
            efficiency: (85 + Math.random() * 15).toFixed(2),
            memoryUsed: (Math.random() * 500 + 100).toFixed(2)
        };
        
        resultsDiv.innerHTML = '<div style="background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">' +
                '<h4 style="color: #22c55e; margin-bottom: 0.5rem;">Processing Complete</h4>' +
                '<p style="color: #94a3b8;">Completed ' + permutationEngine.currentIteration + ' iterations in ' + elapsedSeconds + ' seconds</p>' +
            '</div>' +
            
            '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">' +
                '<div style="background: rgba(96, 165, 250, 0.1); border: 1px solid #60a5fa; border-radius: 8px; padding: 1rem;">' +
                    '<p style="color: #60a5fa; font-size: 0.9rem; margin-bottom: 0.3rem;">Total Permutations</p>' +
                    '<p style="color: white; font-size: 1.5rem; font-weight: 600;">' + results.totalPermutations.toLocaleString() + '</p>' +
                '</div>' +
                '<div style="background: rgba(96, 165, 250, 0.1); border: 1px solid #60a5fa; border-radius: 8px; padding: 1rem;">' +
                    '<p style="color: #60a5fa; font-size: 0.9rem; margin-bottom: 0.3rem;">Optimal Solution</p>' +
                    '<p style="color: white; font-size: 1.5rem; font-weight: 600;">' + results.optimalSolution + '</p>' +
                '</div>' +
                '<div style="background: rgba(96, 165, 250, 0.1); border: 1px solid #60a5fa; border-radius: 8px; padding: 1rem;">' +
                    '<p style="color: #60a5fa; font-size: 0.9rem; margin-bottom: 0.3rem;">Convergence Rate</p>' +
                    '<p style="color: white; font-size: 1.5rem; font-weight: 600;">' + results.convergenceRate + '%</p>' +
                '</div>' +
                '<div style="background: rgba(96, 165, 250, 0.1); border: 1px solid #60a5fa; border-radius: 8px; padding: 1rem;">' +
                    '<p style="color: #60a5fa; font-size: 0.9rem; margin-bottom: 0.3rem;">Efficiency</p>' +
                    '<p style="color: white; font-size: 1.5rem; font-weight: 600;">' + results.efficiency + '%</p>' +
                '</div>' +
                '<div style="background: rgba(96, 165, 250, 0.1); border: 1px solid #60a5fa; border-radius: 8px; padding: 1rem;">' +
                    '<p style="color: #60a5fa; font-size: 0.9rem; margin-bottom: 0.3rem;">Memory Used</p>' +
                    '<p style="color: white; font-size: 1.5rem; font-weight: 600;">' + results.memoryUsed + ' MB</p>' +
                '</div>' +
            '</div>' +
            
            '<div style="margin-top: 1rem; padding: 1rem; background: rgba(30, 41, 59, 0.5); border-radius: 8px;">' +
                '<button onclick="exportPermutationResults()" style="background: linear-gradient(90deg, #60a5fa, #3b82f6); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-right: 10px;">' +
                    '<i class="fas fa-download"></i> Export Results' +
                '</button>' +
                '<button onclick="visualizePermutationResults()" style="background: linear-gradient(90deg, #8b5cf6, #7c3aed); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">' +
                    '<i class="fas fa-chart-bar"></i> Visualize' +
                '</button>' +
            '</div>';
    }
    
    function exportPermutationResults() {
        alert('Export functionality will be implemented based on your specific requirements.');
    }
    
    function visualizePermutationResults() {
        alert('Visualization functionality will be implemented based on your specific requirements.');
    }
    
    // Securitisation Engine Functions
    let currentInputMode = 'manual';
    let securitisationEngine = {
        status: 'stopped',
        permutations: [],
        validCount: 0,
        invalidCount: 0,
        currentIndex: 0,
        totalPermutations: 0,
        bestIRR: 0
    };
    
    function setInputMode(mode) {
        currentInputMode = mode;
        
        // Update button states
        document.querySelectorAll('.input-mode-btn').forEach(btn => {
            btn.style.background = 'rgba(96, 165, 250, 0.2)';
            btn.style.color = '#60a5fa';
        });
        
        const activeBtn = document.getElementById('mode-' + mode);
        if (activeBtn) {
            activeBtn.style.background = 'linear-gradient(90deg, #60a5fa, #3b82f6)';
            activeBtn.style.color = 'white';
        }
        
        // Show/hide input containers
        const sections = ['project', 'senior', 'mezz', 'equity'];
        sections.forEach(section => {
            var manualEl = document.getElementById('manual-' + section);
            if (manualEl) manualEl.style.display = 'none';
            var rangeEl = document.getElementById('range-' + section);
            if (rangeEl) rangeEl.style.display = 'none';
            var lowhighEl = document.getElementById('lowhigh-' + section);
            if (lowhighEl) lowhighEl.style.display = 'none';
            
            const activeContainer = document.getElementById(mode + '-' + section);
            if (activeContainer) {
                activeContainer.style.display = 'block';
            }
        });
    }
    
    function generatePermutations() {
        // Reset engine state
        securitisationEngine.status = 'running';
        securitisationEngine.permutations = [];
        securitisationEngine.validCount = 0;
        securitisationEngine.invalidCount = 0;
        securitisationEngine.currentIndex = 0;
        securitisationEngine.bestIRR = 0;
        
        // Update UI
        document.getElementById('perm-status').textContent = 'Generating';
        document.getElementById('perm-status').style.color = '#f59e0b';
        
        // Get input values based on mode
        let inputs = collectInputValues();
        
        // Generate all permutations
        let permutations = generateAllPermutations(inputs);
        securitisationEngine.totalPermutations = permutations.length;
        
        // Limit to max permutations
        const maxPerms = parseInt(document.getElementById('sec-max-perms').value) || 1000;
        if (permutations.length > maxPerms) {
            permutations = permutations.slice(0, maxPerms);
        }
        
        // Process permutations
        processPermutations(permutations);
    }
    
    function collectInputValues() {
        let inputs = {};
        
        if (currentInputMode === 'manual') {
            // Collect manual input values
            var capexEl = document.getElementById('sec-capex-manual');
            const capexValues = capexEl ? capexEl.value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v)) : [];
            var opexEl = document.getElementById('sec-opex-manual');
            const opexValues = opexEl ? opexEl.value.split(',').map(v => parseFloat(v.trim())/100).filter(v => !isNaN(v)) : [];
            var rentEl = document.getElementById('sec-rent-manual');
            const rentValues = rentEl ? rentEl.value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v)) : [];
            var seniorDSCREl = document.getElementById('sec-senior-dscr-manual');
            const seniorDSCR = seniorDSCREl ? seniorDSCREl.value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v)) : [];
            var seniorCouponEl = document.getElementById('sec-senior-coupon-manual');
            const seniorCoupon = seniorCouponEl ? seniorCouponEl.value.split(',').map(v => parseFloat(v.trim())/100).filter(v => !isNaN(v)) : [];
            var seniorTenorEl = document.getElementById('sec-senior-tenor-manual');
            const seniorTenor = seniorTenorEl ? seniorTenorEl.value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v)) : [];
            var mezzDSCREl = document.getElementById('sec-mezz-dscr-manual');
            const mezzDSCR = mezzDSCREl ? mezzDSCREl.value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v)) : [];
            var mezzCouponEl = document.getElementById('sec-mezz-coupon-manual');
            const mezzCoupon = mezzCouponEl ? mezzCouponEl.value.split(',').map(v => parseFloat(v.trim())/100).filter(v => !isNaN(v)) : [];
            var equityIRREl = document.getElementById('sec-equity-irr-manual');
            const equityIRR = equityIRREl ? equityIRREl.value.split(',').map(v => parseFloat(v.trim())/100).filter(v => !isNaN(v)) : [];
            
            inputs = {
                capex: capexValues.length ? capexValues : [7500000, 10000000],
                opex: opexValues.length ? opexValues : [0.15, 0.20, 0.25],
                rent: rentValues.length ? rentValues : [120, 140, 160, 180],
                seniorDSCR: seniorDSCR.length ? seniorDSCR : [1.5, 1.55, 1.6],
                seniorCoupon: seniorCoupon.length ? seniorCoupon : [0.03, 0.035, 0.04],
                seniorTenor: seniorTenor.length ? seniorTenor : [5, 7, 10],
                mezzDSCR: mezzDSCR.length ? mezzDSCR : [1.1, 1.15, 1.2],
                mezzCoupon: mezzCoupon.length ? mezzCoupon : [0.06, 0.065, 0.07],
                equityIRR: equityIRR.length ? equityIRR : [0.14, 0.15, 0.16]
            };
        } else if (currentInputMode === 'range') {
            // Generate values from range inputs
            inputs = generateRangeValues();
        } else if (currentInputMode === 'lowhigh') {
            // Generate values from low/high boundaries
            inputs = generateLowHighValues();
        }
        
        return inputs;
    }
    
    function generateAllPermutations(inputs) {
        let permutations = [];
        
        // Generate cartesian product of all input arrays
        const keys = Object.keys(inputs);
        const values = Object.values(inputs);
        
        function cartesian(arr) {
            return arr.reduce((a, b) => a.flatMap(d => b.map(e => [d, e].flat())));
        }
        
        if (values.length > 0) {
            const combinations = cartesian(values);
            combinations.forEach(combo => {
                let perm = {};
                keys.forEach((key, index) => {
                    perm[key] = Array.isArray(combo) ? combo[index] : combo;
                });
                permutations.push(perm);
            });
        }
        
        return permutations;
    }
    
    function processPermutations(permutations) {
        const tbody = document.getElementById('perm-results-body');
        tbody.innerHTML = '';
        
        permutations.forEach((perm, index) => {
            // Calculate derived values
            const annualRent = perm.rent * 12;
            const netIncome = annualRent * (1 - perm.opex);
            
            // Calculate senior debt
            const seniorDebtService = netIncome / perm.seniorDSCR;
            const seniorDebt = seniorDebtService / perm.seniorCoupon;
            
            // Calculate mezz debt
            const remainingNOI = netIncome - seniorDebtService;
            const mezzDebtService = remainingNOI / perm.mezzDSCR;
            const mezzDebt = mezzDebtService / perm.mezzCoupon;
            
            // Calculate equity
            const totalDebt = seniorDebt + mezzDebt;
            const equity = Math.max(0, perm.capex - totalDebt);
            
            // Calculate metrics
            const leverage = totalDebt / perm.capex;
            const wacd = (seniorDebt * perm.seniorCoupon + mezzDebt * perm.mezzCoupon) / totalDebt;
            const irr = perm.equityIRR;
            
            // Check viability
            const isViable = leverage <= 0.85 && equity > 0 && wacd < 0.08;
            
            if (isViable) {
                securitisationEngine.validCount++;
                if (irr > securitisationEngine.bestIRR) {
                    securitisationEngine.bestIRR = irr;
                }
            } else {
                securitisationEngine.invalidCount++;
            }
            
            // Add to table
            const row = tbody.insertRow();
            row.style.borderBottom = '1px solid #364049';
            row.innerHTML = '<td style="padding: 8px;">' + (index + 1) + '</td>' +
                '<td style="padding: 8px;">£' + perm.capex.toLocaleString() + '</td>' +
                '<td style="padding: 8px;">' + (perm.opex * 100).toFixed(1) + '%</td>' +
                '<td style="padding: 8px;">£' + perm.rent.toLocaleString() + '</td>' +
                '<td style="padding: 8px;">' + perm.seniorDSCR.toFixed(2) + '</td>' +
                '<td style="padding: 8px;">' + (perm.seniorCoupon * 100).toFixed(2) + '%</td>' +
                '<td style="padding: 8px;">£' + seniorDebt.toLocaleString('en-GB', {maximumFractionDigits: 0}) + '</td>' +
                '<td style="padding: 8px;">' + perm.mezzDSCR.toFixed(2) + '</td>' +
                '<td style="padding: 8px;">' + (perm.mezzCoupon * 100).toFixed(2) + '%</td>' +
                '<td style="padding: 8px;">£' + mezzDebt.toLocaleString('en-GB', {maximumFractionDigits: 0}) + '</td>' +
                '<td style="padding: 8px;">£' + equity.toLocaleString('en-GB', {maximumFractionDigits: 0}) + '</td>' +
                '<td style="padding: 8px;">' + (irr * 100).toFixed(2) + '%</td>' +
                '<td style="padding: 8px;">' + (wacd * 100).toFixed(2) + '%</td>' +
                '<td style="padding: 8px; color: ' + (isViable ? '#22c55e' : '#ef4444') + ';">' + (isViable ? 'Viable' : 'Invalid') + '</td>';
            
            // Update progress
            updateProgress(index + 1, permutations.length);
        });
        
        // Complete
        securitisationEngine.status = 'completed';
        document.getElementById('perm-status').textContent = 'Completed';
        document.getElementById('perm-status').style.color = '#22c55e';
        document.getElementById('perm-best-irr').textContent = (securitisationEngine.bestIRR * 100).toFixed(2) + '%';
    }
    
    function updateProgress(current, total) {
        const percent = (current / total * 100).toFixed(1);
        document.getElementById('perm-progress-bar').style.width = percent + '%';
        document.getElementById('perm-progress-percent').textContent = percent + '%';
        document.getElementById('perm-progress-text').textContent = current + ' / ' + total;
        document.getElementById('perm-valid-count').textContent = securitisationEngine.validCount;
        document.getElementById('perm-invalid-count').textContent = securitisationEngine.invalidCount;
        
        // Update dashboard widget
        updateDashboardWidget();
    }
    
    function updateDashboardWidget() {
        // Update dashboard widget values if they exist
        const dashboardPermCount = document.getElementById('dashboard-perm-count');
        const dashboardViableCount = document.getElementById('dashboard-viable-count');
        const dashboardInvalidCount = document.getElementById('dashboard-invalid-count');
        const dashboardBestIRR = document.getElementById('dashboard-best-irr');
        const dashboardEngineStatus = document.getElementById('dashboard-engine-status');
        
        if (dashboardPermCount) {
            dashboardPermCount.textContent = securitisationEngine.totalPermutations || 0;
        }
        if (dashboardViableCount) {
            dashboardViableCount.textContent = securitisationEngine.validCount || 0;
        }
        if (dashboardInvalidCount) {
            dashboardInvalidCount.textContent = securitisationEngine.invalidCount || 0;
        }
        if (dashboardBestIRR) {
            dashboardBestIRR.textContent = securitisationEngine.bestIRR > 0 ? 
                (securitisationEngine.bestIRR * 100).toFixed(2) + '%' : '-';
        }
        if (dashboardEngineStatus) {
            dashboardEngineStatus.textContent = securitisationEngine.status === 'running' ? 'Processing' : 
                                                 securitisationEngine.status === 'completed' ? 'Completed' : 'Ready';
            dashboardEngineStatus.className = 'badge ' + 
                (securitisationEngine.status === 'running' ? 'bg-warning' : 
                 securitisationEngine.status === 'completed' ? 'bg-success' : 'bg-secondary');
        }
    }
    
    function pauseGeneration() {
        if (securitisationEngine.status === 'running') {
            securitisationEngine.status = 'paused';
            document.getElementById('perm-status').textContent = 'Paused';
            document.getElementById('perm-status').style.color = '#f59e0b';
        }
    }
    
    function stopGeneration() {
        securitisationEngine.status = 'stopped';
        document.getElementById('perm-status').textContent = 'Stopped';
        document.getElementById('perm-status').style.color = '#ef4444';
    }
    
    function resetEngine() {
        securitisationEngine = {
            status: 'stopped',
            permutations: [],
            validCount: 0,
            invalidCount: 0,
            currentIndex: 0,
            totalPermutations: 0,
            bestIRR: 0
        };
        
        document.getElementById('perm-status').textContent = 'Ready';
        document.getElementById('perm-status').style.color = '#22c55e';
        document.getElementById('perm-progress-bar').style.width = '0%';
        document.getElementById('perm-progress-percent').textContent = '';
        document.getElementById('perm-progress-text').textContent = '0 / 0';
        document.getElementById('perm-valid-count').textContent = '0';
        document.getElementById('perm-invalid-count').textContent = '0';
        document.getElementById('perm-best-irr').textContent = '-';
        document.getElementById('perm-results-body').innerHTML = '<tr>' +
                '<td colspan="14" style="padding: 20px; text-align: center; color: #94a3b8;">' +
                    'No permutations generated yet. Configure parameters and click "Generate Permutations" to start.' +
                '</td>' +
            '</tr>';
    }
    
    function exportToExcel() {
        alert('Excel export will be implemented to save all permutation results.');
    }
    
    function exportToCSV() {
        alert('CSV export will be implemented to save all permutation results.');
    }
    
    function filterResults() {
        alert('Filter functionality will be implemented to filter viable/invalid results.');
    }
    
    function generateRangeValues() {
        // Implementation for range mode value generation
        return {
            capex: [],
            opex: [],
            rent: [],
            seniorDSCR: [],
            seniorCoupon: [],
            seniorTenor: [],
            mezzDSCR: [],
            mezzCoupon: [],
            equityIRR: []
        };
    }
    
    function generateLowHighValues() {
        // Implementation for low/high mode value generation
        var numScenariosEl = document.getElementById('sec-num-scenarios');
        const numScenarios = numScenariosEl ? parseInt(numScenariosEl.value) : 10;
        return {
            capex: [],
            opex: [],
            rent: [],
            seniorDSCR: [],
            seniorCoupon: [],
            seniorTenor: [],
            mezzDSCR: [],
            mezzCoupon: [],
            equityIRR: []
        };
    }

    // Modal functions for Quick Actions
    function showNewAnalysisModal() {
        const modal = '<div class="modal fade" id="newAnalysisModal" tabindex="-1">' +
                '<div class="modal-dialog">' +
                    '<div class="modal-content bg-dark text-light">' +
                        '<div class="modal-header">' +
                            '<h5 class="modal-title">New Analysis</h5>' +
                            '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>' +
                        '</div>' +
                        '<div class="modal-body">' +
                            '<p>Select analysis type:</p>' +
                            '<div class="d-grid gap-2">' +
                                '<button class="btn btn-outline-primary" onclick="location.href=\'/securitization-engine\'">Securitization Analysis</button>' +
                                '<button class="btn btn-outline-primary" onclick="showPermutationEngine()">Permutation Analysis</button>' +
                                '<button class="btn btn-outline-primary" disabled>Market Analysis (Coming Soon)</button>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        document.body.insertAdjacentHTML('beforeend', modal);
        const modalEl = new bootstrap.Modal(document.getElementById('newAnalysisModal'));
        modalEl.show();
        document.getElementById('newAnalysisModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    }

    function showUploadModal() {
        const modal = '<div class="modal fade" id="uploadModal" tabindex="-1">' +
                '<div class="modal-dialog">' +
                    '<div class="modal-content bg-dark text-light">' +
                        '<div class="modal-header">' +
                            '<h5 class="modal-title">Upload Data</h5>' +
                            '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>' +
                        '</div>' +
                        '<div class="modal-body">' +
                            '<div class="mb-3">' +
                                '<label class="form-label">Select file type:</label>' +
                                '<select class="form-select bg-dark text-light">' +
                                    '<option>CSV</option>' +
                                    '<option>Excel</option>' +
                                    '<option>JSON</option>' +
                                '</select>' +
                            '</div>' +
                            '<div class="mb-3">' +
                                '<input type="file" class="form-control bg-dark text-light" accept=".csv,.xlsx,.json">' +
                            '</div>' +
                            '<button class="btn btn-primary w-100">Upload File</button>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        document.body.insertAdjacentHTML('beforeend', modal);
        const modalEl = new bootstrap.Modal(document.getElementById('uploadModal'));
        modalEl.show();
        document.getElementById('uploadModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    }

    function exportData() {
        const data = {
            timestamp: new Date().toISOString(),
            market_data: window.currentMarketData || {},
            user: {{ username|tojson|safe }}
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'atlas_nexus_export_' + new Date().toISOString().split('T')[0] + '.json';
        a.click();
        URL.revokeObjectURL(url);
    }

    function showSettingsModal() {
        const modal = '<div class="modal fade" id="settingsModal" tabindex="-1">' +
                '<div class="modal-dialog">' +
                    '<div class="modal-content bg-dark text-light">' +
                        '<div class="modal-header">' +
                            '<h5 class="modal-title">Settings</h5>' +
                            '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>' +
                        '</div>' +
                        '<div class="modal-body">' +
                            '<div class="mb-3">' +
                                '<label class="form-label">Theme</label>' +
                                '<select class="form-select bg-dark text-light">' +
                                    '<option>Dark (Default)</option>' +
                                    '<option disabled>Light (Coming Soon)</option>' +
                                '</select>' +
                            '</div>' +
                            '<div class="mb-3">' +
                                '<label class="form-label">Data Refresh Rate</label>' +
                                '<select class="form-select bg-dark text-light">' +
                                    '<option>5 minutes</option>' +
                                    '<option>10 minutes</option>' +
                                    '<option>30 minutes</option>' +
                                '</select>' +
                            '</div>' +
                            '<div class="mb-3">' +
                                '<label class="form-label">Notifications</label>' +
                                '<div class="form-check">' +
                                    '<input class="form-check-input" type="checkbox" checked>' +
                                    '<label class="form-check-label">Email notifications</label>' +
                                '</div>' +
                            '</div>' +
                            '<button class="btn btn-primary w-100">Save Settings</button>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        document.body.insertAdjacentHTML('beforeend', modal);
        const modalEl = new bootstrap.Modal(document.getElementById('settingsModal'));
        modalEl.show();
        document.getElementById('settingsModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    }
    </script>
</body>
</html>