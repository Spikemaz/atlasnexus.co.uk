<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Permutation Engine - Atlas Nexus</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: #1A1D23;
            color: #E5E9F0;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, rgba(20, 25, 45, 0.95) 0%, rgba(10, 15, 30, 0.95) 100%);
            border-bottom: 1px solid rgba(96, 165, 250, 0.2);
            padding: 1.5rem 2rem;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo h1 {
            font-size: 1.8rem;
            color: #60a5fa;
            text-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
        }

        .logo p {
            font-size: 0.9rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 0.25rem;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .control-bar {
            background: linear-gradient(135deg, rgba(44, 49, 55, 0.8) 0%, rgba(54, 64, 73, 0.8) 100%);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .input-mode-selector {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            border: 1px solid rgba(96, 165, 250, 0.2);
            background: rgba(26, 32, 46, 0.6);
            color: #B8C0C8;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .mode-btn.active {
            background: linear-gradient(90deg, #60a5fa, #3b82f6);
            color: white;
            border-color: #60a5fa;
        }

        .mode-btn:hover:not(.active) {
            border-color: #60a5fa;
            color: #60a5fa;
            background: rgba(96, 165, 250, 0.15);
        }

        .parameters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .parameter-card {
            background: linear-gradient(135deg, rgba(44, 49, 55, 0.8) 0%, rgba(54, 64, 73, 0.8) 100%);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .parameter-card:hover {
            border-color: rgba(96, 165, 250, 0.4);
            box-shadow: 0 4px 20px rgba(96, 165, 250, 0.15);
        }

        .parameter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .parameter-name {
            font-size: 1rem;
            color: #60a5fa;
            font-weight: 600;
        }

        .parameter-toggle {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .input-group {
            display: grid;
            gap: 0.5rem;
        }

        .input-row {
            display: grid;
            grid-template-columns: 80px 1fr;
            align-items: center;
            gap: 0.5rem;
        }

        .input-label {
            font-size: 0.85rem;
            color: #888;
            text-align: right;
        }

        .input-field {
            padding: 0.5rem 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #ffd700;
            background: rgba(255, 255, 255, 0.08);
        }

        .input-field:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .category-section {
            margin-bottom: 2rem;
        }

        .category-header {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .category-header:hover {
            background: rgba(255, 215, 0, 0.15);
        }

        .category-title {
            font-size: 1.2rem;
            color: #ffd700;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .category-count {
            background: rgba(255, 215, 0, 0.2);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            color: #ffd700;
        }

        .results-panel {
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(255, 215, 0, 0.1);
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
            min-height: 400px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
        }

        .results-title {
            font-size: 1.5rem;
            color: #ffd700;
        }

        .results-meta {
            display: flex;
            gap: 2rem;
            color: #888;
            font-size: 0.9rem;
        }

        .results-content {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.1);
            border-radius: 8px;
            padding: 1.5rem;
            min-height: 300px;
            overflow: auto;
            max-height: 600px;
        }

        .permutation-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 215, 0, 0.1);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .permutation-item:hover {
            border-color: rgba(255, 215, 0, 0.3);
            background: rgba(255, 255, 255, 0.04);
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 1rem 2rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #0a0e27;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 215, 0, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffd700;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 215, 0, 0.1);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 215, 0, 0.2);
            border-top-color: #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .stats-box {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-item {
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            color: #ffd700;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 0.5rem;
        }

        @media (max-width: 768px) {
            .parameters-grid {
                grid-template-columns: 1fr;
            }
            
            .control-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-mode-selector {
                justify-content: center;
            }
            
            .stats-box {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
    </div>

    <div class="header">
        <div class="header-content">
            <div class="logo">
                <h1>ATLAS NEXUS</h1>
                <p>Permutation Engine - Advanced Modeling</p>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <a href="/dashboard" style="background: transparent; color: #60a5fa; border: 1px solid #60a5fa; padding: 0.75rem 1.5rem; border-radius: 5px; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease;">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="control-bar">
            <div class="input-mode-selector">
                <button class="mode-btn active" onclick="setInputMode('manual')" data-mode="manual">
                    <i class="fas fa-edit"></i> Manual
                </button>
                <button class="mode-btn" onclick="setInputMode('range')" data-mode="range">
                    <i class="fas fa-sliders-h"></i> Range
                </button>
                <button class="mode-btn" onclick="setInputMode('boundary')" data-mode="boundary">
                    <i class="fas fa-compress-arrows-alt"></i> Boundary
                </button>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <span style="color: #888;">Max Permutations:</span>
                <input type="number" class="input-field" id="maxPermutations" value="1000" min="1" max="100000" style="width: 120px;">
                <button class="btn btn-secondary" onclick="selectAllParameters()" style="padding: 0.5rem 1rem;">
                    <i class="fas fa-check-square"></i> All
                </button>
                <button class="btn btn-secondary" onclick="deselectAllParameters()" style="padding: 0.5rem 1rem;">
                    <i class="fas fa-square"></i> None
                </button>
            </div>
        </div>

        <!-- Project Parameters -->
        <div class="category-section">
            <div class="category-header" onclick="toggleCategory('project')">
                <div class="category-title">
                    <i class="fas fa-project-diagram"></i>
                    Project Parameters
                </div>
                <div class="category-count" id="projectCount">0 active</div>
            </div>
            <div class="parameters-grid" id="projectParams">
                <!-- Parameters will be dynamically added here -->
            </div>
        </div>

        <!-- Financial Parameters -->
        <div class="category-section">
            <div class="category-header" onclick="toggleCategory('financial')">
                <div class="category-title">
                    <i class="fas fa-dollar-sign"></i>
                    Financial Parameters
                </div>
                <div class="category-count" id="financialCount">0 active</div>
            </div>
            <div class="parameters-grid" id="financialParams" style="display: none;">
                <!-- Parameters will be dynamically added here -->
            </div>
        </div>

        <!-- Senior Debt Parameters -->
        <div class="category-section">
            <div class="category-header" onclick="toggleCategory('senior')">
                <div class="category-title">
                    <i class="fas fa-building"></i>
                    Senior Debt Parameters
                </div>
                <div class="category-count" id="seniorCount">0 active</div>
            </div>
            <div class="parameters-grid" id="seniorParams" style="display: none;">
                <!-- Parameters will be dynamically added here -->
            </div>
        </div>

        <!-- Mezzanine Debt Parameters -->
        <div class="category-section">
            <div class="category-header" onclick="toggleCategory('mezzanine')">
                <div class="category-title">
                    <i class="fas fa-layer-group"></i>
                    Mezzanine Debt Parameters
                </div>
                <div class="category-count" id="mezzanineCount">0 active</div>
            </div>
            <div class="parameters-grid" id="mezzanineParams" style="display: none;">
                <!-- Parameters will be dynamically added here -->
            </div>
        </div>

        <!-- Equity Parameters -->
        <div class="category-section">
            <div class="category-header" onclick="toggleCategory('equity')">
                <div class="category-title">
                    <i class="fas fa-chart-line"></i>
                    Equity Parameters
                </div>
                <div class="category-count" id="equityCount">0 active</div>
            </div>
            <div class="parameters-grid" id="equityParams" style="display: none;">
                <!-- Parameters will be dynamically added here -->
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-primary" onclick="generatePermutations()">
                <i class="fas fa-cogs"></i> Generate Permutations
            </button>
            <button class="btn btn-secondary" onclick="loadPreset()">
                <i class="fas fa-file-import"></i> Load Preset
            </button>
            <button class="btn btn-secondary" onclick="savePreset()">
                <i class="fas fa-save"></i> Save Preset
            </button>
            <button class="btn btn-secondary" onclick="resetAll()">
                <i class="fas fa-redo"></i> Reset All
            </button>
        </div>

        <div class="results-panel">
            <div class="results-header">
                <div class="results-title">
                    <i class="fas fa-chart-bar"></i> Permutation Results
                </div>
                <div class="results-meta">
                    <span>Total: <strong id="totalPermutations">0</strong></span>
                    <span>Generated: <strong id="generatedTime">--:--</strong></span>
                </div>
            </div>
            
            <div class="stats-box">
                <div class="stat-item">
                    <div class="stat-value" id="statActive">0</div>
                    <div class="stat-label">Active Parameters</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statCombinations">0</div>
                    <div class="stat-label">Combinations</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statReduction">0%</div>
                    <div class="stat-label">Reduction</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statTime">0ms</div>
                    <div class="stat-label">Process Time</div>
                </div>
            </div>

            <div class="results-content" id="resultsContent">
                <div style="text-align: center; color: #666; padding: 3rem;">
                    <i class="fas fa-cube" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <p>No permutations generated yet</p>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem;">Configure parameters and click Generate</p>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="exportCSV()">
                    <i class="fas fa-file-csv"></i> Export CSV
                </button>
                <button class="btn btn-secondary" onclick="exportJSON()">
                    <i class="fas fa-file-code"></i> Export JSON
                </button>
                <button class="btn btn-secondary" onclick="runInSecuritization()">
                    <i class="fas fa-rocket"></i> Run in Securitization
                </button>
            </div>
        </div>
    </div>

    <script>
        // Complete parameter list from PQuery table (80+ parameters)
        const parameters = {
            project: [
                { id: 'currency', name: 'Currency', type: 'select', options: ['EUR', 'USD', 'GBP'], default: 'EUR' },
                { id: 'grossItLoad', name: 'Gross IT Load (MW)', type: 'number', min: 1, max: 1000, step: 0.1, default: 10 },
                { id: 'pue', name: 'PUE', type: 'number', min: 1, max: 3, step: 0.01, default: 1.15 },
                { id: 'netItLoad', name: 'Net IT Load (MW)', type: 'formula', formula: 'grossItLoad / pue' },
                { id: 'deliveryDate', name: 'Delivery Date', type: 'date', default: '2025-01-01' },
                { id: 'projectLocation', name: 'Location', type: 'select', options: ['London', 'Frankfurt', 'Paris', 'Amsterdam', 'Dublin'], default: 'London' }
            ],
            financial: [
                { id: 'grossMonthlyRent', name: 'Gross Monthly Rent (€/kW)', type: 'number', min: 50, max: 500, step: 10, default: 110 },
                { id: 'opexPercent', name: 'OPEX %', type: 'number', min: 0, max: 100, step: 1, default: 15 },
                { id: 'contractTerm', name: 'Contract Term (Years)', type: 'number', min: 1, max: 30, step: 1, default: 10 },
                { id: 'indexation', name: 'Annual Indexation %', type: 'number', min: 0, max: 10, step: 0.5, default: 2 },
                { id: 'capex', name: 'CAPEX (€/kW)', type: 'number', min: 1000, max: 20000, step: 100, default: 7000 },
                { id: 'shellCost', name: 'Shell Cost (€/sqm)', type: 'number', min: 500, max: 5000, step: 100, default: 1500 },
                { id: 'mepCost', name: 'MEP Cost (€/kW)', type: 'number', min: 1000, max: 10000, step: 100, default: 3500 },
                { id: 'fitOutCost', name: 'Fit-Out Cost (€/kW)', type: 'number', min: 500, max: 5000, step: 100, default: 1500 },
                { id: 'landCost', name: 'Land Cost (€)', type: 'number', min: 0, max: 100000000, step: 100000, default: 5000000 },
                { id: 'developmentMargin', name: 'Development Margin %', type: 'number', min: 0, max: 50, step: 1, default: 15 }
            ],
            senior: [
                { id: 'seniorTargetDscr', name: 'Target DSCR', type: 'number', min: 1, max: 3, step: 0.05, default: 1.35 },
                { id: 'seniorCoupon', name: 'Coupon %', type: 'number', min: 0, max: 20, step: 0.25, default: 6.5 },
                { id: 'seniorTenor', name: 'Tenor (Years)', type: 'number', min: 1, max: 30, step: 1, default: 7 },
                { id: 'seniorAmortizationType', name: 'Amortization Type', type: 'select', options: ['Bullet', 'Linear', 'Annuity', 'Custom'], default: 'Linear' },
                { id: 'seniorAmortizationPercent', name: 'Amortization %', type: 'number', min: 0, max: 100, step: 5, default: 50 },
                { id: 'seniorMaxLtv', name: 'Max LTV %', type: 'number', min: 0, max: 100, step: 5, default: 65 },
                { id: 'seniorUpfrontFee', name: 'Upfront Fee %', type: 'number', min: 0, max: 5, step: 0.25, default: 1 },
                { id: 'seniorReserveMonths', name: 'Reserve Months', type: 'number', min: 0, max: 24, step: 1, default: 6 }
            ],
            mezzanine: [
                { id: 'mezzIncluded', name: 'Include Mezzanine', type: 'boolean', default: true },
                { id: 'mezzTargetDscr', name: 'Target DSCR', type: 'number', min: 1, max: 2, step: 0.05, default: 1.15 },
                { id: 'mezzCoupon', name: 'Coupon %', type: 'number', min: 0, max: 30, step: 0.5, default: 12 },
                { id: 'mezzTenor', name: 'Tenor (Years)', type: 'number', min: 1, max: 15, step: 1, default: 5 },
                { id: 'mezzPikPercent', name: 'PIK %', type: 'number', min: 0, max: 100, step: 10, default: 50 },
                { id: 'mezzMaxLtv', name: 'Max Combined LTV %', type: 'number', min: 0, max: 100, step: 5, default: 80 },
                { id: 'mezzUpfrontFee', name: 'Upfront Fee %', type: 'number', min: 0, max: 10, step: 0.5, default: 2 }
            ],
            equity: [
                { id: 'equityTargetIrr', name: 'Target IRR %', type: 'number', min: 0, max: 50, step: 1, default: 18 },
                { id: 'equityHoldPeriod', name: 'Hold Period (Years)', type: 'number', min: 1, max: 20, step: 1, default: 5 },
                { id: 'equityExitCapRate', name: 'Exit Cap Rate %', type: 'number', min: 0, max: 20, step: 0.25, default: 7 },
                { id: 'equityPromoteTier1', name: 'Promote Tier 1 IRR %', type: 'number', min: 0, max: 30, step: 1, default: 12 },
                { id: 'equityPromoteTier2', name: 'Promote Tier 2 IRR %', type: 'number', min: 0, max: 40, step: 1, default: 18 },
                { id: 'equityManagementFee', name: 'Management Fee %', type: 'number', min: 0, max: 5, step: 0.25, default: 1.5 }
            ]
        };

        let currentMode = 'manual';
        let activeParameters = new Set();
        let permutations = [];

        function initializeEngine() {
            renderAllParameters();
            updateCategoryCounts();
        }

        function renderAllParameters() {
            Object.keys(parameters).forEach(category => {
                const container = document.getElementById(`${category}Params`);
                container.innerHTML = '';
                
                parameters[category].forEach(param => {
                    const card = createParameterCard(param, category);
                    container.appendChild(card);
                });
            });
        }

        function createParameterCard(param, category) {
            const card = document.createElement('div');
            card.className = 'parameter-card';
            card.id = `param-${param.id}`;
            
            let inputHtml = '';
            
            if (currentMode === 'manual') {
                inputHtml = createManualInput(param);
            } else if (currentMode === 'range') {
                inputHtml = createRangeInput(param);
            } else if (currentMode === 'boundary') {
                inputHtml = createBoundaryInput(param);
            }
            
            card.innerHTML = `
                <div class="parameter-header">
                    <div class="parameter-name">${param.name}</div>
                    <input type="checkbox" class="parameter-toggle" 
                           data-param="${param.id}" 
                           data-category="${category}"
                           onchange="toggleParameter('${param.id}', '${category}')">
                </div>
                <div class="input-group">
                    ${inputHtml}
                </div>
            `;
            
            return card;
        }

        function createManualInput(param) {
            if (param.type === 'formula') {
                return `
                    <div class="input-row">
                        <span class="input-label">Formula:</span>
                        <input type="text" class="input-field" value="${param.formula}" disabled>
                    </div>
                `;
            } else if (param.type === 'select') {
                return `
                    <div class="input-row">
                        <span class="input-label">Value:</span>
                        <select class="input-field" data-param="${param.id}">
                            ${param.options.map(opt => 
                                `<option value="${opt}" ${opt === param.default ? 'selected' : ''}>${opt}</option>`
                            ).join('')}
                        </select>
                    </div>
                `;
            } else if (param.type === 'boolean') {
                return `
                    <div class="input-row">
                        <span class="input-label">Value:</span>
                        <select class="input-field" data-param="${param.id}">
                            <option value="true" ${param.default ? 'selected' : ''}>Yes</option>
                            <option value="false" ${!param.default ? 'selected' : ''}>No</option>
                        </select>
                    </div>
                `;
            } else {
                return `
                    <div class="input-row">
                        <span class="input-label">Value:</span>
                        <input type="${param.type}" class="input-field" 
                               data-param="${param.id}"
                               value="${param.default || ''}"
                               ${param.min !== undefined ? `min="${param.min}"` : ''}
                               ${param.max !== undefined ? `max="${param.max}"` : ''}
                               ${param.step !== undefined ? `step="${param.step}"` : ''}>
                    </div>
                `;
            }
        }

        function createRangeInput(param) {
            if (param.type === 'formula') {
                return createManualInput(param);
            } else if (param.type === 'select') {
                return `
                    <div style="display: grid; gap: 0.5rem;">
                        ${param.options.map(opt => `
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" value="${opt}" data-param="${param.id}-range">
                                <span style="color: #888;">${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                `;
            } else if (param.type === 'number') {
                return `
                    <div class="input-row">
                        <span class="input-label">Min:</span>
                        <input type="number" class="input-field" data-param="${param.id}-min"
                               value="${param.min || param.default}" step="${param.step || 1}">
                    </div>
                    <div class="input-row">
                        <span class="input-label">Max:</span>
                        <input type="number" class="input-field" data-param="${param.id}-max"
                               value="${param.max || param.default}" step="${param.step || 1}">
                    </div>
                    <div class="input-row">
                        <span class="input-label">Step:</span>
                        <input type="number" class="input-field" data-param="${param.id}-step"
                               value="${param.step || 1}">
                    </div>
                `;
            } else {
                return createManualInput(param);
            }
        }

        function createBoundaryInput(param) {
            if (param.type === 'formula' || param.type === 'select' || param.type === 'boolean') {
                return createManualInput(param);
            } else if (param.type === 'number') {
                return `
                    <div class="input-row">
                        <span class="input-label">Low:</span>
                        <input type="number" class="input-field" data-param="${param.id}-low"
                               value="${param.default * 0.8}" step="${param.step || 1}">
                    </div>
                    <div class="input-row">
                        <span class="input-label">High:</span>
                        <input type="number" class="input-field" data-param="${param.id}-high"
                               value="${param.default * 1.2}" step="${param.step || 1}">
                    </div>
                `;
            } else {
                return createManualInput(param);
            }
        }

        function setInputMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            renderAllParameters();
            updateCategoryCounts();
        }

        function toggleParameter(paramId, category) {
            const checkbox = document.querySelector(`input[data-param="${paramId}"]`);
            if (checkbox.checked) {
                activeParameters.add(paramId);
            } else {
                activeParameters.delete(paramId);
            }
            updateCategoryCounts();
            updateStats();
        }

        function toggleCategory(category) {
            const params = document.getElementById(`${category}Params`);
            params.style.display = params.style.display === 'none' ? 'grid' : 'none';
        }

        function updateCategoryCounts() {
            Object.keys(parameters).forEach(category => {
                const count = parameters[category].filter(p => activeParameters.has(p.id)).length;
                document.getElementById(`${category}Count`).textContent = `${count} active`;
            });
        }

        function updateStats() {
            const activeCount = activeParameters.size;
            document.getElementById('statActive').textContent = activeCount;
            
            // Calculate potential combinations
            let combinations = 1;
            activeParameters.forEach(paramId => {
                if (currentMode === 'range' || currentMode === 'boundary') {
                    combinations *= 10; // Simplified calculation
                }
            });
            
            document.getElementById('statCombinations').textContent = 
                combinations > 1000000 ? (combinations / 1000000).toFixed(1) + 'M' : combinations;
        }

        function selectAllParameters() {
            document.querySelectorAll('.parameter-toggle').forEach(checkbox => {
                checkbox.checked = true;
                const paramId = checkbox.dataset.param;
                activeParameters.add(paramId);
            });
            updateCategoryCounts();
            updateStats();
        }

        function deselectAllParameters() {
            document.querySelectorAll('.parameter-toggle').forEach(checkbox => {
                checkbox.checked = false;
            });
            activeParameters.clear();
            updateCategoryCounts();
            updateStats();
        }

        async function generatePermutations() {
            const loader = document.getElementById('loadingOverlay');
            loader.classList.add('active');
            
            const startTime = Date.now();
            
            try {
                // Collect parameter values based on mode
                const parameterValues = collectParameterValues();
                
                // Generate permutations
                permutations = generateCombinations(parameterValues);
                
                // Limit permutations to max
                const maxPerms = parseInt(document.getElementById('maxPermutations').value);
                if (permutations.length > maxPerms) {
                    permutations = permutations.slice(0, maxPerms);
                }
                
                // Display results
                displayPermutations(permutations);
                
                // Update stats
                const endTime = Date.now();
                document.getElementById('statTime').textContent = `${endTime - startTime}ms`;
                document.getElementById('totalPermutations').textContent = permutations.length;
                document.getElementById('generatedTime').textContent = new Date().toLocaleTimeString();
                
                const reduction = activeParameters.size > 0 ? 
                    Math.round((1 - permutations.length / Math.pow(10, activeParameters.size)) * 100) : 0;
                document.getElementById('statReduction').textContent = `${reduction}%`;
                
            } catch (error) {
                console.error('Error generating permutations:', error);
                alert('Error generating permutations: ' + error.message);
            } finally {
                loader.classList.remove('active');
            }
        }

        function collectParameterValues() {
            const values = {};
            
            activeParameters.forEach(paramId => {
                const param = findParameter(paramId);
                if (!param) return;
                
                if (currentMode === 'manual') {
                    const input = document.querySelector(`input[data-param="${paramId}"], select[data-param="${paramId}"]`);
                    if (input) {
                        values[paramId] = [input.value];
                    }
                } else if (currentMode === 'range') {
                    if (param.type === 'select') {
                        const checked = document.querySelectorAll(`input[data-param="${paramId}-range"]:checked`);
                        values[paramId] = Array.from(checked).map(cb => cb.value);
                    } else if (param.type === 'number') {
                        const min = parseFloat(document.querySelector(`input[data-param="${paramId}-min"]`).value);
                        const max = parseFloat(document.querySelector(`input[data-param="${paramId}-max"]`).value);
                        const step = parseFloat(document.querySelector(`input[data-param="${paramId}-step"]`).value);
                        values[paramId] = [];
                        for (let v = min; v <= max; v += step) {
                            values[paramId].push(v);
                        }
                    }
                } else if (currentMode === 'boundary') {
                    if (param.type === 'number') {
                        const low = parseFloat(document.querySelector(`input[data-param="${paramId}-low"]`).value);
                        const high = parseFloat(document.querySelector(`input[data-param="${paramId}-high"]`).value);
                        values[paramId] = [low, high];
                    } else {
                        const input = document.querySelector(`input[data-param="${paramId}"], select[data-param="${paramId}"]`);
                        if (input) {
                            values[paramId] = [input.value];
                        }
                    }
                }
            });
            
            return values;
        }

        function findParameter(paramId) {
            for (const category in parameters) {
                const param = parameters[category].find(p => p.id === paramId);
                if (param) return param;
            }
            return null;
        }

        function generateCombinations(parameterValues) {
            const keys = Object.keys(parameterValues);
            if (keys.length === 0) return [];
            
            const combinations = [];
            const maxPerms = parseInt(document.getElementById('maxPermutations').value);
            
            function generate(index, current) {
                if (combinations.length >= maxPerms) return;
                
                if (index === keys.length) {
                    combinations.push({...current});
                    return;
                }
                
                const key = keys[index];
                const values = parameterValues[key];
                
                for (const value of values) {
                    current[key] = value;
                    generate(index + 1, current);
                    if (combinations.length >= maxPerms) return;
                }
            }
            
            generate(0, {});
            return combinations;
        }

        function displayPermutations(perms) {
            const container = document.getElementById('resultsContent');
            
            if (perms.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 3rem;">
                        <i class="fas fa-cube" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>No permutations generated</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            perms.forEach((perm, index) => {
                html += `
                    <div class="permutation-item">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <strong style="color: #ffd700;">Permutation ${index + 1}</strong>
                            <button class="btn btn-secondary" style="padding: 0.3rem 0.8rem; font-size: 0.85rem;" 
                                    onclick="usePermutation(${index})">
                                Use This
                            </button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem;">
                            ${Object.entries(perm).map(([key, value]) => {
                                const param = findParameter(key);
                                return `
                                    <div style="font-size: 0.85rem;">
                                        <span style="color: #888;">${param ? param.name : key}:</span>
                                        <span style="color: #2ecc71; margin-left: 0.5rem;">${value}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function usePermutation(index) {
            const perm = permutations[index];
            if (!perm) return;
            
            // Send to securitization engine
            localStorage.setItem('permutationData', JSON.stringify(perm));
            window.location.href = '/securitization-engine';
        }

        function exportCSV() {
            if (permutations.length === 0) {
                alert('No permutations to export');
                return;
            }
            
            // Create CSV content
            const keys = Object.keys(permutations[0]);
            let csv = keys.join(',') + '\n';
            
            permutations.forEach(perm => {
                csv += keys.map(key => perm[key]).join(',') + '\n';
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `permutations_${new Date().getTime()}.csv`;
            a.click();
        }

        function exportJSON() {
            if (permutations.length === 0) {
                alert('No permutations to export');
                return;
            }
            
            const data = {
                timestamp: new Date().toISOString(),
                mode: currentMode,
                activeParameters: Array.from(activeParameters),
                permutations: permutations
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `permutations_${new Date().getTime()}.json`;
            a.click();
        }

        async function runInSecuritization() {
            if (permutations.length === 0) {
                alert('No permutations to run');
                return;
            }
            
            // Store permutations and redirect
            localStorage.setItem('batchPermutations', JSON.stringify(permutations));
            window.location.href = '/securitization-engine';
        }

        function savePreset() {
            const preset = {
                mode: currentMode,
                activeParameters: Array.from(activeParameters),
                values: collectParameterValues()
            };
            
            localStorage.setItem('permutationPreset', JSON.stringify(preset));
            alert('Preset saved');
        }

        function loadPreset() {
            const saved = localStorage.getItem('permutationPreset');
            if (!saved) {
                alert('No preset found');
                return;
            }
            
            const preset = JSON.parse(saved);
            setInputMode(preset.mode);
            
            activeParameters.clear();
            preset.activeParameters.forEach(p => activeParameters.add(p));
            
            updateCategoryCounts();
            updateStats();
            alert('Preset loaded');
        }

        function resetAll() {
            deselectAllParameters();
            setInputMode('manual');
            document.getElementById('maxPermutations').value = '1000';
            permutations = [];
            displayPermutations([]);
            document.getElementById('totalPermutations').textContent = '0';
            document.getElementById('generatedTime').textContent = '--:--';
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initializeEngine);
    </script>
</body>
</html>