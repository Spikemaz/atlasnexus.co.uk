{% extends "base.html" %}

{% block title %}Analysis Configuration - Securitization Engine{% endblock %}

{% block content %}
<div class="row">
    <!-- Page Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="display-6 fw-bold text-dark mb-2">
                    <i class="fas fa-calculator text-primary me-3"></i>
                    Analysis Configuration
                </h1>
                <p class="lead text-muted mb-0">
                    Configure your securitization analysis parameters
                </p>
            </div>
            <div>
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<form method="POST" action="{{ url_for('run_analysis') }}" id="analysisForm">
    <div class="row g-4">
        <!-- Core Parameters -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-sliders-h me-2"></i>Core Parameters
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="max_permutations" class="form-label fw-semibold">
                                <i class="fas fa-sitemap me-1"></i>Max Permutations
                            </label>
                            <input type="number" 
                                   class="form-control" 
                                   id="max_permutations" 
                                   name="max_permutations" 
                                   value="3000" 
                                   min="100" 
                                   max="10000"
                                   data-bs-toggle="tooltip"
                                   title="Maximum number of permutations to generate">
                            <div class="form-text">
                                Recommended: 1,000-5,000 for optimal performance
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="jurisdiction" class="form-label fw-semibold">
                                <i class="fas fa-globe me-1"></i>Jurisdiction
                            </label>
                            <select class="form-select" id="jurisdiction" name="jurisdiction">
                                <option value="UK" selected>United Kingdom</option>
                                <option value="EU">European Union</option>
                                <option value="US">United States</option>
                            </select>
                            <div class="form-text">
                                Determines applicable repo rules and regulations
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <label for="noi_base" class="form-label fw-semibold">
                                <i class="fas fa-pound-sign me-1"></i>Base NOI (Net Operating Income)
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">Â£</span>
                                <input type="number" 
                                       class="form-control" 
                                       id="noi_base" 
                                       name="noi_base" 
                                       value="5000000" 
                                       min="1000000" 
                                       max="50000000"
                                       step="100000"
                                       data-bs-toggle="tooltip"
                                       title="Base Net Operating Income for calculations">
                            </div>
                            <div class="form-text">
                                Annual net operating income available for debt service
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Senior Tranche Parameters -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-layer-group me-2"></i>Senior Tranche
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="senior_dscr_min" class="form-label fw-semibold">
                                <i class="fas fa-chart-line me-1"></i>Min DSCR
                            </label>
                            <input type="number" 
                                   class="form-control" 
                                   id="senior_dscr_min" 
                                   name="senior_dscr_min" 
                                   value="1.30" 
                                   min="1.00" 
                                   max="2.00"
                                   step="0.05"
                                   data-bs-toggle="tooltip"
                                   title="Minimum senior tranche DSCR">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="senior_dscr_max" class="form-label fw-semibold">
                                <i class="fas fa-chart-line me-1"></i>Max DSCR
                            </label>
                            <input type="number" 
                                   class="form-control" 
                                   id="senior_dscr_max" 
                                   name="senior_dscr_max" 
                                   value="1.60" 
                                   min="1.20" 
                                   max="2.50"
                                   step="0.05"
                                   data-bs-toggle="tooltip"
                                   title="Maximum senior tranche DSCR">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="senior_coupon_min" class="form-label fw-semibold">
                                <i class="fas fa-percentage me-1"></i>Min Coupon (%)
                            </label>
                            <input type="number" 
                                   class="form-control" 
                                   id="senior_coupon_min" 
                                   name="senior_coupon_min" 
                                   value="3.5" 
                                   min="1.0" 
                                   max="10.0"
                                   step="0.1"
                                   data-bs-toggle="tooltip"
                                   title="Minimum senior coupon rate (%)">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="senior_coupon_max" class="form-label fw-semibold">
                                <i class="fas fa-percentage me-1"></i>Max Coupon (%)
                            </label>
                            <input type="number" 
                                   class="form-control" 
                                   id="senior_coupon_max" 
                                   name="senior_coupon_max" 
                                   value="5.5" 
                                   min="2.0" 
                                   max="15.0"
                                   step="0.1"
                                   data-bs-toggle="tooltip"
                                   title="Maximum senior coupon rate (%)">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Advanced Options -->
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>Advanced Options
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       id="include_monetization" 
                                       name="include_monetization" 
                                       checked>
                                <label class="form-check-label fw-semibold" for="include_monetization">
                                    <i class="fas fa-coins me-2"></i>Include Monetization Overlays
                                </label>
                                <div class="form-text">
                                    Calculate ZCiS and TRS monetization opportunities
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       id="detailed_output" 
                                       name="detailed_output" 
                                       checked>
                                <label class="form-check-label fw-semibold" for="detailed_output">
                                    <i class="fas fa-list-alt me-2"></i>Detailed Output
                                </label>
                                <div class="form-text">
                                    Include comprehensive analysis metrics
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Upload -->
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-upload me-2"></i>Data Upload (Optional)
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <label for="data_file" class="form-label fw-semibold">
                                Custom Data File
                            </label>
                            <input type="file" 
                                   class="form-control" 
                                   id="data_file" 
                                   name="data_file"
                                   accept=".xlsx,.xlsm,.csv"
                                   data-bs-toggle="tooltip"
                                   title="Upload your custom Tables file">
                            <div class="form-text">
                                Upload Excel file (.xlsx, .xlsm) or CSV with your custom parameters
                            </div>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-outline-info w-100" onclick="downloadTemplate()">
                                <i class="fas fa-download me-2"></i>
                                Download Template
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="fw-bold mb-1">Ready to Run Analysis?</h6>
                            <p class="text-muted mb-0 small">
                                This will generate permutations based on your parameters and analyze viability
                            </p>
                        </div>
                        <div class="d-flex gap-3">
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                <i class="fas fa-undo me-2"></i>Reset
                            </button>
                            <button type="submit" class="btn btn-primary btn-lg px-4">
                                <span class="loading spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <i class="fas fa-play me-2"></i>
                                Run Analysis
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="fw-bold">Running Analysis...</h5>
                <p class="text-muted mb-0">
                    Please wait while we process your securitization parameters
                </p>
                <div class="progress mt-3" style="height: 8px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.getElementById('analysisForm').addEventListener('submit', function(e) {
    // Validate form
    if (!validateForm()) {
        e.preventDefault();
        return;
    }
    
    // Show progress modal
    const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
    progressModal.show();
    
    // Show loading on button
    showLoading('analysisForm');
});

function validateForm() {
    let isValid = true;
    const errors = [];
    
    // Check DSCR ranges
    const minDSCR = parseFloat(document.getElementById('senior_dscr_min').value);
    const maxDSCR = parseFloat(document.getElementById('senior_dscr_max').value);
    
    if (minDSCR >= maxDSCR) {
        errors.push('Maximum DSCR must be greater than minimum DSCR');
        isValid = false;
    }
    
    // Check coupon ranges
    const minCoupon = parseFloat(document.getElementById('senior_coupon_min').value);
    const maxCoupon = parseFloat(document.getElementById('senior_coupon_max').value);
    
    if (minCoupon >= maxCoupon) {
        errors.push('Maximum coupon must be greater than minimum coupon');
        isValid = false;
    }
    
    // Check permutation count
    const maxPerms = parseInt(document.getElementById('max_permutations').value);
    if (maxPerms > 10000) {
        errors.push('Maximum permutations should not exceed 10,000 for performance reasons');
        isValid = false;
    }
    
    // Display errors if any
    if (!isValid) {
        alert('Please fix the following errors:\n\n' + errors.join('\n'));
    }
    
    return isValid;
}

function resetForm() {
    if (confirm('Are you sure you want to reset all parameters to default values?')) {
        document.getElementById('analysisForm').reset();
        
        // Set default values
        document.getElementById('max_permutations').value = '3000';
        document.getElementById('noi_base').value = '5000000';
        document.getElementById('senior_dscr_min').value = '1.30';
        document.getElementById('senior_dscr_max').value = '1.60';
        document.getElementById('senior_coupon_min').value = '3.5';
        document.getElementById('senior_coupon_max').value = '5.5';
        document.getElementById('jurisdiction').value = 'UK';
        document.getElementById('include_monetization').checked = true;
        document.getElementById('detailed_output').checked = true;
    }
}

function downloadTemplate() {
    // In a real implementation, this would download an actual template file
    alert('Template download functionality will be available in the next update.\n\nFor now, please use the existing Tables v6.xlsm file as a reference.');
}

// Real-time validation feedback
document.getElementById('senior_dscr_min').addEventListener('input', function() {
    const min = parseFloat(this.value);
    const max = parseFloat(document.getElementById('senior_dscr_max').value);
    
    if (min >= max) {
        this.classList.add('is-invalid');
    } else {
        this.classList.remove('is-invalid');
    }
});

document.getElementById('senior_dscr_max').addEventListener('input', function() {
    const max = parseFloat(this.value);
    const min = parseFloat(document.getElementById('senior_dscr_min').value);
    
    if (max <= min) {
        this.classList.add('is-invalid');
    } else {
        this.classList.remove('is-invalid');
    }
});

document.getElementById('senior_coupon_min').addEventListener('input', function() {
    const min = parseFloat(this.value);
    const max = parseFloat(document.getElementById('senior_coupon_max').value);
    
    if (min >= max) {
        this.classList.add('is-invalid');
    } else {
        this.classList.remove('is-invalid');
    }
});

document.getElementById('senior_coupon_max').addEventListener('input', function() {
    const max = parseFloat(this.value);
    const min = parseFloat(document.getElementById('senior_coupon_min').value);
    
    if (max <= min) {
        this.classList.add('is-invalid');
    } else {
        this.classList.remove('is-invalid');
    }
});

// File upload handling
document.getElementById('data_file').addEventListener('change', function() {
    const file = this.files[0];
    if (file) {
        const fileSize = file.size / 1024 / 1024; // MB
        if (fileSize > 10) {
            alert('File size should not exceed 10MB');
            this.value = '';
        }
    }
});
</script>
{% endblock %}